<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³ØªØ± ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Vakamova</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e293b;
            --light: #f8fafc;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            color: #60a5fa;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .subtitle {
            color: #94a3b8;
            font-size: 1.2rem;
        }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: var(--dark);
            color: white;
            border: 2px solid #334155;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #3b82f6);
            border: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #34d399);
            border: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #f87171);
            border: none;
        }
        
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: rgba(30, 41, 59, 0.8);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            border-color: rgba(96, 165, 250, 0.3);
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-value {
            font-size: 2.8rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .progress-container {
            margin: 30px 0;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .file-list {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 16px;
            padding: 25px;
            margin: 30px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .file-card {
            background: rgba(15, 23, 42, 0.8);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .file-card.loaded {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .file-card.error {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .file-card.pending {
            border-color: #64748b;
        }
        
        .file-name {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-path {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 10px;
            word-break: break-all;
        }
        
        .file-status {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .status-loaded { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .status-error { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .status-pending { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }
        
        .log-container {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 16px;
            padding: 25px;
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 600px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            animation: fadeIn 0.3s ease;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-success { 
            color: var(--success);
            border-right: 4px solid var(--success);
        }
        
        .log-error { 
            color: var(--danger);
            border-right: 4px solid var(--danger);
        }
        
        .log-warning { 
            color: var(--warning);
            border-right: 4px solid var(--warning);
        }
        
        .log-info { 
            color: #60a5fa;
            border-right: 4px solid #60a5fa;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .file-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ§ª ØªØ³ØªØ± ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Vakamova</h1>
            <p class="subtitle">Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø§Ø±ØªØ¨Ø§Ø· Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ Ùˆ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡</p>
        </header>
        
        <div class="control-panel">
            <button class="btn btn-primary" onclick="runFullTest()">
                <span>ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Ú©Ø§Ù…Ù„</span>
            </button>
            <button class="btn" onclick="loadAllModules()">
                <span>ğŸ“¦ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡Ù…Ù‡ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§</span>
            </button>
            <button class="btn-success" onclick="runEssentialTests()">
                <span>âœ… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ</span>
            </button>
            <button class="btn-danger" onclick="clearAll()">
                <span>ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡</span>
            </button>
        </div>
        
        <div class="stats-panel">
            <div class="stat-card">
                <h3>Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡</h3>
                <div class="stat-value" id="loadedCount">0</div>
                <div id="loadedPercent">0%</div>
            </div>
            <div class="stat-card">
                <h3>ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚</h3>
                <div class="stat-value" id="passedCount">0</div>
                <div>Ø§Ø² <span id="totalTests">0</span> ØªØ³Øª</div>
            </div>
            <div class="stat-card">
                <h3>ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚</h3>
                <div class="stat-value" id="failedCount">0</div>
                <div id="failureRate">0%</div>
            </div>
            <div class="stat-card">
                <h3>Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§</h3>
                <div class="stat-value" id="executionTime">0s</div>
                <div id="timestamp">--:--:--</div>
            </div>
        </div>
        
        <div class="progress-container">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Ù¾ÛŒØ´Ø±ÙØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</span>
                <span id="progressText">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <div class="file-list">
            <h3 style="color: #e2e8f0; margin-bottom: 20px;">ğŸ“ Ù„ÛŒØ³Øª Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡</h3>
            <div class="file-grid" id="fileGrid">
                <!-- ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯ÛŒÙ†Ø§Ù…ÛŒÚ© Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            </div>
        </div>
        
        <div class="log-container">
            <h3 style="color: #e2e8f0; margin-bottom: 20px;">ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</h3>
            <div id="logContent">
                <div class="log-entry log-info">
                    <strong>[Ø¢Ù…Ø§Ø¯Ù‡]</strong> ØªØ³ØªØ± Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª. Ø±ÙˆÛŒ "Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Ú©Ø§Ù…Ù„" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ ====================
        const MODULES_CONFIG = [
            // Ù‡Ø³ØªÙ‡ Ø§ØµÙ„ÛŒ (Core) - Ø¨Ø§ export Ùˆ window
            { 
                name: 'Event Bus', 
                path: 'core/event_bus.js', 
                type: 'core', 
                required: true,
                globalCheck: () => window.eventBus !== undefined,
                moduleCheck: () => true // Ú†ÙˆÙ† Ù…Ø§Ú˜ÙˆÙ„ Ø§Ø³Øª
            },
            { 
                name: 'State Manager', 
                path: 'core/state_manager.js', 
                type: 'core', 
                required: true,
                globalCheck: () => window.HyperStateManager !== undefined,
                moduleCheck: () => true
            },
            { 
                name: 'Utils', 
                path: 'core/utils.js', 
                type: 'core', 
                required: true,
                globalCheck: () => window.utils !== undefined,
                moduleCheck: () => true
            },
            { 
                name: 'Context Provider', 
                path: 'core/context_provider.js', 
                type: 'core', 
                required: false,
                globalCheck: () => window.createContext !== undefined,
                moduleCheck: () => true
            },
            { 
                name: 'API Client', 
                path: 'core/api_client.js', 
                type: 'core', 
                required: false,
                globalCheck: () => window.HyperApiClient !== undefined,
                moduleCheck: () => true
            },
            { 
                name: 'Router', 
                path: 'core/router.js', 
                type: 'core', 
                required: false,
                globalCheck: () => window.router !== undefined,
                moduleCheck: () => true
            },
            { 
                name: 'Database', 
                path: 'core/database.js', 
                type: 'core', 
                required: false,
                globalCheck: () => window.AppDatabase !== undefined,
                moduleCheck: () => true
            },
            
            // ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø´Ù…Ø§
            { 
                name: 'Security Layer', 
                path: 'core/security.layer.js', 
                type: 'custom', 
                required: true,
                globalCheck: () => window.securityLayer !== undefined,
                moduleCheck: () => true
            },
            { 
                name: 'Core Operations', 
                path: 'core/core.operation.js', 
                type: 'custom', 
                required: true,
                globalCheck: () => window.coreOperation !== undefined,
                moduleCheck: () => true
            },
            { 
                name: 'Persistence', 
                path: 'core/persistence.js', 
                type: 'custom', 
                required: true,
                globalCheck: () => window.persistence !== undefined,
                moduleCheck: () => true
            },
            
            // Ù…Ø§Ú˜ÙˆÙ„ Auth
            { 
                name: 'Auth Manager', 
                path: 'modules/auth/auth_manager.js', 
                type: 'auth', 
                required: true,
                globalCheck: () => window.auth_manager !== undefined,
                moduleCheck: () => true
            },
            { 
                name: 'Token Manager', 
                path: 'modules/auth/token_manager.js', 
                type: 'auth', 
                required: false,
                globalCheck: () => window.token_manager !== undefined,
                moduleCheck: () => true
            },
            
            // ØµÙØ­Ø§Øª
            { 
                name: 'Home Page', 
                path: 'pages/home/page.js', 
                type: 'page', 
                required: false,
                globalCheck: () => window.homePage !== undefined,
                moduleCheck: () => true
            },
            { 
                name: 'Auth View', 
                path: 'pages/auth/view.js', 
                type: 'page', 
                required: false,
                globalCheck: () => window.authView !== undefined,
                moduleCheck: () => true
            },
            { 
                name: 'Language Picker', 
                path: 'pages/language_picker/view.js', 
                type: 'page', 
                required: false,
                globalCheck: () => window.LanguagePickerView !== undefined,
                moduleCheck: () => true
            }
        ];

        // ==================== ÙˆØ¶Ø¹ÛŒØª ØªØ³ØªØ± ====================
        const state = {
            loadedModules: new Map(),
            testResults: { passed: 0, failed: 0, total: 0 },
            startTime: null,
            logs: [],
            currentOperation: 'Ø¢Ù…Ø§Ø¯Ù‡'
        };

        // ==================== Ø³ÛŒØ³ØªÙ… Ù„Ø§Ú¯ÛŒÙ†Ú¯ ====================
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            const logEntry = { message, type, timestamp };
            state.logs.push(logEntry);
            
            const logElement = document.createElement('div');
            logElement.className = `log-entry log-${type}`;
            logElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            document.getElementById('logContent').prepend(logElement);
            
            // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª
            updateStats();
            return logEntry;
        }

        // ==================== Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ ====================
        async function loadModule(module) {
            return new Promise((resolve, reject) => {
                // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø´
                const script = document.createElement('script');
                script.src = `${module.path}?v=${Date.now()}`;
                script.type = 'module'; // Ù‡Ù…Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø§Ú˜ÙˆÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
                
                const timeoutId = setTimeout(() => {
                    reject(new Error(`ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ${module.name}`));
                }, 10000);
                
                script.onload = () => {
                    clearTimeout(timeoutId);
                    
                    // Ú©Ù…ÛŒ ØµØ¨Ø± Ú©Ù† ØªØ§ window.* ØªÙ†Ø¸ÛŒÙ… Ø´ÙˆÙ†Ø¯
                    setTimeout(() => {
                        const isLoaded = module.globalCheck ? module.globalCheck() : true;
                        
                        if (isLoaded || module.moduleCheck()) {
                            state.loadedModules.set(module.name, {
                                ...module,
                                loaded: true,
                                timestamp: Date.now(),
                                method: isLoaded ? 'global' : 'module'
                            });
                            
                            updateModuleUI(module.name, 'loaded');
                            log(`âœ… ${module.name} Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯ (${isLoaded ? 'global' : 'module'})`, 'success');
                            resolve(module);
                        } else {
                            state.loadedModules.set(module.name, {
                                ...module,
                                loaded: false,
                                error: 'Global export Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯'
                            });
                            
                            updateModuleUI(module.name, 'error');
                            log(`âš ï¸ ${module.name}: Global export ÛŒØ§ÙØª Ù†Ø´Ø¯ (Ø§Ù…Ø§ Ù…Ø§Ú˜ÙˆÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯)`, 'warning');
                            resolve(module); // Ù…Ø§Ú˜ÙˆÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡ ÙˆÙ„ÛŒ global Ù†ÛŒØ³Øª
                        }
                    }, 100);
                };
                
                script.onerror = (error) => {
                    clearTimeout(timeoutId);
                    
                    state.loadedModules.set(module.name, {
                        ...module,
                        loaded: false,
                        error: error.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡'
                    });
                    
                    updateModuleUI(module.name, 'error');
                    
                    if (module.required) {
                        log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ${module.name}: ${error.message || 'ÙØ§ÛŒÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯'}`, 'error');
                        reject(new Error(`Required module failed: ${module.name}`));
                    } else {
                        log(`âš ï¸ ${module.name} ÛŒØ§ÙØª Ù†Ø´Ø¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)`, 'warning');
                        resolve(null); // Ù…Ø§Ú˜ÙˆÙ„ Ø§Ø®ØªÛŒØ§Ø±ÛŒ
                    }
                };
                
                document.head.appendChild(script);
            });
        }

        async function loadAllModules() {
            log('Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡Ù…Ù‡ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§...', 'info');
            state.startTime = Date.now();
            state.loadedModules.clear();
            resetProgress();
            
            const required = MODULES_CONFIG.filter(m => m.required);
            const optional = MODULES_CONFIG.filter(m => !m.required);
            
            let loaded = 0;
            const total = MODULES_CONFIG.length;
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
            for (let i = 0; i < required.length; i++) {
                try {
                    await loadModule(required[i]);
                    loaded++;
                    updateProgress(loaded, total);
                    await delay(100); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² overload
                } catch (error) {
                    log(`ØªÙˆÙ‚Ù Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: ${error.message}`, 'error');
                    return;
                }
            }
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªÛŒØ§Ø±ÛŒ
            for (let i = 0; i < optional.length; i++) {
                try {
                    await loadModule(optional[i]);
                    loaded++;
                    updateProgress(loaded, total);
                    await delay(50);
                } catch (error) {
                    // Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø®Ø·Ø§ Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯
                }
            }
            
            updateProgress(total, total);
            log(`Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯: ${loaded} Ø§Ø² ${total} Ù…Ø§Ú˜ÙˆÙ„`, 'success');
        }

        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ ====================
        async function testEventBusIntegration() {
            log('ØªØ³Øª EventBus Integration...', 'info');
            
            if (!window.eventBus) {
                log('âŒ EventBus ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡', 'error');
                state.testResults.failed++;
                return false;
            }
            
            try {
                // ØªØ³Øª Ø§Ù†ØªØ´Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯
                let received = false;
                const testEvent = 'test:integration';
                
                const unsubscribe = eventBus.on(testEvent, (data) => {
                    received = true;
                    log(`âœ… Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯: ${JSON.stringify(data)}`, 'success');
                });
                
                eventBus.emit(testEvent, { 
                    test: 'Vakamova Integration',
                    timestamp: Date.now() 
                });
                
                // Ù…Ù†ØªØ¸Ø± Ø¯Ø±ÛŒØ§ÙØª Ø±ÙˆÛŒØ¯Ø§Ø¯
                await delay(150);
                
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
                
                if (received) {
                    log('âœ… EventBus Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯', 'success');
                    state.testResults.passed++;
                    return true;
                } else {
                    log('âŒ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ù…Ù†ØªØ´Ø± Ø´Ø¯ Ø§Ù…Ø§ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
                    state.testResults.failed++;
                    return false;
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø§ÛŒ EventBus: ${error.message}`, 'error');
                state.testResults.failed++;
                return false;
            }
        }

        async function testStateManagerIntegration() {
            log('ØªØ³Øª State Manager...', 'info');
            
            if (!window.HyperStateManager) {
                log('âš ï¸ HyperStateManager ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡', 'warning');
                return false;
            }
            
            try {
                const testState = new HyperStateManager(eventBus);
                const testKey = 'integration.test';
                const testValue = { 
                    project: 'Vakamova', 
                    phase: 'integration',
                    timestamp: Date.now()
                };
                
                // ØªØ³Øª set Ùˆ get
                testState.set(testKey, testValue);
                const retrieved = testState.get(testKey);
                
                if (retrieved && retrieved.project === 'Vakamova') {
                    log('âœ… State Manager Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯', 'success');
                    state.testResults.passed++;
                    
                    // ØªØ³Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ state:changed
                    let stateEventReceived = false;
                    eventBus.on('state:changed', (data) => {
                        if (data.path === testKey) {
                            stateEventReceived = true;
                        }
                    });
                    
                    testState.set(testKey, { ...testValue, updated: true });
                    await delay(100);
                    
                    if (stateEventReceived) {
                        log('âœ… EventBus â†’ StateManager Ø§Ø±ØªØ¨Ø§Ø· Ø¯Ø§Ø±Ø¯', 'success');
                    }
                    
                    return true;
                } else {
                    log('âŒ State Manager Ø¯Ø§Ø¯Ù‡ Ø±Ø§ Ø¨Ø±Ù†Ú¯Ø±Ø¯Ø§Ù†Ø¯', 'error');
                    state.testResults.failed++;
                    return false;
                }
            } catch (error) {
                log(`âŒ Ø®Ø·Ø§ÛŒ State Manager: ${error.message}`, 'error');
                state.testResults.failed++;
                return false;
            }
        }

        async function testNewModules() {
            log('Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯...', 'info');
            
            const newModules = [
                { name: 'Security Layer', check: () => window.securityLayer },
                { name: 'Core Operations', check: () => window.coreOperation },
                { name: 'Persistence', check: () => window.persistence }
            ];
            
            let passed = 0;
            
            for (const module of newModules) {
                if (module.check()) {
                    log(`âœ… ${module.name} Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª`, 'success');
                    passed++;
                    
                    // ØªØ³Øª Ø³Ø§Ø¯Ù‡ Ø¹Ù…Ù„Ú©Ø±Ø¯
                    try {
                        // Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø®Ø§Øµ Ù‡Ø± Ù…Ø§Ú˜ÙˆÙ„ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯
                        log(`   ${module.name} ØªØ³Øª Ø´Ø¯`, 'info');
                    } catch (e) {
                        log(`âš ï¸ ${module.name}: ${e.message}`, 'warning');
                    }
                } else {
                    log(`âŒ ${module.name} ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡`, 'error');
                }
            }
            
            if (passed === newModules.length) {
                state.testResults.passed++;
                return true;
            } else {
                state.testResults.failed++;
                return false;
            }
        }

        async function testAuthSystem() {
            log('Ø¨Ø±Ø±Ø³ÛŒ Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª...', 'info');
            
            if (!window.auth_manager) {
                log('âš ï¸ Auth Manager ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡', 'warning');
                return false;
            }
            
            try {
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…ØªØ¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
                const requiredMethods = ['login', 'register', 'logout', 'getCurrentUser'];
                let hasAllMethods = true;
                
                for (const method of requiredMethods) {
                    if (typeof auth_manager[method] !== 'function') {
                        log(`âš ï¸ auth_manager.${method} ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡`, 'warning');
                        hasAllMethods = false;
                    }
                }
                
                if (hasAllMethods) {
                    log('âœ… Auth Manager Ù…ØªØ¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø¯Ø§Ø±Ø¯', 'success');
                    
                    // ØªØ³Øª Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ EventBus (Ø§Ú¯Ø± login Ø±ÙˆÛŒØ¯Ø§Ø¯ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯)
                    let authEventReceived = false;
                    eventBus.on('auth:state:changed', () => {
                        authEventReceived = true;
                    });
                    
                    // ØªØ³Øª getCurrentUser (Ø¨Ø¯ÙˆÙ† Ø¹Ù…Ù„ÛŒØ§Øª ÙˆØ§Ù‚Ø¹ÛŒ)
                    try {
                        const user = auth_manager.getCurrentUser();
                        log(`âœ… getCurrentUser Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯: ${user ? 'Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ¬ÙˆØ¯' : 'Ø¨Ø¯ÙˆÙ† Ú©Ø§Ø±Ø¨Ø±'}`, 'success');
                    } catch (e) {
                        log(`âš ï¸ getCurrentUser: ${e.message}`, 'warning');
                    }
                    
                    state.testResults.passed++;
                    return true;
                } else {
                    log('âš ï¸ Auth Manager Ø¨Ø±Ø®ÛŒ Ù…ØªØ¯Ù‡Ø§ Ø±Ø§ Ù†Ø¯Ø§Ø±Ø¯', 'warning');
                    return false;
                }
            } catch (error) {
                log(`âš ï¸ Ø®Ø·Ø§ÛŒ Auth System: ${error.message}`, 'warning');
                return false;
            }
        }

        async function testLanguagePicker() {
            log('Ø¨Ø±Ø±Ø³ÛŒ Language Picker...', 'info');
            
            if (!window.LanguagePickerView) {
                log('âš ï¸ LanguagePickerView ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡', 'warning');
                return false;
            }
            
            try {
                // ØªØ³Øª Ø³Ø§Ø®Øª instance
                const picker = new LanguagePickerView({
                    eventSystem: eventBus,
                    containerId: 'test-container'
                });
                
                log('âœ… LanguagePickerView Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯', 'success');
                
                // ØªØ³Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ language:selected
                let languageEventReceived = false;
                eventBus.on('language:selected', (data) => {
                    languageEventReceived = true;
                    log(`âœ… Ø±ÙˆÛŒØ¯Ø§Ø¯ language:selected Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯: ${data.language}`, 'success');
                });
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø²Ø¨Ø§Ù†
                if (picker.selectLanguage) {
                    picker.selectLanguage('fa', { source: 'test' });
                    await delay(100);
                    
                    if (languageEventReceived) {
                        log('âœ… Ø³ÛŒØ³ØªÙ… Ø±ÙˆÛŒØ¯Ø§Ø¯ LanguagePicker Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯', 'success');
                    }
                }
                
                state.testResults.passed++;
                return true;
            } catch (error) {
                log(`âš ï¸ Ø®Ø·Ø§ÛŒ LanguagePicker: ${error.message}`, 'warning');
                return false;
            }
        }

        // ==================== ØªØ³Øª Ú©Ø§Ù…Ù„ ====================
        async function runFullTest() {
            log('='.repeat(60), 'info');
            log('Ø´Ø±ÙˆØ¹ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ú©Ø§Ù…Ù„ Vakamova...', 'info');
            log('='.repeat(60), 'info');
            
            // Ø±ÛŒØ³Øª ÙˆØ¶Ø¹ÛŒØª
            state.testResults = { passed: 0, failed: 0, total: 0 };
            state.startTime = Date.now();
            document.getElementById('logContent').innerHTML = '';
            
            initializeModuleGrid();
            
            try {
                // Ù…Ø±Ø­Ù„Ù‡ Û±: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡Ù…Ù‡ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§
                state.currentOperation = 'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§';
                await loadAllModules();
                
                // Ù…Ø±Ø­Ù„Ù‡ Û²: ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ
                state.currentOperation = 'ØªØ³Øª EventBus';
                state.testResults.total++;
                await testEventBusIntegration();
                
                state.currentOperation = 'ØªØ³Øª State Manager';
                state.testResults.total++;
                await testStateManagerIntegration();
                
                state.currentOperation = 'ØªØ³Øª Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯';
                state.testResults.total++;
                await testNewModules();
                
                state.currentOperation = 'ØªØ³Øª Auth System';
                state.testResults.total++;
                await testAuthSystem();
                
                state.currentOperation = 'ØªØ³Øª Language Picker';
                state.testResults.total++;
                await testLanguagePicker();
                
                // Ù…Ø±Ø­Ù„Ù‡ Û³: Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ
                const endTime = Date.now();
                const duration = ((endTime - state.startTime) / 1000).toFixed(2);
                
                log('='.repeat(60), 'info');
                log('Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ:', 'info');
                log(`ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚: ${state.testResults.passed}`, 'success');
                log(`ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚: ${state.testResults.failed}`, 
                    state.testResults.failed > 0 ? 'error' : 'success');
                log(`Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§: ${duration} Ø«Ø§Ù†ÛŒÙ‡`, 'info');
                log('='.repeat(60), 'info');
                
                // Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª
                if (state.testResults.failed === 0) {
                    log('ğŸ‰ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯! Ø³ÛŒØ³ØªÙ… ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ø§Ø³Øª.', 'success');
                    log('Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø±ÙˆÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Router Ùˆ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ ØªÙ…Ø±Ú©Ø² Ú©Ù†ÛŒØ¯.', 'info');
                } else if (state.testResults.passed >= 3) {
                    log('âœ… Ø³ÛŒØ³ØªÙ… Ù¾Ø§ÛŒÙ‡ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.', 'warning');
                } else {
                    log('ğŸ”§ Ù…Ø´Ú©Ù„Ø§Øª Ø§Ø³Ø§Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯. Ø§Ø¨ØªØ¯Ø§ EventBus Ùˆ StateManager Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.', 'error');
                }
                
                updateStats();
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø§ÛŒ Ø¬Ø¯ÛŒ Ø¯Ø± ØªØ³Øª: ${error.message}`, 'error');
                log('ØªÙˆÙ‚Ù ØªØ³Øª Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø®Ø·Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ', 'error');
            }
            
            state.currentOperation = 'Ú©Ø§Ù…Ù„ Ø´Ø¯';
            updateStats();
        }

        async function runEssentialTests() {
            log('Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ...', 'info');
            
            // ÙÙ‚Ø· ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
            await testEventBusIntegration();
            await testStateManagerIntegration();
            await testNewModules();
            
            log('ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù†Ø¯', 'info');
        }

        // ==================== Utilities ====================
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function initializeModuleGrid() {
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = '';
            
            MODULES_CONFIG.forEach(module => {
                const card = document.createElement('div');
                card.className = 'file-card pending';
                card.id = `module-${module.name.replace(/\s+/g, '-')}`;
                card.innerHTML = `
                    <div class="file-name">
                        ${module.type === 'core' ? 'ğŸ§ ' : 
                          module.type === 'auth' ? 'ğŸ”' : 
                          module.type === 'page' ? 'ğŸ“„' : 'âš™ï¸'}
                        ${module.name}
                    </div>
                    <div class="file-path">${module.path}</div>
                    <div class="file-status status-pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div>
                    ${module.required ? '<div style="margin-top: 8px; font-size: 0.8rem; color: #f59e0b;">Ø¶Ø±ÙˆØ±ÛŒ</div>' : ''}
                `;
                
                grid.appendChild(card);
            });
        }

        function updateModuleUI(moduleName, status) {
            const element = document.getElementById(`module-${moduleName.replace(/\s+/g, '-')}`);
            if (!element) return;
            
            element.className = `file-card ${status}`;
            const statusEl = element.querySelector('.file-status');
            statusEl.className = 'file-status';
            
            switch (status) {
                case 'loaded':
                    statusEl.classList.add('status-loaded');
                    statusEl.textContent = 'Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯';
                    break;
                case 'error':
                    statusEl.classList.add('status-error');
                    statusEl.textContent = 'Ø®Ø·Ø§';
                    break;
                case 'pending':
                    statusEl.classList.add('status-pending');
                    statusEl.textContent = 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±';
                    break;
            }
        }

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${percent}%`;
        }

        function resetProgress() {
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
        }

        function updateStats() {
            const loaded = Array.from(state.loadedModules.values()).filter(m => m.loaded).length;
            const total = MODULES_CONFIG.length;
            const percent = Math.round((loaded / total) * 100);
            
            document.getElementById('loadedCount').textContent = `${loaded}/${total}`;
            document.getElementById('loadedPercent').textContent = `${percent}%`;
            
            document.getElementById('passedCount').textContent = state.testResults.passed;
            document.getElementById('failedCount').textContent = state.testResults.failed;
            document.getElementById('totalTests').textContent = state.testResults.total;
            
            const failureRate = state.testResults.total > 0 
                ? Math.round((state.testResults.failed / state.testResults.total) * 100)
                : 0;
            document.getElementById('failureRate').textContent = `${failureRate}%`;
            
            if (state.startTime) {
                const duration = ((Date.now() - state.startTime) / 1000).toFixed(1);
                document.getElementById('executionTime').textContent = `${duration}s`;
            }
            
            document.getElementById('timestamp').textContent = 
                new Date().toLocaleTimeString('fa-IR');
        }

        function clearAll() {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ù‡Ù…Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ùˆ Ù†ØªØ§ÛŒØ¬ Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯.')) {
                state.loadedModules.clear();
                state.testResults = { passed: 0, failed: 0, total: 0 };
                state.logs = [];
                state.startTime = null;
                
                document.getElementById('logContent').innerHTML = '';
                initializeModuleGrid();
                resetProgress();
                updateStats();
                
                log('Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯', 'info');
            }
        }

        // ==================== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ====================
        window.addEventListener('DOMContentLoaded', () => {
            initializeModuleGrid();
            updateStats();
            
            // Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù…ÛŒØ§Ù†Ø¨Ø±
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    runFullTest();
                }
                if (e.ctrlKey && e.key === 'Escape') {
                    clearAll();
                }
            });
            
            log('ØªØ³ØªØ± ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Vakamova Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.', 'info');
            log('Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø±ÙˆÛŒ "Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Ú©Ø§Ù…Ù„" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ÛŒØ§ Ctrl+Enter Ø¨Ø²Ù†ÛŒØ¯.', 'info');
        });

        // Global access for debugging
        window.VakamovaIntegrationTester = {
            runFullTest,
            loadAllModules,
            runEssentialTests,
            clearAll,
            getState: () => ({ ...state }),
            getModules: () => MODULES_CONFIG,
            log
        };
    </script>
</body>
</html>
