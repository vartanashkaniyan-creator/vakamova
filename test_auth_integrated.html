<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªØ³Øª Auth Manager</title>
    <style>
        body { font-family: Tahoma; margin: 20px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .auth-status { padding: 15px; margin: 10px 0; border: 2px solid #ccc; }
        .authenticated { border-color: green; background: #e8f5e9; }
        .not-authenticated { border-color: red; background: #ffebee; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª Auth Manager</h1>
    
    <div id="authStatus" class="auth-status not-authenticated">
        ÙˆØ¶Ø¹ÛŒØª: Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...
    </div>
    
    <div>
        <button onclick="testLogin()">ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±</button>
        <button onclick="testLogout()">Ø®Ø±ÙˆØ¬ Ú©Ø§Ø±Ø¨Ø±</button>
        <button onclick="testRegister()">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</button>
        <button onclick="testPermissions()">Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§</button>
    </div>
    
    <div id="output" style="margin-top: 20px; padding: 15px; background: #f5f5f5;"></div>

    <script>
        // Ø§Ø¨ØªØ¯Ø§ StateManager Ùˆ SessionManager Ø³Ø§Ø¯Ù‡ Ø±Ø§ ØªØ¹Ø±ÛŒÙ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        class SimpleStateManager {
            constructor() {
                this.state = {};
                this.history = [];
            }
            
            setState(updates) {
                this.state = { ...this.state, ...updates };
                return true;
            }
            
            getState(path) {
                if (!path) return this.state;
                return this.state.auth || null;
            }
        }
        
        class SimpleSessionManager {
            constructor() {
                this.session = null;
            }
            
            startSession(user) {
                this.session = {
                    user,
                    startedAt: new Date(),
                    token: 'simulated_token_' + Date.now()
                };
                sessionStorage.setItem('vakamova_session', JSON.stringify(this.session));
                return true;
            }
            
            endSession() {
                this.session = null;
                sessionStorage.removeItem('vakamova_session');
                return true;
            }
            
            getSession() {
                return this.session;
            }
        }
        
        // Ø­Ø§Ù„Ø§ AuthManager Ø±Ø§ ØªØ¹Ø±ÛŒÙ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        class AuthManager {
            constructor(stateManager, sessionManager) {
                this.stateManager = stateManager;
                this.sessionManager = sessionManager;
                this.eventBus = {
                    events: {},
                    publish: function(event, data) {
                        console.log(`[EventBus] ${event}:`, data);
                        if (this.events[event]) {
                            this.events[event].forEach(handler => handler(data));
                        }
                    },
                    subscribe: function(event, handler) {
                        if (!this.events[event]) this.events[event] = [];
                        this.events[event].push(handler);
                    }
                };
                
                // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ state
                this.stateManager.setState({
                    auth: {
                        user: null,
                        isAuthenticated: false,
                        permissions: []
                    }
                });
                
                // Ø«Ø¨Øª event listeners
                this.eventBus.subscribe('auth:loggedIn', (user) => {
                    this._updateUI();
                });
                
                this.eventBus.subscribe('auth:loggedOut', (user) => {
                    this._updateUI();
                });
                
                this.eventBus.subscribe('auth:registered', (user) => {
                    this._updateUI();
                });
            }
            
            async login(credentials) {
                console.log('ğŸ”‘ Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯ Ø¨Ø§:', credentials);
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚
                const user = {
                    id: 1,
                    email: credentials.email,
                    name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª',
                    permissions: ['user', 'premium', 'lesson_access'],
                    subscription: 'premium'
                };
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ state
                this.stateManager.setState({
                    auth: {
                        user,
                        isAuthenticated: true,
                        permissions: user.permissions
                    }
                });
                
                // Ø´Ø±ÙˆØ¹ session
                this.sessionManager.startSession(user);
                
                // Ø§Ù†ØªØ´Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯
                this.eventBus.publish('auth:loggedIn', user);
                
                return user;
            }
            
            async logout() {
                console.log('ğŸšª Ø¯Ø± Ø­Ø§Ù„ Ø®Ø±ÙˆØ¬...');
                const user = this.getCurrentUser();
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ state
                this.stateManager.setState({
                    auth: {
                        user: null,
                        isAuthenticated: false,
                        permissions: []
                    }
                });
                
                // Ù¾Ø§ÛŒØ§Ù† session
                this.sessionManager.endSession();
                
                // Ø§Ù†ØªØ´Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯
                this.eventBus.publish('auth:loggedOut', user);
                
                return true;
            }
            
            async register(userData) {
                console.log('ğŸ“ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…:', userData);
                
                const newUser = {
                    id: Date.now(),
                    email: userData.email,
                    name: userData.name,
                    permissions: ['user'],
                    subscription: 'free'
                };
                
                this.stateManager.setState({
                    auth: {
                        user: newUser,
                        isAuthenticated: true,
                        permissions: newUser.permissions
                    }
                });
                
                this.sessionManager.startSession(newUser);
                this.eventBus.publish('auth:registered', newUser);
                
                return newUser;
            }
            
            getCurrentUser() {
                return this.stateManager.getState('auth')?.user;
            }
            
            isAuthenticated() {
                return this.stateManager.getState('auth')?.isAuthenticated || false;
            }
            
            hasPermission(permission) {
                const permissions = this.stateManager.getState('auth')?.permissions || [];
                return permissions.includes(permission);
            }
            
            _updateUI() {
                const authStatus = document.getElementById('authStatus');
                const output = document.getElementById('output');
                const user = this.getCurrentUser();
                const isAuth = this.isAuthenticated();
                
                if (isAuth && user) {
                    authStatus.className = 'auth-status authenticated';
                    authStatus.innerHTML = `
                        <h3>âœ… Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø§Ø³Øª</h3>
                        <p><strong>Ù†Ø§Ù…:</strong> ${user.name}</p>
                        <p><strong>Ø§ÛŒÙ…ÛŒÙ„:</strong> ${user.email}</p>
                        <p><strong>Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§:</strong> ${user.permissions.join(', ')}</p>
                        <p><strong>Ø§Ø´ØªØ±Ø§Ú©:</strong> ${user.subscription}</p>
                        <p><small>Ø´Ù†Ø§Ø³Ù‡: ${user.id}</small></p>
                    `;
                } else {
                    authStatus.className = 'auth-status not-authenticated';
                    authStatus.innerHTML = `
                        <h3>âŒ Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</h3>
                        <p>Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ ÛŒØ§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯</p>
                    `;
                }
            }
        }
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§
        const stateManager = new SimpleStateManager();
        const sessionManager = new SimpleSessionManager();
        const authManager = new AuthManager(stateManager, sessionManager);
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± window Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
        window.authManager = authManager;
        
        // ØªÙˆØ§Ø¨Ø¹ ØªØ³Øª
        window.testLogin = async function() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>ğŸ”‘ Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯...</p>';
            
            try {
                const credentials = {
                    email: 'user@vakamova.com',
                    password: 'test123'
                };
                
                const user = await authManager.login(credentials);
                
                output.innerHTML = `
                    <div style="background: #d4edda; padding: 10px; margin: 5px 0;">
                        âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚<br>
                        <strong>Ú©Ø§Ø±Ø¨Ø±:</strong> ${user.name}<br>
                        <strong>Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§:</strong> ${user.permissions.length} Ø¯Ø³ØªØ±Ø³ÛŒ
                    </div>
                    ${output.innerHTML}
                `;
                
                console.log('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚:', user);
            } catch (error) {
                output.innerHTML = `
                    <div style="background: #f8d7da; padding: 10px; margin: 5px 0;">
                        âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ${error.message}
                    </div>
                    ${output.innerHTML}
                `;
            }
        };
        
        window.testLogout = async function() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>ğŸšª Ø¯Ø± Ø­Ø§Ù„ Ø®Ø±ÙˆØ¬...</p>';
            
            try {
                await authManager.logout();
                
                output.innerHTML = `
                    <div style="background: #fff3cd; padding: 10px; margin: 5px 0;">
                        ğŸ” Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚<br>
                        Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø®Ø§Ø±Ø¬ Ø´Ø¯
                    </div>
                    ${output.innerHTML}
                `;
                
                console.log('Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚');
            } catch (error) {
                output.innerHTML = `
                    <div style="background: #f8d7da; padding: 10px; margin: 5px 0;">
                        âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬: ${error.message}
                    </div>
                    ${output.innerHTML}
                `;
            }
        };
        
        window.testRegister = async function() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>ğŸ“ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...</p>';
            
            try {
                const userData = {
                    name: 'Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯',
                    email: 'newuser@vakamova.com',
                    password: 'newpass123'
                };
                
                const user = await authManager.register(userData);
                
                output.innerHTML = `
                    <div style="background: #cce5ff; padding: 10px; margin: 5px 0;">
                        ğŸ‰ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚<br>
                        <strong>Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯:</strong> ${user.name}<br>
                        <strong>Ø§ÛŒÙ…ÛŒÙ„:</strong> ${user.email}<br>
                        <strong>Ø´Ù†Ø§Ø³Ù‡:</strong> ${user.id}
                    </div>
                    ${output.innerHTML}
                `;
                
                console.log('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚:', user);
            } catch (error) {
                output.innerHTML = `
                    <div style="background: #f8d7da; padding: 10px; margin: 5px 0;">
                        âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: ${error.message}
                    </div>
                    ${output.innerHTML}
                `;
            }
        };
        
        window.testPermissions = async function() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§...</p>';
            
            try {
                const permissions = ['user', 'premium', 'lesson_access', 'admin'];
                const results = [];
                
                for (const perm of permissions) {
                    const hasPerm = await authManager.hasPermission(perm);
                    results.push({ permission: perm, granted: hasPerm });
                }
                
                let resultHTML = '<div style="background: #e2e3e5; padding: 10px; margin: 5px 0;">';
                resultHTML += '<strong>Ù†ØªÛŒØ¬Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§:</strong><br>';
                
                results.forEach(result => {
                    resultHTML += `${result.granted ? 'âœ…' : 'âŒ'} ${result.permission}<br>`;
                });
                
                resultHTML += '</div>';
                output.innerHTML = resultHTML + output.innerHTML;
                
            } catch (error) {
                output.innerHTML = `
                    <div style="background: #f8d7da; padding: 10px; margin: 5px 0;">
                        âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§: ${error.message}
                    </div>
                    ${output.innerHTML}
                `;
            }
        };
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ UI
        setTimeout(() => {
            authManager._updateUI();
            console.log('âœ… Auth Manager ØªØ³Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
        }, 100);
    </script>
</body>
</html>
