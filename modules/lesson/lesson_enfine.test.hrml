<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>ØªØ³Øª Lesson Engine - Vakamova</title>
    <style>
        body { font-family: Tahoma; direction: rtl; padding: 20px; background: #f5f5f5; }
        .test { background: white; margin: 10px 0; padding: 15px; border-radius: 8px; border-right: 5px solid #4CAF50; }
        .pass { border-right-color: #4CAF50; }
        .fail { border-right-color: #f44336; }
        button { padding: 10px 20px; margin: 5px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        pre { background: #333; color: #fff; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª Lesson Engine</h1>
    
    <div id="test1" class="test">
        <h3>âœ… ØªØ³Øª Û±: Ø³Ø§Ø®Øª Ù…ÙˆØªÙˆØ± Ø¨Ø§ ØªØ²Ø±ÛŒÙ‚ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ</h3>
        <button onclick="runTest1()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        <div id="result1"></div>
    </div>

    <div id="test2" class="test">
        <h3>âœ… ØªØ³Øª Û²: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÙˆØ±Ù‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ</h3>
        <button onclick="runTest2()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        <div id="result2"></div>
    </div>

    <div id="test3" class="test">
        <h3>âœ… ØªØ³Øª Û³: Ø´Ø±ÙˆØ¹ Ø¬Ù„Ø³Ù‡ Ø¯Ø±Ø³</h3>
        <button onclick="runTest3()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        <div id="result3"></div>
    </div>

    <div id="test4" class="test">
        <h3>âœ… ØªØ³Øª Û´: Ø§Ø±Ø³Ø§Ù„ ØªÙ…Ø±ÛŒÙ† Ùˆ Ø¯Ø±ÛŒØ§ÙØª Ù†ØªÛŒØ¬Ù‡</h3>
        <button onclick="runTest4()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        <div id="result4"></div>
    </div>

    <div id="test5" class="test">
        <h3>âœ… ØªØ³Øª Ûµ: Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±</h3>
        <button onclick="runTest5()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        <div id="result5"></div>
    </div>

    <div id="test6" class="test">
        <h3>âœ… ØªØ³Øª Û¶: Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†ØªØ´Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</h3>
        <button onclick="runTest6()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        <div id="result6"></div>
    </div>

    <div id="test7" class="test">
        <h3>âœ… ØªØ³Øª Û·: Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§Ù‡Ø§</h3>
        <button onclick="runTest7()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        <div id="result7"></div>
    </div>

    <div id="summary" style="margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px;">
        <h2>ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬</h2>
        <div id="summaryResults"></div>
    </div>

    <script type="module">
        // Mock ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
        class MockDatabase {
            constructor() {
                this.data = {
                    courses: [
                        {
                            id: 'english_beginners',
                            language: 'en',
                            title: 'Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ù…Ù‚Ø¯Ù…Ø§ØªÛŒ',
                            description: 'Ø¯ÙˆØ±Ù‡ Ù…Ø¨ØªØ¯ÛŒ Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ',
                            lessons: [
                                { id: 'lesson_1', title: 'Ø§Ù„ÙØ¨Ø§ÛŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ', order: 1, difficulty: 'beginner', duration: 30 }
                            ],
                            exercises: [
                                { id: 'ex_1', lessonId: 'lesson_1', correctAnswers: ['A', 'B', 'C'], points: 10 }
                            ],
                            estimatedHours: 20
                        }
                    ],
                    lessons: [
                        {
                            id: 'lesson_1',
                            title: 'Ø§Ù„ÙØ¨Ø§ÛŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ',
                            order: 1,
                            difficulty: 'beginner',
                            duration: 30,
                            exercises: [
                                { id: 'ex_1', correctAnswers: ['A', 'B', 'C'], points: 10 }
                            ]
                        }
                    ],
                    exercises: [
                        { id: 'ex_1', correctAnswers: ['A', 'B', 'C'], points: 10 }
                    ]
                };
            }

            query(table) {
                return {
                    where: (field, operator, value) => {
                        return this;
                    },
                    andWhere: (field, operator, value) => this,
                    with: (relation) => this,
                    first: () => this.data[table]?.[0] || null
                };
            }
        }

        class MockEventBus {
            constructor() {
                this.events = [];
            }
            publish(event, data) {
                this.events.push({ event, data });
                console.log(`ğŸ“¢ Ø±ÙˆÛŒØ¯Ø§Ø¯: ${event}`, data);
            }
        }

        class MockProgressTracker {
            constructor() {
                this.sessions = [];
                this.progress = [];
            }
            startSession(sessionId, userId, lessonId) {
                this.sessions.push({ sessionId, userId, lessonId });
                return Promise.resolve();
            }
            recordExerciseResult(data) {
                return Promise.resolve();
            }
            completeLesson(userId, lessonId, score, startTime, endTime) {
                return Promise.resolve();
            }
            getUserProgress(userId, courseId) {
                return Promise.resolve({
                    completedLessons: 1,
                    overallScore: 85,
                    timeSpent: 3600,
                    lastActive: new Date()
                });
            }
        }

        // Ø§ÛŒÙ…Ù¾ÙˆØ±Øª LessonEngine (Ø¯Ø± Ù…Ø­ÛŒØ· ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø² import Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
        // Ø¯Ø± Ø§ÛŒÙ† ØªØ³Øª Ø§Ø² Ú©Ø¯ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        const { LessonEngine } = await import('/modules/lesson-engine/lesson-engine.js');

        let lessonEngine;
        const testResults = {};

        async function initializeEngine() {
            const mockDB = new MockDatabase();
            const mockEventBus = new MockEventBus();
            const mockProgressTracker = new MockProgressTracker();

            lessonEngine = new LessonEngine({
                database: mockDB,
                eventBus: mockEventBus,
                progressTracker: mockProgressTracker
            });

            return { mockDB, mockEventBus, mockProgressTracker };
        }

        // ØªØ³Øªâ€ŒÙ‡Ø§
        async function runTest1() {
            const resultEl = document.getElementById('result1');
            try {
                await initializeEngine();
                resultEl.innerHTML = `<div class="pass">âœ… Ù…ÙˆÙÙ‚: Ù…ÙˆØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯</div>`;
                testResults.test1 = 'pass';
            } catch (error) {
                resultEl.innerHTML = `<div class="fail">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
                testResults.test1 = 'fail';
            }
            updateSummary();
        }

        async function runTest2() {
            const resultEl = document.getElementById('result2');
            try {
                await initializeEngine();
                const course = await lessonEngine.loadCourse('english_beginners', 'en');
                
                if (course && course.id === 'english_beginners') {
                    resultEl.innerHTML = `
                        <div class="pass">âœ… Ù…ÙˆÙÙ‚: Ø¯ÙˆØ±Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯</div>
                        <pre>${JSON.stringify(course, null, 2)}</pre>
                    `;
                    testResults.test2 = 'pass';
                } else {
                    throw new Error('Ø¯ÙˆØ±Ù‡ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯');
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="fail">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
                testResults.test2 = 'fail';
            }
            updateSummary();
        }

        async function runTest3() {
            const resultEl = document.getElementById('result3');
            try {
                await initializeEngine();
                const session = await lessonEngine.startLesson('lesson_1', 'user_123');
                
                if (session && session.id && session.userId === 'user_123') {
                    resultEl.innerHTML = `
                        <div class="pass">âœ… Ù…ÙˆÙÙ‚: Ø¬Ù„Ø³Ù‡ Ø¯Ø±Ø³ Ø´Ø±ÙˆØ¹ Ø´Ø¯</div>
                        <pre>${JSON.stringify(session, null, 2)}</pre>
                    `;
                    testResults.test3 = 'pass';
                } else {
                    throw new Error('Ø¬Ù„Ø³Ù‡ Ø¯Ø±Ø³ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯');
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="fail">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
                testResults.test3 = 'fail';
            }
            updateSummary();
        }

        async function runTest4() {
            const resultEl = document.getElementById('result4');
            try {
                await initializeEngine();
                const session = await lessonEngine.startLesson('lesson_1', 'user_123');
                
                const submission = {
                    sessionId: session.id,
                    exerciseId: 'ex_1',
                    answers: ['A', 'B', 'C'],
                    timeSpent: 30
                };
                
                const result = await lessonEngine.submitExercise(submission);
                
                if (result.isCorrect === true && result.score > 0) {
                    resultEl.innerHTML = `
                        <div class="pass">âœ… Ù…ÙˆÙÙ‚: ØªÙ…Ø±ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ùˆ Ù†ØªÛŒØ¬Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯</div>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                    testResults.test4 = 'pass';
                } else {
                    throw new Error('Ù†ØªØ§ÛŒØ¬ ØªÙ…Ø±ÛŒÙ† ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª');
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="fail">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
                testResults.test4 = 'fail';
            }
            updateSummary();
        }

        async function runTest5() {
            const resultEl = document.getElementById('result5');
            try {
                await initializeEngine();
                const progress = await lessonEngine.getProgress('user_123', 'english_beginners');
                
                if (progress && typeof progress.completionPercentage === 'number') {
                    resultEl.innerHTML = `
                        <div class="pass">âœ… Ù…ÙˆÙÙ‚: Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯</div>
                        <pre>${JSON.stringify(progress, null, 2)}</pre>
                    `;
                    testResults.test5 = 'pass';
                } else {
                    throw new Error('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØª ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª');
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="fail">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
                testResults.test5 = 'fail';
            }
            updateSummary();
        }

        async function runTest6() {
            const resultEl = document.getElementById('result6');
            try {
                const { mockEventBus } = await initializeEngine();
                await lessonEngine.startLesson('lesson_1', 'user_123');
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
                const hasLessonStartedEvent = mockEventBus.events.some(e => e.event === 'lesson.started');
                
                if (hasLessonStartedEvent) {
                    resultEl.innerHTML = `
                        <div class="pass">âœ… Ù…ÙˆÙÙ‚: Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù†Ø¯</div>
                        <pre>Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù‡: ${mockEventBus.events.length}</pre>
                        <pre>${JSON.stringify(mockEventBus.events, null, 2)}</pre>
                    `;
                    testResults.test6 = 'pass';
                } else {
                    throw new Error('Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ù…Ù†ØªØ´Ø± Ù†Ø´Ø¯Ù†Ø¯');
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="fail">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
                testResults.test6 = 'fail';
            }
            updateSummary();
        }

        async function runTest7() {
            const resultEl = document.getElementById('result7');
            try {
                await initializeEngine();
                
                // ØªØ³Øª Ø®Ø·Ø§ÛŒ Ø¯Ø±Ø³ Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯
                try {
                    await lessonEngine.startLesson('invalid_lesson', 'user_123');
                    resultEl.innerHTML = `<div class="fail">âŒ Ø®Ø·Ø§: Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ù…ÛŒâ€ŒØ¯Ø§Ø¯ Ø§Ù…Ø§ Ù†Ø¯Ø§Ø¯</div>`;
                    testResults.test7 = 'fail';
                } catch (error) {
                    if (error.message.includes('not found')) {
                        resultEl.innerHTML = `<div class="pass">âœ… Ù…ÙˆÙÙ‚: Ø®Ø·Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¯: ${error.message}</div>`;
                        testResults.test7 = 'pass';
                    } else {
                        throw error;
                    }
                }
            } catch (error) {
                resultEl.innerHTML = `<div class="fail">âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª: ${error.message}</div>`;
                testResults.test7 = 'fail';
            }
            updateSummary();
        }

        function updateSummary() {
            const summaryEl = document.getElementById('summaryResults');
            const totalTests = 7;
            const passed = Object.values(testResults).filter(r => r === 'pass').length;
            const failed = totalTests - passed;
            
            summaryEl.innerHTML = `
                <p>ğŸ“ˆ ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øªâ€ŒÙ‡Ø§: ${totalTests}</p>
                <p>âœ… Ù…ÙˆÙÙ‚: ${passed}</p>
                <p>âŒ Ù†Ø§Ù…ÙˆÙÙ‚: ${failed}</p>
                <p>ğŸ¯ Ø¯Ø±ØµØ¯ Ù…ÙˆÙÙ‚ÛŒØª: ${Math.round((passed / totalTests) * 100)}%</p>
            `;
        }
    </script>
</body>
</html>
