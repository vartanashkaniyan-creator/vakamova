<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ Payment + State</title>
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ø´Ø§Ø¨Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card { background: white; padding: 20px; margin: 10px; border-radius: 10px; }
        .success { border-right: 5px solid #10b981; }
        .failed { border-right: 5px solid #ef4444; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ Payment + State Management</h1>
    <div id="test-results"></div>

    <script type="module">
        import { PaymentManager } from './core/payment-manager.js';
        import { StateManager } from './core/state-manager.js';
        import { MockPaymentAdapter } from './core/zarinpal-adapter.js';

        const tests = [
            {
                name: "Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ + Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ State",
                run: async () => {
                    const stateManager = new StateManager();
                    const paymentAdapter = new MockPaymentAdapter();
                    const paymentManager = new PaymentManager(paymentAdapter, stateManager);
                    
                    // 1. Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª
                    const result = await paymentManager.initiatePayment({
                        userId: "user_123",
                        amount: 49000,
                        productId: "premium_monthly"
                    });
                    
                    // 2. Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ State
                    const state = stateManager.getState();
                    if (!state.payments[result.transactionId]) {
                        throw new Error("State Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø´Ø¯");
                    }
                    
                    return "âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ùˆ State Ù‡Ù…Ø§Ù‡Ù†Ú¯ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù†Ø¯";
                }
            },
            {
                name: "Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚ + Ø­ÙØ¸ State Ù‚Ø¨Ù„ÛŒ",
                run: async () => {
                    const stateManager = new StateManager();
                    const failingAdapter = {
                        async processPayment() {
                            throw new Error("Ú©Ù…Ø¨ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ÛŒ");
                        }
                    };
                    const paymentManager = new PaymentManager(failingAdapter, stateManager);
                    
                    const initialState = stateManager.getState();
                    
                    try {
                        await paymentManager.initiatePayment({
                            userId: "user_456",
                            amount: 99000,
                            productId: "yearly_subscription"
                        });
                    } catch (error) {
                        // Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø§Ø±ÛŒÙ… Ø®Ø·Ø§ Ø¯Ù‡Ø¯
                    }
                    
                    // State Ù†Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯
                    const finalState = stateManager.getState();
                    if (JSON.stringify(initialState) !== JSON.stringify(finalState)) {
                        throw new Error("State Ù¾Ø³ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯");
                    }
                    
                    return "âœ… State Ù¾Ø³ Ø§Ø² Ø®Ø·Ø§ Ø­ÙØ¸ Ø´Ø¯";
                }
            },
            {
                name: "Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ + Rollback State",
                run: async () => {
                    const stateManager = new StateManager();
                    const adapter = new MockPaymentAdapter();
                    const paymentManager = new PaymentManager(adapter, stateManager);
                    
                    // Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ÙˆÙ„ÛŒÙ‡
                    const payment = await paymentManager.initiatePayment({
                        userId: "user_789",
                        amount: 25000,
                        productId: "course_access"
                    });
                    
                    const stateAfterPayment = stateManager.getState();
                    
                    // Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡
                    await paymentManager.refundPayment(payment.transactionId);
                    
                    const stateAfterRefund = stateManager.getState();
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Rollback State
                    if (stateAfterRefund.userBalance === stateAfterPayment.userBalance) {
                        throw new Error("Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø´Ø¯");
                    }
                    
                    return "âœ… Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ùˆ Rollback State Ù…ÙˆÙÙ‚";
                }
            },
            {
                name: "Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ State Ú†Ù†Ø¯ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øª",
                run: async () => {
                    const stateManager = new StateManager();
                    const adapter = new MockPaymentAdapter();
                    const paymentManager = new PaymentManager(adapter, stateManager);
                    
                    // 3 Ù¾Ø±Ø¯Ø§Ø®Øª Ù‡Ù…Ø²Ù…Ø§Ù†
                    const payments = await Promise.all([
                        paymentManager.initiatePayment({ userId: "user_1", amount: 10000, productId: "item_1" }),
                        paymentManager.initiatePayment({ userId: "user_1", amount: 20000, productId: "item_2" }),
                        paymentManager.initiatePayment({ userId: "user_1", amount: 15000, productId: "item_3" })
                    ]);
                    
                    const state = stateManager.getState();
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ØµØ­Øª State Ù†Ù‡Ø§ÛŒÛŒ
                    const totalInState = Object.values(state.payments)
                        .reduce((sum, p) => sum + p.amount, 0);
                    
                    const expectedTotal = 10000 + 20000 + 15000;
                    
                    if (totalInState !== expectedTotal) {
                        throw new Error(`Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨Ø§Ù„Øº Ø¯Ø± State Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª: ${totalInState} â‰  ${expectedTotal}`);
                    }
                    
                    return "âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ State Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ§Ø²ÛŒ Ù…ÙˆÙÙ‚";
                }
            }
        ];

        // Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§
        async function runTests() {
            const resultsDiv = document.getElementById('test-results');
            let passed = 0;
            
            for (const test of tests) {
                const card = document.createElement('div');
                card.className = 'test-card';
                card.innerHTML = `<h3>${test.name}</h3><p>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...</p>`;
                resultsDiv.appendChild(card);
                
                try {
                    const result = await test.run();
                    card.classList.add('success');
                    card.innerHTML = `<h3>${test.name}</h3><p>${result}</p>`;
                    passed++;
                } catch (error) {
                    card.classList.add('failed');
                    card.innerHTML = `<h3>${test.name}</h3><p>âŒ ${error.message}</p>`;
                }
            }
            
            // Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬
            const summary = document.createElement('div');
            summary.className = 'test-card';
            summary.innerHTML = `
                <h2>ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬</h2>
                <p>ØªØ¹Ø¯Ø§Ø¯ ØªØ³Øªâ€ŒÙ‡Ø§: ${tests.length}</p>
                <p>Ù…ÙˆÙÙ‚: ${passed}</p>
                <p>Ù†Ø§Ù…ÙˆÙÙ‚: ${tests.length - passed}</p>
                <p>Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª: ${Math.round((passed / tests.length) * 100)}%</p>
            `;
            resultsDiv.appendChild(summary);
        }

        // Ø§Ø¬Ø±Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>
