<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ Payment + State Management</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .badge {
            background: #10b981;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 30px;
        }
        
        .test-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .test-card:hover {
            transform: translateY(-5px);
            border-color: #4f46e5;
            box-shadow: 0 15px 40px rgba(79, 70, 229, 0.15);
        }
        
        .test-card.passed {
            border-left: 5px solid #10b981;
        }
        
        .test-card.failed {
            border-left: 5px solid #ef4444;
        }
        
        .test-card.pending {
            border-left: 5px solid #f59e0b;
        }
        
        .test-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-result {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .passed .test-result {
            background: #d1fae5;
            color: #065f46;
        }
        
        .failed .test-result {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .pending .test-result {
            background: #fef3c7;
            color: #92400e;
        }
        
        .test-desc {
            color: #6b7280;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        
        .test-output {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            direction: ltr;
        }
        
        .test-output.success {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
        
        .test-output.error {
            background: #fef2f2;
            border-color: #fecaca;
        }
        
        .test-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: #f8fafc;
            border-top: 2px solid #e2e8f0;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            min-width: 120px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .passed .stat-value { color: #10b981; }
        .failed .stat-value { color: #ef4444; }
        .pending .stat-value { color: #f59e0b; }
        
        button {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .action-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 30px;
            border-top: 2px solid #e2e8f0;
        }
        
        @media (max-width: 768px) {
            .test-grid {
                grid-template-columns: 1fr;
                padding: 20px;
            }
            
            header h1 {
                font-size: 1.8rem;
                flex-direction: column;
                gap: 10px;
            }
            
            .test-stats {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-top-color: #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #console-log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            margin: 0 30px 30px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 150px;
            overflow-y: auto;
            direction: ltr;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <span>ğŸ§ª ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ Payment + State</span>
                <span class="badge">Vakamova</span>
            </h1>
            <p>Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø§Ù…Ù„ Ù…Ø§Ú˜ÙˆÙ„ Ù¾Ø±Ø¯Ø§Ø®Øª Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª</p>
        </header>
        
        <div class="test-stats">
            <div class="stat passed">
                <span class="stat-value" id="passed-count">0</span>
                <span class="stat-label">Ù…ÙˆÙÙ‚</span>
            </div>
            <div class="stat failed">
                <span class="stat-value" id="failed-count">0</span>
                <span class="stat-label">Ù†Ø§Ù…ÙˆÙÙ‚</span>
            </div>
            <div class="stat pending">
                <span class="stat-value" id="pending-count">4</span>
                <span class="stat-label">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="coverage">0%</span>
                <span class="stat-label">Ù¾ÙˆØ´Ø´ ØªØ³Øª</span>
            </div>
        </div>
        
        <div class="test-grid" id="test-grid">
            <!-- ØªØ³Øªâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
        
        <div id="console-log">
            <div>> Ú©Ù†Ø³ÙˆÙ„ ØªØ³Øª:</div>
            <div id="console-output"></div>
        </div>
        
        <div class="action-bar">
            <button id="run-all-btn">
                <span>â–¶ï¸</span>
                Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§
            </button>
            <button id="clear-btn" style="background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);">
                <span>ğŸ”„</span>
                Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬
            </button>
        </div>
    </div>

    <script>
        // ========== Ø³ÛŒØ³ØªÙ… Ù„Ø§Ú¯ ==========
        const logger = {
            log: (message, data = {}) => {
                const time = new Date().toLocaleTimeString('fa-IR');
                const output = document.getElementById('console-output');
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<span style="color: #94a3b8">[${time}]</span> ${message}`;
                output.appendChild(logEntry);
                output.scrollTop = output.scrollHeight;
                console.log(message, data);
            },
            error: (message, error) => {
                logger.log(`<span style="color: #ef4444">âŒ ${message}: ${error}</span>`);
            },
            success: (message) => {
                logger.log(`<span style="color: #10b981">âœ… ${message}</span>`);
            }
        };

        // ========== Mock EventBus ==========
        class MockEventBus {
            constructor() {
                this.events = new Map();
            }
            
            emit(event, data) {
                logger.log(`ğŸ“¡ Event: ${event}`, data);
            }
        }

        // ========== Mock Payment Adapter ==========
        class MockPaymentAdapter {
            constructor() {
                this.successRate = 0.9; // 90% Ù…ÙˆÙÙ‚ÛŒØª
            }
            
            async processPayment(request) {
                await new Promise(resolve => setTimeout(resolve, 300));
                
                if (Math.random() > this.successRate) {
                    throw new Error("Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚ - Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª");
                }
                
                return {
                    transactionId: `TXN_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    gatewayReference: `REF_${Math.random().toString(36).substr(2, 12)}`,
                    success: true,
                    amount: request.amount,
                    currency: request.currency || 'IRR'
                };
            }
            
            async verifyPayment(transactionId) {
                await new Promise(resolve => setTimeout(resolve, 200));
                return {
                    success: true,
                    transactionId,
                    verificationCode: `VER_${Math.random().toString(36).substr(2, 8)}`
                };
            }
            
            async refundPayment(transactionId) {
                await new Promise(resolve => setTimeout(resolve, 400));
                return {
                    success: true,
                    transactionId,
                    refundId: `REFUND_${Date.now()}`
                };
            }
            
            async isAvailable() {
                return true;
            }
        }

        // ========== State Manager ==========
        class StateManager {
            constructor() {
                this.state = {
                    payments: {},
                    userBalance: 0,
                    transactions: [],
                    subscription: null,
                    lastUpdated: Date.now()
                };
                
                this.listeners = new Set();
            }
            
            getState() {
                return { ...this.state };
            }
            
            updateState(updater) {
                const oldState = this.state;
                const newState = typeof updater === 'function' 
                    ? updater(oldState) 
                    : { ...oldState, ...updater };
                
                this.state = newState;
                this.state.lastUpdated = Date.now();
                
                // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ listeners
                this.listeners.forEach(listener => listener(newState, oldState));
                
                return this.state;
            }
            
            subscribe(listener) {
                this.listeners.add(listener);
                return () => this.listeners.delete(listener);
            }
            
            reset() {
                this.state = {
                    payments: {},
                    userBalance: 0,
                    transactions: [],
                    subscription: null,
                    lastUpdated: Date.now()
                };
            }
        }

        // ========== Payment Manager ==========
        class PaymentManager {
            constructor(paymentAdapter, stateManager, eventBus) {
                this._adapter = paymentAdapter;
                this._state = stateManager;
                this._eventBus = eventBus;
                this._pendingPayments = new Map();
            }
            
            async initiatePayment(request) {
                logger.log(`ğŸ’° Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª: ${request.amount} Ø±ÛŒØ§Ù„`);
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ state Ù‚Ø¨Ù„ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª
                this._state.updateState(state => ({
                    ...state,
                    payments: {
                        ...state.payments,
                        [request.id]: {
                            ...request,
                            status: 'processing',
                            startedAt: Date.now()
                        }
                    }
                }));
                
                try {
                    const result = await this._adapter.processPayment(request);
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ state Ù¾Ø³ Ø§Ø² Ù…ÙˆÙÙ‚ÛŒØª
                    this._state.updateState(state => ({
                        ...state,
                        payments: {
                            ...state.payments,
                            [request.id]: {
                                ...state.payments[request.id],
                                status: 'completed',
                                completedAt: Date.now(),
                                transactionId: result.transactionId
                            }
                        },
                        userBalance: state.userBalance - request.amount,
                        transactions: [
                            ...state.transactions,
                            {
                                type: 'payment',
                                amount: request.amount,
                                transactionId: result.transactionId,
                                timestamp: Date.now(),
                                productId: request.productId
                            }
                        ]
                    }));
                    
                    this._eventBus.emit('payment:completed', {
                        requestId: request.id,
                        transactionId: result.transactionId,
                        amount: request.amount
                    });
                    
                    logger.success(`Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚: ${result.transactionId}`);
                    return { ...result, requestId: request.id };
                    
                } catch (error) {
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ state Ù¾Ø³ Ø§Ø² Ø®Ø·Ø§
                    this._state.updateState(state => ({
                        ...state,
                        payments: {
                            ...state.payments,
                            [request.id]: {
                                ...state.payments[request.id],
                                status: 'failed',
                                failedAt: Date.now(),
                                error: error.message
                            }
                        }
                    }));
                    
                    throw error;
                }
            }
            
            async refundPayment(transactionId) {
                logger.log(`ğŸ’¸ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡: ${transactionId}`);
                
                const result = await this._adapter.refundPayment(transactionId);
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ state Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡
                this._state.updateState(state => {
                    // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ø±Ø¨ÙˆØ·Ù‡
                    const paymentEntry = Object.entries(state.payments)
                        .find(([_, payment]) => payment.transactionId === transactionId);
                    
                    if (!paymentEntry) return state;
                    
                    const [requestId, payment] = paymentEntry;
                    
                    return {
                        ...state,
                        payments: {
                            ...state.payments,
                            [requestId]: {
                                ...payment,
                                status: 'refunded',
                                refundedAt: Date.now(),
                                refundId: result.refundId
                            }
                        },
                        userBalance: state.userBalance + payment.amount,
                        transactions: [
                            ...state.transactions,
                            {
                                type: 'refund',
                                amount: payment.amount,
                                transactionId: result.refundId,
                                originalTransactionId: transactionId,
                                timestamp: Date.now()
                            }
                        ]
                    };
                });
                
                logger.success(`Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ù…ÙˆÙÙ‚: ${result.refundId}`);
                return result;
            }
            
            getPaymentStatus(requestId) {
                const state = this._state.getState();
                return state.payments[requestId] || null;
            }
            
            getUserBalance() {
                return this._state.getState().userBalance;
            }
        }

        // ========== ØªØ¹Ø±ÛŒÙ ØªØ³Øªâ€ŒÙ‡Ø§ ==========
        const tests = [
            {
                id: 'test-1',
                title: 'Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ + Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ State',
                description: 'Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ State',
                run: async () => {
                    const stateManager = new StateManager();
                    const eventBus = new MockEventBus();
                    const adapter = new MockPaymentAdapter();
                    adapter.successRate = 1.0; // ØªØ¶Ù…ÛŒÙ† Ù…ÙˆÙÙ‚ÛŒØª
                    
                    const paymentManager = new PaymentManager(adapter, stateManager, eventBus);
                    
                    const paymentRequest = {
                        id: `PAY_${Date.now()}`,
                        amount: 49000,
                        productId: 'premium_monthly',
                        userId: 'user_123',
                        currency: 'IRR'
                    };
                    
                    const result = await paymentManager.initiatePayment(paymentRequest);
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ State
                    const state = stateManager.getState();
                    const paymentInState = state.payments[paymentRequest.id];
                    
                    if (!paymentInState) throw new Error('Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± State Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯');
                    if (paymentInState.status !== 'completed') throw new Error('ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± State Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª');
                    if (paymentInState.transactionId !== result.transactionId) throw new Error('Ø´Ù†Ø§Ø³Ù‡ ØªØ±Ø§Ú©Ù†Ø´ Ø¯Ø± State Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª');
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±
                    if (state.userBalance !== -49000) throw new Error('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡â€ŒØ¯Ø±Ø³ØªÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø´Ø¯');
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§
                    const transaction = state.transactions.find(t => t.transactionId === result.transactionId);
                    if (!transaction) throw new Error('ØªØ±Ø§Ú©Ù†Ø´ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯');
                    
                    return `âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚. Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±: ${state.userBalance.toLocaleString()} Ø±ÛŒØ§Ù„`;
                }
            },
            {
                id: 'test-2',
                title: 'Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚ + Ø­ÙØ¸ State Ù‚Ø¨Ù„ÛŒ',
                description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø­ÙØ¸ State Ù¾Ø³ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚',
                run: async () => {
                    const stateManager = new StateManager();
                    const eventBus = new MockEventBus();
                    const adapter = new MockPaymentAdapter();
                    adapter.successRate = 0.0; // ØªØ¶Ù…ÛŒÙ† Ø´Ú©Ø³Øª
                    
                    const paymentManager = new PaymentManager(adapter, stateManager, eventBus);
                    
                    const initialState = stateManager.getState();
                    const initialBalance = initialState.userBalance;
                    
                    const paymentRequest = {
                        id: `FAIL_PAY_${Date.now()}`,
                        amount: 99000,
                        productId: 'yearly_subscription',
                        userId: 'user_456'
                    };
                    
                    try {
                        await paymentManager.initiatePayment(paymentRequest);
                        throw new Error('Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ù…ÛŒâ€ŒØ¯Ø§Ø¯ Ø§Ù…Ø§ Ù†Ø¯Ø§Ø¯!');
                    } catch (error) {
                        // Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø§Ø±ÛŒÙ… Ø®Ø·Ø§ Ø¯Ù‡Ø¯
                    }
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ State Ù¾Ø³ Ø§Ø² Ø®Ø·Ø§
                    const finalState = stateManager.getState();
                    const paymentInState = finalState.payments[paymentRequest.id];
                    
                    if (!paymentInState) throw new Error('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¯Ø± State Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯');
                    if (paymentInState.status !== 'failed') throw new Error('ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± State Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª');
                    
                    // Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ù†Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯
                    if (finalState.userBalance !== initialBalance) {
                        throw new Error(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯: ${initialBalance} â†’ ${finalState.userBalance}`);
                    }
                    
                    return `âœ… State Ù¾Ø³ Ø§Ø² Ø®Ø·Ø§ Ø­ÙØ¸ Ø´Ø¯. Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±: ${finalState.userBalance.toLocaleString()} Ø±ÛŒØ§Ù„`;
                }
            },
            {
                id: 'test-3',
                title: 'Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ + Rollback State',
                description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ State Ù‚Ø¨Ù„ÛŒ',
                run: async () => {
                    const stateManager = new StateManager();
                    const eventBus = new MockEventBus();
                    const adapter = new MockPaymentAdapter();
                    adapter.successRate = 1.0;
                    
                    const paymentManager = new PaymentManager(adapter, stateManager, eventBus);
                    
                    // Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ÙˆÙ„ÛŒÙ‡
                    const paymentRequest = {
                        id: `REFUND_PAY_${Date.now()}`,
                        amount: 25000,
                        productId: 'course_access',
                        userId: 'user_789'
                    };
                    
                    const paymentResult = await paymentManager.initiatePayment(paymentRequest);
                    const stateAfterPayment = stateManager.getState();
                    
                    // Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡
                    await paymentManager.refundPayment(paymentResult.transactionId);
                    
                    const stateAfterRefund = stateManager.getState();
                    const paymentInState = stateAfterRefund.payments[paymentRequest.id];
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡
                    if (paymentInState.status !== 'refunded') throw new Error('ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª');
                    
                    // Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ Ø¨Ø±Ú¯Ø±Ø¯Ø¯
                    if (stateAfterRefund.userBalance !== 0) {
                        throw new Error(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª: ${stateAfterRefund.userBalance}`);
                    }
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
                    const refundTransaction = stateAfterRefund.transactions.find(t => t.type === 'refund');
                    if (!refundTransaction) throw new Error('ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯');
                    
                    return `âœ… Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ù…ÙˆÙÙ‚. Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ: ${stateAfterRefund.userBalance.toLocaleString()} Ø±ÛŒØ§Ù„`;
                }
            },
            {
                id: 'test-4',
                title: 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ State Ú†Ù†Ø¯ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øª',
                description: 'Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ State Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†',
                run: async () => {
                    const stateManager = new StateManager();
                    const eventBus = new MockEventBus();
                    const adapter = new MockPaymentAdapter();
                    adapter.successRate = 1.0;
                    
                    const paymentManager = new PaymentManager(adapter, stateManager, eventBus);
                    
                    // 3 Ù¾Ø±Ø¯Ø§Ø®Øª Ù¾Ø´Øª Ø³Ø± Ù‡Ù…
                    const payments = [
                        {
                            id: `PARALLEL_1_${Date.now()}`,
                            amount: 10000,
                            productId: 'item_1',
                            userId: 'user_999'
                        },
                        {
                            id: `PARALLEL_2_${Date.now() + 1}`,
                            amount: 20000,
                            productId: 'item_2',
                            userId: 'user_999'
                        },
                        {
                            id: `PARALLEL_3_${Date.now() + 2}`,
                            amount: 15000,
                            productId: 'item_3',
                            userId: 'user_999'
                        }
                    ];
                    
                    // Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§
                    const results = [];
                    for (const payment of payments) {
                        results.push(await paymentManager.initiatePayment(payment));
                    }
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ State Ù†Ù‡Ø§ÛŒÛŒ
                    const finalState = stateManager.getState();
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¯Ø± State
                    const paymentCount = Object.keys(finalState.payments).length;
                    if (paymentCount !== 3) throw new Error(`ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ Ø¯Ø± State Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª: ${paymentCount}`);
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨Ø§Ù„Øº Ú©Ø³Ø± Ø´Ø¯Ù‡
                    const expectedBalance = -(10000 + 20000 + 15000);
                    if (finalState.userBalance !== expectedBalance) {
                        throw new Error(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª: ${finalState.userBalance} (Ø§Ù†ØªØ¸Ø§Ø±: ${expectedBalance})`);
                    }
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª ØªÙ…Ø§Ù… Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§
                    for (const payment of payments) {
                        if (finalState.payments[payment.id].status !== 'completed') {
                            throw new Error(`Ù¾Ø±Ø¯Ø§Ø®Øª ${payment.id} ØªÚ©Ù…ÛŒÙ„ Ù†Ø´Ø¯Ù‡`);
                        }
                    }
                    
                    return `âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù…ÙˆÙÙ‚. Ù…Ø¬Ù…ÙˆØ¹ Ú©Ø³Ø±ÛŒ: ${Math.abs(finalState.userBalance).toLocaleString()} Ø±ÛŒØ§Ù„`;
                }
            }
        ];

        // ========== Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ØªØ³Øª ==========
        const TestManager = {
            tests: tests,
            results: {},
            
            renderTests() {
                const testGrid = document.getElementById('test-grid');
                testGrid.innerHTML = '';
                
                this.tests.forEach(test => {
                    const card = document.createElement('div');
                    card.className = 'test-card pending';
                    card.id = `card-${test.id}`;
                    card.innerHTML = `
                        <div class="test-title">
                            <span>${test.title}</span>
                            <span class="test-result" id="result-${test.id}">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
                        </div>
                        <div class="test-desc">${test.description}</div>
                        <div class="test-output" id="output-${test.id}"></div>
                    `;
                    testGrid.appendChild(card);
                });
                
                this.updateStats();
            },
            
            async runTest(test) {
                const card = document.getElementById(`card-${test.id}`);
                const output = document.getElementById(`output-${test.id}`);
                const resultSpan = document.getElementById(`result-${test.id}`);
                
                card.className = 'test-card pending';
                resultSpan.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...';
                output.className = 'test-output';
                output.innerHTML = '<div class="loading"></div> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª...';
                
                logger.log(`Ø´Ø±ÙˆØ¹ ØªØ³Øª: ${test.title}`);
                
                try {
                    const result = await test.run();
                    card.className = 'test-card passed';
                    resultSpan.textContent = 'Ù…ÙˆÙÙ‚';
                    output.className = 'test-output success';
                    output.innerHTML = `<strong>âœ… Ù†ØªÛŒØ¬Ù‡:</strong> ${result}`;
                    this.results[test.id] = { success: true, result };
                    logger.success(`ØªØ³Øª "${test.title}" Ù…ÙˆÙÙ‚`);
                    return true;
                } catch (error) {
                    card.className = 'test-card failed';
                    resultSpan.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
                    output.className = 'test-output error';
                    output.innerHTML = `<strong>âŒ Ø®Ø·Ø§:</strong> ${error.message}`;
                    this.results[test.id] = { success: false, error: error.message };
                    logger.error(`ØªØ³Øª "${test.title}" Ù†Ø§Ù…ÙˆÙÙ‚`, error.message);
                    return false;
                } finally {
                    this.updateStats();
                }
            },
            
            async runAllTests() {
                const runBtn = document.getElementById('run-all-btn');
                runBtn.disabled = true;
                runBtn.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§...';
                
                let passed = 0;
                
                logger.log('ğŸš€ Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ Payment + State...');
                
                for (const test of this.tests) {
                    const success = await this.runTest(test);
                    if (success) passed++;
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                runBtn.disabled = false;
                runBtn.innerHTML = '<span>â–¶ï¸</span> Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§';
                
                logger.log(`ğŸ¯ ØªØ³Øªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„ Ø´Ø¯! ${passed} Ø§Ø² ${this.tests.length} ØªØ³Øª Ù…ÙˆÙÙ‚`);
            },
            
            updateStats() {
                const passed = document.querySelectorAll('.test-card.passed').length;
                const failed = document.querySelectorAll('.test-card.failed').length;
                const pending = this.tests.length - passed - failed;
                
                document.getElementById('passed-count').textContent = passed;
                document.getElementById('failed-count').textContent = failed;
                document.getElementById('pending-count').textContent = pending;
                
                const coverage = Math.round((passed / this.tests.length) * 100);
                document.getElementById('coverage').textContent = `${coverage}%`;
            },
            
            clearTests() {
                this.tests.forEach(test => {
                    const card = document.getElementById(`card-${test.id}`);
                    const output = document.getElementById(`output-${test.id}`);
                    const resultSpan = document.getElementById(`result-${test.id}`);
                    
                    card.className = 'test-card pending';
                    resultSpan.textContent = 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±';
                    output.className = 'test-output';
                    output.innerHTML = '';
                });
                
                this.results = {};
                this.updateStats();
                document.getElementById('console-output').innerHTML = '';
                logger.log('ğŸ§¹ Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯');
            }
        };

        // ========== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ==========
        document.addEventListener('DOMContentLoaded', () => {
            TestManager.renderTests();
            
            document.getElementById('run-all-btn').addEventListener('click', () => {
                TestManager.runAllTests();
            });
            
            document.getElementById('clear-btn').addEventListener('click', () => {
                TestManager.clearTests();
            });
            
            logger.log('ğŸš€ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ Payment + State Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ Ù‡Ø³ØªÙ†Ø¯');
        });
    </script>
</body>
</html>
