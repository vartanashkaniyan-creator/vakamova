<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <title>ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ ExerciseManager - Vakamova</title>
    <style>
        body { font-family: Tahoma; max-width: 900px; margin: 20px auto; padding: 20px; }
        .success { color: #27ae60; background: #eafaf1; padding: 12px; margin: 10px 0; border-right: 5px solid #27ae60; border-radius: 4px; }
        .error { color: #c0392b; background: #fdedec; padding: 12px; margin: 10px 0; border-right: 5px solid #c0392b; border-radius: 4px; }
        .section { background: #f8f9fa; padding: 15px; margin: 20px 0; border-radius: 8px; border: 1px solid #ddd; }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 8px; }
        button { background: linear-gradient(to left, #3498db, #2ecc71); color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .data-box { background: white; padding: 15px; margin: 10px 0; border-radius: 6px; border: 1px dashed #ccc; font-family: monospace; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ (Integration Test) - Vakamova</h1>
    <p>Ø§ÛŒÙ† ØªØ³Øª Ø§Ø±ØªØ¨Ø§Ø· ExerciseManager Ø¨Ø§ LessonEngine Ùˆ ProgressTracker Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</p>
    <button onclick="runIntegrationTest()">Ø´Ø±ÙˆØ¹ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡</button>
    <div id="results"></div>

    <script>
        // ğŸ”¹ ==================== MOCK MODELS ====================
        class MockLesson {
            constructor(id, title) {
                this.id = id;
                this.title = title;
                this.exercises = [];
                this.completed = false;
            }
        }

        class MockProgress {
            constructor() {
                this.lessonsCompleted = 0;
                this.totalScore = 0;
                this.lastActivity = null;
            }
        }

        // ğŸ”¹ ==================== MOCK LESSON ENGINE ====================
        class MockLessonEngine {
            constructor() {
                this.lessons = new Map();
                this.currentLessonId = null;
                this.log = [];
            }

            createLesson(title) {
                const lesson = new MockLesson(`lesson_${Date.now()}`, title);
                this.lessons.set(lesson.id, lesson);
                this.log.push(`ğŸ“˜ Ø¯Ø±Ø³ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: ${title} (${lesson.id})`);
                return lesson;
            }

            addExerciseToLesson(lessonId, exercise) {
                const lesson = this.lessons.get(lessonId);
                if (!lesson) throw new Error(`Ø¯Ø±Ø³ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯: ${lessonId}`);
                
                lesson.exercises.push(exercise);
                this.log.push(`ğŸ“ ØªÙ…Ø±ÛŒÙ† Ø¨Ù‡ Ø¯Ø±Ø³ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: ${exercise.id}`);
                return lesson;
            }

            completeLesson(lessonId) {
                const lesson = this.lessons.get(lessonId);
                if (!lesson) throw new Error(`Ø¯Ø±Ø³ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯: ${lessonId}`);
                
                lesson.completed = true;
                this.log.push(`âœ… Ø¯Ø±Ø³ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯: ${lesson.title}`);
                return lesson;
            }

            getLog() {
                return this.log;
            }
        }

        // ğŸ”¹ ==================== MOCK PROGRESS TRACKER ====================
        class MockProgressTracker {
            constructor() {
                this.progress = new MockProgress();
                this.history = [];
            }

            updateProgress(lessonId, exerciseId, score) {
                this.progress.totalScore += score;
                this.progress.lessonsCompleted += 1;
                this.progress.lastActivity = new Date().toISOString();
                
                this.history.push({
                    timestamp: new Date().toISOString(),
                    lessonId,
                    exerciseId,
                    score,
                    totalScore: this.progress.totalScore
                });
                
                return this.progress;
            }

            getProgressReport() {
                return {
                    ...this.progress,
                    history: this.history
                };
            }
        }

        // ğŸ”¹ ==================== EXERCISE MANAGER ====================
        class ExerciseManager {
            constructor(deps) {
                this.exerciseRepo = deps.exerciseRepository;
                this.evaluationService = deps.evaluationService;
                this.scoringStrategy = deps.scoringStrategy;
                this.logger = deps.logger;
                this.exerciseTypes = new Map();
                this.registerDefaultTypes();
            }

            registerDefaultTypes() {
                this.registerExerciseType('multipleChoice', this.createMC.bind(this));
                this.registerExerciseType('fillBlank', this.createFB.bind(this));
            }

            registerExerciseType(type, handler) {
                this.exerciseTypes.set(type, handler);
            }

            async createExercise(type, config) {
                if (!this.exerciseTypes.has(type)) throw new Error(`Ù†ÙˆØ¹ Ù†Ø§Ù…Ø¹ØªØ¨Ø±: ${type}`);
                const handler = this.exerciseTypes.get(type);
                const exercise = await handler(config);
                const saved = await this.exerciseRepo.save(exercise);
                this.logger.info(`ØªÙ…Ø±ÛŒÙ† Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: ${saved.id}`);
                return saved;
            }

            async evaluateAnswer(exerciseId, userAnswer) {
                const exercise = await this.exerciseRepo.findById(exerciseId);
                if (!exercise) throw new Error(`ØªÙ…Ø±ÛŒÙ† Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯: ${exerciseId}`);
                
                const evaluation = await this.evaluationService.evaluate(exercise, userAnswer);
                evaluation.score = this.scoringStrategy.calculate(exercise, evaluation);
                await this.exerciseRepo.saveEvaluation(exerciseId, userAnswer, evaluation);
                
                return evaluation;
            }

            // Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ØªÙ…Ø±ÛŒÙ†
            async createMC(config) {
                return {
                    type: 'multipleChoice',
                    id: 'ex_mc_' + Date.now(),
                    question: config.question,
                    options: config.options,
                    correctAnswer: config.correctAnswer,
                    lessonId: config.lessonId,
                    difficulty: config.difficulty,
                    createdAt: new Date().toISOString()
                };
            }

            async createFB(config) {
                return {
                    type: 'fillBlank',
                    id: 'ex_fb_' + Date.now(),
                    sentence: config.sentence,
                    blankPosition: config.blankPosition,
                    correctAnswer: config.correctAnswer,
                    lessonId: config.lessonId,
                    difficulty: config.difficulty,
                    createdAt: new Date().toISOString()
                };
            }
        }

        // ğŸ”¹ ==================== INTEGRATION TEST ====================
        async function runIntegrationTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="section"><h2>ğŸ§© Ù†ØªØ§ÛŒØ¬ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡</h2></div>';
            
            try {
                // 1. Ø§ÛŒØ¬Ø§Ø¯ mock ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
                addResult('1. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ MockÙ‡Ø§...', 'info');
                
                const mockDeps = {
                    exerciseRepository: {
                        save: async (ex) => ({ ...ex, saved: true }),
                        findById: async (id) => ({ id, type: 'multipleChoice', lessonId: 'test_lesson' }),
                        saveEvaluation: async () => ({ recorded: true })
                    },
                    evaluationService: {
                        evaluate: async (exercise, answer) => ({
                            isCorrect: answer === exercise.correctAnswer,
                            feedback: answer === exercise.correctAnswer ? 'ØµØ­ÛŒØ­!' : 'Ù†Ø§Ø¯Ø±Ø³Øª',
                            correctAnswer: exercise.correctAnswer
                        })
                    },
                    scoringStrategy: {
                        calculate: () => Math.floor(Math.random() * 30) + 70  // Ù†Ù…Ø±Ù‡ 70-100
                    },
                    logger: {
                        info: (msg) => console.log('ğŸ“˜', msg),
                        error: (msg) => console.error('âŒ', msg)
                    }
                };

                // 2. Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§
                addResult('2. Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ú˜ÙˆÙ„...', 'info');
                
                const lessonEngine = new MockLessonEngine();
                const progressTracker = new MockProgressTracker();
                const exerciseManager = new ExerciseManager(mockDeps);

                // 3. Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯
                addResult('3. Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯...', 'info');
                
                const lesson = lessonEngine.createLesson('Ø¯Ø±Ø³ ØªØ³Øª - Ù…Ú©Ø§Ù„Ù…Ù‡ Ø±ÙˆØ²Ù…Ø±Ù‡');
                addResult(`   ğŸ“– Ø¯Ø±Ø³ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: <strong>${lesson.title}</strong> (${lesson.id})`, 'success');

                // 4. Ø§ÛŒØ¬Ø§Ø¯ ØªÙ…Ø±ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ø±Ø³
                addResult('4. Ø§ÛŒØ¬Ø§Ø¯ ØªÙ…Ø±ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø³...', 'info');
                
                const exerciseConfig = {
                    lessonId: lesson.id,
                    difficulty: 'medium',
                    question: 'Ù…Ø¹Ø§Ø¯Ù„ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ "ØµØ¨Ø­ Ø¨Ø®ÛŒØ±" Ú†ÛŒØ³ØªØŸ',
                    options: ['Good morning', 'Good night', 'Good afternoon'],
                    correctAnswer: 'Good morning'
                };
                
                const exercise = await exerciseManager.createExercise('multipleChoice', exerciseConfig);
                addResult(`   ğŸ“ ØªÙ…Ø±ÛŒÙ† Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: <strong>${exercise.question}</strong>`, 'success');
                addResult(`   ğŸ”¹ Ù†ÙˆØ¹: ${exercise.type} | Ø³Ø·Ø­: ${exercise.difficulty}`, 'info');

                // 5. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªÙ…Ø±ÛŒÙ† Ø¨Ù‡ Ø¯Ø±Ø³
                lessonEngine.addExerciseToLesson(lesson.id, exercise);
                addResult(`   âœ… ØªÙ…Ø±ÛŒÙ† Ø¨Ù‡ Ø¯Ø±Ø³ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`, 'success');

                // 6. Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø±
                addResult('5. Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø±...', 'info');
                
                const userAnswer = 'Good morning';  // Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­
                const evaluation = await exerciseManager.evaluateAnswer(exercise.id, userAnswer);
                
                addResult(`   âœ¨ Ù†ØªÛŒØ¬Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ: <strong>${evaluation.isCorrect ? 'ØµØ­ÛŒØ­' : 'Ù†Ø§Ø¯Ø±Ø³Øª'}</strong>`, 
                         evaluation.isCorrect ? 'success' : 'error');
                addResult(`   ğŸ“Š Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø¨ Ø´Ø¯Ù‡: <strong>${evaluation.score}</strong>`, 'info');
                addResult(`   ğŸ’¬ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯: ${evaluation.feedback}`, 'info');

                // 7. Ø«Ø¨Øª Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±
                addResult('6. Ø«Ø¨Øª Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±...', 'info');
                
                const updatedProgress = progressTracker.updateProgress(
                    lesson.id, 
                    exercise.id, 
                    evaluation.score
                );
                
                addResult(`   ğŸ“ˆ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±: <strong>${updatedProgress.totalScore}</strong>`, 'success');
                addResult(`   ğŸ¯ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡: <strong>${updatedProgress.lessonsCompleted}</strong>`, 'success');

                // 8. ØªÚ©Ù…ÛŒÙ„ Ø¯Ø±Ø³
                addResult('7. ØªÚ©Ù…ÛŒÙ„ Ø¯Ø±Ø³...', 'info');
                
                const completedLesson = lessonEngine.completeLesson(lesson.id);
                addResult(`   ğŸ‰ Ø¯Ø±Ø³ <strong>${completedLesson.title}</strong> Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯.`, 'success');

                // 9. Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ
                addResult('8. ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ...', 'info');
                
                const progressReport = progressTracker.getProgressReport();
                const lessonLog = lessonEngine.getLog();
                
                // Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø± Ø¨Ø§Ú©Ø³ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡
                const reportBox = document.createElement('div');
                reportBox.className = 'data-box';
                reportBox.innerHTML = `
                    <h3>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ</h3>
                    <p><strong>Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„:</strong> ${progressReport.totalScore}</p>
                    <p><strongØ¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡:</strong> ${progressReport.lessonsCompleted}</p>
                    <p><strong>Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª:</strong> ${new Date(progressReport.lastActivity).toLocaleString('fa-IR')}</p>
                    <p><strong>Ù„Ø§Ú¯ Ø§Ø¬Ø±Ø§:</strong></p>
                    <ul>${lessonLog.map(log => `<li>${log}</li>`).join('')}</ul>
                `;
                
                resultsDiv.appendChild(reportBox);
                addResult('ğŸŠ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯!', 'success');

            } catch (error) {
                addResult(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // ğŸ”¹ ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type === 'success' ? 'success' : 
                           type === 'error' ? 'error' : 
                           'info';
            
            // Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ info Ø§Ø³ØªØ§ÛŒÙ„ Ø³Ø§Ø¯Ù‡â€ŒØªØ±
            if (type === 'info') {
                div.style.cssText = 'color: #7f8c8d; padding: 8px 12px; margin: 5px 0; background: #f8f9fa; border-right: 3px solid #bdc3c7;';
            }
            
            div.innerHTML = message;
            document.getElementById('results').appendChild(div);
        }
    </script>
</body>
</html>
