<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ LessonEngine</title>
    <style>
        body { font-family: Tahoma; direction: rtl; padding: 20px; background: #f5f7fa; }
        .test-case { background: white; margin: 15px 0; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pass { border-right: 5px solid #4CAF50; }
        .fail { border-right: 5px solid #f44336; }
        .running { border-right: 5px solid #FFC107; }
        button { padding: 10px 20px; margin: 5px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .summary { background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 20px; }
        code { background: #f1f1f1; padding: 2px 5px; border-radius: 3px; }
        pre { background: #2d3748; color: #e2e8f0; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 0.9rem; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ LessonEngine</h1>
    <p>Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…ÙˆØªÙˆØ± Ø¢Ù…ÙˆØ²Ø´ Ø¯Ø± ØªØ¹Ø§Ù…Ù„ Ø¨Ø§ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±</p>
    
    <div class="test-controls">
        <button onclick="runAllTests()">â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
        <button onclick="runSpecificTest(1)">Û±. ØªØ³Øª Ø³Ø§Ø®Øª Ù…ÙˆØªÙˆØ±</button>
        <button onclick="runSpecificTest(2)">Û². ØªØ³Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÙˆØ±Ù‡</button>
        <button onclick="runSpecificTest(3)">Û³. ØªØ³Øª Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø³</button>
        <button onclick="runSpecificTest(4)">Û´. ØªØ³Øª Ø§Ø±Ø³Ø§Ù„ ØªÙ…Ø±ÛŒÙ†</button>
        <button onclick="runSpecificTest(5)">Ûµ. ØªØ³Øª Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±</button>
        <button onclick="clearResults()" style="background: #6c757d;">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬</button>
    </div>
    
    <div id="testResults"></div>
    
    <div class="summary" id="summary">
        <h3>ğŸ“Š Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§</h3>
        <p>Ø¨Ø± Ø±ÙˆÛŒ ÛŒÚ©ÛŒ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
    </div>

    <script>
        // ==================== Mock ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒâ€ŒØªØ± ====================
        class MockDatabase {
            constructor() {
                this.data = {
                    courses: [
                        {
                            id: 'english_a1',
                            language: 'en',
                            title: 'Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø³Ø·Ø­ A1',
                            description: 'Ù…Ø¨ØªØ¯ÛŒ Ú©Ø§Ù…Ù„',
                            estimatedHours: 30,
                            lessons: [
                                { id: 'lesson_1', title: 'Ø¢Ø´Ù†Ø§ÛŒÛŒ', exercises: [{ id: 'ex1', points: 10, correctAnswers: ['Hello'] }] },
                                { id: 'lesson_2', title: 'Ø§Ø¹Ø¯Ø§Ø¯', exercises: [{ id: 'ex2', points: 15, correctAnswers: ['One', 'Two'] }] }
                            ]
                        }
                    ],
                    lessons: [
                        { 
                            id: 'lesson_1', 
                            title: 'Ø¢Ø´Ù†Ø§ÛŒÛŒ',
                            exercises: [
                                { id: 'ex1', correctAnswers: ['Hello'], points: 10 },
                                { id: 'ex2', correctAnswers: ['Goodbye'], points: 10 }
                            ]
                        }
                    ],
                    exercises: [
                        { id: 'ex1', correctAnswers: ['Hello'], points: 10 },
                        { id: 'ex2', correctAnswers: ['Goodbye'], points: 10 }
                    ]
                };
            }
            
            query(table) {
                const self = this;
                const queryBuilder = {
                    where(field, operator, value) {
                        if (field === 'id' && value) {
                            this.filteredData = self.data[table]?.filter(item => item.id === value);
                        }
                        return this;
                    },
                    andWhere(field, operator, value) {
                        if (field === 'language' && this.filteredData) {
                            this.filteredData = this.filteredData.filter(item => item.language === value);
                        }
                        return this;
                    },
                    with(relation) {
                        // Ø¯Ø± Mock Ø³Ø§Ø¯Ù‡ØŒ relationÙ‡Ø§ Ø§Ø² Ù‚Ø¨Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡
                        return this;
                    },
                    first() {
                        return this.filteredData?.[0] || self.data[table]?.[0] || null;
                    }
                };
                return queryBuilder;
            }
        }

        class MockEventBus {
            constructor() {
                this.events = [];
            }
            publish(event, data) {
                this.events.push({ event, data, timestamp: new Date() });
                console.log(`ğŸ“¢ [EventBus] ${event}:`, data);
            }
        }

        class MockProgressTracker {
            constructor() {
                this.sessions = [];
                this.exerciseResults = [];
                this.completedLessons = [];
            }
            
            async startSession(sessionId, userId, lessonId) {
                this.sessions.push({ sessionId, userId, lessonId, startTime: new Date() });
                return Promise.resolve();
            }
            
            async recordExerciseResult(data) {
                this.exerciseResults.push(data);
                return Promise.resolve();
            }
            
            async completeLesson(userId, lessonId, score, startTime, endTime) {
                this.completedLessons.push({ userId, lessonId, score, startTime, endTime });
                return Promise.resolve();
            }
            
            async getUserProgress(userId, courseId) {
                const userLessons = this.completedLessons.filter(l => l.userId === userId);
                return Promise.resolve({
                    completedLessons: userLessons.length,
                    overallScore: userLessons.reduce((sum, l) => sum + l.score, 0),
                    timeSpent: userLessons.length * 1800, // 30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø±Ø³
                    lastActive: new Date()
                });
            }
        }

        // ==================== Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ LessonEngine ====================
        class LessonEngine {
            constructor({ database, eventBus, progressTracker }) {
                if (!database || !eventBus || !progressTracker) {
                    throw new Error('ØªÙ…Ø§Ù… ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ù‡Ø³ØªÙ†Ø¯');
                }
                this._database = database;
                this._eventBus = eventBus;
                this._progressTracker = progressTracker;
                this._activeSessions = new Map();
            }

            async loadCourse(courseId, languageCode) {
                try {
                    const course = await this._database.query('courses')
                        .where('id', '=', courseId)
                        .andWhere('language', '=', languageCode)
                        .first();

                    if (!course) {
                        throw new Error(`Ø¯ÙˆØ±Ù‡ ${courseId} Ø¨Ø±Ø§ÛŒ Ø²Ø¨Ø§Ù† ${languageCode} ÛŒØ§ÙØª Ù†Ø´Ø¯`);
                    }

                    return {
                        id: course.id,
                        title: course.title,
                        description: course.description,
                        totalLessons: course.lessons?.length || 0,
                        estimatedHours: course.estimatedHours,
                        lessons: course.lessons?.map(l => ({
                            id: l.id,
                            title: l.title,
                            exerciseCount: l.exercises?.length || 0
                        })) || []
                    };
                } catch (error) {
                    this._eventBus.publish('lesson-engine.error', { action: 'loadCourse', error: error.message });
                    throw error;
                }
            }

            async startLesson(lessonId, userId) {
                const lesson = await this._database.query('lessons').where('id', '=', lessonId).first();
                if (!lesson) {
                    throw new Error(`Ø¯Ø±Ø³ ${lessonId} ÛŒØ§ÙØª Ù†Ø´Ø¯`);
                }
                
                const session = {
                    id: `session_${Date.now()}_${lessonId}`,
                    lessonId,
                    userId,
                    startTime: new Date(),
                    status: 'active',
                    currentExerciseIndex: 0,
                    completedExercises: [],
                    score: 0
                };

                await this._progressTracker.startSession(session.id, userId, lessonId);
                this._activeSessions.set(session.id, session);
                this._eventBus.publish('lesson.started', { 
                    sessionId: session.id, 
                    lessonId, 
                    userId,
                    timestamp: new Date().toISOString()
                });

                return session;
            }

            async submitExercise(submission) {
                const { sessionId, exerciseId, answers, timeSpent } = submission;
                const session = this._activeSessions.get(sessionId);

                if (!session) {
                    throw new Error(`Ø¬Ù„Ø³Ù‡ ${sessionId} ÛŒØ§ÙØª Ù†Ø´Ø¯`);
                }

                const exercise = await this._database.query('exercises').where('id', '=', exerciseId).first();
                if (!exercise) {
                    throw new Error(`ØªÙ…Ø±ÛŒÙ† ${exerciseId} ÛŒØ§ÙØª Ù†Ø´Ø¯`);
                }

                // Ù…Ù†Ø·Ù‚ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø³Ø§Ø¯Ù‡
                const isCorrect = JSON.stringify(answers.sort()) === JSON.stringify(exercise.correctAnswers.sort());
                const score = isCorrect ? exercise.points : 0;

                await this._progressTracker.recordExerciseResult({
                    sessionId,
                    exerciseId,
                    isCorrect,
                    score,
                    timeSpent
                });

                session.completedExercises.push(exerciseId);
                session.score += score;

                // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ú¯Ø± Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                const lesson = await this._database.query('lessons').where('id', '=', session.lessonId).first();
                if (session.completedExercises.length >= (lesson?.exercises?.length || 0)) {
                    session.status = 'completed';
                    session.endTime = new Date();
                    await this._progressTracker.completeLesson(
                        session.userId,
                        session.lessonId,
                        session.score,
                        session.startTime,
                        session.endTime
                    );
                    this._activeSessions.delete(session.id);
                    this._eventBus.publish('lesson.completed', {
                        sessionId: session.id,
                        lessonId: session.lessonId,
                        userId: session.userId,
                        score: session.score,
                        duration: session.endTime - session.startTime
                    });
                }

                return {
                    isCorrect,
                    score,
                    feedback: isCorrect ? 'Ø¹Ø§Ù„ÛŒ! Ù¾Ø§Ø³Ø® Ø¯Ø±Ø³Øª Ø§Ø³Øª.' : 'Ù¾Ø§Ø³Ø® Ù†Ø§Ø¯Ø±Ø³Øª. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.',
                    correctAnswers: exercise.correctAnswers,
                    nextExerciseId: null
                };
            }

            async getProgress(userId, courseId) {
                const progress = await this._progressTracker.getUserProgress(userId, courseId);
                const course = await this.loadCourse(courseId, 'en');

                return {
                    userId,
                    courseId,
                    completedLessons: progress.completedLessons,
                    totalLessons: course.totalLessons,
                    overallScore: progress.overallScore,
                    timeSpent: progress.timeSpent,
                    lastActive: progress.lastActive,
                    completionPercentage: Math.round((progress.completedLessons / course.totalLessons) * 100)
                };
            }
        }

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª ØªØ³Øªâ€ŒÙ‡Ø§ ====================
        function createTestResultElement(testId) {
            const div = document.createElement('div');
            div.id = `test${testId}`;
            document.getElementById('testResults').appendChild(div);
            return div;
        }

        function updateSummary() {
            const allTests = document.querySelectorAll('.test-case');
            const passed = Array.from(allTests).filter(t => t.className.includes('pass')).length;
            const failed = Array.from(allTests).filter(t => t.className.includes('fail')).length;
            const running = Array.from(allTests).filter(t => t.className.includes('running')).length;
            const total = 5; // ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ ØªØ³Øªâ€ŒÙ‡Ø§
            
            const summary = document.getElementById('summary');
            if (running > 0) {
                summary.innerHTML = `<h3>â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§...</h3><p>${running} ØªØ³Øª Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª</p>`;
            } else if (allTests.length > 0) {
                const percentage = total > 0 ? Math.round((passed / total) * 100) : 0;
                summary.innerHTML = `
                    <h3>ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬</h3>
                    <p>âœ… Ù…ÙˆÙÙ‚: ${passed} ØªØ³Øª</p>
                    <p>âŒ Ù†Ø§Ù…ÙˆÙÙ‚: ${failed} ØªØ³Øª</p>
                    <p>ğŸ“‹ Ú©Ù„: ${total} ØªØ³Øª</p>
                    <p>ğŸ¯ Ø¯Ø±ØµØ¯ Ù…ÙˆÙÙ‚ÛŒØª: ${percentage}%</p>
                    ${percentage >= 80 ? '<p style="color:#4CAF50; font-weight:bold;">ğŸ‰ ÙˆØ¶Ø¹ÛŒØª Ø¹Ø§Ù„ÛŒ! LessonEngine Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.</p>' : 
                      percentage >= 60 ? '<p style="color:#FF9800; font-weight:bold;">âš ï¸ ÙˆØ¶Ø¹ÛŒØª Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„. Ø¨Ø±Ø®ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø±Ù†Ø¯.</p>' :
                      '<p style="color:#f44336; font-weight:bold;">ğŸš« Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø¬Ø¯ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚.</p>'}
                `;
            }
        }

        // ==================== ØªÙˆØ§Ø¨Ø¹ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ØªÚ©ÛŒ ====================
        async function runSpecificTest(testId) {
            // Ø§ÛŒØ¬Ø§Ø¯ MockÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù‡Ø± ØªØ³Øª ØªÚ©ÛŒ
            const mockDB = new MockDatabase();
            const mockEventBus = new MockEventBus();
            const mockProgressTracker = new MockProgressTracker();
            
            const localEngine = new LessonEngine({
                database: mockDB,
                eventBus: mockEventBus,
                progressTracker: mockProgressTracker
            });
            
            const resultDiv = document.getElementById(`test${testId}`) || createTestResultElement(testId);
            resultDiv.className = 'test-case running';
            resultDiv.innerHTML = `<h3>ØªØ³Øª ${testId} Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...</h3><p>Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</p>`;
            
            try {
                let result;
                switch(testId) {
                    case 1: // ØªØ³Øª Ø³Ø§Ø®Øª Ù…ÙˆØªÙˆØ±
                        result = { 
                            success: true, 
                            message: 'Ù…ÙˆØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯',
                            data: { engine: 'LessonEngine', dependencies: 3 }
                        };
                        break;
                        
                    case 2: // ØªØ³Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÙˆØ±Ù‡
                        const course = await localEngine.loadCourse('english_a1', 'en');
                        result = {
                            success: course && course.id === 'english_a1',
                            message: course ? `Ø¯ÙˆØ±Ù‡ "${course.title}" Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯` : 'Ø¯ÙˆØ±Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯',
                            data: course
                        };
                        break;
                        
                    case 3: // ØªØ³Øª Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø³
                        const session = await localEngine.startLesson('lesson_1', 'user_single');
                        const hasEvent = mockEventBus.events.some(e => e.event === 'lesson.started');
                        result = {
                            success: session && session.id && hasEvent,
                            message: session ? `Ø¬Ù„Ø³Ù‡ "${session.id}" Ø´Ø±ÙˆØ¹ Ø´Ø¯` : 'Ø´Ø±ÙˆØ¹ Ø¬Ù„Ø³Ù‡ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯',
                            data: { session, events: mockEventBus.events.length }
                        };
                        break;
                        
                    case 4: // ØªØ³Øª Ø§Ø±Ø³Ø§Ù„ ØªÙ…Ø±ÛŒÙ†
                        const newSession = await localEngine.startLesson('lesson_1', 'user_exercise');
                        const submission = {
                            sessionId: newSession.id,
                            exerciseId: 'ex1',
                            answers: ['Hello'],
                            timeSpent: 45
                        };
                        const exerciseResult = await localEngine.submitExercise(submission);
                        result = {
                            success: exerciseResult && exerciseResult.score === 10,
                            message: exerciseResult ? `ØªÙ…Ø±ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. Ø§Ù…ØªÛŒØ§Ø²: ${exerciseResult.score}` : 'Ø§Ø±Ø³Ø§Ù„ ØªÙ…Ø±ÛŒÙ† Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯',
                            data: exerciseResult
                        };
                        break;
                        
                    case 5: // ØªØ³Øª Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ø±ÙØª
                        // Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ù¾ÛŒØ´Ø±ÙØªØŒ ÛŒÚ© Ø¯Ø±Ø³ Ø±Ø§ Ú©Ø§Ù…Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                        const progressSession = await localEngine.startLesson('lesson_1', 'user_progress');
                        await localEngine.submitExercise({
                            sessionId: progressSession.id,
                            exerciseId: 'ex1',
                            answers: ['Hello'],
                            timeSpent: 30
                        });
                        await localEngine.submitExercise({
                            sessionId: progressSession.id,
                            exerciseId: 'ex2',
                            answers: ['Goodbye'],
                            timeSpent: 40
                        });
                        
                        const progress = await localEngine.getProgress('user_progress', 'english_a1');
                        result = {
                            success: progress && progress.completionPercentage === 100,
                            message: progress ? `Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±: ${progress.completionPercentage}% Ú©Ø§Ù…Ù„` : 'Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ø±ÙØª Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯',
                            data: progress
                        };
                        break;
                        
                    default:
                        result = { success: false, message: 'ØªØ³Øª Ù†Ø§Ù…Ø´Ø®Øµ' };
                }
                
                resultDiv.className = `test-case ${result.success ? 'pass' : 'fail'}`;
                resultDiv.innerHTML = `
                    <h3>ØªØ³Øª ${testId}</h3>
                    <p><strong>Ù†ØªÛŒØ¬Ù‡:</strong> ${result.success ? 'âœ… Ù…ÙˆÙÙ‚' : 'âŒ Ù†Ø§Ù…ÙˆÙÙ‚'}</p>
                    <p><strong>Ù¾ÛŒØ§Ù…:</strong> ${result.message}</p>
                    ${result.data ? `<p><strong>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:</strong> <code>${JSON.stringify(result.data).substring(0, 100)}...</code></p>` : ''}
                    <p><small>Ø²Ù…Ø§Ù†: ${new Date().toLocaleTimeString('fa-IR')}</small></p>
                `;
                
            } catch (error) {
                resultDiv.className = 'test-case fail';
                resultDiv.innerHTML = `
                    <h3>ØªØ³Øª ${testId} - Ø®Ø·Ø§</h3>
                    <p><strong>Ù†ØªÛŒØ¬Ù‡:</strong> âŒ Ø®Ø·Ø§ÛŒ Ø§Ø¬Ø±Ø§</p>
                    <p><strong>Ø®Ø·Ø§:</strong> ${error.message}</p>
                    <details>
                        <summary>Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø·Ø§</summary>
                        <pre>${error.stack || error.toString()}</pre>
                    </details>
                `;
                console.error(`Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª ${testId}:`, error);
            }
            
            updateSummary();
        }

        // ==================== ØªØ³Øª Ú¯Ø±ÙˆÙ‡ÛŒ ====================
        async function runAllTests() {
            document.getElementById('testResults').innerHTML = '';
            
            for (let testId = 1; testId <= 5; testId++) {
                // Ø§ÛŒØ¬Ø§Ø¯ MockÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù‡Ø± ØªØ³Øª
                const mockDB = new MockDatabase();
                const mockEventBus = new MockEventBus();
                const mockProgressTracker = new MockProgressTracker();
                
                const localEngine = new LessonEngine({
                    database: mockDB,
                    eventBus: mockEventBus,
                    progressTracker: mockProgressTracker
                });
                
                const resultDiv = createTestResultElement(testId);
                resultDiv.className = 'test-case running';
                resultDiv.innerHTML = `<h3>ØªØ³Øª ${testId} Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...</h3>`;
                
                try {
                    let result;
                    switch(testId) {
                        case 1:
                            result = { success: true, message: 'Ù…ÙˆØªÙˆØ± Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯' };
                            break;
                        case 2:
                            const course = await localEngine.loadCourse('english_a1', 'en');
                            result = {
                                success: course && course.id === 'english_a1',
                                message: course ? `Ø¯ÙˆØ±Ù‡ "${course.title}" Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯` : 'Ø¯ÙˆØ±Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯'
                            };
                            break;
                        case 3:
                            const session = await localEngine.startLesson('lesson_1', `user_all_${testId}`);
                            result = {
                                success: session && session.id,
                                message: session ? `Ø¬Ù„Ø³Ù‡ Ø´Ø±ÙˆØ¹ Ø´Ø¯ (${session.id})` : 'Ø´Ø±ÙˆØ¹ Ø¬Ù„Ø³Ù‡ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯'
                            };
                            break;
                        case 4:
                            const newSession = await localEngine.startLesson('lesson_1', `user_all_ex_${testId}`);
                            const exResult = await localEngine.submitExercise({
                                sessionId: newSession.id,
                                exerciseId: 'ex1',
                                answers: ['Hello'],
                                timeSpent: 30
                            });
                            result = {
                                success: exResult && exResult.score === 10,
                                message: exResult ? `ØªÙ…Ø±ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ (Ø§Ù…ØªÛŒØ§Ø²: ${exResult.score})` : 'Ø§Ø±Ø³Ø§Ù„ ØªÙ…Ø±ÛŒÙ† Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯'
                            };
                            break;
                        case 5:
                            const progressSession = await localEngine.startLesson('lesson_1', `user_all_prog_${testId}`);
                            
                            // ğŸ”¥ Ø§ØµÙ„Ø§Ø­: Ø§Ø±Ø³Ø§Ù„ Ù‡Ø± Ø¯Ùˆ ØªÙ…Ø±ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù…Ù„ Ú©Ø±Ø¯Ù† Ø¯Ø±Ø³
                            await localEngine.submitExercise({
                                sessionId: progressSession.id,
                                exerciseId: 'ex1',
                                answers: ['Hello'],
                                timeSpent: 30
                            });
                            await localEngine.submitExercise({
                                sessionId: progressSession.id,
                                exerciseId: 'ex2',
                                answers: ['Goodbye'],
                                timeSpent: 40
                            });
                            
                            const progress = await localEngine.getProgress(`user_all_prog_${testId}`, 'english_a1');
                            result = {
                                // ğŸ”¥ Ø§ØµÙ„Ø§Ø­: Ø¨Ø±Ø±Ø³ÛŒ 100% Ø´Ø¯Ù† Ù¾ÛŒØ´Ø±ÙØª
                                success: progress && progress.completionPercentage === 100,
                                message: progress ? `Ù¾ÛŒØ´Ø±ÙØª: ${progress.completionPercentage}% (Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„)` : 'Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ø±ÙØª Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯'
                            };
                            break;
                    }
                    
                    resultDiv.className = `test-case ${result.success ? 'pass' : 'fail'}`;
                    resultDiv.innerHTML = `
                        <h3>ØªØ³Øª ${testId}</h3>
                        <p><strong>Ù†ØªÛŒØ¬Ù‡:</strong> ${result.success ? 'âœ… Ù…ÙˆÙÙ‚' : 'âŒ Ù†Ø§Ù…ÙˆÙÙ‚'}</p>
                        <p><strong>Ù¾ÛŒØ§Ù…:</strong> ${result.message}</p>
                    `;
                    
                } catch (error) {
                    resultDiv.className = 'test-case fail';
                    resultDiv.innerHTML = `
                        <h3>ØªØ³Øª ${testId} - Ø®Ø·Ø§</h3>
                        <p><strong>Ù†ØªÛŒØ¬Ù‡:</strong> âŒ Ø®Ø·Ø§</p>
                        <p><strong>Ø®Ø·Ø§:</strong> ${error.message}</p>
                    `;
                }
                
                // ØªØ§Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ±
                await new Promise(resolve => setTimeout(resolve, 400));
            }
            
            updateSummary();
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('summary').innerHTML = `
                <h3>ğŸ“Š Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§</h3>
                <p>Ù†ØªØ§ÛŒØ¬ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯. Ø¨Ø± Ø±ÙˆÛŒ ÛŒÚ©ÛŒ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
            `;
        }
    </script>
</body>
</html>
