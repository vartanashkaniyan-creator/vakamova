// ==================== ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ runSpecificTest ====================
async function runSpecificTest(testId) {
    const testIndex = testId - 1;
    if (testIndex < 0 || testIndex >= testCases.length) return;
    
    const test = testCases[testIndex];
    const resultDiv = document.getElementById(`test${testId}`) || createTestResultElement(testId);
    
    // ğŸ”¥ Ø§ØµÙ„Ø§Ø­ Ø­ÛŒØ§ØªÛŒ: Ø§ÛŒØ¬Ø§Ø¯ Mock Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù‡Ø± ØªØ³Øª ØªÚ©ÛŒ
    const mockDB = new MockDatabase();
    const mockEventBus = new MockEventBus();
    const mockProgressTracker = new MockProgressTracker();
    
    // Ø§ÛŒØ¬Ø§Ø¯ Ù…ÙˆØªÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ MockÙ‡Ø§ÛŒ ØªØ§Ø²Ù‡
    const localLessonEngine = new LessonEngine({
        database: mockDB,
        eventBus: mockEventBus,
        progressTracker: mockProgressTracker
    });
    
    resultDiv.className = 'test-case running';
    resultDiv.innerHTML = `<h3>${test.id}. ${test.name}</h3><p>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...</p>`;
    
    try {
        // ğŸ”¥ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Ø¨Ø§ Ù…ÙˆØªÙˆØ± Ùˆ MockÙ‡Ø§ÛŒ Ù…Ø³ØªÙ‚Ù„
        let result;
        switch(testId) {
            case 1: // Ø³Ø§Ø®Øª Ù…ÙˆØªÙˆØ±
                result = { 
                    success: !!localLessonEngine, 
                    message: 'Ù…ÙˆØªÙˆØ± Ø¨Ø§ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Mock Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯' 
                };
                break;
                
            case 2: // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÙˆØ±Ù‡
                const course = await localLessonEngine.loadCourse('english_a1', 'en');
                result = {
                    success: course && course.id === 'english_a1',
                    message: course ? 'Ø¯ÙˆØ±Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯' : 'Ø¯ÙˆØ±Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯',
                    data: course
                };
                break;
                
            case 3: // Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø³
                const session = await localLessonEngine.startLesson('lesson_1', 'user_1001');
                const hasEvent = mockEventBus.events.some(e => e.event === 'lesson.started');
                result = {
                    success: session && session.id && hasEvent,
                    message: session ? 'Ø¬Ù„Ø³Ù‡ Ø´Ø±ÙˆØ¹ Ø´Ø¯' : 'Ø´Ø±ÙˆØ¹ Ø¬Ù„Ø³Ù‡ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯',
                    data: session
                };
                break;
                
            case 4: // Ø§Ø±Ø³Ø§Ù„ ØªÙ…Ø±ÛŒÙ†
                // Ø§ÙˆÙ„ ÛŒÚ© Ø¬Ù„Ø³Ù‡ Ø¬Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ…
                const newSession = await localLessonEngine.startLesson('lesson_1', 'user_1002');
                const submission = {
                    sessionId: newSession.id,
                    exerciseId: 'ex1',
                    answers: ['Hello'],
                    timeSpent: 45
                };
                const exerciseResult = await localLessonEngine.submitExercise(submission);
                result = {
                    success: exerciseResult && exerciseResult.score === 10,
                    message: exerciseResult ? `ØªÙ…Ø±ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ (Ø§Ù…ØªÛŒØ§Ø²: ${exerciseResult.score})` : 'Ø§Ø±Ø³Ø§Ù„ ØªÙ…Ø±ÛŒÙ† Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯',
                    data: exerciseResult
                };
                break;
                
            case 5: // Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ø±ÙØª
                const progress = await localLessonEngine.getProgress('user_1003', 'english_a1');
                result = {
                    success: progress && typeof progress.completionPercentage === 'number',
                    message: progress ? `Ù¾ÛŒØ´Ø±ÙØª: ${progress.completionPercentage}%` : 'Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ø±ÙØª Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯',
                    data: progress
                };
                break;
        }
        
        resultDiv.className = `test-case ${result.success ? 'pass' : 'fail'}`;
        resultDiv.innerHTML = `
            <h3>${test.id}. ${test.name}</h3>
            <p><strong>Ù†ØªÛŒØ¬Ù‡:</strong> ${result.success ? 'âœ… Ù…ÙˆÙÙ‚' : 'âŒ Ù†Ø§Ù…ÙˆÙÙ‚'}</p>
            <p><strong>Ù¾ÛŒØ§Ù…:</strong> ${result.message}</p>
            ${result.data ? `<p><strong>Ù†Ù…ÙˆÙ†Ù‡ Ø¯Ø§Ø¯Ù‡:</strong> <code>${JSON.stringify(result.data).substring(0, 100)}...</code></p>` : ''}
        `;
        
    } catch (error) {
        resultDiv.className = 'test-case fail';
        resultDiv.innerHTML = `
            <h3>${test.id}. ${test.name}</h3>
            <p><strong>Ù†ØªÛŒØ¬Ù‡:</strong> âŒ Ø®Ø·Ø§ÛŒ Ø§Ø¬Ø±Ø§</p>
            <p><strong>Ø®Ø·Ø§:</strong> ${error.message}</p>
            <details style="margin-top:10px;">
                <summary>Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ø®Ø·Ø§</summary>
                <pre style="background:#f1f1f1;padding:10px;border-radius:5px;">${error.stack}</pre>
            </details>
        `;
    }
    
    updateSummary();
}

// ==================== ØªØ§Ø¨Ø¹ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ runAllTests ====================
async function runAllTests() {
    document.getElementById('testResults').innerHTML = '';
    
    // ğŸ”¥ Ø³Ø§Ø®Øª MockÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù‡Ø± ØªØ³Øª Ø¯Ø± Ø­Ø§Ù„Øª Ú¯Ø±ÙˆÙ‡ÛŒ
    for (const test of testCases) {
        const mockDB = new MockDatabase();
        const mockEventBus = new MockEventBus();
        const mockProgressTracker = new MockProgressTracker();
        
        const localEngine = new LessonEngine({
            database: mockDB,
            eventBus: mockEventBus,
            progressTracker: mockProgressTracker
        });
        
        const resultDiv = createTestResultElement(test.id);
        resultDiv.className = 'test-case running';
        resultDiv.innerHTML = `<h3>${test.id}. ${test.name}</h3><p>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...</p>`;
        
        try {
            let result;
            switch(test.id) {
                case 1:
                    result = { success: true, message: 'Ù…ÙˆØªÙˆØ± Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯' };
                    break;
                case 2:
                    const course = await localEngine.loadCourse('english_a1', 'en');
                    result = {
                        success: course && course.id === 'english_a1',
                        message: course ? 'Ø¯ÙˆØ±Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯' : 'Ø¯ÙˆØ±Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯'
                    };
                    break;
                case 3:
                    const session = await localEngine.startLesson('lesson_1', 'user_all_1');
                    result = {
                        success: session && session.id,
                        message: session ? 'Ø¬Ù„Ø³Ù‡ Ø´Ø±ÙˆØ¹ Ø´Ø¯' : 'Ø´Ø±ÙˆØ¹ Ø¬Ù„Ø³Ù‡ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯'
                    };
                    break;
                case 4:
                    const newSession = await localEngine.startLesson('lesson_1', 'user_all_2');
                    const exResult = await localEngine.submitExercise({
                        sessionId: newSession.id,
                        exerciseId: 'ex1',
                        answers: ['Hello'],
                        timeSpent: 30
                    });
                    result = {
                        success: exResult && exResult.score === 10,
                        message: exResult ? `ØªÙ…Ø±ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ (Ø§Ù…ØªÛŒØ§Ø²: ${exResult.score})` : 'Ø§Ø±Ø³Ø§Ù„ ØªÙ…Ø±ÛŒÙ† Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯'
                    };
                    break;
                case 5:
                    const progress = await localEngine.getProgress('user_all_3', 'english_a1');
                    result = {
                        success: progress && typeof progress.completionPercentage === 'number',
                        message: progress ? `Ù¾ÛŒØ´Ø±ÙØª: ${progress.completionPercentage}%` : 'Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ´Ø±ÙØª Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯'
                    };
                    break;
            }
            
            resultDiv.className = `test-case ${result.success ? 'pass' : 'fail'}`;
            resultDiv.innerHTML = `
                <h3>${test.id}. ${test.name}</h3>
                <p><strong>Ù†ØªÛŒØ¬Ù‡:</strong> ${result.success ? 'âœ… Ù…ÙˆÙÙ‚' : 'âŒ Ù†Ø§Ù…ÙˆÙÙ‚'}</p>
                <p><strong>Ù¾ÛŒØ§Ù…:</strong> ${result.message}</p>
            `;
            
        } catch (error) {
            resultDiv.className = 'test-case fail';
            resultDiv.innerHTML = `
                <h3>${test.id}. ${test.name}</h3>
                <p><strong>Ù†ØªÛŒØ¬Ù‡:</strong> âŒ Ø®Ø·Ø§</p>
                <p><strong>Ø®Ø·Ø§:</strong> ${error.message}</p>
            `;
        }
        
        // Ú©Ù…ÛŒ ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ±
        await new Promise(resolve => setTimeout(resolve, 300));
    }
    
    updateSummary();
}
