<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªØ³Øª Ø³Ø§Ø¯Ù‡ Ù‡Ø³ØªÙ‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³</title>
    <style>
        body { font-family: Tahoma; margin: 20px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
        button:hover { background: #0056b3; }
        #output { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; border: 1px solid #dee2e6; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª Ø³Ø§Ø¯Ù‡ Database Core</h1>
    
    <div>
        <button onclick="testDatabase()">ØªØ³Øª Database</button>
        <button onclick="testSchema()">ØªØ³Øª Schema Manager</button>
        <button onclick="testMigration()">ØªØ³Øª Migration</button>
        <button onclick="clearOutput()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø®Ø±ÙˆØ¬ÛŒ</button>
    </div>
    
    <div id="output">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯...</div>
    
    <script>
        // Log function
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const color = type === 'success' ? 'green' : type === 'error' ? 'red' : 'black';
            output.innerHTML += `<div style="color: ${color}; margin: 5px 0;">${message}</div>`;
        }
        
        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }
        
        // Test 1: Database
        async function testDatabase() {
            clearOutput();
            log('ğŸ”§ Ø´Ø±ÙˆØ¹ ØªØ³Øª Database...', 'info');
            
            try {
                // Create a simple IndexedDB wrapper
                const dbName = 'TestDB_' + Date.now();
                const request = indexedDB.open(dbName, 1);
                
                request.onerror = (event) => {
                    log('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§Ø¨ÛŒØ³', 'error');
                };
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    log('âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯', 'success');
                    
                    // Add test data
                    const transaction = db.transaction(['testStore'], 'readwrite');
                    const store = transaction.objectStore('testStore');
                    
                    store.add({ id: 1, name: 'ØªØ³Øª', value: 100 });
                    
                    transaction.oncomplete = () => {
                        log('âœ… Ø¯Ø§Ø¯Ù‡ ØªØ³Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
                        
                        // Read data
                        const readTransaction = db.transaction(['testStore'], 'readonly');
                        const readStore = readTransaction.objectStore('testStore');
                        const getRequest = readStore.get(1);
                        
                        getRequest.onsuccess = () => {
                            log(`ğŸ“– Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯Ù‡: ${JSON.stringify(getRequest.result)}`, 'success');
                            
                            // Cleanup
                            db.close();
                            indexedDB.deleteDatabase(dbName);
                            log('ğŸ§¹ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù¾Ø§Ú© Ø´Ø¯', 'info');
                        };
                    };
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('testStore')) {
                        db.createObjectStore('testStore', { keyPath: 'id' });
                        log('ğŸ“¦ store ØªØ³Øª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯', 'info');
                    }
                };
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
            }
        }
        
        // Test 2: Schema Manager Simulation
        async function testSchema() {
            clearOutput();
            log('ğŸ“ Ø´Ø±ÙˆØ¹ ØªØ³Øª Schema Manager...', 'info');
            
            // Simulated Schema Manager
            class SimpleSchemaManager {
                constructor() {
                    this.schemas = new Map();
                }
                
                defineSchema(version, stores) {
                    this.schemas.set(version, {
                        version,
                        stores,
                        createdAt: new Date()
                    });
                    log(`âœ… Schema Ù†Ø³Ø®Ù‡ ${version} ØªØ¹Ø±ÛŒÙ Ø´Ø¯`, 'success');
                    return this.schemas.get(version);
                }
                
                getSchema(version) {
                    const schema = this.schemas.get(version);
                    if (schema) {
                        log(`ğŸ“„ Schema Ù†Ø³Ø®Ù‡ ${version} Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯`, 'success');
                        return schema;
                    } else {
                        throw new Error(`Schema Ù†Ø³Ø®Ù‡ ${version} ÛŒØ§ÙØª Ù†Ø´Ø¯`);
                    }
                }
            }
            
            try {
                const schemaManager = new SimpleSchemaManager();
                
                // Define schema v1
                const schemaV1 = schemaManager.defineSchema(1, [
                    { name: 'users', keyPath: 'id' },
                    { name: 'lessons', keyPath: 'lessonId' }
                ]);
                
                // Define schema v2
                const schemaV2 = schemaManager.defineSchema(2, [
                    ...schemaV1.stores,
                    { name: 'progress', keyPath: 'id' }
                ]);
                
                // Get schema
                const retrievedSchema = schemaManager.getSchema(2);
                log(`ğŸ“Š Schema Ø­Ø§ÙˆÛŒ ${retrievedSchema.stores.length} store`, 'info');
                
                log('âœ… ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Schema Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú¯Ø°Ø´Øª', 'success');
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
            }
        }
        
        // Test 3: Migration Simulation
        async function testMigration() {
            clearOutput();
            log('ğŸ”„ Ø´Ø±ÙˆØ¹ ØªØ³Øª Migration Engine...', 'info');
            
            class SimpleMigrationEngine {
                constructor() {
                    this.migrations = [];
                }
                
                async migrate(fromVersion, toVersion) {
                    log(`ğŸ”„ Ø´Ø±ÙˆØ¹ Ù…Ù‡Ø§Ø¬Ø±Øª Ø§Ø² v${fromVersion} Ø¨Ù‡ v${toVersion}...`, 'info');
                    
                    for (let v = fromVersion + 1; v <= toVersion; v++) {
                        log(`  ğŸ“¦ Ø§Ø¬Ø±Ø§ÛŒ migration Ù†Ø³Ø®Ù‡ ${v}...`, 'info');
                        
                        // Simulate migration steps
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        this.migrations.push({
                            from: v - 1,
                            to: v,
                            timestamp: new Date()
                        });
                        
                        log(`  âœ… Migration Ù†Ø³Ø®Ù‡ ${v} ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯`, 'success');
                    }
                    
                    return {
                        success: true,
                        fromVersion,
                        toVersion,
                        steps: toVersion - fromVersion
                    };
                }
            }
            
            try {
                const migrationEngine = new SimpleMigrationEngine();
                
                // Execute migration
                const result = await migrationEngine.migrate(1, 3);
                
                log(`ğŸ‰ Ù…Ù‡Ø§Ø¬Ø±Øª Ú©Ø§Ù…Ù„ Ø´Ø¯!`, 'success');
                log(`ğŸ“Š Ù†ØªÛŒØ¬Ù‡: ${result.steps} Ù…Ø±Ø­Ù„Ù‡ Ø§Ø¬Ø±Ø§ Ø´Ø¯`, 'info');
                log(`ğŸ“Š Ø§Ø² Ù†Ø³Ø®Ù‡ ${result.fromVersion} Ø¨Ù‡ ${result.toVersion}`, 'info');
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        log('ğŸš€ Ø³ÛŒØ³ØªÙ… ØªØ³Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª. Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.', 'info');
    </script>
</body>
</html>
