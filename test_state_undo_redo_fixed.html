<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø³ÛŒØ³ØªÙ… Undo/Redo - Vakamova</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:tahoma;background:#006064;color:#333;padding:20px}.container{max-width:1000px;margin:auto;background:#fff;border-radius:10px;overflow:hidden}header{background:#00838f;color:#fff;padding:20px;text-align:center}h1{font-size:1.5rem}.test-section{padding:20px}.test-item{background:#f5f5f5;border-radius:8px;padding:15px;margin-bottom:15px;border-right:5px solid#4db6ac}.passed{border-right-color:#43a047;background:#e8f5e9}.failed{border-right-color:#e53935;background:#ffebee}.running{border-right-color:#fb8c00;background:#fff3e0}.test-header{display:flex;justify-content:space-between;margin-bottom:10px}.test-name{font-weight:bold}.test-status{padding:3px 10px;border-radius:12px;font-size:.8rem}.status-pending{background:#fff9c4;color:#f57c00}.status-running{background:#bbdefb;color:#1565c0}.status-passed{background:#c8e6c9;color:#2e7d32}.status-failed{background:#ffcdd2;color:#c62828}button{background:#00838f;color:#fff;border:none;padding:12px 25px;border-radius:8px;font-size:1rem;cursor:pointer;width:100%;margin-top:15px}button:hover{background:#006064}.console{background:#263238;color:#80cbc4;padding:15px;margin-top:20px;border-radius:8px;font-family:monospace;font-size:.9rem;max-height:250px;overflow-y:auto}.log{padding:5px 0;border-bottom:1px solid #37474f}.undo-redo-controls{background:#b2ebf2;padding:15px;border-radius:8px;margin:15px 0;display:flex;gap:10px;flex-wrap:wrap}.control-btn{background:#4db6ac;color:#fff;border:none;padding:8px 15px;border-radius:6px;cursor:pointer;flex:1;min-width:120px;text-align:center}.control-btn:hover{background:#26a69a}.history-timeline{background:#e0f7fa;padding:15px;border-radius:8px;margin:15px 0;max-height:200px;overflow-y:auto}.history-item{padding:8px;margin:5px 0;background:#fff;border-radius:4px;border-right:3px solid#4db6ac;font-size:.85rem}.history-item.current{background:#b2ebf2;border-right-color:#00838f}.state-visualizer{background:#f1f8e9;padding:15px;border-radius:8px;margin:15px 0;font-family:monospace;font-size:.85rem;max-height:150px;overflow-y:auto}.btn-group{display:flex;gap:10px;margin-top:15px}.btn-group button{flex:1}
    </style>
</head>
<body>
    <div class="container">
        <header><h1>âªâ© ØªØ³Øª Ø³ÛŒØ³ØªÙ… Undo/Redo + Time Travel</h1></header>
        <div class="test-section">
            <div class="undo-redo-controls">
                <button class="control-btn" id="undo-btn" disabled>âª Undo</button>
                <button class="control-btn" id="redo-btn" disabled>â© Redo</button>
                <button class="control-btn" id="clear-history-btn" style="background:#ef5350">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
                <button class="control-btn" id="jump-to-btn" style="background:#ab47bc">ğŸ•’ Ù¾Ø±Ø´ Ø¨Ù‡ Ø²Ù…Ø§Ù†</button>
            </div>
            
            <div class="history-timeline" id="history-timeline">
                <div class="history-item">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Undo/Redo Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</div>
            </div>
            
            <div class="state-visualizer" id="state-visualizer">
                <strong>ğŸ¯ State ÙØ¹Ù„ÛŒ:</strong> Ù…Ù†ØªØ¸Ø± Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§...
            </div>
            
            <div class="test-item" id="test1">
                <div class="test-header"><div class="test-name">Û±. Undo/Redo Ù¾Ø§ÛŒÙ‡ Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚</div><div class="test-status status-pending" id="status1">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output1"></div>
            </div>
            <div class="test-item" id="test2">
                <div class="test-header"><div class="test-name">Û². Grouped Actions Ùˆ Transactions</div><div class="test-status status-pending" id="status2">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output2"></div>
            </div>
            <div class="test-item" id="test3">
                <div class="test-header"><div class="test-name">Û³. Time Travel Ùˆ Export/Import ØªØ§Ø±ÛŒØ®Ú†Ù‡</div><div class="test-status status-pending" id="status3">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output3"></div>
            </div>
            <div class="test-item" id="test4">
                <div class="test-header"><div class="test-name">Û´. Action Logging Ùˆ Replay</div><div class="test-status status-pending" id="status4">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output4"></div>
            </div>
            
            <div class="btn-group">
                <button id="run-btn">â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
                <button id="run-simulation-btn" style="background:#5c6bc0">ğŸ® Ø§Ø¬Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ø±Ø¨Ø±</button>
            </div>
            
            <div class="console" id="console">
                <div class="log">[Ø³ÛŒØ³ØªÙ…] ØªØ³Øª Undo/Redo + Time Travel Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</div>
            </div>
        </div>
    </div>

<script>
// ========== Ø³ÛŒØ³ØªÙ… Undo/Redo Ù¾ÛŒØ´Ø±ÙØªÙ‡ ==========
const UndoRedoManager = {
    state: {},
    history: [],
    future: [], // Ø¨Ø±Ø§ÛŒ Redo
    currentIndex: -1,
    maxHistorySize: 50,
    transactionStack: [],
    actionLog: [],
    
    // ========== Ù…Ø¯ÛŒØ±ÛŒØª State Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Undo/Redo ==========
    setState(key, value, options = {}) {
        const { 
            description = `ØªÙ†Ø¸ÛŒÙ… ${key}`,
            groupId = null,
            skipHistory = false,
            timestamp = Date.now()
        } = options;
        
        const oldValue = this.state[key];
        const newValue = value;
        
        // Ø§ÛŒØ¬Ø§Ø¯ action record
        const action = {
            id: this.generateId(),
            type: 'SET_STATE',
            key,
            oldValue: JSON.parse(JSON.stringify(oldValue)), // Deep copy
            newValue: JSON.parse(JSON.stringify(newValue)), // Deep copy
            description,
            groupId,
            timestamp,
            stateSnapshot: this.getStateSnapshot()
        };
        
        // Ø§Ú¯Ø± Ø¯Ø± transaction Ù‡Ø³ØªÛŒÙ…ØŒ action Ø±Ø§ Ø¨Ù‡ transaction ÙØ¹Ù„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
        if (this.transactionStack.length > 0 && !skipHistory) {
            const currentTransaction = this.transactionStack[this.transactionStack.length - 1];
            currentTransaction.actions.push(action);
            this.log(`Action Ø¨Ù‡ transaction "${currentTransaction.name}" Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯`);
            this.actionLog.push({...action, logType: 'ACTION_ADDED_TO_TRANSACTION'});
        } 
        // Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±ØªØŒ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
        else if (!skipHistory) {
            this.addToHistory(action);
        } else {
            // ÙÙ‚Ø· state Ø±Ø§ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡
            this.state[key] = newValue;
            this.updateVisualizations();
            return action;
        }
        
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† future (ÙˆÙ‚ØªÛŒ ØªØºÛŒÛŒØ± Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ future Ø¨Ø§Ø·Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
        if (!skipHistory && this.future.length > 0) {
            this.future = [];
            this.updateControls();
        }
        
        this.log(`âœ… ${description}: ${this.formatValue(oldValue)} â†’ ${this.formatValue(newValue)}`);
        this.updateVisualizations();
        
        return action;
    },
    
    // ========== Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ ==========
    addToHistory(action) {
        // Ø§Ú¯Ø± Ø¯Ø± Ù…ÛŒØ§Ù†Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù‡Ø³ØªÛŒÙ…ØŒ future Ø±Ø§ Ù‚Ø·Ø¹ Ú©Ù†
        if (this.currentIndex < this.history.length - 1) {
            this.history = this.history.slice(0, this.currentIndex + 1);
            this.future = []; // future Ø±Ø§ Ù‡Ù… Ù¾Ø§Ú© Ú©Ù†
            this.log(`ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø² Ø§ÛŒÙ†Ø¯Ú©Ø³ ${this.currentIndex + 1} Ù‚Ø·Ø¹ Ø´Ø¯`);
        }
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† action Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
        this.history.push(action);
        this.currentIndex = this.history.length - 1;
        
        // Ø§Ø¬Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± State (Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø¬Ø±Ø§ Ù†Ø´Ø¯Ù‡)
        if (action.type === 'SET_STATE') {
            this.state[action.key] = action.newValue;
        } else if (action.type === 'TRANSACTION') {
            for (const subAction of action.actions) {
                if (subAction.type === 'SET_STATE') {
                    this.state[subAction.key] = subAction.newValue;
                }
            }
        }
        
        // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø§Ù†Ø¯Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
        if (this.history.length > this.maxHistorySize) {
            const removed = this.history.shift();
            this.currentIndex--;
            this.log(`ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø± Ø´Ø¯. Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† action Ø­Ø°Ù Ø´Ø¯: ${removed.description}`);
        }
        
        // Ù„Ø§Ú¯ action
        this.actionLog.push({
            ...action,
            loggedAt: Date.now(),
            logType: 'ACTION_ADDED_TO_HISTORY'
        });
        
        this.updateControls();
        this.updateHistoryTimeline();
        
        return action;
    },
    
    // ========== Undo/Redo ==========
    undo() {
        if (this.currentIndex < 0) {
            this.log("Ù‡ÛŒÚ† actionØ§ÛŒ Ø¨Ø±Ø§ÛŒ undo ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", 'warning');
            return null;
        }
        
        const action = this.history[this.currentIndex];
        
        // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† State
        if (action.type === 'SET_STATE') {
            this.state[action.key] = action.oldValue;
            this.log(`âª Undo SET_STATE: ${action.description} (${this.formatValue(action.newValue)} â†’ ${this.formatValue(action.oldValue)})`);
        } 
        else if (action.type === 'TRANSACTION') {
            // Ø¨Ø±Ø§ÛŒ transactionÙ‡Ø§ØŒ ØªÙ…Ø§Ù… actions Ø¯Ø§Ø®Ù„ÛŒ Ø±Ø§ undo Ú©Ù† (Ø¨Ø±Ø¹Ú©Ø³ ØªØ±ØªÛŒØ¨)
            for (let i = action.actions.length - 1; i >= 0; i--) {
                const subAction = action.actions[i];
                if (subAction.type === 'SET_STATE') {
                    this.state[subAction.key] = subAction.oldValue;
                }
            }
            this.log(`âª Undo TRANSACTION: ${action.name} (${action.actions.length} action)`);
        }
        
        // Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ future Ø¨Ø±Ø§ÛŒ Ø§Ù…Ú©Ø§Ù† redo
        this.future.unshift(JSON.parse(JSON.stringify(action))); // Deep copy
        
        this.currentIndex--;
        
        // Ù„Ø§Ú¯ undo
        this.actionLog.push({
            id: this.generateId(),
            type: 'UNDO',
            actionId: action.id,
            description: `Undo: ${action.description}`,
            timestamp: Date.now(),
            logType: 'UNDO_PERFORMED'
        });
        
        this.updateVisualizations();
        this.updateControls();
        this.updateHistoryTimeline();
        
        return action;
    },
    
    redo() {
        if (this.future.length === 0) {
            this.log("Ù‡ÛŒÚ† actionØ§ÛŒ Ø¨Ø±Ø§ÛŒ redo ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", 'warning');
            return null;
        }
        
        const action = this.future.shift();
        
        // Ø§Ø¹Ù…Ø§Ù„ Ù…Ø¬Ø¯Ø¯ ØªØºÛŒÛŒØ±
        if (action.type === 'SET_STATE') {
            this.state[action.key] = action.newValue;
            this.log(`â© Redo SET_STATE: ${action.description} (${this.formatValue(action.oldValue)} â†’ ${this.formatValue(action.newValue)})`);
        } 
        else if (action.type === 'TRANSACTION') {
            // Ø¨Ø±Ø§ÛŒ transactionÙ‡Ø§ØŒ ØªÙ…Ø§Ù… actions Ø¯Ø§Ø®Ù„ÛŒ Ø±Ø§ redo Ú©Ù†
            for (const subAction of action.actions) {
                if (subAction.type === 'SET_STATE') {
                    this.state[subAction.key] = subAction.newValue;
                }
            }
            this.log(`â© Redo TRANSACTION: ${action.name} (${action.actions.length} action)`);
        }
        
        this.currentIndex++;
        
        // Ø§Ú¯Ø± history Ú©ÙˆØªØ§Ù‡â€ŒØªØ± Ø§Ø³ØªØŒ extend Ú©Ù†
        if (this.currentIndex >= this.history.length) {
            this.history.push(action);
        } else {
            this.history[this.currentIndex] = action;
        }
        
        // Ù„Ø§Ú¯ redo
        this.actionLog.push({
            id: this.generateId(),
            type: 'REDO',
            actionId: action.id,
            description: `Redo: ${action.description}`,
            timestamp: Date.now(),
            logType: 'REDO_PERFORMED'
        });
        
        this.updateVisualizations();
        this.updateControls();
        this.updateHistoryTimeline();
        
        return action;
    },
    
    // ========== Grouped Actions Ùˆ Transactions ==========
    beginTransaction(name = `Transaction_${Date.now()}`) {
        const transaction = {
            id: this.generateId(),
            name,
            startTime: Date.now(),
            actions: [],
            completed: false
        };
        
        this.transactionStack.push(transaction);
        this.log(`ğŸš€ Ø´Ø±ÙˆØ¹ Transaction: "${name}"`);
        
        // Ù„Ø§Ú¯ Ø´Ø±ÙˆØ¹ transaction
        this.actionLog.push({
            id: this.generateId(),
            type: 'TRANSACTION_START',
            transactionId: transaction.id,
            name: transaction.name,
            timestamp: Date.now(),
            logType: 'TRANSACTION_STARTED'
        });
        
        return transaction.id;
    },
    
    commitTransaction() {
        if (this.transactionStack.length === 0) {
            this.log("Transaction ÙØ¹Ø§Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", 'warning');
            return null;
        }
        
        const transaction = this.transactionStack.pop();
        transaction.endTime = Date.now();
        transaction.completed = true;
        
        // Ù„Ø§Ú¯ commit transaction
        this.actionLog.push({
            id: this.generateId(),
            type: 'TRANSACTION_COMMIT',
            transactionId: transaction.id,
            name: transaction.name,
            actionCount: transaction.actions.length,
            timestamp: Date.now(),
            logType: 'TRANSACTION_COMMITTED'
        });
        
        // Ø§Ú¯Ø± transaction Ø´Ø§Ù…Ù„ action Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© group Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
        if (transaction.actions.length > 0) {
            const groupAction = {
                id: transaction.id,
                type: 'TRANSACTION',
                name: transaction.name,
                actions: JSON.parse(JSON.stringify(transaction.actions)), // Deep copy
                startTime: transaction.startTime,
                endTime: transaction.endTime,
                description: `Transaction: ${transaction.name} (${transaction.actions.length} action)`,
                timestamp: Date.now()
            };
            
            this.addToHistory(groupAction);
            this.log(`âœ… Transaction "${transaction.name}" Ø«Ø¨Øª Ø´Ø¯: ${transaction.actions.length} action`);
        } else {
            this.log(`Transaction "${transaction.name}" Ø¨Ø¯ÙˆÙ† action Ø¨ÙˆØ¯`, 'warning');
        }
        
        return transaction;
    },
    
    rollbackTransaction() {
        if (this.transactionStack.length === 0) {
            this.log("Transaction ÙØ¹Ø§Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", 'warning');
            return null;
        }
        
        const transaction = this.transactionStack.pop();
        
        // Undo Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… actionÙ‡Ø§ÛŒ transaction
        for (let i = transaction.actions.length - 1; i >= 0; i--) {
            const action = transaction.actions[i];
            if (action.type === 'SET_STATE') {
                this.state[action.key] = action.oldValue;
            }
        }
        
        this.log(`â†©ï¸ Transaction "${transaction.name}" rollback Ø´Ø¯: ${transaction.actions.length} action Ù„ØºÙˆ Ø´Ø¯Ù†Ø¯`);
        
        // Ù„Ø§Ú¯ rollback transaction
        this.actionLog.push({
            id: this.generateId(),
            type: 'TRANSACTION_ROLLBACK',
            transactionId: transaction.id,
            name: transaction.name,
            actionCount: transaction.actions.length,
            timestamp: Date.now(),
            logType: 'TRANSACTION_ROLLED_BACK'
        });
        
        this.updateVisualizations();
        
        return transaction;
    },
    
    // ========== Time Travel ==========
    jumpToHistoryIndex(index) {
        if (index < 0 || index >= this.history.length) {
            this.log(`Ø§ÛŒÙ†Ø¯Ú©Ø³ ${index} Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø³Øª`, 'error');
            return false;
        }
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ steps Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
        const steps = Math.abs(index - this.currentIndex);
        
        // Ú¯Ø±ÙØªÙ† snapshot Ø§Ø² state ÙØ¹Ù„ÛŒ
        const currentState = this.getStateSnapshot();
        
        // Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ state Ø§Ø² Ø§Ø¨ØªØ¯Ø§ ØªØ§ index Ù‡Ø¯Ù
        this.state = {};
        
        for (let i = 0; i <= index; i++) {
            const action = this.history[i];
            
            if (action.type === 'SET_STATE') {
                this.state[action.key] = action.newValue;
            } else if (action.type === 'TRANSACTION') {
                // Ø¨Ø±Ø§ÛŒ transactionÙ‡Ø§ØŒ ØªÙ…Ø§Ù… actions Ø¯Ø§Ø®Ù„ÛŒ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†
                for (const subAction of action.actions) {
                    if (subAction.type === 'SET_STATE') {
                        this.state[subAction.key] = subAction.newValue;
                    }
                }
            }
        }
        
        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ future (actions Ø¨Ø¹Ø¯ Ø§Ø² index ÙØ¹Ù„ÛŒ)
        this.future = JSON.parse(JSON.stringify(this.history.slice(index + 1))); // Deep copy
        this.currentIndex = index;
        
        this.log(`ğŸ•’ Time Travel ${steps} step Ø¨Ù‡ action ${index + 1} Ø§Ø² ${this.history.length} (${this.history[index].description})`);
        
        // Ù„Ø§Ú¯ time travel
        this.actionLog.push({
            id: this.generateId(),
            type: 'TIME_TRAVEL',
            targetIndex: index,
            steps,
            description: `Time travel ${steps} step Ø¨Ù‡ Ø§ÛŒÙ†Ø¯Ú©Ø³ ${index}`,
            timestamp: Date.now(),
            logType: 'TIME_TRAVEL_PERFORMED'
        });
        
        this.updateVisualizations();
        this.updateControls();
        this.updateHistoryTimeline();
        
        return { success: true, steps };
    },
    
    jumpToTimestamp(timestamp) {
        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† action Ø¨Ù‡ timestamp Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡
        let closestIndex = -1;
        let minDiff = Infinity;
        
        for (let i = 0; i < this.history.length; i++) {
            const diff = Math.abs(this.history[i].timestamp - timestamp);
            if (diff < minDiff) {
                minDiff = diff;
                closestIndex = i;
            }
        }
        
        if (closestIndex >= 0) {
            return this.jumpToHistoryIndex(closestIndex);
        }
        
        return false;
    },
    
    // ========== Export/Import Ùˆ Replay ==========
    exportHistory() {
        const exportData = {
            history: this.history,
            currentIndex: this.currentIndex,
            state: this.getStateSnapshot(),
            exportTime: Date.now(),
            version: '1.0'
        };
        
        const serialized = JSON.stringify(exportData, null, 2);
        this.log(`ØªØ§Ø±ÛŒØ®Ú†Ù‡ export Ø´Ø¯: ${this.history.length} action`);
        
        return serialized;
    },
    
    importHistory(serialized) {
        try {
            const importData = JSON.parse(serialized);
            
            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø§Ø®ØªØ§Ø±
            if (!importData.history || !Array.isArray(importData.history)) {
                throw new Error('ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
            }
            
            this.history = importData.history;
            this.currentIndex = importData.currentIndex || this.history.length - 1;
            
            // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ State
            if (importData.state) {
                this.state = importData.state;
            }
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† future
            this.future = [];
            
            this.log(`ØªØ§Ø±ÛŒØ®Ú†Ù‡ import Ø´Ø¯: ${this.history.length} action`);
            this.updateVisualizations();
            this.updateControls();
            this.updateHistoryTimeline();
            
            return true;
        } catch (error) {
            this.log(`Ø®Ø·Ø§ Ø¯Ø± import ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${error.message}`, 'error');
            return false;
        }
    },
    
    replayActions(actions, speed = 100) {
        return new Promise((resolve) => {
            this.log(`Ø´Ø±ÙˆØ¹ Replay ${actions.length} action Ø¨Ø§ Ø³Ø±Ø¹Øª ${speed}ms`);
            
            let index = 0;
            const replayInterval = setInterval(() => {
                if (index >= actions.length) {
                    clearInterval(replayInterval);
                    this.log(`Replay Ú©Ø§Ù…Ù„ Ø´Ø¯`);
                    resolve(true);
                    return;
                }
                
                const action = actions[index];
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ action
                if (action.type === 'SET_STATE') {
                    this.state[action.key] = action.newValue;
                    this.log(`Replay [${index + 1}/${actions.length}]: ${action.description}`);
                }
                
                index++;
                this.updateVisualizations();
                
            }, speed);
        });
    },
    
    // ========== Utilities ==========
    generateId() {
        return `act_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    },
    
    getStateSnapshot() {
        return JSON.parse(JSON.stringify(this.state));
    },
    
    formatValue(value) {
        if (value === null) return 'null';
        if (value === undefined) return 'undefined';
        if (typeof value === 'object') return `{${Object.keys(value).length} key}`;
        if (typeof value === 'string') return `"${value.substring(0, 20)}${value.length > 20 ? '...' : ''}"`;
        return String(value);
    },
    
    clearHistory() {
        this.history = [];
        this.future = [];
        this.currentIndex = -1;
        this.actionLog = [];
        this.log("ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù…Ù„Ø§Ù‹ Ù¾Ø§Ú© Ø´Ø¯");
        this.updateVisualizations();
        this.updateControls();
        this.updateHistoryTimeline();
    },
    
    // ========== UI Updates ==========
    updateControls() {
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        
        undoBtn.disabled = this.currentIndex < 0;
        redoBtn.disabled = this.future.length === 0;
        
        undoBtn.innerHTML = `âª Undo (${Math.max(0, this.currentIndex + 1)}/${this.history.length})`;
        redoBtn.innerHTML = `â© Redo (${this.future.length})`;
    },
    
    updateHistoryTimeline() {
        const timeline = document.getElementById('history-timeline');
        timeline.innerHTML = '';
        
        if (this.history.length === 0) {
            timeline.innerHTML = '<div class="history-item">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</div>';
            return;
        }
        
        for (let i = 0; i < this.history.length; i++) {
            const action = this.history[i];
            const item = document.createElement('div');
            item.className = `history-item ${i === this.currentIndex ? 'current' : ''}`;
            
            const time = new Date(action.timestamp).toLocaleTimeString('fa-IR');
            const desc = action.description || action.type;
            
            item.innerHTML = `
                <strong>#${i + 1}</strong> [${time}]: ${desc}
                ${action.type === 'SET_STATE' ? `<br><small>${action.key}: ${this.formatValue(action.oldValue)} â†’ ${this.formatValue(action.newValue)}</small>` : ''}
                ${action.type === 'TRANSACTION' ? `<br><small>${action.actions.length} action Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø´Ø¯Ù‡</small>` : ''}
            `;
            
            // Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ jump Ø¨Ù‡ Ø§ÛŒÙ† action
            item.style.cursor = 'pointer';
            item.addEventListener('click', () => {
                if (i !== this.currentIndex) {
                    this.jumpToHistoryIndex(i);
                }
            });
            
            timeline.appendChild(item);
        }
        
        // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ø¢ÛŒØªÙ… Ø¬Ø§Ø±ÛŒ
        const currentItem = timeline.querySelector('.history-item.current');
        if (currentItem) {
            currentItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    },
    
    updateVisualizations() {
        const visualizer = document.getElementById('state-visualizer');
        const stateKeys = Object.keys(this.state);
        
        if (stateKeys.length === 0) {
            visualizer.innerHTML = '<strong>ğŸ¯ State ÙØ¹Ù„ÛŒ:</strong> Ø®Ø§Ù„ÛŒ';
            return;
        }
        
        let html = `<strong>ğŸ¯ State ÙØ¹Ù„ÛŒ (${stateKeys.length} key):</strong><br>`;
        
        // Ù†Ù…Ø§ÛŒØ´ Ûµ key Ø§ÙˆÙ„
        stateKeys.slice(0, 5).forEach(key => {
            const value = this.state[key];
            html += `<div style="margin-top: 5px;"><strong>${key}:</strong> ${this.formatValue(value)}</div>`;
        });
        
        if (stateKeys.length > 5) {
            html += `<div style="color:#666;margin-top:5px;">Ùˆ ${stateKeys.length - 5} key Ø¯ÛŒÚ¯Ø±...</div>`;
        }
        
        html += `<div style="color:#4db6ac;margin-top:8px;font-size:.8rem;">
            ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${this.history.length} action | UndoÙ‡Ø§: ${this.currentIndex + 1} | RedoÙ‡Ø§: ${this.future.length} | Ù„Ø§Ú¯â€ŒÙ‡Ø§: ${this.actionLog.length}
        </div>`;
        
        visualizer.innerHTML = html;
    },
    
    log(message, type = 'info') {
        const consoleEl = document.getElementById('console');
        const logEntry = document.createElement('div');
        logEntry.className = 'log';
        
        const prefix = type === 'error' ? '[Ø®Ø·Ø§] ' : 
                      type === 'warning' ? '[Ù‡Ø´Ø¯Ø§Ø±] ' : 
                      type === 'success' ? '[Ù…ÙˆÙÙ‚] ' : '';
        
        logEntry.textContent = `${prefix}${message}`;
        
        if (type === 'error') logEntry.style.color = '#ef9a9a';
        if (type === 'warning') logEntry.style.color = '#fff59d';
        if (type === 'success') logEntry.style.color = '#c5e1a5';
        
        consoleEl.appendChild(logEntry);
        consoleEl.scrollTop = consoleEl.scrollHeight;
        console.log(`[UndoRedo] ${message}`);
    },
    
    clear() {
        this.state = {};
        this.history = [];
        this.future = [];
        this.currentIndex = -1;
        this.transactionStack = [];
        this.actionLog = [];
        this.log("Ø³ÛŒØ³ØªÙ… Undo/Redo Ù¾Ø§Ú© Ø´Ø¯");
        this.updateVisualizations();
        this.updateControls();
        this.updateHistoryTimeline();
    }
};

// ========== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo ==========
const undoRedoTests = [
    {
        id: 'test1',
        name: 'Undo/Redo Ù¾Ø§ÛŒÙ‡ Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚',
        run: async () => {
            UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Undo/Redo Ù¾Ø§ÛŒÙ‡ ===");
            UndoRedoManager.clear();
            
            // Û±. ØªØ³Øª Ø§ÛŒØ¬Ø§Ø¯ Ú†Ù†Ø¯ÛŒÙ† ØªØºÛŒÛŒØ±
            UndoRedoManager.setState('user', 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª', { description: 'ØªÙ†Ø¸ÛŒÙ… Ú©Ø§Ø±Ø¨Ø±' });
            UndoRedoManager.setState('score', 0, { description: 'Ø´Ø±ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø²' });
            UndoRedoManager.setState('level', 1, { description: 'Ø´Ø±ÙˆØ¹ Ø³Ø·Ø­' });
            UndoRedoManager.setState('score', 50, { description: 'Ø§ÙØ²Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø²' });
            UndoRedoManager.setState('level', 2, { description: 'Ø§Ø±ØªÙ‚Ø§Ø¡ Ø³Ø·Ø­' });
            
            // Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ûµ action Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§Ø´Ø¯
            if (UndoRedoManager.history.length !== 5) {
                throw new Error(`ØªØ¹Ø¯Ø§Ø¯ actions ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: 5ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${UndoRedoManager.history.length}`);
            }
            
            // Û². ØªØ³Øª Undo
            const undo1 = UndoRedoManager.undo(); // Ø¨Ø§ÛŒØ¯ level Ø±Ø§ Ø§Ø² 2 Ø¨Ù‡ 1 Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯
            if (!undo1 || undo1.description !== 'Ø§Ø±ØªÙ‚Ø§Ø¡ Ø³Ø·Ø­') {
                throw new Error('Undo Ø§ÙˆÙ„ Ø§Ø´ØªØ¨Ø§Ù‡ Ø¹Ù…Ù„ Ú©Ø±Ø¯');
            }
            if (UndoRedoManager.state.level !== 1) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² undoØŒ level Ø¨Ø§ÛŒØ¯ 1 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.level} Ø§Ø³Øª`);
            }
            
            const undo2 = UndoRedoManager.undo(); // Ø¨Ø§ÛŒØ¯ score Ø±Ø§ Ø§Ø² 50 Ø¨Ù‡ 0 Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯
            if (UndoRedoManager.state.score !== 0) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² undo Ø¯ÙˆÙ…ØŒ score Ø¨Ø§ÛŒØ¯ 0 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.score} Ø§Ø³Øª`);
            }
            
            // Û³. ØªØ³Øª Redo
            const redo1 = UndoRedoManager.redo(); // Ø¨Ø§ÛŒØ¯ score Ø±Ø§ Ø¨Ù‡ 50 Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯
            if (!redo1 || redo1.description !== 'Ø§ÙØ²Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø²') {
                throw new Error('Redo Ø§ÙˆÙ„ Ø§Ø´ØªØ¨Ø§Ù‡ Ø¹Ù…Ù„ Ú©Ø±Ø¯');
            }
            if (UndoRedoManager.state.score !== 50) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² redoØŒ score Ø¨Ø§ÛŒØ¯ 50 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.score} Ø§Ø³Øª`);
            }
            
            // Û´. ØªØ³Øª Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚ ØªØ§Ø±ÛŒØ®Ú†Ù‡
            UndoRedoManager.maxHistorySize = 3;
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† actions Ø¨ÛŒØ´ØªØ± Ø§Ø² limit
            UndoRedoManager.setState('coins', 100, { description: 'Ø§ÙØ²Ø§ÛŒØ´ Ø³Ú©Ù‡â€ŒÙ‡Ø§' });
            UndoRedoManager.setState('coins', 150, { description: 'Ø§ÙØ²Ø§ÛŒØ´ Ø¨ÛŒØ´ØªØ± Ø³Ú©Ù‡â€ŒÙ‡Ø§' });
            UndoRedoManager.setState('coins', 200, { description: 'Ø­Ø¯Ø§Ú©Ø«Ø± Ø³Ú©Ù‡â€ŒÙ‡Ø§' });
            
            // Ø¨Ø§ÛŒØ¯ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ù‡ Û³ action Ù…Ø­Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ (Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ†â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯)
            if (UndoRedoManager.history.length !== 3) {
                throw new Error(`Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±Ø¹Ø§ÛŒØª Ù†Ø´Ø¯. Ø§Ù†ØªØ¸Ø§Ø±: 3ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${UndoRedoManager.history.length}`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† actionÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
            const remainingActions = UndoRedoManager.history.map(a => a.description);
            if (!remainingActions.includes('Ø­Ø¯Ø§Ú©Ø«Ø± Ø³Ú©Ù‡â€ŒÙ‡Ø§') || 
                !remainingActions.includes('Ø§ÙØ²Ø§ÛŒØ´ Ø¨ÛŒØ´ØªØ± Ø³Ú©Ù‡â€ŒÙ‡Ø§') ||
                !remainingActions.includes('Ø§ÙØ²Ø§ÛŒØ´ Ø³Ú©Ù‡â€ŒÙ‡Ø§')) {
                throw new Error('Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† actions Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø­Ø°Ù Ù†Ø´Ø¯Ù†Ø¯');
            }
            
            // Ûµ. ØªØ³Øª Undo ØªÙ…Ø§Ù… actions
            let undoCount = 0;
            while (UndoRedoManager.currentIndex >= 0) {
                UndoRedoManager.undo();
                undoCount++;
            }
            
            if (undoCount !== 3) {
                throw new Error(`Ø¨Ø§ÛŒØ¯ 3 Ø¨Ø§Ø± Undo Ø´ÙˆØ¯ØŒ Ø§Ù…Ø§ ${undoCount} Ø¨Ø§Ø± Undo Ø´Ø¯`);
            }
            
            if (UndoRedoManager.currentIndex !== -1) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² undo Ù‡Ù…Ù‡ actionsØŒ currentIndex Ø¨Ø§ÛŒØ¯ -1 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.currentIndex} Ø§Ø³Øª`);
            }
            
            // Û¶. ØªØ³Øª Redo ØªÙ…Ø§Ù… actions
            let redoCount = 0;
            while (UndoRedoManager.future.length > 0) {
                UndoRedoManager.redo();
                redoCount++;
            }
            
            if (redoCount !== 3) {
                throw new Error(`Ø¨Ø§ÛŒØ¯ 3 Ø¨Ø§Ø± Redo Ø´ÙˆØ¯ØŒ Ø§Ù…Ø§ ${redoCount} Ø¨Ø§Ø± Redo Ø´Ø¯`);
            }
            
            if (UndoRedoManager.future.length !== 0) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² redo Ù‡Ù…Ù‡ actionsØŒ future Ø¨Ø§ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.future.length} Ø¢ÛŒØªÙ… Ø¯Ø§Ø±Ø¯`);
            }
            
            // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† limit Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡
            UndoRedoManager.maxHistorySize = 50;
            
            UndoRedoManager.log("âœ… ØªØ³Øª Undo/Redo Ù¾Ø§ÛŒÙ‡ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯", 'success');
            
            return `âœ… Undo/Redo Ù¾Ø§ÛŒÙ‡ ØµØ­ÛŒØ­ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (Ûµ action Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ØŒ Ø¹Ù…Ù‚ Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ù‡ Û³)`;
        }
    },
    {
        id: 'test2',
        name: 'Grouped Actions Ùˆ Transactions',
        run: async () => {
            UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Grouped Actions ===");
            UndoRedoManager.clear();
            
            // Û±. Ø´Ø±ÙˆØ¹ ÛŒÚ© transaction
            const transactionId = UndoRedoManager.beginTransaction('Ø®Ø±ÛŒØ¯ Ø¯Ø±Ø³ Ø²Ø¨Ø§Ù†');
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† actions Ø¨Ù‡ transaction
            UndoRedoManager.setState('cart', [], { description: 'Ø®Ø§Ù„ÛŒ Ú©Ø±Ø¯Ù† Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯' });
            UndoRedoManager.setState('total', 0, { description: 'ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬Ù…ÙˆØ¹' });
            UndoRedoManager.setState('cart', ['Ø¯Ø±Ø³ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ù…Ù‚Ø¯Ù…Ø§ØªÛŒ'], { description: 'Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø³ Ø¨Ù‡ Ø³Ø¨Ø¯' });
            UndoRedoManager.setState('total', 50, { description: 'Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø¬Ù…ÙˆØ¹' });
            UndoRedoManager.setState('userCoins', 100, { description: 'ØªÙ†Ø¸ÛŒÙ… Ø³Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø±' });
            UndoRedoManager.setState('userCoins', 50, { description: 'Ú©Ø³Ø± Ù‡Ø²ÛŒÙ†Ù‡ Ø®Ø±ÛŒØ¯' });
            
            // Û². commit transaction
            const transaction = UndoRedoManager.commitTransaction();
            
            if (!transaction) {
                throw new Error('Transaction commit Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
            }
            
            if (transaction.actions.length !== 6) {
                throw new Error(`ØªØ¹Ø¯Ø§Ø¯ actions Ø¯Ø± transaction Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: 6ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${transaction.actions.length}`);
            }
            
            // Û³. Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ transaction Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© action Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø«Ø¨Øª Ø´Ø¯Ù‡
            const lastAction = UndoRedoManager.history[UndoRedoManager.history.length - 1];
            if (lastAction.type !== 'TRANSACTION') {
                throw new Error('Transaction Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯');
            }
            
            // Û´. Undo Ú©Ø±Ø¯Ù† transaction (Ø¨Ø§ÛŒØ¯ ØªÙ…Ø§Ù… 6 action Ø¨Ø§ ÛŒÚ© Undo Ø¨Ø±Ú¯Ø±Ø¯Ù†Ø¯)
            const undoResult = UndoRedoManager.undo();
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ transaction undo Ø´Ø¯
            if (!undoResult || undoResult.type !== 'TRANSACTION') {
                throw new Error('Undo transaction Ø¨Ø§ÛŒØ¯ ÛŒÚ© transaction Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯');
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ú¯Ø´Øª stateÙ‡Ø§ - userCoins Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ 100 Ø¨Ø±Ú¯Ø±Ø¯Ø¯
            if (UndoRedoManager.state.userCoins !== 100) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² undo transactionØŒ userCoins Ø¨Ø§ÛŒØ¯ 100 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.userCoins} Ø§Ø³Øª`);
            }
            
            // cart Ø¨Ø§ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø´ÙˆØ¯
            if (!Array.isArray(UndoRedoManager.state.cart) || UndoRedoManager.state.cart.length !== 0) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² undo transactionØŒ cart Ø¨Ø§ÛŒØ¯ [] Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${JSON.stringify(UndoRedoManager.state.cart)} Ø§Ø³Øª`);
            }
            
            // Ûµ. Redo Ú©Ø±Ø¯Ù† transaction
            UndoRedoManager.redo();
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ stateÙ‡Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù†Ø¯
            if (UndoRedoManager.state.userCoins !== 50) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² redo transactionØŒ userCoins Ø¨Ø§ÛŒØ¯ 50 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.userCoins} Ø§Ø³Øª`);
            }
            
            // Û¶. ØªØ³Øª nested transactions
            UndoRedoManager.beginTransaction('ØªØ±Ø§Ú©Ù†Ø´ ÙˆØ§Ù„Ø¯');
            UndoRedoManager.setState('parent', 'Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ù„Ø¯', { description: 'ØªÙ†Ø¸ÛŒÙ… ÙˆØ§Ù„Ø¯' });
            
            UndoRedoManager.beginTransaction('ØªØ±Ø§Ú©Ù†Ø´ ÙØ±Ø²Ù†Ø¯');
            UndoRedoManager.setState('child', 'Ù…Ù‚Ø¯Ø§Ø± ÙØ±Ø²Ù†Ø¯', { description: 'ØªÙ†Ø¸ÛŒÙ… ÙØ±Ø²Ù†Ø¯' });
            UndoRedoManager.commitTransaction(); // commit ÙØ±Ø²Ù†Ø¯
            
            UndoRedoManager.setState('parent', 'Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ù„Ø¯ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡', { description: 'ØªØºÛŒÛŒØ± ÙˆØ§Ù„Ø¯' });
            UndoRedoManager.commitTransaction(); // commit ÙˆØ§Ù„Ø¯
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ transaction
            const transactionLogs = UndoRedoManager.actionLog.filter(log => 
                log.logType && log.logType.includes('TRANSACTION')
            );
            
            // Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Ûµ Ù„Ø§Ú¯ transaction Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ…: Ø´Ø±ÙˆØ¹/Ú©Ø§Ù…ÛŒØª Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ùˆ + Ø´Ø±ÙˆØ¹ Ú©Ù„ÛŒ
            if (transactionLogs.length < 5) {
                throw new Error(`Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ transaction Ú©Ø§ÙÛŒ Ù†ÛŒØ³ØªÙ†Ø¯. Ø§Ù†ØªØ¸Ø§Ø± Ø­Ø¯Ø§Ù‚Ù„ ÛµØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${transactionLogs.length}`);
            }
            
            UndoRedoManager.log("âœ… ØªØ³Øª Grouped Actions Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯", 'success');
            
            return `âœ… Transactions ØµØ­ÛŒØ­ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ (Û¶ action Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒØŒ userCoins Ø§Ø² ÛµÛ° Ø¨Ù‡ Û±Û°Û° Ø¨Ø±Ú¯Ø´Øª)`;
        }
    },
    {
        id: 'test3',
        name: 'Time Travel Ùˆ Export/Import ØªØ§Ø±ÛŒØ®Ú†Ù‡',
        run: async () => {
            UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Time Travel ===");
            UndoRedoManager.clear();
            
            // Û±. Ø§ÛŒØ¬Ø§Ø¯ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ³Øª
            UndoRedoManager.setState('step', 0, { description: 'Ø´Ø±ÙˆØ¹ Ø§Ø² ØµÙØ±' });
            UndoRedoManager.setState('step', 1, { description: 'Ù‚Ø¯Ù… Ø§ÙˆÙ„' });
            UndoRedoManager.setState('step', 2, { description: 'Ù‚Ø¯Ù… Ø¯ÙˆÙ…' });
            UndoRedoManager.setState('step', 3, { description: 'Ù‚Ø¯Ù… Ø³ÙˆÙ…' });
            UndoRedoManager.setState('step', 4, { description: 'Ù‚Ø¯Ù… Ú†Ù‡Ø§Ø±Ù…' });
            
            if (UndoRedoManager.history.length !== 5) {
                throw new Error(`ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§ÛŒØ¯ Ûµ action Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.history.length} Ø¯Ø§Ø±Ø¯`);
            }
            
            // Û². Jump Ø¨Ù‡ index 2
            const initialIndex = UndoRedoManager.currentIndex; // Ø¨Ø§ÛŒØ¯ 4 Ø¨Ø§Ø´Ø¯
            const jumpResult = UndoRedoManager.jumpToHistoryIndex(2);
            
            if (!jumpResult || !jumpResult.success) {
                throw new Error('Jump Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ steps Ú¯Ø²Ø§Ø±Ø´ Ø´Ø¯Ù‡
            const expectedSteps = Math.abs(2 - initialIndex); // |2-4| = 2
            if (jumpResult.steps !== 2) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² jump Ø¨Ù‡ index 2ØŒ steps Ø¨Ø§ÛŒØ¯ 2 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${jumpResult.steps} Ø§Ø³Øª`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ state ÙØ¹Ù„ÛŒ
            if (UndoRedoManager.state.step !== 2) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² jump Ø¨Ù‡ index 2ØŒ step Ø¨Ø§ÛŒØ¯ 2 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.step} Ø§Ø³Øª`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ currentIndex
            if (UndoRedoManager.currentIndex !== 2) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² jumpØŒ currentIndex Ø¨Ø§ÛŒØ¯ 2 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.currentIndex} Ø§Ø³Øª`);
            }
            
            // Û³. Export ØªØ§Ø±ÛŒØ®Ú†Ù‡
            const exported = UndoRedoManager.exportHistory();
            if (!exported || exported.length === 0) {
                throw new Error('Export ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
            }
            
            // Û´. Ø§ÛŒØ¬Ø§Ø¯ ØªØºÛŒÛŒØ± Ø¬Ø¯ÛŒØ¯ (Ø¨Ø§ÛŒØ¯ future Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†Ø¯)
            UndoRedoManager.setState('newKey', 'Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯', { description: 'ØªØºÛŒÛŒØ± Ø¬Ø¯ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² jump' });
            
            // Ûµ. Import ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù‚Ø¨Ù„ÛŒ
            const importResult = UndoRedoManager.importHistory(exported);
            if (!importResult) {
                throw new Error('Import ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ Ø¨Ù‡ state Ù‚Ø¨Ù„ Ø§Ø² ØªØºÛŒÛŒØ± Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ú¯Ø´ØªÛŒÙ…
            if (UndoRedoManager.state.newKey !== undefined) {
                throw new Error('Ø¨Ø¹Ø¯ Ø§Ø² importØŒ newKey Ø¨Ø§ÛŒØ¯ undefined Ø¨Ø§Ø´Ø¯');
            }
            
            if (UndoRedoManager.state.step !== 2) {
                throw new Error('Ø¨Ø¹Ø¯ Ø§Ø² importØŒ step Ø¨Ø§ÛŒØ¯ 2 Ø¨Ø§Ø´Ø¯');
            }
            
            // Û¶. ØªØ³Øª jump Ø¨Ù‡ timestamp
            const firstActionTime = UndoRedoManager.history[0].timestamp;
            const jumpToTimeResult = UndoRedoManager.jumpToTimestamp(firstActionTime);
            
            if (!jumpToTimeResult) {
                throw new Error('Jump Ø¨Ù‡ timestamp Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
            }
            
            // Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø§ÙˆÙ„ÛŒÙ† action Ø¨Ø±Ú¯Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ…
            if (UndoRedoManager.currentIndex !== 0) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² jump Ø¨Ù‡ timestamp Ø§ÙˆÙ„ØŒ currentIndex Ø¨Ø§ÛŒØ¯ 0 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.currentIndex} Ø§Ø³Øª`);
            }
            
            UndoRedoManager.log("âœ… ØªØ³Øª Time Travel Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯", 'success');
            
            return `âœ… Time Travel ØµØ­ÛŒØ­ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (Jump Û² stepØŒ Export/Import ØªØ§Ø±ÛŒØ®Ú†Ù‡)`;
        }
    },
    {
        id: 'test4',
        name: 'Action Logging Ùˆ Replay',
        run: async () => {
            UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Action Logging ===");
            UndoRedoManager.clear();
            
            // Û±. Ø§ÛŒØ¬Ø§Ø¯ Ú†Ù†Ø¯ÛŒÙ† transaction Ù…Ø®ØªÙ„Ù
            UndoRedoManager.beginTransaction('ØªØ±Ø§Ú©Ù†Ø´ Ø§ÙˆÙ„');
            UndoRedoManager.setState('t1_a', 'Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„Ù', { description: 'ØªÙ†Ø¸ÛŒÙ… Ø§Ù„Ù' });
            UndoRedoManager.setState('t1_b', 'Ù…Ù‚Ø¯Ø§Ø± Ø¨', { description: 'ØªÙ†Ø¸ÛŒÙ… Ø¨' });
            UndoRedoManager.commitTransaction();
            
            UndoRedoManager.beginTransaction('ØªØ±Ø§Ú©Ù†Ø´ Ø¯ÙˆÙ…');
            UndoRedoManager.setState('t2_a', 'Ù…Ù‚Ø¯Ø§Ø± Ø¬', { description: 'ØªÙ†Ø¸ÛŒÙ… Ø¬' });
            UndoRedoManager.rollbackTransaction(); // rollback Ø§ÛŒÙ† transaction
            
            UndoRedoManager.beginTransaction('ØªØ±Ø§Ú©Ù†Ø´ Ø³ÙˆÙ…');
            UndoRedoManager.setState('t3_a', 'Ù…Ù‚Ø¯Ø§Ø± Ø¯', { description: 'ØªÙ†Ø¸ÛŒÙ… Ø¯' });
            UndoRedoManager.commitTransaction();
            
            // Û². Undo/Redo Ú©Ø±Ø¯Ù†
            UndoRedoManager.undo(); // Undo ØªØ±Ø§Ú©Ù†Ø´ Ø³ÙˆÙ…
            UndoRedoManager.redo(); // Redo ØªØ±Ø§Ú©Ù†Ø´ Ø³ÙˆÙ…
            
            // Û³. Ø¨Ø±Ø±Ø³ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§
            const transactionLogs = UndoRedoManager.actionLog.filter(log => 
                log.logType && log.logType.includes('TRANSACTION')
            );
            
            // Ø¨Ø§ÛŒØ¯ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ…:
            // Û±. Ø´Ø±ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´ Ø§ÙˆÙ„
            // Û². Ú©Ø§Ù…ÛŒØª ØªØ±Ø§Ú©Ù†Ø´ Ø§ÙˆÙ„
            // Û³. Ø´Ø±ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´ Ø¯ÙˆÙ…  
            // Û´. rollback ØªØ±Ø§Ú©Ù†Ø´ Ø¯ÙˆÙ…
            // Ûµ. Ø´Ø±ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´ Ø³ÙˆÙ…
            // Û¶. Ú©Ø§Ù…ÛŒØª ØªØ±Ø§Ú©Ù†Ø´ Ø³ÙˆÙ…
            // Ù…Ø¬Ù…ÙˆØ¹: Û¶ Ù„Ø§Ú¯ transaction
            
            if (transactionLogs.length < 6) {
                throw new Error(`Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ transaction Ú©Ø§ÙÛŒ Ù†ÛŒØ³ØªÙ†Ø¯. Ø§Ù†ØªØ¸Ø§Ø± Ø­Ø¯Ø§Ù‚Ù„ Û¶ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${transactionLogs.length}`);
            }
            
            // Û´. Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†ÙˆØ§Ø¹ Ù„Ø§Ú¯â€ŒÙ‡Ø§
            const logTypes = transactionLogs.map(log => log.logType);
            const startedCount = logTypes.filter(type => type === 'TRANSACTION_STARTED').length;
            const committedCount = logTypes.filter(type => type === 'TRANSACTION_COMMITTED').length;
            const rolledBackCount = logTypes.filter(type => type === 'TRANSACTION_ROLLED_BACK').length;
            
            if (startedCount < 3) {
                throw new Error(`Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û³ Ù„Ø§Ú¯ TRANSACTION_STARTED Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ…ØŒ Ø§Ù…Ø§ ${startedCount} Ø¯Ø§Ø±ÛŒÙ…`);
            }
            
            if (committedCount < 2) { // ØªØ±Ø§Ú©Ù†Ø´ Ø§ÙˆÙ„ Ùˆ Ø³ÙˆÙ…
                throw new Error(`Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û² Ù„Ø§Ú¯ TRANSACTION_COMMITTED Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ…ØŒ Ø§Ù…Ø§ ${committedCount} Ø¯Ø§Ø±ÛŒÙ…`);
            }
            
            if (rolledBackCount < 1) { // ØªØ±Ø§Ú©Ù†Ø´ Ø¯ÙˆÙ…
                throw new Error(`Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û± Ù„Ø§Ú¯ TRANSACTION_ROLLED_BACK Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ…ØŒ Ø§Ù…Ø§ ${rolledBackCount} Ø¯Ø§Ø±ÛŒÙ…`);
            }
            
            // Ûµ. ØªØ³Øª Replay
            const testActions = [
                {
                    type: 'SET_STATE',
                    key: 'replay_1',
                    newValue: 'Ù…Ù‚Ø¯Ø§Ø± ØªØ³Øª Û±',
                    description: 'ØªØ³Øª replay 1'
                },
                {
                    type: 'SET_STATE',
                    key: 'replay_2', 
                    newValue: 'Ù…Ù‚Ø¯Ø§Ø± ØªØ³Øª Û²',
                    description: 'ØªØ³Øª replay 2'
                },
                {
                    type: 'SET_STATE',
                    key: 'replay_3',
                    newValue: 'Ù…Ù‚Ø¯Ø§Ø± ØªØ³Øª Û³',
                    description: 'ØªØ³Øª replay 3'
                }
            ];
            
            await UndoRedoManager.replayActions(testActions, 50);
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ actions replay Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
            if (UndoRedoManager.state.replay_1 !== 'Ù…Ù‚Ø¯Ø§Ø± ØªØ³Øª Û±' ||
                UndoRedoManager.state.replay_2 !== 'Ù…Ù‚Ø¯Ø§Ø± ØªØ³Øª Û²' ||
                UndoRedoManager.state.replay_3 !== 'Ù…Ù‚Ø¯Ø§Ø± ØªØ³Øª Û³') {
                throw new Error('Replay actions Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø§Ø¬Ø±Ø§ Ù†Ø´Ø¯Ù†Ø¯');
            }
            
            // Û¶. Ø¨Ø±Ø±Ø³ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒ
            const totalLogs = UndoRedoManager.actionLog.length;
            if (totalLogs < 20) { // Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ actions Ù…Ø®ØªÙ„Ù
                throw new Error(`ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ú©Ù… Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø± Ø­Ø¯Ø§Ù‚Ù„ Û²Û°ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${totalLogs}`);
            }
            
            UndoRedoManager.log("âœ… ØªØ³Øª Action Logging Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯", 'success');
            
            return `âœ… Action Logging ØµØ­ÛŒØ­ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (${transactionLogs.length} Ù„Ø§Ú¯ transactionØŒ ${totalLogs} Ù„Ø§Ú¯ Ú©Ù„ÛŒ)`;
        }
    }
];

// ========== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ==========
async function runAllTests() {
    const runBtn = document.getElementById('run-btn');
    runBtn.disabled = true;
    runBtn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§...';
    
    // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ù†Ø³ÙˆÙ„
    document.getElementById('console').innerHTML = '<div class="log">[Ø³ÛŒØ³ØªÙ…] Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo</div>';
    
    UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo ===");
    
    let passed = 0;
    
    for (let i = 0; i < undoRedoTests.length; i++) {
        const test = undoRedoTests[i];
        const testElement = document.getElementById(test.id);
        const statusElement = document.getElementById(`status${i+1}`);
        const outputElement = document.getElementById(`output${i+1}`);
        
        // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§
        testElement.className = 'test-item running';
        statusElement.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§';
        statusElement.className = 'test-status status-running';
        outputElement.innerHTML = '<span style="color:#666">Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ...</span>';
        
        try {
            UndoRedoManager.log(`Ø´Ø±ÙˆØ¹ ØªØ³Øª: ${test.name}`);
            
            // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± ØªØ³Øª
            UndoRedoManager.clear();
            
            const result = await test.run();
            
            // ØªØ³Øª Ù…ÙˆÙÙ‚
            testElement.className = 'test-item passed';
            statusElement.textContent = 'Ù…ÙˆÙÙ‚';
            statusElement.className = 'test-status status-passed';
            outputElement.innerHTML = `<div style="color:#2e7d32">${result}</div>`;
            passed++;
            
            UndoRedoManager.log(`ØªØ³Øª "${test.name}" Ù…ÙˆÙÙ‚`, 'success');
            
        } catch (error) {
            // ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚
            testElement.className = 'test-item failed';
            statusElement.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
            statusElement.className = 'test-status status-failed';
            outputElement.innerHTML = `<div style="color:#c62828"><strong>âŒ Ø®Ø·Ø§:</strong> ${error.message}</div>`;
            
            UndoRedoManager.log(`ØªØ³Øª "${test.name}" Ù†Ø§Ù…ÙˆÙÙ‚: ${error.message}`, 'error');
        }
        
        // ØªØ§Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡ Ø¨ÛŒÙ† ØªØ³Øªâ€ŒÙ‡Ø§
        await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    runBtn.disabled = false;
    runBtn.textContent = `ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ (${passed}/${undoRedoTests.length} Ù…ÙˆÙÙ‚)`;
    
    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
    if (passed === undoRedoTests.length) {
        UndoRedoManager.log("ğŸ‰ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø´Øª Ø³Ø± Ú¯Ø°Ø§Ø´ØªÙ‡ Ø´Ø¯Ù†Ø¯!", 'success');
        UndoRedoManager.log("âœ… Ø³ÛŒØ³ØªÙ… Undo/Redo Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Vakamova Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.", 'success');
    } else {
        UndoRedoManager.log(`ØªØ³Øªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù†Ø¯: ${passed} Ø§Ø² ${undoRedoTests.length} Ù…ÙˆÙÙ‚`, 
                           passed >= 3 ? 'success' : 'warning');
    }
}

// ========== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ==========
document.addEventListener('DOMContentLoaded', () => {
    // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
    document.getElementById('run-btn').addEventListener('click', runAllTests);
    document.getElementById('undo-btn').addEventListener('click', () => UndoRedoManager.undo());
    document.getElementById('redo-btn').addEventListener('click', () => UndoRedoManager.redo());
    document.getElementById('clear-history-btn').addEventListener('click', () => UndoRedoManager.clearHistory());
    document.getElementById('jump-to-btn').addEventListener('click', () => {
        const index = prompt('Ø¨Ù‡ Ú©Ø¯Ø§Ù… Ø§ÛŒÙ†Ø¯Ú©Ø³ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø±ÙˆÛŒÙ…ØŸ (Û° ØªØ§ ' + (UndoRedoManager.history.length - 1) + ')');
        if (index !== null) {
            const idx = parseInt(index);
            if (!isNaN(idx)) {
                UndoRedoManager.jumpToHistoryIndex(idx);
            }
        }
    });
    
    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ø±Ø¨Ø±
    document.getElementById('run-simulation-btn').addEventListener('click', async () => {
        UndoRedoManager.clear();
        UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ø±Ø¨Ø± ===");
        
        // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø±ÛŒØ¯ Ø¯Ø±Ø³
        UndoRedoManager.beginTransaction('Ø®Ø±ÛŒØ¯ Ø¯Ø±Ø³ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ');
        await new Promise(r => setTimeout(r, 300));
        UndoRedoManager.setState('coins', 1000, { description: 'Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„' });
        await new Promise(r => setTimeout(r, 300));
        UndoRedoManager.setState('cart', ['Ø¯Ø±Ø³ Ù…Ù‚Ø¯Ù…Ø§ØªÛŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ'], { description: 'Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯' });
        await new Promise(r => setTimeout(r, 300));
        UndoRedoManager.setState('coins', 900, { description: 'Ù¾Ø±Ø¯Ø§Ø®Øª Û±Û°Û° Ø³Ú©Ù‡' });
        await new Promise(r => setTimeout(r, 300));
        UndoRedoManager.setState('lessons', ['Ø¯Ø±Ø³ Ù…Ù‚Ø¯Ù…Ø§ØªÛŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ'], { description: 'Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡' });
        await new Promise(r => setTimeout(r, 300));
        UndoRedoManager.commitTransaction();
        
        // Undo Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ
        await new Promise(r => setTimeout(r, 500));
        UndoRedoManager.log("Ú©Ø§Ø±Ø¨Ø± Ø®Ø±ÛŒØ¯ Ø±Ø§ Undo Ù…ÛŒâ€ŒÚ©Ù†Ø¯...");
        UndoRedoManager.undo();
        
        // Redo
        await new Promise(r => setTimeout(r, 500));
        UndoRedoManager.log("Ú©Ø§Ø±Ø¨Ø± Ø®Ø±ÛŒØ¯ Ø±Ø§ Redo Ù…ÛŒâ€ŒÚ©Ù†Ø¯...");
        UndoRedoManager.redo();
        
        UndoRedoManager.log("âœ… Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯");
    });
    
    UndoRedoManager.log("Ø³ÛŒØ³ØªÙ… ØªØ³Øª Undo/Redo + Time Travel Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.");
    UndoRedoManager.log("Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ 'Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.");
    UndoRedoManager.updateVisualizations();
});
</script>
</body>
    </html>
