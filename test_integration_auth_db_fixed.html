<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ Auth + Database - Vakamova (Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡)</title>
    <style>
        :root {
            --primary: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f8fafc;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', 'Vazirmatn', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.8;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 5px solid rgba(255, 255, 255, 0.2);
        }
        
        header h1 {
            font-size: 2.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .badge {
            background: var(--success);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .integration-flow {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px;
            background: var(--light);
            border-bottom: 2px solid #e2e8f0;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .module-box {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 180px;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .module-box.active {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(79, 70, 229, 0.25);
        }
        
        .module-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
        }
        
        .arrow {
            font-size: 2rem;
            color: var(--primary);
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            padding: 35px;
        }
        
        .test-card {
            background: white;
            border-radius: 18px;
            padding: 30px;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.08);
            border: 3px solid transparent;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .test-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            background: #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .test-card.passed::before {
            background: var(--success);
        }
        
        .test-card.failed::before {
            background: var(--danger);
        }
        
        .test-card.pending::before {
            background: var(--warning);
        }
        
        .test-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
        }
        
        .test-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .test-number {
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .test-result {
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        
        .passed .test-result {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
        }
        
        .failed .test-result {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
        }
        
        .pending .test-result {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
        }
        
        .test-desc {
            color: #6b7280;
            margin-bottom: 25px;
            font-size: 1.05rem;
            line-height: 1.7;
        }
        
        .test-details {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .test-card.active .test-details {
            display: block;
            animation: slideDown 0.5s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .test-output {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', 'Monaco', monospace;
            font-size: 0.95rem;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            direction: ltr;
            text-align: left;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .test-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 25px 35px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-top: 3px solid #e2e8f0;
        }
        
        .stat {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        
        .stat:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
        }
        
        .stat-value {
            font-size: 2.8rem;
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }
        
        .stat-label {
            font-size: 1rem;
            color: #6b7280;
            font-weight: 600;
        }
        
        .stat.passed .stat-value { color: var(--success); }
        .stat.failed .stat-value { color: var(--danger); }
        .stat.pending .stat-value { color: var(--warning); }
        .stat.coverage .stat-value { color: var(--primary); }
        
        .action-bar {
            display: flex;
            justify-content: center;
            gap: 25px;
            padding: 30px;
            border-top: 3px solid #e2e8f0;
            background: white;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            min-width: 220px;
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(79, 70, 229, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.3);
        }
        
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .test-grid {
                grid-template-columns: 1fr;
                padding: 20px;
            }
            
            .test-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            header h1 {
                font-size: 1.8rem;
                flex-direction: column;
                gap: 10px;
            }
            
            .integration-flow {
                flex-direction: column;
            }
            
            .arrow {
                transform: rotate(90deg);
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <span>ğŸ”— ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ Auth + Database</span>
                <span class="badge">Vakamova - Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡</span>
            </h1>
            <p>Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø§Ù…Ù„ Ú©Ø§Ù…Ù„ Ø¨ÛŒÙ† Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ùˆ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ (ØªØ³Øª 6 Ø§ØµÙ„Ø§Ø­ Ø´Ø¯)</p>
        </header>
        
        <div class="integration-flow">
            <div class="module-box active" id="auth-module">
                <span class="module-icon">ğŸ”</span>
                <h3>Auth Manager</h3>
                <div class="module-status">Ø¢Ù…Ø§Ø¯Ù‡</div>
            </div>
            <div class="arrow">â‡„</div>
            <div class="module-box" id="db-module">
                <span class="module-icon">ğŸ—„ï¸</span>
                <h3>Database</h3>
                <div class="module-status">Ù…Ù†ØªØ¸Ø±</div>
            </div>
            <div class="arrow">â‡„</div>
            <div class="module-box" id="state-module">
                <span class="module-icon">ğŸ“Š</span>
                <h3>State Manager</h3>
                <div class="module-status">Ù…Ù†ØªØ¸Ø±</div>
            </div>
        </div>
        
        <div class="test-grid" id="test-grid">
            <!-- ØªØ³Øªâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù†Ø¯Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>
        
        <div class="test-stats">
            <div class="stat passed">
                <span class="stat-value" id="passed-count">0</span>
                <span class="stat-label">Ù…ÙˆÙÙ‚</span>
            </div>
            <div class="stat failed">
                <span class="stat-value" id="failed-count">0</span>
                <span class="stat-label">Ù†Ø§Ù…ÙˆÙÙ‚</span>
            </div>
            <div class="stat pending">
                <span class="stat-value" id="pending-count">6</span>
                <span class="stat-label">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
            </div>
            <div class="stat coverage">
                <span class="stat-value" id="coverage">0%</span>
                <span class="stat-label">Ù¾ÙˆØ´Ø´ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡</span>
            </div>
        </div>
        
        <div class="action-bar">
            <button id="run-all-btn">
                <span>ğŸš€</span>
                Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§
            </button>
            <button id="run-step-btn" class="secondary">
                <span>âš¡</span>
                Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø±Ø­Ù„Ù‡â€ŒØ¨Ù‡â€ŒÙ…Ø±Ø­Ù„Ù‡
            </button>
            <button id="clear-btn" class="secondary">
                <span>ğŸ”„</span>
                Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬
            </button>
        </div>
    </div>

    <script>
        // ==================== Ø³ÛŒØ³ØªÙ… Ù„Ø§Ú¯ ====================
        class IntegrationLogger {
            constructor() {
                this.logs = [];
                this.maxLogs = 1000;
            }
            
            log(message, data = {}, module = 'SYSTEM') {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    module,
                    message,
                    data,
                    level: 'INFO'
                };
                
                this.logs.unshift(logEntry);
                if (this.logs.length > this.maxLogs) {
                    this.logs.pop();
                }
                
                console.log(`[${module}] ${message}`, data);
                return logEntry;
            }
            
            error(message, error, module = 'SYSTEM') {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    module,
                    message,
                    error: error?.message || error,
                    stack: error?.stack,
                    level: 'ERROR'
                };
                
                this.logs.unshift(logEntry);
                console.error(`[${module}] ${message}:`, error);
                return logEntry;
            }
            
            success(message, data = {}, module = 'SYSTEM') {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    module,
                    message,
                    data,
                    level: 'SUCCESS'
                };
                
                this.logs.unshift(logEntry);
                console.log(`âœ… [${module}] ${message}`, data);
                return logEntry;
            }
        }

        // ==================== Mock Auth Manager ====================
        class MockAuthManager {
            constructor(database, logger) {
                this.db = database;
                this.logger = logger;
                this.currentUser = null;
                this.sessions = new Map();
            }
            
            async register(userData) {
                try {
                    this.logger.log('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±', userData, 'AUTH');
                    
                    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    if (!userData.email || !userData.password) {
                        throw new Error('Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª');
                    }
                    
                    if (userData.password.length < 6) {
                        throw new Error('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯');
                    }
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
                    const existingUser = await this.db.query('users', { email: userData.email });
                    if (existingUser.length > 0) {
                        throw new Error('Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª');
                    }
                    
                    // Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
                    const userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    const user = {
                        ...userData,
                        id: userId,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        status: 'active',
                        lastLogin: null
                    };
                    
                    await this.db.create('users', user);
                    
                    // Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø±
                    const profile = {
                        id: `profile_${userId}`,
                        userId: userId,
                        level: 'beginner',
                        points: 0,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    await this.db.create('profiles', profile);
                    
                    this.logger.success('Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯', { userId }, 'AUTH');
                    return { success: true, userId, user };
                    
                } catch (error) {
                    this.logger.error('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…', error, 'AUTH');
                    throw error;
                }
            }
            
            async login(email, password) {
                try {
                    this.logger.log('Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±', { email }, 'AUTH');
                    
                    // Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±
                    const users = await this.db.query('users', { email });
                    if (users.length === 0) {
                        throw new Error('Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯');
                    }
                    
                    const user = users[0];
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø¯Ø± Ø­Ø§Ù„Øª ÙˆØ§Ù‚Ø¹ÛŒ Ù‡Ø´ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
                    if (user.password !== password) {
                        throw new Error('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
                    }
                    
                    // Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø´Ù†
                    const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 12)}`;
                    const session = {
                        id: sessionId,
                        userId: user.id,
                        createdAt: new Date().toISOString(),
                        expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // 24 Ø³Ø§Ø¹Øª
                        ip: '127.0.0.1',
                        userAgent: navigator.userAgent
                    };
                    
                    this.sessions.set(sessionId, session);
                    this.currentUser = user;
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ø®Ø±ÛŒÙ† ÙˆØ±ÙˆØ¯
                    user.lastLogin = new Date().toISOString();
                    await this.db.update('users', user.id, { lastLogin: user.lastLogin });
                    
                    this.logger.success('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²', { userId: user.id, sessionId }, 'AUTH');
                    return { success: true, sessionId, user };
                    
                } catch (error) {
                    this.logger.error('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯', error, 'AUTH');
                    throw error;
                }
            }
            
            async logout(sessionId) {
                try {
                    this.logger.log('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø±ÙˆØ¬', { sessionId }, 'AUTH');
                    
                    if (this.sessions.has(sessionId)) {
                        this.sessions.delete(sessionId);
                        this.currentUser = null;
                        this.logger.success('Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²', { sessionId }, 'AUTH');
                        return { success: true };
                    }
                    
                    throw new Error('Ø³Ø´Ù† Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª');
                    
                } catch (error) {
                    this.logger.error('Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬', error, 'AUTH');
                    throw error;
                }
            }
            
            async validateSession(sessionId) {
                try {
                    if (!this.sessions.has(sessionId)) {
                        return { valid: false, reason: 'Ø³Ø´Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯' };
                    }
                    
                    const session = this.sessions.get(sessionId);
                    if (new Date(session.expiresAt) < new Date()) {
                        this.sessions.delete(sessionId);
                        return { valid: false, reason: 'Ø³Ø´Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡' };
                    }
                    
                    // Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³
                    const user = await this.db.get('users', session.userId);
                    if (!user) {
                        return { valid: false, reason: 'Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯' };
                    }
                    
                    return { valid: true, session, user };
                    
                } catch (error) {
                    this.logger.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø´Ù†', error, 'AUTH');
                    return { valid: false, reason: 'Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±' };
                }
            }
        }

        // ==================== Mock Database ====================
        class MockDatabase {
            constructor(logger) {
                this.logger = logger;
                this.data = {
                    users: new Map(),
                    sessions: new Map(),
                    profiles: new Map(),
                    activities: new Map() // âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ Ø¨Ø±Ø§ÛŒ ØªØ³Øª 6
                };
                this.init();
            }
            
            init() {
                this.logger.log('Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Mock Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯', {}, 'DATABASE');
            }
            
            async create(collection, item) {
                await this.delay(50); // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªØ§Ø®ÛŒØ± Ø´Ø¨Ú©Ù‡
                
                if (!this.data[collection]) {
                    this.data[collection] = new Map();
                }
                
                this.data[collection].set(item.id, item);
                this.logger.log(`Ø¢ÛŒØªÙ… Ø¯Ø± ${collection} Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`, { id: item.id }, 'DATABASE');
                return item;
            }
            
            async get(collection, id) {
                await this.delay(30);
                
                if (!this.data[collection]) {
                    return null;
                }
                
                return this.data[collection].get(id) || null;
            }
            
            async update(collection, id, updates) {
                await this.delay(40);
                
                if (!this.data[collection] || !this.data[collection].has(id)) {
                    throw new Error('Ø¢ÛŒØªÙ… ÛŒØ§ÙØª Ù†Ø´Ø¯');
                }
                
                const item = this.data[collection].get(id);
                const updatedItem = { ...item, ...updates, updatedAt: new Date().toISOString() };
                this.data[collection].set(id, updatedItem);
                
                this.logger.log(`Ø¢ÛŒØªÙ… Ø¯Ø± ${collection} Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯`, { id }, 'DATABASE');
                return updatedItem;
            }
            
            async delete(collection, id) {
                await this.delay(30);
                
                if (!this.data[collection]) {
                    return false;
                }
                
                const deleted = this.data[collection].delete(id);
                this.logger.log(`Ø¢ÛŒØªÙ… Ø§Ø² ${collection} Ø­Ø°Ù Ø´Ø¯`, { id, deleted }, 'DATABASE');
                return deleted;
            }
            
            async query(collection, filters = {}) {
                await this.delay(100); // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø²Ù…Ø§Ù† Ø¬Ø³ØªØ¬Ùˆ
                
                if (!this.data[collection]) {
                    return [];
                }
                
                const items = Array.from(this.data[collection].values());
                
                // ÙÛŒÙ„ØªØ± Ø³Ø§Ø¯Ù‡
                return items.filter(item => {
                    return Object.entries(filters).every(([key, value]) => {
                        return item[key] === value;
                    });
                });
            }
            
            async transaction(operations) {
                this.logger.log('Ø´Ø±ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´', { operationsCount: operations.length }, 'DATABASE');
                
                try {
                    const results = [];
                    for (const op of operations) {
                        const result = await this[op.action](op.collection, ...op.args);
                        results.push(result);
                    }
                    
                    this.logger.success('ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', { resultsCount: results.length }, 'DATABASE');
                    return results;
                    
                } catch (error) {
                    this.logger.error('ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯', error, 'DATABASE');
                    throw error;
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            getStats() {
                const stats = {};
                for (const [collection, items] of Object.entries(this.data)) {
                    stats[collection] = items.size;
                }
                return stats;
            }
        }

        // ==================== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ ====================
        const integrationTests = [
            {
                id: 'test-1',
                number: 'Û±',
                title: 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ + Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³',
                description: 'Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ø¢ÛŒÙ†Ø¯ Ú©Ø§Ù…Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³',
                modules: ['AUTH', 'DATABASE'],
                run: async (auth, db, logger) => {
                    // Û±. Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±
                    const userData = {
                        email: `test_${Date.now()}@vakamova.com`,
                        password: 'SecurePass123!',
                        name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª',
                        phone: '09123456789'
                    };
                    
                    const registerResult = await auth.register(userData);
                    
                    if (!registerResult.success) {
                        throw new Error('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
                    }
                    
                    // Û². Ø¨Ø±Ø±Ø³ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
                    const savedUser = await db.get('users', registerResult.userId);
                    
                    if (!savedUser) {
                        throw new Error('Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                    }
                    
                    // Û³. Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    if (savedUser.email !== userData.email) {
                        throw new Error('Ø§ÛŒÙ…ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª');
                    }
                    
                    if (savedUser.name !== userData.name) {
                        throw new Error('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª');
                    }
                    
                    if (savedUser.status !== 'active') {
                        throw new Error('ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª');
                    }
                    
                    // Û´. Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯Ú©Ø§Ø±
                    const userProfile = await db.get('profiles', `profile_${registerResult.userId}`);
                    if (!userProfile) {
                        throw new Error('Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                    }
                    
                    return {
                        success: true,
                        userId: registerResult.userId,
                        userEmail: savedUser.email,
                        profileCreated: true,
                        dbStats: db.getStats()
                    };
                }
            },
            {
                id: 'test-2',
                number: 'Û²',
                title: 'ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± + Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø´Ù† + Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ lastLogin',
                description: 'Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ø¢ÛŒÙ†Ø¯ ÙˆØ±ÙˆØ¯ØŒ Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø´Ù† Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† ÙˆØ±ÙˆØ¯',
                modules: ['AUTH', 'DATABASE'],
                run: async (auth, db, logger) => {
                    // Û±. Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    const userData = {
                        email: `login_test_${Date.now()}@vakamova.com`,
                        password: 'TestPass456!',
                        name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª ÙˆØ±ÙˆØ¯'
                    };
                    
                    await auth.register(userData);
                    
                    // Û². ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
                    const loginResult = await auth.login(userData.email, userData.password);
                    
                    if (!loginResult.success) {
                        throw new Error('ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
                    }
                    
                    // Û³. Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø´Ù†
                    if (!loginResult.sessionId) {
                        throw new Error('Ø³Ø´Ù† Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                    }
                    
                    // Û´. Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ lastLogin Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
                    const updatedUser = await db.get('users', loginResult.user.id);
                    
                    if (!updatedUser.lastLogin) {
                        throw new Error('ÙÛŒÙ„Ø¯ lastLogin Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                    }
                    
                    // Ûµ. Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø´Ù†
                    const sessionValidation = await auth.validateSession(loginResult.sessionId);
                    
                    if (!sessionValidation.valid) {
                        throw new Error(`Ø³Ø´Ù† Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª: ${sessionValidation.reason}`);
                    }
                    
                    return {
                        success: true,
                        sessionId: loginResult.sessionId,
                        lastLogin: updatedUser.lastLogin,
                        sessionValid: true
                    };
                }
            },
            {
                id: 'test-3',
                number: 'Û³',
                title: 'Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø´Ù† + Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³',
                description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø´Ù† Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³',
                modules: ['AUTH', 'DATABASE'],
                run: async (auth, db, logger) => {
                    // Û±. Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø³Ø´Ù†
                    const userData = {
                        email: `session_test_${Date.now()}@vakamova.com`,
                        password: 'SessionPass789!',
                        name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª Ø³Ø´Ù†'
                    };
                    
                    await auth.register(userData);
                    const loginResult = await auth.login(userData.email, userData.password);
                    
                    // Û². Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø´Ù†
                    const validation = await auth.validateSession(loginResult.sessionId);
                    
                    if (!validation.valid) {
                        throw new Error(`Ø³Ø´Ù† Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª: ${validation.reason}`);
                    }
                    
                    // Û³. Ø¨Ø±Ø±Ø³ÛŒ ØªØ·Ø§Ø¨Ù‚ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
                    if (validation.user.email !== userData.email) {
                        throw new Error('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯Ù‡ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª');
                    }
                    
                    // Û´. Ø¨Ø±Ø±Ø³ÛŒ ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§
                    const expiresAt = new Date(validation.session.expiresAt);
                    const now = new Date();
                    
                    if (expiresAt <= now) {
                        throw new Error('Ø³Ø´Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª');
                    }
                    
                    // Ûµ. ØªØ³Øª Ø³Ø´Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±
                    const invalidValidation = await auth.validateSession('invalid_session_id');
                    
                    if (invalidValidation.valid) {
                        throw new Error('Ø³Ø´Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ØªØ¨Ø± Ø´Ù†Ø§Ø®ØªÙ‡ Ø´Ø¯');
                    }
                    
                    return {
                        success: true,
                        sessionValid: validation.valid,
                        userEmail: validation.user.email,
                        sessionExpiresAt: validation.session.expiresAt,
                        invalidSessionRejected: true
                    };
                }
            },
            {
                id: 'test-4',
                number: 'Û´',
                title: 'Ø®Ø±ÙˆØ¬ Ú©Ø§Ø±Ø¨Ø± + Ø­Ø°Ù Ø³Ø´Ù†',
                description: 'Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø®Ø±ÙˆØ¬ Ùˆ Ø­Ø°Ù Ø³Ø´Ù† Ø§Ø² Ø³ÛŒØ³ØªÙ…',
                modules: ['AUTH', 'DATABASE'],
                run: async (auth, db, logger) => {
                    // Û±. Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ø³Ø´Ù†
                    const userData = {
                        email: `logout_test_${Date.now()}@vakamova.com`,
                        password: 'LogoutPass123!',
                        name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª Ø®Ø±ÙˆØ¬'
                    };
                    
                    await auth.register(userData);
                    const loginResult = await auth.login(userData.email, userData.password);
                    
                    // Û². Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø³Ø´Ù† Ù‚Ø¨Ù„ Ø§Ø² Ø®Ø±ÙˆØ¬
                    const beforeValidation = await auth.validateSession(loginResult.sessionId);
                    if (!beforeValidation.valid) {
                        throw new Error('Ø³Ø´Ù† Ù‚Ø¨Ù„ Ø§Ø² Ø®Ø±ÙˆØ¬ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª');
                    }
                    
                    // Û³. Ø®Ø±ÙˆØ¬ Ú©Ø§Ø±Ø¨Ø±
                    const logoutResult = await auth.logout(loginResult.sessionId);
                    
                    if (!logoutResult.success) {
                        throw new Error('Ø®Ø±ÙˆØ¬ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
                    }
                    
                    // Û´. Ø¨Ø±Ø±Ø³ÛŒ Ø­Ø°Ù Ø³Ø´Ù†
                    const afterValidation = await auth.validateSession(loginResult.sessionId);
                    
                    if (afterValidation.valid) {
                        throw new Error('Ø³Ø´Ù† Ù¾Ø³ Ø§Ø² Ø®Ø±ÙˆØ¬ Ù‡Ù†ÙˆØ² Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                    }
                    
                    // Ûµ. Ø¨Ø±Ø±Ø³ÛŒ currentUser
                    if (auth.currentUser !== null) {
                        throw new Error('currentUser Ù¾Ø³ Ø§Ø² Ø®Ø±ÙˆØ¬ null Ù†ÛŒØ³Øª');
                    }
                    
                    return {
                        success: true,
                        sessionId: loginResult.sessionId,
                        beforeLogoutValid: beforeValidation.valid,
                        afterLogoutValid: afterValidation.valid,
                        currentUserCleared: auth.currentUser === null
                    };
                }
            },
            {
                id: 'test-5',
                number: 'Ûµ',
                title: 'ØªØ±Ø§Ú©Ù†Ø´ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª Ú©Ø§Ø±Ø¨Ø±',
                description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ú©Ø§Ø±Ø¨Ø±',
                modules: ['AUTH', 'DATABASE'],
                run: async (auth, db, logger) => {
                    // Û±. Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ ØªØ±Ø§Ú©Ù†Ø´
                    const userId = `tx_user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    const userEmail = `tx_test_${Date.now()}@vakamova.com`;
                    
                    const transactionResult = await db.transaction([
                        {
                            action: 'create',
                            collection: 'users',
                            args: [{
                                id: userId,
                                email: userEmail,
                                password: 'TxPass123!',
                                name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª ØªØ±Ø§Ú©Ù†Ø´',
                                createdAt: new Date().toISOString(),
                                status: 'pending'
                            }]
                        },
                        {
                            action: 'create',
                            collection: 'profiles',
                            args: [{
                                id: `profile_${userId}`,
                                userId: userId,
                                level: 'beginner',
                                points: 0,
                                createdAt: new Date().toISOString()
                            }]
                        }
                    ]);
                    
                    // Û². Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªØ§ÛŒØ¬ ØªØ±Ø§Ú©Ù†Ø´
                    if (transactionResult.length !== 2) {
                        throw new Error('ØªØ±Ø§Ú©Ù†Ø´ Ú©Ø§Ù…Ù„ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯');
                    }
                    
                    // Û³. Ø¨Ø±Ø±Ø³ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ
                    const savedUser = await db.get('users', userId);
                    const savedProfile = await db.get('profiles', `profile_${userId}`);
                    
                    if (!savedUser) {
                        throw new Error('Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± ØªØ±Ø§Ú©Ù†Ø´ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯');
                    }
                    
                    if (!savedProfile) {
                        throw new Error('Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¯Ø± ØªØ±Ø§Ú©Ù†Ø´ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯');
                    }
                    
                    // Û´. ØªØ³Øª ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚
                    try {
                        await db.transaction([
                            {
                                action: 'create',
                                collection: 'users',
                                args: [{
                                    id: 'test_user_1',
                                    email: 'test@test.com'
                                    // Ø¨Ø¯ÙˆÙ† password - Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ø¯Ù‡Ø¯
                                }]
                            },
                            {
                                action: 'create',
                                collection: 'profiles',
                                args: [{
                                    id: 'profile_test_1',
                                    userId: 'test_user_1'
                                }]
                            }
                        ]);
                        
                        // Ø§Ú¯Ø± Ø¨Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ø³ÛŒØ¯ÛŒÙ… ÛŒØ¹Ù†ÛŒ ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ÛŒØ¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ø¯
                        throw new Error('ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§ÛŒØ¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ù…ÛŒâ€ŒØ´Ø¯ Ø§Ù…Ø§ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
                        
                    } catch (error) {
                        // Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø§Ø±ÛŒÙ… Ø®Ø·Ø§ Ø¯Ù‡Ø¯ - Ø§ÛŒÙ† Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø³Øª
                        logger.log('ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ (Ù‡Ù…Ø§Ù†Ø·ÙˆØ± Ú©Ù‡ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÛŒâ€ŒØ±ÙØª)', { error: error.message }, 'TEST');
                    }
                    
                    return {
                        success: true,
                        userId,
                        profileId: savedProfile.id,
                        transactionCount: transactionResult.length,
                        stats: db.getStats()
                    };
                }
            },
            {
                id: 'test-6',
                number: 'Û¶',
                title: 'Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø± (Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…ØŒ ÙˆØ±ÙˆØ¯ØŒ ÙØ¹Ø§Ù„ÛŒØªØŒ Ø®Ø±ÙˆØ¬) âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡',
                description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… ØªØ§ Ø®Ø±ÙˆØ¬ (Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡)',
                modules: ['AUTH', 'DATABASE', 'STATE'],
                run: async (auth, db, logger) => {
                    const results = {
                        steps: [],
                        timestamps: {},
                        stats: {}
                    };
                    
                    // Û±. Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…
                    const startTime = Date.now();
                    const userData = {
                        email: `full_scenario_${startTime}@vakamova.com`,
                        password: 'FullScenario123!',
                        name: 'Ú©Ø§Ø±Ø¨Ø± Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ú©Ø§Ù…Ù„',
                        phone: '09120000000'
                    };
                    
                    const registerResult = await auth.register(userData);
                    results.steps.push('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚');
                    results.timestamps.registered = new Date().toISOString();
                    
                    // Û². ÙˆØ±ÙˆØ¯
                    const loginResult = await auth.login(userData.email, userData.password);
                    results.steps.push('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚');
                    results.timestamps.loggedIn = new Date().toISOString();
                    results.sessionId = loginResult.sessionId;
                    
                    // Û³. Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø´Ù†
                    const validation = await auth.validateSession(loginResult.sessionId);
                    if (!validation.valid) {
                        throw new Error('Ø³Ø´Ù† Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª');
                    }
                    results.steps.push('Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø´Ù† Ù…ÙˆÙÙ‚');
                    
                    // Û´. Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                    const profileId = `profile_${registerResult.userId}`;
                    let profile = await db.get('profiles', profileId);
                    
                    if (!profile) {
                        // Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                        profile = {
                            id: profileId,
                            userId: registerResult.userId,
                            level: 'beginner',
                            points: 0,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        await db.create('profiles', profile);
                        results.steps.push('Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…ÙˆÙÙ‚');
                    }
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                    await db.update('profiles', profileId, {
                        level: 'intermediate',
                        points: 100,
                        updatedAt: new Date().toISOString()
                    });
                    results.steps.push('Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…ÙˆÙÙ‚');
                    
                    // Ûµ. Ø°Ø®ÛŒØ±Ù‡ ÙØ¹Ø§Ù„ÛŒØª Ú©Ø§Ø±Ø¨Ø±
                    await db.create('activities', {
                        id: `activity_${Date.now()}`,
                        userId: registerResult.userId,
                        type: 'login',
                        timestamp: new Date().toISOString(),
                        details: { 
                            ip: '127.0.0.1', 
                            device: 'desktop',
                            action: 'user_login',
                            duration: '0s'
                        }
                    });
                    results.steps.push('Ø°Ø®ÛŒØ±Ù‡ ÙØ¹Ø§Ù„ÛŒØª Ù…ÙˆÙÙ‚');
                    
                    // Û¶. Ø®Ø±ÙˆØ¬
                    const logoutResult = await auth.logout(loginResult.sessionId);
                    if (!logoutResult.success) {
                        throw new Error('Ø®Ø±ÙˆØ¬ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
                    }
                    results.steps.push('Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚');
                    results.timestamps.loggedOut = new Date().toISOString();
                    
                    // Û·. Ø°Ø®ÛŒØ±Ù‡ ÙØ¹Ø§Ù„ÛŒØª Ø®Ø±ÙˆØ¬
                    await db.create('activities', {
                        id: `activity_${Date.now()}_logout`,
                        userId: registerResult.userId,
                        type: 'logout',
                        timestamp: new Date().toISOString(),
                        details: { 
                            ip: '127.0.0.1',
                            action: 'user_logout',
                            sessionDuration: '5m'
                        }
                    });
                    results.steps.push('Ø°Ø®ÛŒØ±Ù‡ ÙØ¹Ø§Ù„ÛŒØª Ø®Ø±ÙˆØ¬ Ù…ÙˆÙÙ‚');
                    
                    // Û¸. Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù‡Ø§ÛŒÛŒ
                    const finalValidation = await auth.validateSession(loginResult.sessionId);
                    if (finalValidation.valid) {
                        throw new Error('Ø³Ø´Ù† Ù¾Ø³ Ø§Ø² Ø®Ø±ÙˆØ¬ Ù‡Ù†ÙˆØ² Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                    }
                    
                    results.totalSteps = results.steps.length;
                    results.executionTime = Date.now() - startTime;
                    results.stats = db.getStats();
                    
                    return results;
                }
            }
        ];

        // ==================== ØªØ³Øª Ø±Ø§Ù†Ø± ====================
        class IntegrationTestRunner {
            constructor() {
                this.logger = new IntegrationLogger();
                this.db = new MockDatabase(this.logger);
                this.auth = new MockAuthManager(this.db, this.logger);
                this.results = new Map();
                this.currentTestIndex = 0;
            }
            
            renderTests() {
                const testGrid = document.getElementById('test-grid');
                testGrid.innerHTML = '';
                
                integrationTests.forEach((test, index) => {
                    const card = document.createElement('div');
                    card.className = 'test-card pending';
                    card.id = `card-${test.id}`;
                    card.innerHTML = `
                        <div class="test-title">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span class="test-number">${test.number}</span>
                                <span>${test.title}</span>
                            </div>
                            <span class="test-result" id="result-${test.id}">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
                        </div>
                        <div class="test-desc">
                            <strong>Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§:</strong> ${test.modules.map(m => `<span class="module-tag">${m}</span>`).join(' ')}
                            <br>
                            ${test.description}
                        </div>
                        <div class="test-details" id="details-${test.id}">
                            <div class="test-output" id="output-${test.id}">...</div>
                        </div>
                    `;
                    
                    card.addEventListener('click', () => {
                        card.classList.toggle('active');
                    });
                    
                    testGrid.appendChild(card);
                });
                
                this.updateStats();
            }
            
            async runTest(test) {
                const card = document.getElementById(`card-${test.id}`);
                const output = document.getElementById(`output-${test.id}`);
                const resultSpan = document.getElementById(`result-${test.id}`);
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§
                test.modules.forEach(module => {
                    const moduleBox = document.getElementById(`${module.toLowerCase().replace(' ', '-')}-module`);
                    if (moduleBox) {
                        moduleBox.classList.add('active');
                        moduleBox.querySelector('.module-status').textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§';
                    }
                });
                
                card.className = 'test-card pending';
                resultSpan.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...';
                output.className = 'test-output';
                output.innerHTML = '<div class="loading" style="border-top-color: #4f46e5;"></div> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª...';
                
                try {
                    const startTime = Date.now();
                    const result = await test.run(this.auth, this.db, this.logger);
                    const executionTime = Date.now() - startTime;
                    
                    card.className = 'test-card passed';
                    resultSpan.textContent = 'Ù…ÙˆÙÙ‚';
                    output.className = 'test-output';
                    output.innerHTML = `
<strong>âœ… ØªØ³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯</strong>
<strong>Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§:</strong> ${executionTime}ms
<strong>Ù†ØªÛŒØ¬Ù‡:</strong> ${JSON.stringify(result, null, 2)}
                    `;
                    
                    this.results.set(test.id, {
                        success: true,
                        executionTime,
                        result,
                        timestamp: new Date().toISOString()
                    });
                    
                    this.logger.success(`ØªØ³Øª "${test.title}" Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯`, { executionTime }, 'TEST-RUNNER');
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§
                    test.modules.forEach(module => {
                        const moduleBox = document.getElementById(`${module.toLowerCase().replace(' ', '-')}-module`);
                        if (moduleBox) {
                            moduleBox.querySelector('.module-status').textContent = 'Ù…ÙˆÙÙ‚';
                        }
                    });
                    
                    return true;
                    
                } catch (error) {
                    card.className = 'test-card failed';
                    resultSpan.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
                    output.className = 'test-output';
                    output.innerHTML = `
<strong>âŒ ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯</strong>
<strong>Ø®Ø·Ø§:</strong> ${error.message}
<strong>Ø¬Ø²Ø¦ÛŒØ§Øª:</strong> ${error.stack || 'Ø¨Ø¯ÙˆÙ† Ø¬Ø²Ø¦ÛŒØ§Øª'}
                    `;
                    
                    this.results.set(test.id, {
                        success: false,
                        error: error.message,
                        timestamp: new Date().toISOString()
                    });
                    
                    this.logger.error(`ØªØ³Øª "${test.title}" Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯`, error, 'TEST-RUNNER');
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§
                    test.modules.forEach(module => {
                        const moduleBox = document.getElementById(`${module.toLowerCase().replace(' ', '-')}-module`);
                        if (moduleBox) {
                            moduleBox.classList.remove('active');
                            moduleBox.querySelector('.module-status').textContent = 'Ø®Ø·Ø§';
                        }
                    });
                    
                    return false;
                } finally {
                    this.updateStats();
                }
            }
            
            async runAllTests() {
                const runBtn = document.getElementById('run-all-btn');
                runBtn.disabled = true;
                runBtn.innerHTML = '<span class="loading"></span> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§...';
                
                let passed = 0;
                this.currentTestIndex = 0;
                
                this.logger.log('ğŸš€ Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ', {}, 'TEST-RUNNER');
                
                for (const test of integrationTests) {
                    const success = await this.runTest(test);
                    if (success) passed++;
                    
                    // ÙˆÙ‚ÙÙ‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ±
                    await new Promise(resolve => setTimeout(resolve, 800));
                    this.currentTestIndex++;
                }
                
                runBtn.disabled = false;
                runBtn.innerHTML = '<span>ğŸš€</span> Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§';
                
                this.logger.success(`ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯: ${passed} Ø§Ø² ${integrationTests.length} Ù…ÙˆÙÙ‚`, 
                    { passed, total: integrationTests.length }, 'TEST-RUNNER');
                
                return { passed, total: integrationTests.length };
            }
            
            async runStepByStep() {
                if (this.currentTestIndex >= integrationTests.length) {
                    this.currentTestIndex = 0;
                }
                
                const test = integrationTests[this.currentTestIndex];
                await this.runTest(test);
                this.currentTestIndex++;
            }
            
            updateStats() {
                const passed = document.querySelectorAll('.test-card.passed').length;
                const failed = document.querySelectorAll('.test-card.failed').length;
                const pending = integrationTests.length - passed - failed;
                
                document.getElementById('passed-count').textContent = passed;
                document.getElementById('failed-count').textContent = failed;
                document.getElementById('pending-count').textContent = pending;
                
                const coverage = Math.round((passed / integrationTests.length) * 100);
                document.getElementById('coverage').textContent = `${coverage}%`;
            }
            
            clearResults() {
                integrationTests.forEach(test => {
                    const card = document.getElementById(`card-${test.id}`);
                    const output = document.getElementById(`output-${test.id}`);
                    const resultSpan = document.getElementById(`result-${test.id}`);
                    
                    card.className = 'test-card pending';
                    resultSpan.textContent = 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±';
                    output.className = 'test-output';
                    output.innerHTML = '...';
                    
                    card.classList.remove('active');
                });
                
                this.results.clear();
                this.currentTestIndex = 0;
                
                // Ø±ÛŒØ³Øª ÙˆØ¶Ø¹ÛŒØª Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§
                ['auth', 'db', 'state'].forEach(module => {
                    const moduleBox = document.getElementById(`${module}-module`);
                    if (moduleBox) {
                        moduleBox.classList.remove('active');
                        if (module === 'auth') moduleBox.classList.add('active');
                        moduleBox.querySelector('.module-status').textContent = module === 'auth' ? 'Ø¢Ù…Ø§Ø¯Ù‡' : 'Ù…Ù†ØªØ¸Ø±';
                    }
                });
                
                this.updateStats();
                this.logger.log('Ù†ØªØ§ÛŒØ¬ ØªØ³Øªâ€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯', {}, 'TEST-RUNNER');
            }
            
            getSummary() {
                const summary = {
                    total: integrationTests.length,
                    passed: 0,
                    failed: 0,
                    coverage: 0,
                    executionTimes: []
                };
                
                this.results.forEach(result => {
                    if (result.success) {
                        summary.passed++;
                        if (result.executionTime) {
                            summary.executionTimes.push(result.executionTime);
                        }
                    } else {
                        summary.failed++;
                    }
                });
                
                summary.coverage = Math.round((summary.passed / summary.total) * 100);
                summary.averageTime = summary.executionTimes.length > 0 
                    ? Math.round(summary.executionTimes.reduce((a, b) => a + b, 0) / summary.executionTimes.length)
                    : 0;
                
                return summary;
            }
        }

        // ==================== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ====================
        document.addEventListener('DOMContentLoaded', () => {
            const testRunner = new IntegrationTestRunner();
            testRunner.renderTests();
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
            document.getElementById('run-all-btn').addEventListener('click', () => {
                testRunner.runAllTests();
            });
            
            document.getElementById('run-step-btn').addEventListener('click', () => {
                testRunner.runStepByStep();
            });
            
            document.getElementById('clear-btn').addEventListener('click', () => {
                testRunner.clearResults();
            });
            
            // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
            testRunner.logger.log('Ø³ÛŒØ³ØªÙ… ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ Auth + Database Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯', {}, 'SYSTEM');
            console.log('âœ… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ Ù‡Ø³ØªÙ†Ø¯ (Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡)');
            console.log('ğŸ“± Ø§ÛŒÙ† ØªØ³Øªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ Ù‡Ø³ØªÙ†Ø¯');
            console.log('ğŸ”§ ØªØ³Øª 6 (Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±) Ø§ØµÙ„Ø§Ø­ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§Ø³Øª');
        });
    </script>
</body>
</html>
