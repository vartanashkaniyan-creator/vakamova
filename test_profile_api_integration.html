<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <title>ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Profile + API</title>
    <style>
        body { font-family: Tahoma; padding: 20px; max-width: 900px; margin: auto; }
        .section { background: #f5f7fa; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .success { color: #2ecc71; background: #eafaf1; padding: 10px; margin: 5px 0; border-right: 4px solid #2ecc71; }
        .error { color: #e74c3c; background: #fdedec; padding: 10px; margin: 5px 0; border-right: 4px solid #e74c3c; }
        .warning { color: #f39c12; background: #fef5e6; padding: 10px; margin: 5px 0; border-right: 4px solid #f39c12; }
        button { background: linear-gradient(90deg, #3498db, #2ecc71); color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 5px; }
        .mock-status { background: white; padding: 10px; border-radius: 5px; border: 2px dashed #3498db; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ User Profile + API Client</h1>
    
    <div class="section">
        <h3>ğŸ”§ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ ØªØ³Øª</h3>
        <div class="mock-status">
            <p><strong>ÙˆØ¶Ø¹ÛŒØª Mock Server:</strong> ÙØ¹Ø§Ù„</p>
            <p><strong>Base URL:</strong> https://api.vakamova.test/v1</p>
            <p><strong>ØªÙˆÚ©Ù† Ø§ÙˆÙ„ÛŒÙ‡:</strong> token_initial_123</p>
            <label><input type="checkbox" id="simulateOffline"> Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø±Ø§ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù†</label>
        </div>
    </div>
    
    <button onclick="runIntegrationTest()">Ø´Ø±ÙˆØ¹ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡</button>
    <button onclick="runSingleTest('sync')">ØªØ³Øª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</button>
    <button onclick="runSingleTest('token')">ØªØ³Øª Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ ØªÙˆÚ©Ù†</button>
    
    <div id="results"></div>

    <script>
        // ==================== Mock Server Configuration ====================
        const mockServer = {
            baseURL: 'https://api.vakamova.test/v1',
            userProfiles: new Map(),
            token: 'token_initial_123',
            isOnline: true,
            responseDelay: 300,
            
            // Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„â€ŒÙ‡Ø§
            saveProfile(userId, profile) {
                this.userProfiles.set(userId, {
                    ...profile,
                    lastModified: new Date().toISOString(),
                    version: (this.userProfiles.get(userId)?.version || 0) + 1
                });
                console.log(`ğŸ’¾ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: ${userId}`, profile);
            },
            
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆØ±
            async handleRequest(url, options) {
                if (!this.isOnline) {
                    throw new Error('Network Error: Server is offline');
                }
                
                // ØªØ§Ø®ÛŒØ± Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ
                await this.delay(this.responseDelay);
                
                const endpoint = url.replace(this.baseURL, '');
                const method = options.method || 'GET';
                console.log(`ğŸŒ ${method} ${endpoint}`);
                
                // Ù¾Ø±Ø¯Ø§Ø²Ø´ endpointâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                if (endpoint.startsWith('/profile/')) {
                    const userId = endpoint.split('/')[2];
                    
                    // Ø¯Ø±Ø®ÙˆØ§Ø³Øª GET Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                    if (method === 'GET') {
                        const profile = this.userProfiles.get(userId);
                        if (!profile) {
                            return this.createResponse(404, { error: 'Profile not found' });
                        }
                        return this.createResponse(200, profile);
                    }
                    
                    // Ø¯Ø±Ø®ÙˆØ§Ø³Øª PUT Ø¢Ù¾Ø¯ÛŒØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                    if (method === 'PUT') {
                        const data = JSON.parse(options.body);
                        this.saveProfile(userId, data);
                        return this.createResponse(200, { success: true, updated: true });
                    }
                }
                
                // Ø¯Ø±Ø®ÙˆØ§Ø³Øª refresh token
                if (endpoint === '/auth/refresh' && method === 'POST') {
                    this.token = 'token_refreshed_' + Date.now();
                    return this.createResponse(200, { 
                        token: this.token,
                        expiresIn: 3600 
                    });
                }
                
                // Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
                return this.createResponse(200, { message: 'Mock response' });
            },
            
            createResponse(status, data) {
                return {
                    ok: status >= 200 && status < 300,
                    status,
                    statusText: status === 200 ? 'OK' : 'Error',
                    headers: { get: () => 'application/json' },
                    json: async () => data,
                    text: async () => JSON.stringify(data)
                };
            },
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        };
        
        // ==================== Mock Fetch Implementation ====================
        const originalFetch = window.fetch;
        let fetchCallCount = 0;
        
        window.fetch = async function(url, options = {}) {
            fetchCallCount++;
            
            // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†
            if (document.getElementById('simulateOffline').checked) {
                console.log('ğŸ“´ Ø¯Ø± Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† - Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø± ØµÙ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯');
                throw new TypeError('Failed to fetch');
            }
            
            // ÙÙ‚Ø· Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ mock server Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†
            if (url.startsWith(mockServer.baseURL)) {
                console.log(`ğŸ”— Fetch #${fetchCallCount}: ${options.method || 'GET'} ${url}`);
                return mockServer.handleRequest(url, options);
            }
            
            // Ø¨Ø±Ø§ÛŒ Ø³Ø§ÛŒØ± URLÙ‡Ø§ Ø§Ø² fetch Ø§ØµÙ„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
            return originalFetch(url, options);
        };
        
        // ==================== Simplified UserProfileManager ====================
        class UserProfileManager {
            constructor(apiClient) {
                this.apiClient = apiClient;
                this.userId = 'user_test_001';
                this.localProfile = null;
                this.isInitialized = false;
            }
            
            async initialize() {
                console.log('ğŸš€ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ UserProfileManager...');
                
                // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø­Ù„ÛŒ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)
                this.localProfile = {
                    userId: this.userId,
                    fullName: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª',
                    email: 'test@vakamova.com',
                    languages: ['en', 'fa'],
                    settings: { theme: 'auto' },
                    lastSynced: null
                };
                
                // Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
                await this.syncWithServer();
                
                this.isInitialized = true;
                console.log('âœ… UserProfileManager Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯');
                return true;
            }
            
            async syncWithServer() {
                console.log('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Ø³Ø±ÙˆØ±...');
                
                try {
                    // Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§Ø² Ø³Ø±ÙˆØ±
                    const serverProfile = await this.apiClient.get(`/profile/${this.userId}`);
                    
                    // Ø§Ø¯ØºØ§Ù… Ø¨Ø§ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ø­Ù„ÛŒ (Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø³Ø§Ø¯Ù‡)
                    const mergedProfile = {
                        ...this.localProfile,
                        ...serverProfile,
                        lastSynced: new Date().toISOString()
                    };
                    
                    // Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­Ù„ÛŒ
                    this.localProfile = mergedProfile;
                    
                    // Ø¢Ù¾Ø¯ÛŒØª Ø³Ø±ÙˆØ±
                    await this.apiClient.put(`/profile/${this.userId}`, mergedProfile);
                    
                    console.log('âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²');
                    return { success: true, profile: mergedProfile };
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ:', error);
                    return { success: false, error: error.message };
                }
            }
            
            async updateProfile(updates) {
                console.log('âœï¸ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„...');
                
                // Ø¢Ù¾Ø¯ÛŒØª Ù…Ø­Ù„ÛŒ
                this.localProfile = { ...this.localProfile, ...updates };
                
                // Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Ø³Ø±ÙˆØ±
                return this.syncWithServer();
            }
            
            getProfile() {
                return this.localProfile;
            }
        }
        
        // ==================== Simplified APIClient ====================
        class APIClient {
            constructor() {
                this.baseURL = mockServer.baseURL;
                this.token = mockServer.token;
                this.retryCount = 0;
                this.maxRetries = 2;
            }
            
            async request(method, endpoint, data = null) {
                const url = `${this.baseURL}${endpoint}`;
                
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.token}`
                    }
                };
                
                if (data && (method === 'POST' || method === 'PUT')) {
                    options.body = JSON.stringify(data);
                }
                
                try {
                    const response = await fetch(url, options);
                    
                    // Ø§Ú¯Ø± ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯
                    if (response.status === 401 && this.retryCount < this.maxRetries) {
                        console.log('ğŸ”„ ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ØŒ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ...');
                        await this.refreshToken();
                        this.retryCount++;
                        
                        // Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯
                        options.headers.Authorization = `Bearer ${this.token}`;
                        return fetch(url, options);
                    }
                    
                    this.retryCount = 0; // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return response.json();
                    
                } catch (error) {
                    console.error(`âŒ Ø®Ø·Ø§ÛŒ API: ${error.message}`);
                    
                    // retry Ø¨Ø±Ø§ÛŒ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡
                    if (this.retryCount < this.maxRetries && error.message.includes('Network')) {
                        console.log(`ğŸ”„ Retry ${this.retryCount + 1}/${this.maxRetries}...`);
                        this.retryCount++;
                        await this.delay(1000 * this.retryCount);
                        return this.request(method, endpoint, data);
                    }
                    
                    throw error;
                }
            }
            
            async refreshToken() {
                console.log('ğŸ”„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ ØªÙˆÚ©Ù†...');
                
                // Ø¯Ø±Ø®ÙˆØ§Ø³Øª refresh Ø¨Ù‡ Ø³Ø±ÙˆØ±
                const response = await fetch(`${this.baseURL}/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Token refresh failed');
                }
                
                const data = await response.json();
                this.token = data.token;
                console.log(`âœ… ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯: ${this.token.substring(0, 20)}...`);
            }
            
            async get(endpoint) {
                return this.request('GET', endpoint);
            }
            
            async post(endpoint, data) {
                return this.request('POST', endpoint, data);
            }
            
            async put(endpoint, data) {
                return this.request('PUT', endpoint, data);
            }
            
            async delete(endpoint) {
                return this.request('DELETE', endpoint);
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }
        
        // ==================== Test Functions ====================
        
        async function runIntegrationTest() {
            clearResults();
            addResult('ğŸš€ Ø´Ø±ÙˆØ¹ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Profile + API', 'info');
            
            try {
                // 1. Ø§ÛŒØ¬Ø§Ø¯ API Client
                addResult('1. Ø§ÛŒØ¬Ø§Ø¯ API Client...', 'info');
                const apiClient = new APIClient();
                addResult('   âœ… APIClient Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯', 'success');
                
                // 2. Ø§ÛŒØ¬Ø§Ø¯ UserProfileManager
                addResult('2. Ø§ÛŒØ¬Ø§Ø¯ UserProfileManager...', 'info');
                const profileManager = new UserProfileManager(apiClient);
                addResult('   âœ… UserProfileManager Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯', 'success');
                
                // 3. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
                addResult('3. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ UserProfileManager...', 'info');
                const initResult = await profileManager.initialize();
                if (initResult) {
                    addResult('   âœ… Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²', 'success');
                } else {
                    addResult('   âŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚', 'error');
                    return;
                }
                
                // 4. Ù†Ù…Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§ÙˆÙ„ÛŒÙ‡
                const initialProfile = profileManager.getProfile();
                addResult(`   ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§ÙˆÙ„ÛŒÙ‡: ${initialProfile.fullName}`, 'success');
                
                // 5. ØªØ³Øª Ø¢Ù¾Ø¯ÛŒØª Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                addResult('4. ØªØ³Øª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„...', 'info');
                const updateResult = await profileManager.updateProfile({
                    fullName: 'Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯Ù‡',
                    email: 'updated@vakamova.com',
                    languages: ['en', 'fa', 'es']
                });
                
                if (updateResult.success) {
                    addResult('   âœ… Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', 'success');
                    addResult(`   ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„ Ø¬Ø¯ÛŒØ¯: ${updateResult.profile.email}`, 'info');
                    addResult(`   ğŸŒ Ø²Ø¨Ø§Ù†â€ŒÙ‡Ø§: ${updateResult.profile.languages.join(', ')}`, 'info');
                } else {
                    addResult(`   âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${updateResult.error}`, 'error');
                }
                
                // 6. ØªØ³Øª Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†
                addResult('5. ØªØ³Øª Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ†...', 'info');
                document.getElementById('simulateOffline').checked = true;
                
                try {
                    await profileManager.syncWithServer();
                    addResult('   âŒ Ø§Ù†ØªØ¸Ø§Ø± Ø®Ø·Ø§ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨ÙˆØ¯ Ø§Ù…Ø§ Ù…ÙˆÙÙ‚ Ø´Ø¯!', 'error');
                } catch (error) {
                    addResult('   âœ… Ø®Ø·Ø§ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯', 'success');
                } finally {
                    document.getElementById('simulateOffline').checked = false;
                }
                
                // 7. ØªØ³Øª ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡
                addResult('6. ØªØ³Øª ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡...', 'info');
                
                // Ø°Ø®ÛŒØ±Ù‡ ØªÙˆÚ©Ù† ÙØ¹Ù„ÛŒ
                const oldToken = apiClient.token;
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡
                mockServer.token = 'expired_token';
                
                // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯ (Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ÛŒ 401 Ø¨Ø¯Ù‡Ø¯)
                try {
                    await apiClient.get('/profile/test');
                } catch (error) {
                    if (error.message.includes('401')) {
                        addResult('   âœ… Ø®Ø·Ø§ÛŒ 401 Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯', 'success');
                    }
                }
                
                // 8. Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ
                addResult('ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ:', 'info');
                addResult(`   â€¢ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ API: ${fetchCallCount}`, 'info');
                addResult(`   â€¢ ØªÙˆÚ©Ù† Ù†Ù‡Ø§ÛŒÛŒ: ${apiClient.token.substring(0, 20)}...`, 'info');
                addResult(`   â€¢ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ: ${updateResult.success ? 'Ù…ÙˆÙÙ‚' : 'Ù†Ø§Ù…ÙˆÙÙ‚'}`, 'info');
                
                addResult('\nğŸ‰ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯!', 'success');
                
            } catch (error) {
                addResult(`âŒ Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ Ø¯Ø± ØªØ³Øª: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function runSingleTest(testType) {
            clearResults();
            
            const apiClient = new APIClient();
            const profileManager = new UserProfileManager(apiClient);
            
            switch(testType) {
                case 'sync':
                    addResult('ğŸ§ª ØªØ³Øª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ', 'info');
                    
                    // Ø°Ø®ÛŒØ±Ù‡ ÛŒÚ© Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¯Ø± mock server
                    mockServer.saveProfile('test_sync', {
                        userId: 'test_sync',
                        fullName: 'ØªØ³Øª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ',
                        version: 1
                    });
                    
                    const syncResult = await profileManager.syncWithServer();
                    if (syncResult.success) {
                        addResult('âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²', 'success');
                        addResult(`ğŸ•’ Ø¢Ø®Ø±ÛŒÙ† Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ: ${syncResult.profile.lastSynced}`, 'info');
                    } else {
                        addResult(`âŒ Ø®Ø·Ø§: ${syncResult.error}`, 'error');
                    }
                    break;
                    
                case 'token':
                    addResult('ğŸ§ª ØªØ³Øª Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ ØªÙˆÚ©Ù†', 'info');
                    
                    // ØªÙˆÚ©Ù† Ø±Ø§ Ù…Ù†Ù‚Ø¶ÛŒ Ú©Ù†
                    const originalToken = apiClient.token;
                    apiClient.token = 'expired_token_123';
                    
                    try {
                        // Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ÛŒ 401 Ø¨Ø¯Ù‡Ø¯
                        await apiClient.get('/protected');
                        addResult('âŒ Ø§Ù†ØªØ¸Ø§Ø± Ø®Ø·Ø§ÛŒ 401 Ø¨ÙˆØ¯ Ø§Ù…Ø§ Ù…ÙˆÙÙ‚ Ø´Ø¯!', 'error');
                    } catch (error) {
                        addResult('âœ… Ø®Ø·Ø§ÛŒ 401 Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯', 'success');
                        
                        // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ ØªÙˆÚ©Ù† refresh Ø´Ø¯Ù‡
                        if (apiClient.token !== 'expired_token_123') {
                            addResult(`âœ… ØªÙˆÚ©Ù† Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ Ø´Ø¯: ${apiClient.token.substring(0, 20)}...`, 'success');
                        }
                    }
                    
                    // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ ØªÙˆÚ©Ù† Ø§ØµÙ„ÛŒ
                    apiClient.token = originalToken;
                    break;
            }
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            fetchCallCount = 0;
        }
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            
            switch(type) {
                case 'success':
                    div.className = 'success';
                    break;
                case 'error':
                    div.className = 'error';
                    break;
                case 'warning':
                    div.className = 'warning';
                    break;
                default:
                    div.style.cssText = 'color: #7f8c8d; padding: 8px 12px; margin: 5px 0; background: #f8f9fa; border-right: 3px solid #bdc3c7;';
            }
            
            div.innerHTML = message;
            document.getElementById('results').appendChild(div);
        }
    </script>
</body>
</html>
