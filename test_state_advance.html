<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ State Manager - Vakamova</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:tahoma;background:#4527a0;color:#333;padding:20px}.container{max-width:900px;margin:auto;background:#fff;border-radius:10px;overflow:hidden}header{background:#5e35b1;color:#fff;padding:20px;text-align:center}h1{font-size:1.5rem}.test-section{padding:20px}.test-item{background:#f5f5f5;border-radius:8px;padding:15px;margin-bottom:15px;border-right:5px solid#7e57c2}.passed{border-right-color:#43a047;background:#e8f5e9}.failed{border-right-color:#e53935;background:#ffebee}.running{border-right-color:#fb8c00;background:#fff3e0}.test-header{display:flex;justify-content:space-between;margin-bottom:10px}.test-name{font-weight:bold}.test-status{padding:3px 10px;border-radius:12px;font-size:.8rem}.status-pending{background:#fff9c4;color:#f57c00}.status-running{background:#bbdefb;color:#1565c0}.status-passed{background:#c8e6c9;color:#2e7d32}.status-failed{background:#ffcdd2;color:#c62828}button{background:#5e35b1;color:#fff;border:none;padding:12px 25px;border-radius:8px;font-size:1rem;cursor:pointer;width:100%;margin-top:15px}button:hover{background:#4527a0}.console{background:#263238;color:#80cbc4;padding:15px;margin-top:20px;border-radius:8px;font-family:monospace;font-size:.9rem;max-height:200px;overflow-y:auto}.log{padding:5px 0;border-bottom:1px solid #37474f}.controls{display:flex;gap:10px;margin:15px 0}.controls button{flex:1;margin-top:0}.history-panel{background:#f3e5f5;padding:15px;border-radius:8px;margin:15px 0}.history-item{padding:5px;border-bottom:1px solid #d1c4e9}.undo-redo{display:flex;justify-content:center;gap:10px;margin:10px 0}
    </style>
</head>
<body>
    <div class="container">
        <header><h1>ğŸ§  ØªØ³Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ State Manager - Undo/Redo + Middleware</h1></header>
        <div class="test-section">
            <div class="history-panel">
                <h3>ğŸ“œ ØªØ§Ø±ÛŒØ®Ú†Ù‡ State (Ø¢Ø®Ø±ÛŒÙ† Ûµ ØªØºÛŒÛŒØ±):</h3>
                <div id="history-list">Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>
                <div class="undo-redo">
                    <button id="undo-btn" style="background:#ff9800">â†¶ Undo</button>
                    <button id="redo-btn" style="background:#2196f3">â†· Redo</button>
                </div>
            </div>
            
            <div class="test-item" id="test1">
                <div class="test-header"><div class="test-name">Û±. Undo/Redo Ù¾ÛŒÚ†ÛŒØ¯Ù‡ (Û±Û° Ø¹Ù…Ù„ÛŒØ§Øª)</div><div class="test-status status-pending" id="status1">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output1"></div>
            </div>
            <div class="test-item" id="test2">
                <div class="test-header"><div class="test-name">Û². State Ù¾ÛŒÚ†ÛŒØ¯Ù‡ (Ø¢Ø±Ø§ÛŒÙ‡ + Ø´ÛŒØ¡ ØªÙˆØ¯Ø±ØªÙˆ)</div><div class="test-status status-pending" id="status2">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output2"></div>
            </div>
            <div class="test-item" id="test3">
                <div class="test-header"><div class="test-name">Û³. Middleware (Logging + Validation)</div><div class="test-status status-pending" id="status3">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output3"></div>
            </div>
            <div class="test-item" id="test4">
                <div class="test-header"><div class="test-name">Û´. State Diff Ùˆ Patch</div><div class="test-status status-pending" id="status4">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output4"></div>
            </div>
            <div class="test-item" id="test5">
                <div class="test-header"><div class="test-name">Ûµ. Performance Ø¨Ø§ Ø¹Ù…Ù„ÛŒØ§Øª Ø²ÛŒØ§Ø¯</div><div class="test-status status-pending" id="status5">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output5"></div>
            </div>
            
            <div class="controls">
                <button id="run-btn">â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
                <button id="reset-btn" style="background:#78909c">ğŸ”„ Ø±ÛŒØ³Øª State</button>
            </div>
            
            <div class="console" id="console">
                <div class="log">[Ø³ÛŒØ³ØªÙ…] State Manager Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</div>
            </div>
        </div>
    </div>

<script>
// ========== State Manager Ù¾ÛŒØ´Ø±ÙØªÙ‡ ==========
class AdvancedStateManager {
    constructor(options = {}) {
        this.state = options.initialState || {};
        this.history = [];
        this.future = []; // Ø¨Ø±Ø§ÛŒ redo
        this.maxHistory = options.maxHistory || 50;
        this.middlewares = [];
        this.listeners = new Set();
        this.isUndoing = false;
        this.isRedoing = false;
        
        // middleware Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        this.addMiddleware(this.loggingMiddleware.bind(this));
    }
    
    // ========== Core Methods ==========
    set(path, value) {
        if (this.isUndoing || this.isRedoing) {
            this._setDirect(path, value);
            return;
        }
        
        const oldState = this._clone(this.state);
        const newState = this._setDirect(path, value);
        
        // Ø§Ø¬Ø±Ø§ÛŒ middlewareÙ‡Ø§
        const middlewareResult = this._runMiddlewares('beforeSet', { path, value, oldState, newState });
        if (middlewareResult.cancel) return oldState;
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
        this._saveToHistory(oldState);
        
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† future Ù‡Ù†Ú¯Ø§Ù… ØªØºÛŒÛŒØ± Ø¬Ø¯ÛŒØ¯
        if (!this.isUndoing && !this.isRedoing) {
            this.future = [];
        }
        
        // Ø§Ø¬Ø±Ø§ÛŒ middleware Ù¾Ø³ Ø§Ø² set
        this._runMiddlewares('afterSet', { path, value, oldState, newState });
        
        // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ listeners
        this._notifyListeners(path, value);
        
        return newState;
    }
    
    get(path, defaultValue = undefined) {
        const parts = Array.isArray(path) ? path : path.split('.');
        let current = this.state;
        
        for (const part of parts) {
            if (current && typeof current === 'object' && part in current) {
                current = current[part];
            } else {
                return defaultValue;
            }
        }
        
        return current;
    }
    
    update(path, updater) {
        const currentValue = this.get(path);
        const newValue = typeof updater === 'function' 
            ? updater(currentValue)
            : { ...currentValue, ...updater };
        
        return this.set(path, newValue);
    }
    
    // ========== Undo/Redo ==========
    undo() {
        if (this.history.length === 0) return null;
        
        this.isUndoing = true;
        
        const previousState = this.history.pop();
        const currentState = this.state;
        
        this.future.push(currentState);
        this.state = previousState;
        
        this._runMiddlewares('onUndo', { previousState, currentState });
        this._notifyListeners('*', null); // Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ù‡Ù…Ù‡ listeners
        
        this.isUndoing = false;
        return previousState;
    }
    
    redo() {
        if (this.future.length === 0) return null;
        
        this.isRedoing = true;
        
        const nextState = this.future.pop();
        const currentState = this.state;
        
        this.history.push(currentState);
        this.state = nextState;
        
        this._runMiddlewares('onRedo', { nextState, currentState });
        this._notifyListeners('*', null);
        
        this.isRedoing = false;
        return nextState;
    }
    
    canUndo() {
        return this.history.length > 0;
    }
    
    canRedo() {
        return this.future.length > 0;
    }
    
    // ========== Middleware ==========
    addMiddleware(middleware) {
        this.middlewares.push(middleware);
    }
    
    // ========== Listeners ==========
    subscribe(listener) {
        this.listeners.add(listener);
        return () => this.listeners.delete(listener);
    }
    
    // ========== Complex State Operations ==========
    merge(path, partialState) {
        const current = this.get(path, {});
        const merged = Array.isArray(current) 
            ? [...current, ...(Array.isArray(partialState) ? partialState : [partialState])]
            : { ...current, ...partialState };
        
        return this.set(path, merged);
    }
    
    push(path, item) {
        const array = this.get(path, []);
        if (!Array.isArray(array)) {
            throw new Error(`Path ${path} is not an array`);
        }
        
        const newArray = [...array, item];
        return this.set(path, newArray);
    }
    
    filter(path, predicate) {
        const array = this.get(path, []);
        if (!Array.isArray(array)) {
            throw new Error(`Path ${path} is not an array`);
        }
        
        const filtered = array.filter(predicate);
        return this.set(path, filtered);
    }
    
    // ========== Diff & Patch ==========
    getDiff(oldState, newState) {
        const diff = {};
        
        const compare = (obj1, obj2, path = '') => {
            const allKeys = new Set([...Object.keys(obj1 || {}), ...Object.keys(obj2 || {})]);
            
            for (const key of allKeys) {
                const currentPath = path ? `${path}.${key}` : key;
                const val1 = obj1?.[key];
                const val2 = obj2?.[key];
                
                if (val1 !== val2) {
                    if (typeof val1 === 'object' && typeof val2 === 'object' && 
                        val1 !== null && val2 !== null) {
                        compare(val1, val2, currentPath);
                    } else {
                        diff[currentPath] = { old: val1, new: val2 };
                    }
                }
            }
        };
        
        compare(oldState, newState);
        return diff;
    }
    
    // ========== Helper Methods ==========
    _setDirect(path, value) {
        const parts = Array.isArray(path) ? path : path.split('.');
        const newState = this._clone(this.state);
        let current = newState;
        
        for (let i = 0; i < parts.length - 1; i++) {
            const part = parts[i];
            if (!(part in current) || typeof current[part] !== 'object') {
                current[part] = {};
            }
            current = current[part];
        }
        
        const lastPart = parts[parts.length - 1];
        current[lastPart] = value;
        
        this.state = newState;
        return newState;
    }
    
    _saveToHistory(state) {
        this.history.push(this._clone(state));
        
        // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø§Ù†Ø¯Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
        if (this.history.length > this.maxHistory) {
            this.history.shift();
        }
    }
    
    _clone(obj) {
        return JSON.parse(JSON.stringify(obj));
    }
    
    _runMiddlewares(event, data) {
        const result = { cancel: false };
        
        for (const middleware of this.middlewares) {
            const middlewareResult = middleware(event, data, result);
            if (middlewareResult && middlewareResult.cancel) {
                result.cancel = true;
                break;
            }
        }
        
        return result;
    }
    
    _notifyListeners(path, value) {
        for (const listener of this.listeners) {
            try {
                listener(path, value, this.state);
            } catch (error) {
                console.error('Listener error:', error);
            }
        }
    }
    
    loggingMiddleware(event, data) {
        const timestamp = new Date().toLocaleTimeString('fa-IR');
        let message = '';
        
        switch (event) {
            case 'beforeSet':
                message = `ğŸ“ Ù‚Ø¨Ù„ Ø§Ø² set: ${data.path} = ${JSON.stringify(data.value).substring(0, 50)}`;
                break;
            case 'afterSet':
                message = `âœ… Ø¨Ø¹Ø¯ Ø§Ø² set: ${data.path} ØªØºÛŒÛŒØ± ÛŒØ§ÙØª`;
                break;
            case 'onUndo':
                message = `â†¶ Undo Ø§Ø¬Ø±Ø§ Ø´Ø¯`;
                break;
            case 'onRedo':
                message = `â†· Redo Ø§Ø¬Ø±Ø§ Ø´Ø¯`;
                break;
        }
        
        if (message) {
            StateLogger.log(`[${timestamp}] ${message}`);
        }
    }
    
    // ========== Validation Middleware ==========
    static createValidationMiddleware(rules) {
        return function validationMiddleware(event, data) {
            if (event === 'beforeSet') {
                for (const rule of rules) {
                    if (rule.path === data.path || rule.path === '*') {
                        const error = rule.validator(data.value, data.state);
                        if (error) {
                            StateLogger.log(`âŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯: ${error}`, 'error');
                            return { cancel: true };
                        }
                    }
                }
            }
        };
    }
}

// ========== Logger ==========
class StateLogger {
    static log(message, type = 'info') {
        const consoleEl = document.getElementById('console');
        const logEntry = document.createElement('div');
        logEntry.className = 'log';
        
        const prefix = type === 'error' ? '[Ø®Ø·Ø§] ' : type === 'success' ? '[Ù…ÙˆÙÙ‚] ' : '';
        logEntry.textContent = `${prefix}${message}`;
        
        if (type === 'error') logEntry.style.color = '#ef9a9a';
        if (type === 'success') logEntry.style.color = '#c5e1a5';
        
        consoleEl.appendChild(logEntry);
        consoleEl.scrollTop = consoleEl.scrollHeight;
        console.log(`[StateManager] ${message}`);
    }
    
    static updateHistory(manager) {
        const historyList = document.getElementById('history-list');
        const lastItems = manager.history.slice(-5).reverse();
        
        if (lastItems.length === 0) {
            historyList.innerHTML = 'Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡';
            return;
        }
        
        let html = '';
        lastItems.forEach((state, index) => {
            const keys = Object.keys(state).join(', ');
            html += `<div class="history-item">${lastItems.length - index}. ${keys || 'Ø®Ø§Ù„ÛŒ'}</div>`;
        });
        
        historyList.innerHTML = html;
        
        // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
        document.getElementById('undo-btn').disabled = !manager.canUndo();
        document.getElementById('redo-btn').disabled = !manager.canRedo();
    }
}

// ========== ØªØ³Øªâ€ŒÙ‡Ø§ ==========
const stateTests = [
    {
        id: 'test1',
        name: 'Undo/Redo Ù¾ÛŒÚ†ÛŒØ¯Ù‡',
        description: 'Û±Û° Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø®ØªÙ„Ù + undo/redo Ø²Ù†Ø¬ÛŒØ±Ù‡â€ŒØ§ÛŒ',
        run: async () => {
            StateLogger.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Undo/Redo Ù¾ÛŒÚ†ÛŒØ¯Ù‡ ===");
            
            const manager = new AdvancedStateManager({
                initialState: { counter: 0, user: { name: 'Ø§ÙˆÙ„ÛŒÙ‡' } }
            });
            
            // Û±Û° Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø®ØªÙ„Ù
            const operations = [
                () => manager.set('counter', 1),
                () => manager.set('user.name', 'Ø¹Ù„ÛŒ'),
                () => manager.set('user.age', 25),
                () => manager.set('items', ['Ø§Ù„Ù', 'Ø¨']),
                () => manager.push('items', 'Ø¬'),
                () => manager.set('settings.theme', 'dark'),
                () => manager.set('counter', 2),
                () => manager.merge('user', { city: 'ØªÙ‡Ø±Ø§Ù†' }),
                () => manager.set('user.age', 26),
                () => manager.set('items.0', 'Ø§Ù„Ù-ÙˆÛŒØ±Ø§ÛŒØ´')
            ];
            
            // Ø§Ø¬Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª
            for (let i = 0; i < operations.length; i++) {
                operations[i]();
                StateLogger.log(`Ø¹Ù…Ù„ÛŒØ§Øª ${i+1} Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ state Ù†Ù‡Ø§ÛŒÛŒ
            const finalState = manager.state;
            if (finalState.counter !== 2) throw new Error(`counter Ø¨Ø§ÛŒØ¯ Û² Ø¨Ø§Ø´Ø¯: ${finalState.counter}`);
            if (finalState.user.name !== 'Ø¹Ù„ÛŒ') throw new Error(`user.name Ø¨Ø§ÛŒØ¯ Ø¹Ù„ÛŒ Ø¨Ø§Ø´Ø¯`);
            if (finalState.items.length !== 3) throw new Error(`items Ø¨Ø§ÛŒØ¯ Û³ Ø¢ÛŒØªÙ… Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯`);
            
            // undo 5 Ù…Ø±Ø­Ù„Ù‡
            for (let i = 0; i < 5; i++) {
                manager.undo();
                StateLogger.log(`Undo ${i+1} Ø§Ø¬Ø±Ø§ Ø´Ø¯`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø³ Ø§Ø² undo
            const afterUndo = manager.state;
            if (afterUndo.counter !== 1) throw new Error(`Ù¾Ø³ Ø§Ø² undoØŒ counter Ø¨Ø§ÛŒØ¯ Û± Ø¨Ø§Ø´Ø¯: ${afterUndo.counter}`);
            
            // redo 3 Ù…Ø±Ø­Ù„Ù‡
            for (let i = 0; i < 3; i++) {
                manager.redo();
                StateLogger.log(`Redo ${i+1} Ø§Ø¬Ø±Ø§ Ø´Ø¯`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø³ Ø§Ø² redo
            const afterRedo = manager.state;
            if (afterRedo.user.city !== 'ØªÙ‡Ø±Ø§Ù†') throw new Error(`Ù¾Ø³ Ø§Ø² redoØŒ user.city Ø¨Ø§ÛŒØ¯ ØªÙ‡Ø±Ø§Ù† Ø¨Ø§Ø´Ø¯`);
            
            StateLogger.log(`âœ“ ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${manager.history.length} Ø¢ÛŒØªÙ…`);
            StateLogger.log(`âœ“ Future: ${manager.future.length} Ø¢ÛŒØªÙ…`);
            
            return `âœ… ${operations.length} Ø¹Ù…Ù„ÛŒØ§Øª + Ûµ Undo + Û³ Redo Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª`;
        }
    },
    {
        id: 'test2',
        name: 'State Ù¾ÛŒÚ†ÛŒØ¯Ù‡',
        description: 'Ø¢Ø±Ø§ÛŒÙ‡â€ŒÙ‡Ø§ Ùˆ Ø§Ø´ÛŒØ§Ø¡ ØªÙˆØ¯Ø±ØªÙˆ + Ø¹Ù…Ù„ÛŒØ§Øª merge/filter',
        run: async () => {
            StateLogger.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª State Ù¾ÛŒÚ†ÛŒØ¯Ù‡ ===");
            
            const manager = new AdvancedStateManager({
                initialState: {
                    users: [
                        { id: 1, name: 'Ú©Ø§Ø±Ø¨Ø± Û±', active: true },
                        { id: 2, name: 'Ú©Ø§Ø±Ø¨Ø± Û²', active: false }
                    ],
                    settings: {
                        theme: 'light',
                        language: 'fa',
                        notifications: { email: true, push: false }
                    }
                }
            });
            
            // Û±. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ push
            manager.push('users', { id: 3, name: 'Ú©Ø§Ø±Ø¨Ø± Û³', active: true });
            if (manager.get('users').length !== 3) throw new Error('ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ÛŒØ¯ Û³ Ø¨Ø§Ø´Ø¯');
            
            // Û². ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆØ¬ÙˆØ¯
            manager.set('users.1.active', true);
            if (!manager.get('users.1.active')) throw new Error('Ú©Ø§Ø±Ø¨Ø± Û² Ø¨Ø§ÛŒØ¯ active Ø¨Ø§Ø´Ø¯');
            
            // Û³. filter Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±Ø§Ù† active
            const activeBefore = manager.get('users').filter(u => u.active).length;
            manager.filter('users', user => user.active);
            const activeAfter = manager.get('users').length;
            
            if (activeBefore !== activeAfter) {
                throw new Error(`ÙÛŒÙ„ØªØ± Ø§Ø´ØªØ¨Ø§Ù‡: ${activeBefore} â†’ ${activeAfter}`);
            }
            
            // Û´. merge Ú©Ø±Ø¯Ù† settings
            manager.merge('settings', { language: 'en', fontSize: 14 });
            const settings = manager.get('settings');
            
            if (settings.language !== 'en') throw new Error('language Ø¨Ø§ÛŒØ¯ en Ø¨Ø§Ø´Ø¯');
            if (settings.fontSize !== 14) throw new Error('fontSize Ø¨Ø§ÛŒØ¯ Û±Û´ Ø¨Ø§Ø´Ø¯');
            if (settings.theme !== 'light') throw new Error('theme Ø¨Ø§ÛŒØ¯ light Ø¨Ø§Ù‚ÛŒ Ø¨Ù…Ø§Ù†Ø¯');
            
            // Ûµ. Ø³Ø§Ø®ØªØ§Ø± ØªÙˆØ¯Ø±ØªÙˆ Ø¹Ù…ÛŒÙ‚
            manager.set('app.data.metrics.weekly.visits', 1500);
            manager.set('app.data.metrics.weekly.conversions', 45);
            
            const visits = manager.get('app.data.metrics.weekly.visits');
            if (visits !== 1500) throw new Error(`visits Ø¨Ø§ÛŒØ¯ Û±ÛµÛ°Û° Ø¨Ø§Ø´Ø¯: ${visits}`);
            
            StateLogger.log(`âœ“ Ø³Ø§Ø®ØªØ§Ø± Ù¾ÛŒÚ†ÛŒØ¯Ù‡: ${JSON.stringify(manager.state).length} Ø¨Ø§ÛŒØª`);
            
            return `âœ… State Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ø¨Ø§ ${Object.keys(manager.state).length} key Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¯`;
        }
    },
    {
        id: 'test3',
        name: 'Middleware',
        description: 'Logging + Validation + Cancel Ø¹Ù…Ù„ÛŒØ§Øª',
        run: async () => {
            StateLogger.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Middleware ===");
            
            const manager = new AdvancedStateManager({
                initialState: { score: 0, user: { email: '' } }
            });
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† validation middleware
            const validationMiddleware = AdvancedStateManager.createValidationMiddleware([
                {
                    path: 'score',
                    validator: (value) => {
                        if (typeof value !== 'number') return 'score Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯';
                        if (value < 0) return 'score Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ù†ÙÛŒ Ø¨Ø§Ø´Ø¯';
                        if (value > 1000) return 'score Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨ÛŒØ´ Ø§Ø² Û±Û°Û°Û° Ø¨Ø§Ø´Ø¯';
                        return null;
                    }
                },
                {
                    path: 'user.email',
                    validator: (value) => {
                        if (!value.includes('@')) return 'Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª';
                        return null;
                    }
                }
            ]);
            
            manager.addMiddleware(validationMiddleware);
            
            // ØªØ³Øª validation Ù…ÙˆÙÙ‚
            manager.set('score', 100);
            if (manager.get('score') !== 100) throw new Error('score Ø¨Ø§ÛŒØ¯ Û±Û°Û° Ø¨Ø§Ø´Ø¯');
            
            // ØªØ³Øª validation Ù†Ø§Ù…ÙˆÙÙ‚ (Ø¨Ø§ÛŒØ¯ cancel Ø´ÙˆØ¯)
            const beforeInvalid = manager.state;
            manager.set('score', -10);
            const afterInvalid = manager.state;
            
            if (JSON.stringify(beforeInvalid) !== JSON.stringify(afterInvalid)) {
                throw new Error('Ø¹Ù…Ù„ÛŒØ§Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ø§ÛŒØ¯ cancel Ø´ÙˆØ¯');
            }
            
            // ØªØ³Øª validation Ø§ÛŒÙ…ÛŒÙ„
            manager.set('user.email', 'test@example.com');
            if (manager.get('user.email') !== 'test@example.com') {
                throw new Error('Ø§ÛŒÙ…ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯');
            }
            
            // ØªØ³Øª cancel Ø´Ø¯Ù† Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±
            manager.set('user.email', 'invalid-email');
            if (manager.get('user.email') === 'invalid-email') {
                throw new Error('Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ù†Ø¨Ø§ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯');
            }
            
            StateLogger.log(`âœ“ ${manager.middlewares.length} middleware ÙØ¹Ø§Ù„`);
            
            return `âœ… Validation Middleware Ø¨Ø§ ${Object.keys(manager.state).length} rule ØªØ³Øª Ø´Ø¯`;
        }
    },
    {
        id: 'test4',
        name: 'State Diff Ùˆ Patch',
        description: 'Ù…Ù‚Ø§ÛŒØ³Ù‡ stateÙ‡Ø§ Ùˆ ØªØ´Ø®ÛŒØµ ØªØºÛŒÛŒØ±Ø§Øª',
        run: async () => {
            StateLogger.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Diff/Patch ===");
            
            const manager = new AdvancedStateManager({
                initialState: {
                    a: 1,
                    b: { c: 2, d: [1, 2, 3] },
                    e: 'Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡'
                }
            });
            
            const state1 = manager._clone(manager.state);
            
            // Ø§ÛŒØ¬Ø§Ø¯ ØªØºÛŒÛŒØ±Ø§Øª
            manager.set('a', 10);
            manager.set('b.c', 20);
            manager.push('b.d', 4);
            manager.set('b.newKey', 'Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
            manager.set('f', 'Ú©Ù„ÛŒØ¯ Ø¬Ø¯ÛŒØ¯');
            
            const state2 = manager.state;
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ diff
            const diff = manager.getDiff(state1, state2);
            
            // Ø¨Ø±Ø±Ø³ÛŒ diff
            const expectedChanges = ['a', 'b.c', 'b.d', 'b.newKey', 'f'];
            for (const key of expectedChanges) {
                if (!diff[key]) {
                    throw new Error(`ØªØºÛŒÛŒØ± ${key} Ø¯Ø± diff Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡`);
                }
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ±
            if (diff['a'].old !== 1 || diff['a'].new !== 10) {
                throw new Error(`diff Ø¨Ø±Ø§ÛŒ a Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª`);
            }
            
            if (diff['b.c'].old !== 2 || diff['b.c'].new !== 20) {
                throw new Error(`diff Ø¨Ø±Ø§ÛŒ b.c Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª`);
            }
            
            StateLogger.log(`âœ“ ${Object.keys(diff).length} ØªØºÛŒÛŒØ± ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯`);
            
            // Ù†Ù…Ø§ÛŒØ´ diff (Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡)
            const diffSample = Object.entries(diff)
                .slice(0, 3)
                .map(([key, change]) => `${key}: ${change.old} â†’ ${change.new}`)
                .join(', ');
            
            return `âœ… Diff/Patch: ${diffSample}...`;
        }
    },
    {
        id: 'test5',
        name: 'Performance Ø¨Ø§ Ø¹Ù…Ù„ÛŒØ§Øª Ø²ÛŒØ§Ø¯',
        description: 'Û±Û°Û° Ø¹Ù…Ù„ÛŒØ§Øª Ø³Ø±ÛŒØ¹ + Ø¨Ø±Ø±Ø³ÛŒ Ø­Ø§ÙØ¸Ù‡',
        run: async () => {
            StateLogger.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Performance ===");
            
            const manager = new AdvancedStateManager({
                initialState: {},
                maxHistory: 1000
            });
            
            const startTime = Date.now();
            const operationCount = 100;
            
            // Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÙˆØ¹
            for (let i = 0; i < operationCount; i++) {
                switch (i % 5) {
                    case 0:
                        manager.set(`key${i}`, i);
                        break;
                    case 1:
                        manager.set(`nested.${i}.value`, `value${i}`);
                        break;
                    case 2:
                        manager.push(`array`, i);
                        break;
                    case 3:
                        manager.merge(`obj`, { [`prop${i}`]: i });
                        break;
                    case 4:
                        manager.update(`counter`, (val = 0) => val + 1);
                        break;
                }
                
                // Ù‡Ø± Û²Û° Ø¹Ù…Ù„ÛŒØ§Øª ÛŒÚ© undo/redo
                if (i % 20 === 0 && i > 0) {
                    manager.undo();
                    manager.redo();
                }
            }
            
            const endTime = Date.now();
            const duration = endTime - startTime;
            
            // Ø¨Ø±Ø±Ø³ÛŒ performance
            if (duration > 5000) {
                throw new Error(`Performance Ø¶Ø¹ÛŒÙ: ${duration}ms Ø¨Ø±Ø§ÛŒ ${operationCount} Ø¹Ù…Ù„ÛŒØ§Øª`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ ØµØ­Øª state
            const finalState = manager.state;
            const keyCount = Object.keys(finalState).length;
            
            if (keyCount < 10) {
                throw new Error(`state Ù†Ù‡Ø§ÛŒÛŒ ÙÙ‚Ø· ${keyCount} key Ø¯Ø§Ø±Ø¯`);
            }
            
            StateLogger.log(`âœ“ ${operationCount} Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± ${duration}ms`);
            StateLogger.log(`âœ“ ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${manager.history.length} Ø¢ÛŒØªÙ…`);
            
            const opsPerSecond = Math.round((operationCount / (duration / 1000)) * 10) / 10;
            return `âœ… ${operationCount} Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± ${duration}ms (${opsPerSecond} Ø¹Ù…Ù„ÛŒØ§Øª/Ø«Ø§Ù†ÛŒÙ‡)`;
        }
    }
];

// ========== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ==========
async function runAllTests() {
    const runBtn = document.getElementById('run-btn');
    runBtn.disabled = true;
    runBtn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡...';
    
    // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ù†Ø³ÙˆÙ„
    document.getElementById('console').innerHTML = '<div class="log">[Ø³ÛŒØ³ØªÙ…] ØªØ³Øª State Manager Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø´Ø±ÙˆØ¹ Ø´Ø¯</div>';
    
    StateLogger.log("=== Ø´Ø±ÙˆØ¹ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ State Manager ===");
    
    let passed = 0;
    
    for (let i = 0; i < stateTests.length; i++) {
        const test = stateTests[i];
        const testEl = document.getElementById(test.id);
        const statusEl = document.getElementById(`status${i+1}`);
        const outputEl = document.getElementById(`output${i+1}`);
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª
        testEl.className = 'test-item running';
        statusEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§';
        statusEl.className = 'test-status status-running';
        outputEl.innerHTML = '<span style="color:#666">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ...</span>';
        
        try {
            StateLogger.log(`Ø´Ø±ÙˆØ¹ ØªØ³Øª: ${test.name}`);
            const result = await test.run();
            
            // ØªØ³Øª Ù…ÙˆÙÙ‚
            testEl.className = 'test-item passed';
            statusEl.textContent = 'Ù…ÙˆÙÙ‚';
            statusEl.className = 'test-status status-passed';
            outputEl.innerHTML = `<div style="color:#2e7d32">${result}</div>`;
            passed++;
            
            StateLogger.log(`âœ… ${test.name} Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯`, 'success');
            
        } catch (error) {
            // ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚
            testEl.className = 'test-item failed';
            statusEl.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
            statusEl.className = 'test-status status-failed';
            outputEl.innerHTML = `<div style="color:#c62828"><strong>âŒ Ø®Ø·Ø§:</strong> ${error.message}</div>`;
            
            StateLogger.log(`âŒ ${test.name} Ù†Ø§Ù…ÙˆÙÙ‚: ${error.message}`, 'error');
        }
        
        // ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ±
        await new Promise(resolve => setTimeout(resolve, 400));
    }
    
    runBtn.disabled = false;
    runBtn.textContent = `ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ (${passed}/${stateTests.length} Ù…ÙˆÙÙ‚)`;
    
    // Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
    if (passed === stateTests.length) {
        StateLogger.log("ğŸ‰ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ State Manager Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø´Øª Ø³Ø± Ú¯Ø°Ø§Ø´ØªÙ‡ Ø´Ø¯Ù†Ø¯!", 'success');
        StateLogger.log("âœ… State Manager Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Vakamova Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.", 'success');
    } else {
        StateLogger.log(`ØªØ³Øªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù†Ø¯: ${passed} Ø§Ø² ${stateTests.length} Ù…ÙˆÙÙ‚`);
    }
}

// ========== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ UI ==========
document.addEventListener('DOMContentLoaded', () => {
    // Ù†Ù…ÙˆÙ†Ù‡ State Manager Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± UI
    const demoManager = new AdvancedStateManager({
        initialState: { demo: true, counter: 0 }
    });
    
    // Ø¢Ù¾Ø¯ÛŒØª history panel
    demoManager.subscribe(() => {
        StateLogger.updateHistory(demoManager);
    });
    
    // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ undo/redo
    document.getElementById('undo-btn').addEventListener('click', () => {
        demoManager.undo();
        StateLogger.log('Ø¯Ú©Ù…Ù‡ Undo Ø²Ø¯Ù‡ Ø´Ø¯');
    });
    
    document.getElementById('redo-btn').addEventListener('click', () => {
        demoManager.redo();
        StateLogger.log('Ø¯Ú©Ù…Ù‡ Redo Ø²Ø¯Ù‡ Ø´Ø¯');
    });
    
    // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
    document.getElementById('run-btn').addEventListener('click', runAllTests);
    
    document.getElementById('reset-btn').addEventListener('click', () => {
        demoManager.state = { demo: true, counter: 0 };
        demoManager.history = [];
        demoManager.future = [];
        StateLogger.updateHistory(demoManager);
        StateLogger.log('State Ø±ÛŒØ³Øª Ø´Ø¯');
    });
    
    StateLogger.log("Ø³ÛŒØ³ØªÙ… ØªØ³Øª State Manager Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.");
    StateLogger.log("Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ 'Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.");
    StateLogger.updateHistory(demoManager);
});
</script>
</body>
</html>
