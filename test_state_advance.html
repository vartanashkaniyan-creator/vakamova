<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ State Manager - Vakamova</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:tahoma;background:#4527a0;color:#333;padding:20px}.container{max-width:900px;margin:auto;background:#fff;border-radius:10px;overflow:hidden}header{background:#512da8;color:#fff;padding:20px;text-align:center}h1{font-size:1.5rem}.test-section{padding:20px}.test-item{background:#f5f5f5;border-radius:8px;padding:15px;margin-bottom:15px;border-right:5px solid #7e57c2}.passed{border-right-color:#43a047;background:#e8f5e9}.failed{border-right-color:#e53935;background:#ffebee}.running{border-right-color:#fb8c00;background:#fff3e0}.test-header{display:flex;justify-content:space-between;margin-bottom:10px}.test-name{font-weight:bold}.test-status{padding:3px 10px;border-radius:12px;font-size:.8rem}.status-pending{background:#fff9c4;color:#f57c00}.status-running{background:#bbdefb;color:#1565c0}.status-passed{background:#c8e6c9;color:#2e7d32}.status-failed{background:#ffcdd2;color:#c62828}button{background:#512da8;color:#fff;border:none;padding:12px 25px;border-radius:8px;font-size:1rem;cursor:pointer;width:100%;margin-top:15px}button:hover{background:#4527a0}.console{background:#263238;color:#80cbc4;padding:15px;margin-top:20px;border-radius:8px;font-family:monospace;font-size:.9rem;max-height:200px;overflow-y:auto}.log{padding:5px 0;border-bottom:1px solid #37474f}.state-preview{background:#f3e5f5;border:2px dashed#7b1fa2;border-radius:8px;padding:15px;margin:15px 0;font-family:monospace;font-size:.85rem;max-height:150px;overflow-y:auto}.controls{display:flex;gap:10px;margin:15px 0}.control-btn{padding:8px 15px;border-radius:6px;font-size:.9rem;flex:1}.undo-btn{background:#5e35b1;color:#fff}.redo-btn{background:#3949ab;color:#fff}.clear-btn{background:#d81b60;color:#fff}.history{background:#ede7f6;border-radius:8px;padding:10px;margin:15px 0;max-height:120px;overflow-y:auto}.history-item{padding:5px;border-bottom:1px solid#d1c4e9;font-size:.8rem}.btn-group{display:flex;gap:10px;margin-top:15px}.btn-group button{flex:1}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”„ ØªØ³Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ State Manager - Undo/Redo + Persistence</h1>
            <p>ØªØ³Øª Ú©Ø§Ù…Ù„ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¨Ø§Ø²Ú¯Ø´Øª Ùˆ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§ÛŒØ¯Ø§Ø±</p>
        </header>
        <div class="test-section">
            
            <!-- Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ú©Ù†ÙˆÙ†ÛŒ -->
            <div class="state-preview">
                <strong>ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ:</strong>
                <pre id="current-state">{"initialized": false}</pre>
            </div>
            
            <!-- Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Undo/Redo -->
            <div class="controls">
                <button class="control-btn undo-btn" id="undo-btn" disabled>â†¶ Undo</button>
                <button class="control-btn redo-btn" id="redo-btn" disabled>â†· Redo</button>
                <button class="control-btn clear-btn" id="clear-state-btn">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
            </div>
            
            <!-- ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª -->
            <div class="history">
                <strong>ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª:</strong>
                <div id="history-list">Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>
            </div>
            
            <!-- ØªØ³Øªâ€ŒÙ‡Ø§ -->
            <div class="test-item" id="test1">
                <div class="test-header"><div class="test-name">Û±. Ø§ÛŒØ¬Ø§Ø¯ State Manager</div><div class="test-status status-pending" id="status1">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output1"></div>
            </div>
            <div class="test-item" id="test2">
                <div class="test-header"><div class="test-name">Û². Ø¹Ù…Ù„ÛŒØ§Øª Set/Get</div><div class="test-status status-pending" id="status2">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output2"></div>
            </div>
            <div class="test-item" id="test3">
                <div class="test-header"><div class="test-name">Û³. Undo/Redo Ø³Ø§Ø¯Ù‡</div><div class="test-status status-pending" id="status3">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output3"></div>
            </div>
            <div class="test-item" id="test4">
                <div class="test-header"><div class="test-name">Û´. Undo/Redo Ù¾ÛŒÚ†ÛŒØ¯Ù‡ (Ú†Ù†Ø¯ Ø³Ø·Ø­)</div><div class="test-status status-pending" id="status4">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output4"></div>
            </div>
            <div class="test-item" id="test5">
                <div class="test-header"><div class="test-name">Ûµ. Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§ÛŒØ¯Ø§Ø± (Persistence)</div><div class="test-status status-pending" id="status5">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output5"></div>
            </div>
            <div class="test-item" id="test6">
                <div class="test-header"><div class="test-name">Û¶. Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ</div><div class="test-status status-pending" id="status6">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output6"></div>
            </div>
            <div class="test-item" id="test7">
                <div class="test-header"><div class="test-name">Û·. Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ø§ State Ø¨Ø²Ø±Ú¯</div><div class="test-status status-pending" id="status7">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output7"></div>
            </div>
            <div class="test-item" id="test8">
                <div class="test-header"><div class="test-name">Û¸. Clear Ùˆ Reset</div><div class="test-status status-pending" id="status8">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output8"></div>
            </div>
            
            <div class="btn-group">
                <button id="run-btn">â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
                <button id="run-undo-tests" style="background:#7b1fa2">ğŸ” ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo ÙÙ‚Ø·</button>
            </div>
            <button id="interactive-test-btn" style="background:#ab47bc">ğŸ® Ø­Ø§Ù„Øª ØªØ¹Ø§Ù…Ù„ÛŒ ØªØ³Øª</button>
            
            <div class="console" id="console">
                <div class="log">[Ø³ÛŒØ³ØªÙ…] ØªØ³Øª State Manager Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</div>
            </div>
        </div>
    </div>

<script>
// ========== State Manager Ù¾ÛŒØ´Ø±ÙØªÙ‡ ==========
class AdvancedStateManager {
    constructor(namespace = 'vakamova_state') {
        this.namespace = namespace;
        this.state = {};
        this.history = [];
        this.future = []; // Ø¨Ø±Ø§ÛŒ redo
        this.currentIndex = -1;
        this.maxHistory = 50; // Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªØ§Ø±ÛŒØ®Ú†Ù‡
        this.initialState = {};
        this.isInitialized = false;
        
        this.log(`State Manager Ø¨Ø§ namespace "${namespace}" Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`);
    }
    
    // ========== Ø¹Ù…Ù„ÛŒØ§Øª Ø§ØµÙ„ÛŒ ==========
    setState(key, value, description = '') {
        const oldState = { ...this.state };
        const newState = { ...this.state, [key]: value };
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
        this._addToHistory(oldState, newState, description || `set ${key}`);
        
        // Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±
        this.state = newState;
        this.future = []; // Ø¨Ø§ Ù‡Ø± ØªØºÛŒÛŒØ± Ø¬Ø¯ÛŒØ¯ØŒ future Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯
        
        this.log(`State Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯: ${key} = ${typeof value === 'object' ? JSON.stringify(value).substring(0, 50) + '...' : value}`);
        this._updateUI();
        this._saveToStorage();
        
        return newState;
    }
    
    setMultiple(changes, description = '') {
        const oldState = { ...this.state };
        const newState = { ...this.state };
        
        Object.keys(changes).forEach(key => {
            newState[key] = changes[key];
        });
        
        this._addToHistory(oldState, newState, description || `set multiple (${Object.keys(changes).length} keys)`);
        this.state = newState;
        this.future = [];
        
        this.log(`Ú†Ù†Ø¯ÛŒÙ† State Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯: ${Object.keys(changes).join(', ')}`);
        this._updateUI();
        this._saveToStorage();
        
        return newState;
    }
    
    getState(key = null) {
        if (key === null) {
            return { ...this.state };
        }
        return this.state[key];
    }
    
    // ========== Undo/Redo ==========
    undo() {
        if (this.currentIndex <= 0) {
            this.log("Ù‡ÛŒÚ† Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ undo ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", 'warning');
            return null;
        }
        
        const currentHistory = this.history[this.currentIndex];
        const previousState = this.history[this.currentIndex - 1].newState;
        
        // Ø°Ø®ÛŒØ±Ù‡ state ÙØ¹Ù„ÛŒ Ø¯Ø± future Ø¨Ø±Ø§ÛŒ redo
        this.future.unshift({
            oldState: previousState,
            newState: currentHistory.newState,
            description: currentHistory.description,
            timestamp: new Date()
        });
        
        this.currentIndex--;
        this.state = { ...previousState };
        
        this.log(`Undo Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯: ${currentHistory.description}`);
        this._updateUI();
        this._saveToStorage();
        
        return this.state;
    }
    
    redo() {
        if (this.future.length === 0) {
            this.log("Ù‡ÛŒÚ† Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ redo ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", 'warning');
            return null;
        }
        
        const nextAction = this.future.shift();
        this.history = this.history.slice(0, this.currentIndex + 2);
        this.history.push(nextAction);
        this.currentIndex++;
        
        this.state = { ...nextAction.newState };
        
        this.log(`Redo Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯: ${nextAction.description}`);
        this._updateUI();
        this._saveToStorage();
        
        return this.state;
    }
    
    canUndo() {
        return this.currentIndex > 0;
    }
    
    canRedo() {
        return this.future.length > 0;
    }
    
    // ========== Persistence ==========
    saveToStorage() {
        try {
            const data = {
                state: this.state,
                history: this.history,
                future: this.future,
                currentIndex: this.currentIndex,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            localStorage.setItem(this.namespace, JSON.stringify(data));
            this.log(`State Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (${JSON.stringify(data).length} Ø¨Ø§ÛŒØª)`);
            return true;
        } catch (error) {
            this.log(`Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ: ${error.message}`, 'error');
            return false;
        }
    }
    
    loadFromStorage() {
        try {
            const saved = localStorage.getItem(this.namespace);
            if (!saved) {
                this.log("Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯", 'warning');
                return false;
            }
            
            const data = JSON.parse(saved);
            
            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
            if (!data.state || !data.history || data.currentIndex === undefined) {
                throw new Error('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ù‡Ø³ØªÙ†Ø¯');
            }
            
            this.state = data.state;
            this.history = data.history;
            this.future = data.future || [];
            this.currentIndex = data.currentIndex;
            this.isInitialized = true;
            
            this.log(`State Ø§Ø² localStorage Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯ (Ù†Ø³Ø®Ù‡: ${data.version || 'unknown'})`);
            this._updateUI();
            return true;
            
        } catch (error) {
            this.log(`Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ: ${error.message}`, 'error');
            return false;
        }
    }
    
    clearStorage() {
        try {
            localStorage.removeItem(this.namespace);
            this.log("State Ø§Ø² localStorage Ù¾Ø§Ú© Ø´Ø¯");
            return true;
        } catch (error) {
            this.log(`Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ: ${error.message}`, 'error');
            return false;
        }
    }
    
    // ========== Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ ==========
    clearHistory() {
        const currentState = this.state;
        this.history = [{
            oldState: {},
            newState: currentState,
            description: 'Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡',
            timestamp: new Date()
        }];
        this.future = [];
        this.currentIndex = 0;
        
        this.log("ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø§Ú© Ø´Ø¯");
        this._updateUI();
    }
    
    getHistory() {
        return [...this.history];
    }
    
    getHistorySummary() {
        return this.history.map((item, index) => ({
            index,
            description: item.description,
            timestamp: item.timestamp,
            isCurrent: index === this.currentIndex
        }));
    }
    
    // ========== ØªØ³Øª Performance ==========
    async performanceTest(iterations = 100) {
        const startTime = Date.now();
        
        for (let i = 0; i < iterations; i++) {
            this.setState(`perf_key_${i}`, `value_${i}`, `ØªØ³Øª performance ${i}`);
        }
        
        const duration = Date.now() - startTime;
        const opsPerSecond = (iterations / (duration / 1000)).toFixed(1);
        
        return {
            iterations,
            duration,
            opsPerSecond,
            stateSize: JSON.stringify(this.state).length,
            historyLength: this.history.length
        };
    }
    
    // ========== Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ==========
    _addToHistory(oldState, newState, description) {
        const historyItem = {
            oldState,
            newState,
            description,
            timestamp: new Date()
        };
        
        // Ø­Ø°Ù ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ø§Ú¯Ø± Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² Ú¯Ø°Ø´Øª
        this.history = this.history.slice(0, this.currentIndex + 1);
        this.history.push(historyItem);
        
        // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø³Ø§ÛŒØ² ØªØ§Ø±ÛŒØ®Ú†Ù‡
        if (this.history.length > this.maxHistory) {
            this.history = this.history.slice(-this.maxHistory);
        }
        
        this.currentIndex = this.history.length - 1;
    }
    
    _updateUI() {
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ state
        document.getElementById('current-state').textContent = 
            JSON.stringify(this.state, null, 2);
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ undo/redo
        document.getElementById('undo-btn').disabled = !this.canUndo();
        document.getElementById('redo-btn').disabled = !this.canRedo();
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡
        const historyList = document.getElementById('history-list');
        const historyItems = this.getHistorySummary();
        
        if (historyItems.length === 0) {
            historyList.innerHTML = 'Ù‡ÛŒÚ† ØªØºÛŒÛŒØ±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡';
        } else {
            historyList.innerHTML = historyItems.map(item => 
                `<div class="history-item" style="${item.isCurrent ? 'background:#d1c4e9;font-weight:bold' : ''}">
                    ${item.index}. ${item.description} 
                    <small>(${new Date(item.timestamp).toLocaleTimeString('fa-IR')})</small>
                </div>`
            ).join('');
        }
    }
    
    _saveToStorage() {
        // Ø¯Ø± Ù…Ø­ÛŒØ· ÙˆØ§Ù‚Ø¹ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        // Ø¨Ø±Ø§ÛŒ ØªØ³Øª ÙÙ‚Ø· Ù„Ø§Ú¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        this.log(`[Ø°Ø®ÛŒØ±Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø±] State Ø¢Ù…Ø§Ø¯Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø§Ø³Øª (${Object.keys(this.state).length} Ú©Ù„ÛŒØ¯)`);
    }
    
    log(message, type = 'info') {
        const consoleEl = document.getElementById('console');
        const logEntry = document.createElement('div');
        logEntry.className = 'log';
        
        const prefix = type === 'error' ? '[Ø®Ø·Ø§] ' : 
                      type === 'warning' ? '[Ù‡Ø´Ø¯Ø§Ø±] ' : 
                      type === 'success' ? '[Ù…ÙˆÙÙ‚] ' : '';
        
        logEntry.textContent = `${prefix}${message}`;
        
        if (type === 'error') logEntry.style.color = '#ef9a9a';
        if (type === 'warning') logEntry.style.color = '#fff59d';
        if (type === 'success') logEntry.style.color = '#c5e1a5';
        
        consoleEl.appendChild(logEntry);
        consoleEl.scrollTop = consoleEl.scrollHeight;
        console.log(`[StateManager] ${message}`);
    }
    
    reset() {
        this.state = {};
        this.history = [];
        this.future = [];
        this.currentIndex = -1;
        this.isInitialized = false;
        this.log("State Manager Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø´Ø¯");
        this._updateUI();
    }
    
    getStats() {
        return {
            stateKeys: Object.keys(this.state).length,
            historyLength: this.history.length,
            futureLength: this.future.length,
            currentIndex: this.currentIndex,
            canUndo: this.canUndo(),
            canRedo: this.canRedo(),
            isInitialized: this.isInitialized
        };
    }
}

// ========== Ù†Ù…ÙˆÙ†Ù‡ State Manager Ø¨Ø±Ø§ÛŒ ØªØ³Øª ==========
const stateManager = new AdvancedStateManager('vakamova_test_state');

// ========== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ State Manager ==========
const stateTests = [
    {
        id: 'test1',
        name: 'Ø§ÛŒØ¬Ø§Ø¯ State Manager',
        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ØµØ­ÛŒØ­ State Manager',
        run: async () => {
            // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ù‚Ø¨Ù„ Ø§Ø² ØªØ³Øª
            stateManager.reset();
            localStorage.clear();
            
            if (!stateManager.namespace) throw new Error('namespace ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡');
            if (stateManager.maxHistory !== 50) throw new Error('maxHistory Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
            
            const stats = stateManager.getStats();
            if (stats.stateKeys !== 0) throw new Error('State Ø¨Ø§ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯');
            
            stateManager.log("Ø§ÛŒØ¬Ø§Ø¯ State Manager Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯", 'success');
            return 'âœ… State Manager Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯';
        }
    },
    {
        id: 'test2',
        name: 'Ø¹Ù…Ù„ÛŒØ§Øª Set/Get',
        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ state',
        run: async () => {
            stateManager.reset();
            
            // ØªØ³Øª set/get Ø³Ø§Ø¯Ù‡
            stateManager.setState('user', { name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª', level: 1 });
            const user = stateManager.getState('user');
            
            if (!user || user.name !== 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª') {
                throw new Error('Ù…Ù‚Ø¯Ø§Ø± user Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯');
            }
            
            // ØªØ³Øª set/get Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡
            stateManager.setMultiple({
                language: 'english',
                coins: 100,
                lastLogin: new Date().toISOString()
            }, 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ø§Ø±Ø¨Ø±');
            
            const allState = stateManager.getState();
            if (allState.language !== 'english' || allState.coins !== 100) {
                throw new Error('Ù…Ù‚Ø§Ø¯ÛŒØ± setMultiple Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯Ù†Ø¯');
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ÛŒØ¯Ù‡Ø§
            const stats = stateManager.getStats();
            if (stats.stateKeys < 4) throw new Error('ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ state Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
            
            return `âœ… Ø¹Ù…Ù„ÛŒØ§Øª Set/Get Ù…ÙˆÙÙ‚. ${stats.stateKeys} Ú©Ù„ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`;
        }
    },
    {
        id: 'test3',
        name: 'Undo/Redo Ø³Ø§Ø¯Ù‡',
        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ùˆ ØªÚ©Ø±Ø§Ø± Ø¹Ù…Ù„ÛŒØ§Øª Ø³Ø§Ø¯Ù‡',
        run: async () => {
            stateManager.reset();
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ú†Ù†Ø¯ ØªØºÛŒÛŒØ±
            stateManager.setState('step1', 'Ù…Ø±Ø­Ù„Ù‡ Ø§ÙˆÙ„');
            stateManager.setState('step2', 'Ù…Ø±Ø­Ù„Ù‡ Ø¯ÙˆÙ…');
            stateManager.setState('step3', 'Ù…Ø±Ø­Ù„Ù‡ Ø³ÙˆÙ…');
            
            const initialStep3 = stateManager.getState('step3');
            
            // ØªØ³Øª undo
            stateManager.undo();
            if (stateManager.getState('step3') !== undefined) {
                throw new Error('Undo Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ - step3 Ù‡Ù†ÙˆØ² ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯');
            }
            
            // ØªØ³Øª undo Ø¯ÙˆÙ…
            stateManager.undo();
            if (stateManager.getState('step2') !== undefined) {
                throw new Error('Undo Ø¯ÙˆÙ… Ú©Ø§Ø± Ù†Ú©Ø±Ø¯');
            }
            
            // ØªØ³Øª redo
            stateManager.redo();
            if (stateManager.getState('step2') !== 'Ù…Ø±Ø­Ù„Ù‡ Ø¯ÙˆÙ…') {
                throw new Error('Redo Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ - step2 Ø¨Ø§Ø²Ù†Ú¯Ø´Øª');
            }
            
            // ØªØ³Øª redo Ø¯ÙˆÙ…
            stateManager.redo();
            if (stateManager.getState('step3') !== initialStep3) {
                throw new Error('Redo Ø¯ÙˆÙ… Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ - step3 Ø¨Ø§Ø²Ù†Ú¯Ø´Øª');
            }
            
            const stats = stateManager.getStats();
            return `âœ… Undo/Redo Ø³Ø§Ø¯Ù‡ Ù…ÙˆÙÙ‚. ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${stats.historyLength} Ø¢ÛŒØªÙ…`;
        }
    },
    {
        id: 'test4',
        name: 'Undo/Redo Ù¾ÛŒÚ†ÛŒØ¯Ù‡',
        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ùˆ ØªÚ©Ø±Ø§Ø± Ø¨Ø§ Ø¹Ù…Ù„ÛŒØ§Øª Ù¾ÛŒÚ†ÛŒØ¯Ù‡',
        run: async () => {
            stateManager.reset();
            
            // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© state Ù¾ÛŒÚ†ÛŒØ¯Ù‡
            const complexState = {
                user: { id: 1, name: 'Ú©Ø§Ø±Ø¨Ø± Ù¾ÛŒÚ†ÛŒØ¯Ù‡' },
                lessons: ['Ø¯Ø±Ø³ Û±', 'Ø¯Ø±Ø³ Û²', 'Ø¯Ø±Ø³ Û³'],
                progress: { completed: 5, total: 20 },
                settings: { theme: 'dark', language: 'fa' }
            };
            
            stateManager.setMultiple(complexState, 'Ø§ÛŒØ¬Ø§Ø¯ state Ù¾ÛŒÚ†ÛŒØ¯Ù‡');
            
            // Ú†Ù†Ø¯ÛŒÙ† ØªØºÛŒÛŒØ± Ù…ØªÙˆØ§Ù„ÛŒ
            stateManager.setState('user.name', 'Ú©Ø§Ø±Ø¨Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯Ù‡');
            stateManager.setState('progress.completed', 8);
            stateManager.setMultiple({ 
                'settings.theme': 'light',
                'lessons.0': 'Ø¯Ø±Ø³ Ø§ÙˆÙ„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯Ù‡'
            }, 'ÙˆÛŒØ±Ø§ÛŒØ´â€ŒÙ‡Ø§ÛŒ Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡');
            
            const beforeUndo = JSON.stringify(stateManager.getState());
            
            // Ú†Ù†Ø¯ÛŒÙ† undo
            stateManager.undo(); // ÙˆÛŒØ±Ø§ÛŒØ´â€ŒÙ‡Ø§ÛŒ Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡
            stateManager.undo(); // progress.completed
            stateManager.undo(); // user.name
            
            const afterUndo = JSON.stringify(stateManager.getState());
            
            // Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ state Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ú¯Ø±Ø¯ÛŒÙ…
            if (afterUndo !== JSON.stringify(complexState)) {
                throw new Error('UndoÙ‡Ø§ÛŒ Ù…ØªÙˆØ§Ù„ÛŒ state Ø§ÙˆÙ„ÛŒÙ‡ Ø±Ø§ Ø¨Ø±Ù†Ú¯Ø±Ø¯Ø§Ù†Ø¯');
            }
            
            // Ú†Ù†Ø¯ÛŒÙ† redo
            stateManager.redo(); // user.name
            stateManager.redo(); // progress.completed
            stateManager.redo(); // ÙˆÛŒØ±Ø§ÛŒØ´â€ŒÙ‡Ø§ÛŒ Ú†Ù†Ø¯Ú¯Ø§Ù†Ù‡
            
            const afterRedo = JSON.stringify(stateManager.getState());
            
            if (afterRedo !== beforeUndo) {
                throw new Error('RedoÙ‡Ø§ÛŒ Ù…ØªÙˆØ§Ù„ÛŒ state Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ø¨Ø±Ù†Ú¯Ø±Ø¯Ø§Ù†Ø¯');
            }
            
            return `âœ… Undo/Redo Ù¾ÛŒÚ†ÛŒØ¯Ù‡ Ù…ÙˆÙÙ‚. ${stateManager.history.length} Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¯`;
        }
    },
    {
        id: 'test5',
        name: 'Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§ÛŒØ¯Ø§Ø±',
        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø°Ø®ÛŒØ±Ù‡ state Ø¯Ø± localStorage',
        run: async () => {
            stateManager.reset();
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³Øª
            stateManager.setState('test_persistence', {
                data: 'Ø§ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯',
                timestamp: new Date().toISOString(),
                version: '1.0'
            });
            
            stateManager.setState('counter', 42);
            stateManager.setState('isTest', true);
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
            const saveResult = stateManager.saveToStorage();
            if (!saveResult) {
                throw new Error('Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± localStorage Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†
            const saved = localStorage.getItem(stateManager.namespace);
            if (!saved) {
                throw new Error('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯');
            }
            
            const parsed = JSON.parse(saved);
            if (!parsed.state || !parsed.state.test_persistence) {
                throw new Error('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ù†Ø§Ù‚Øµ Ù‡Ø³ØªÙ†Ø¯');
            }
            
            return `âœ… Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§ÛŒØ¯Ø§Ø± Ù…ÙˆÙÙ‚. ${saved.length} Ø¨Ø§ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`;
        }
    },
    {
        id: 'test6',
        name: 'Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ',
        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ state Ø§Ø² localStorage',
        run: async () => {
            // Ø§Ø¨ØªØ¯Ø§ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒÙ… Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
            const saved = localStorage.getItem(stateManager.namespace);
            if (!saved) {
                throw new Error('Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
            }
            
            // State Manager Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ
            const newManager = new AdvancedStateManager('vakamova_test_state');
            newManager.reset();
            
            // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            const loadResult = newManager.loadFromStorage();
            if (!loadResult) {
                throw new Error('Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø² localStorage Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯Ù‡
            const recoveredState = newManager.getState();
            if (!recoveredState.test_persistence) {
                throw new Error('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ test_persistence Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†Ø´Ø¯');
            }
            
            if (recoveredState.counter !== 42) {
                throw new Error('Ù…Ù‚Ø¯Ø§Ø± counter Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†Ø´Ø¯');
            }
            
            if (recoveredState.isTest !== true) {
                throw new Error('Ù…Ù‚Ø¯Ø§Ø± isTest Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†Ø´Ø¯');
            }
            
            const stats = newManager.getStats();
            return `âœ… Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù…ÙˆÙÙ‚. ${stats.stateKeys} Ú©Ù„ÛŒØ¯ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯`;
        }
    },
    {
        id: 'test7',
        name: 'Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ø§ State Ø¨Ø²Ø±Ú¯',
        description: 'Ø¨Ø±Ø±Ø³ÛŒ performance Ø¨Ø§ state Ø­Ø¬ÛŒÙ…',
        run: async () => {
            stateManager.reset();
            
            // Ø§ÛŒØ¬Ø§Ø¯ state Ø¨Ø²Ø±Ú¯
            const largeData = {};
            for (let i = 0; i < 50; i++) {
                largeData[`item_${i}`] = {
                    id: i,
                    name: `Ø¢ÛŒØªÙ… ${i}`,
                    data: 'x'.repeat(100), // Ø¯Ø§Ø¯Ù‡ Ø­Ø¬ÛŒÙ…
                    timestamp: new Date().toISOString()
                };
            }
            
            stateManager.setMultiple(largeData, 'Ø§ÛŒØ¬Ø§Ø¯ state Ø¨Ø²Ø±Ú¯');
            
            // ØªØ³Øª performance
            const perfResult = await stateManager.performanceTest(20);
            
            if (perfResult.duration > 1000) {
                throw new Error(`Performance Ø¶Ø¹ÛŒÙ: ${perfResult.duration}ms Ø¨Ø±Ø§ÛŒ Û²Û° Ø¹Ù…Ù„ÛŒØ§Øª`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§ÛŒØ² state
            const stateStr = JSON.stringify(stateManager.getState());
            if (stateStr.length < 5000) {
                throw new Error('State Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø²Ø±Ú¯ Ù†ÛŒØ³Øª');
            }
            
            return `âœ… Performance Ù…Ù†Ø§Ø³Ø¨: ${perfResult.opsPerSecond} Ø¹Ù…Ù„ÛŒØ§Øª/Ø«Ø§Ù†ÛŒÙ‡`;
        }
    },
    {
        id: 'test8',
        name: 'Clear Ùˆ Reset',
        description: 'Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ state Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡',
        run: async () => {
            // Ø§Ø¨ØªØ¯Ø§ state Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒÙ…
            stateManager.setState('to_be_cleared', 'Ø§ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ Ù¾Ø§Ú© Ø´ÙˆØ¯');
            stateManager.setState('another_data', 123);
            
            const beforeClear = stateManager.getStats();
            
            // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
            stateManager.reset();
            
            const afterReset = stateManager.getStats();
            
            if (afterReset.stateKeys !== 0) {
                throw new Error('State Ù¾Ø³ Ø§Ø² reset Ù¾Ø§Ú© Ù†Ø´Ø¯');
            }
            
            if (afterReset.historyLength !== 0) {
                throw new Error('ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø³ Ø§Ø² reset Ù¾Ø§Ú© Ù†Ø´Ø¯');
            }
            
            // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ localStorage
            const clearResult = stateManager.clearStorage();
            if (!clearResult) {
                throw new Error('Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ localStorage Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ú© Ø´Ø¯Ù† Ø§Ø² localStorage
            const stillExists = localStorage.getItem(stateManager.namespace);
            if (stillExists) {
                throw new Error('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² localStorage Ù¾Ø§Ú© Ù†Ø´Ø¯Ù†Ø¯');
            }
            
            return `âœ… Clear/Reset Ù…ÙˆÙÙ‚. ${beforeClear.stateKeys} Ú©Ù„ÛŒØ¯ Ù¾Ø§Ú© Ø´Ø¯`;
        }
    }
];

// ========== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ==========
async function runAllTests() {
    const runBtn = document.getElementById('run-btn');
    runBtn.disabled = true;
    runBtn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§...';
    
    // Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ú©Ù†Ø³ÙˆÙ„
    document.getElementById('console').innerHTML = '<div class="log">[Ø³ÛŒØ³ØªÙ…] Ø´Ø±ÙˆØ¹ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ State Manager</div>';
    
    stateManager.log("=== Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ State Manager ===");
    
    let passed = 0;
    
    for (let i = 0; i < stateTests.length; i++) {
        const test = stateTests[i];
        const testEl = document.getElementById(test.id);
        const statusEl = document.getElementById(`status${i+1}`);
        const outputEl = document.getElementById(`output${i+1}`);
        
        // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§
        testEl.className = 'test-item running';
        statusEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§';
        statusEl.className = 'test-status status-running';
        outputEl.innerHTML = '<span style="color:#666">Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ...</span>';
        
        try {
            stateManager.log(`Ø´Ø±ÙˆØ¹ ØªØ³Øª: ${test.name}`);
            const result = await test.run();
            
            // ØªØ³Øª Ù…ÙˆÙÙ‚
            testEl.className = 'test-item passed';
            statusEl.textContent = 'Ù…ÙˆÙÙ‚';
            statusEl.className = 'test-status status-passed';
            outputEl.innerHTML = `<div style="color:#2e7d32">${result}</div>`;
            passed++;
            
            stateManager.log(`âœ… ØªØ³Øª "${test.name}" Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯`, 'success');
            
        } catch (error) {
            // ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚
            testEl.className = 'test-item failed';
            statusEl.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
            statusEl.className = 'test-status status-failed';
            outputEl.innerHTML = `<div style="color:#c62828"><strong>âŒ Ø®Ø·Ø§:</strong> ${error.message}</div>`;
            
            stateManager.log(`âŒ ØªØ³Øª "${test.name}" Ù†Ø§Ù…ÙˆÙÙ‚: ${error.message}`, 'error');
        }
        
        // ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ±
        await new Promise(resolve => setTimeout(resolve, 400));
    }
    
    runBtn.disabled = false;
    runBtn.textContent = `ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ (${passed}/${stateTests.length} Ù…ÙˆÙÙ‚)`;
    
    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
    if (passed === stateTests.length) {
        stateManager.log("ğŸ‰ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ State Manager Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø´Øª Ø³Ø± Ú¯Ø°Ø§Ø´ØªÙ‡ Ø´Ø¯Ù†Ø¯!", 'success');
        stateManager.log("âœ… State Manager Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Vakamova Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.", 'success');
    } else {
        stateManager.log(`ØªØ³Øªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù†Ø¯: ${passed} Ø§Ø² ${stateTests.length} Ù…ÙˆÙÙ‚`, 
                       passed >= 6 ? 'success' : 'warning');
    }
}

// ========== Ø­Ø§Ù„Øª ØªØ¹Ø§Ù…Ù„ÛŒ ==========
function setupInteractiveMode() {
    stateManager.reset();
    stateManager.log("=== Ø­Ø§Ù„Øª ØªØ¹Ø§Ù…Ù„ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯ ===", 'success');
    stateManager.log("Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØºÛŒÛŒØ±Ø§Øª Ø²ÛŒØ± Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯:", 'success');
    stateManager.log("1. Ø±ÙˆÛŒ Undo/Redo Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯", 'success');
    stateManager.log("2. Ø¯Ú©Ù…Ù‡ 'Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†' Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯", 'success');
    stateManager.log("3. State Ø±Ø§ Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡/Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ú©Ù†ÛŒØ¯", 'success');
    
    // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ¹Ø§Ù…Ù„ÛŒ
    document.getElementById('undo-btn').addEventListener('click', () => {
        stateManager.undo();
    });
    
    document.getElementById('redo-btn').addEventListener('click', () => {
        stateManager.redo();
    });
    
    document.getElementById('clear-state-btn').addEventListener('click', () => {
        if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ State Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ')) {
            stateManager.reset();
            stateManager.log("State Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯", 'success');
        }
    });
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú†Ù†Ø¯ state Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª ØªØ¹Ø§Ù…Ù„ÛŒ
    stateManager.setState('interactive_mode', true);
    stateManager.setState('user_level', 1);
    stateManager.setState('language', 'persian');
    stateManager.setMultiple({
        coins: 100,
        last_action: new Date().toISOString()
    }, 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø­Ø§Ù„Øª ØªØ¹Ø§Ù…Ù„ÛŒ');
}

// ========== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ==========
document.addEventListener('DOMContentLoaded', () => {
    // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ
    document.getElementById('run-btn').addEventListener('click', runAllTests);
    
    // Ø¯Ú©Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ undo/redo ÙÙ‚Ø·
    document.getElementById('run-undo-tests').addEventListener('click', async () => {
        stateManager.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo ÙÙ‚Ø· ===");
        
        const undoRedoTests = [stateTests[2], stateTests[3]]; // ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Û³ Ùˆ Û´
        
        for (let i = 0; i < undoRedoTests.length; i++) {
            const test = undoRedoTests[i];
            const testIndex = stateTests.indexOf(test) + 1;
            const testEl = document.getElementById(test.id);
            const statusEl = document.getElementById(`status${testIndex}`);
            const outputEl = document.getElementById(`output${testIndex}`);
            
            testEl.className = 'test-item running';
            statusEl.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§';
            outputEl.innerHTML = '<span style="color:#666">Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Undo/Redo...</span>';
            
            try {
                const result = await test.run();
                testEl.className = 'test-item passed';
                statusEl.textContent = 'Ù…ÙˆÙÙ‚';
                outputEl.innerHTML = `<div style="color:#2e7d32">${result}</div>`;
                stateManager.log(`âœ… ${test.name} Ù…ÙˆÙÙ‚`, 'success');
            } catch (error) {
                testEl.className = 'test-item failed';
                statusEl.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
                outputEl.innerHTML = `<div style="color:#c62828">âŒ ${error.message}</div>`;
                stateManager.log(`âŒ ${test.name} Ù†Ø§Ù…ÙˆÙÙ‚`, 'error');
            }
            
            await new Promise(resolve => setTimeout(resolve, 300));
        }
    });
    
    // Ø¯Ú©Ù…Ù‡ Ø­Ø§Ù„Øª ØªØ¹Ø§Ù…Ù„ÛŒ
    document.getElementById('interactive-test-btn').addEventListener('click', setupInteractiveMode);
    
    // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ UI
    stateManager._updateUI();
    stateManager.log("Ø³ÛŒØ³ØªÙ… ØªØ³Øª State Manager Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.");
    stateManager.log("Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ú©Ø§Ù…Ù„ Ø±ÙˆÛŒ 'Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.");
    stateManager.log("Ø¨Ø±Ø§ÛŒ ØªØ³Øª ØªØ¹Ø§Ù…Ù„ÛŒ Ø±ÙˆÛŒ 'Ø­Ø§Ù„Øª ØªØ¹Ø§Ù…Ù„ÛŒ ØªØ³Øª' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.");
});
</script>
</body>
</html>
