<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ø³ÛŒØ³ØªÙ… Undo/Redo - Vakamova</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:tahoma;background:#006064;color:#333;padding:20px}.container{max-width:1000px;margin:auto;background:#fff;border-radius:10px;overflow:hidden}header{background:#00838f;color:#fff;padding:20px;text-align:center}h1{font-size:1.5rem}.test-section{padding:20px}.test-item{background:#f5f5f5;border-radius:8px;padding:15px;margin-bottom:15px;border-right:5px solid#4db6ac}.passed{border-right-color:#43a047;background:#e8f5e9}.failed{border-right-color:#e53935;background:#ffebee}.running{border-right-color:#fb8c00;background:#fff3e0}.test-header{display:flex;justify-content:space-between;margin-bottom:10px}.test-name{font-weight:bold}.test-status{padding:3px 10px;border-radius:12px;font-size:.8rem}.status-pending{background:#fff9c4;color:#f57c00}.status-running{background:#bbdefb;color:#1565c0}.status-passed{background:#c8e6c9;color:#2e7d32}.status-failed{background:#ffcdd2;color:#c62828}button{background:#00838f;color:#fff;border:none;padding:12px 25px;border-radius:8px;font-size:1rem;cursor:pointer;width:100%;margin-top:15px}button:hover{background:#006064}.console{background:#263238;color:#80cbc4;padding:15px;margin-top:20px;border-radius:8px;font-family:monospace;font-size:.9rem;max-height:250px;overflow-y:auto}.log{padding:5px 0;border-bottom:1px solid #37474f}.undo-redo-controls{background:#b2ebf2;padding:15px;border-radius:8px;margin:15px 0;display:flex;gap:10px;flex-wrap:wrap}.control-btn{background:#4db6ac;color:#fff;border:none;padding:8px 15px;border-radius:6px;cursor:pointer;flex:1;min-width:120px;text-align:center}.control-btn:hover{background:#26a69a}.history-timeline{background:#e0f7fa;padding:15px;border-radius:8px;margin:15px 0;max-height:200px;overflow-y:auto}.history-item{padding:8px;margin:5px 0;background:#fff;border-radius:4px;border-right:3px solid#4db6ac;font-size:.85rem}.history-item.current{background:#b2ebf2;border-right-color:#00838f}.state-visualizer{background:#f1f8e9;padding:15px;border-radius:8px;margin:15px 0;font-family:monospace;font-size:.85rem;max-height:150px;overflow-y:auto}.btn-group{display:flex;gap:10px;margin-top:15px}.btn-group button{flex:1}
    </style>
</head>
<body>
    <div class="container">
        <header><h1>âªâ© ØªØ³Øª Ø³ÛŒØ³ØªÙ… Undo/Redo + Time Travel</h1></header>
        <div class="test-section">
            <div class="undo-redo-controls">
                <button class="control-btn" id="undo-btn" disabled>âª Undo</button>
                <button class="control-btn" id="redo-btn" disabled>â© Redo</button>
                <button class="control-btn" id="clear-history-btn" style="background:#ef5350">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
                <button class="control-btn" id="jump-to-btn" style="background:#ab47bc">ğŸ•’ Ù¾Ø±Ø´ Ø¨Ù‡ Ø²Ù…Ø§Ù†</button>
            </div>
            
            <div class="history-timeline" id="history-timeline">
                <div class="history-item">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Undo/Redo Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</div>
            </div>
            
            <div class="state-visualizer" id="state-visualizer">
                <strong>ğŸ¯ State ÙØ¹Ù„ÛŒ:</strong> Ù…Ù†ØªØ¸Ø± Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§...
            </div>
            
            <div class="test-item" id="test1">
                <div class="test-header"><div class="test-name">Û±. Undo/Redo Ù¾Ø§ÛŒÙ‡ Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚</div><div class="test-status status-pending" id="status1">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output1"></div>
            </div>
            <div class="test-item" id="test2">
                <div class="test-header"><div class="test-name">Û². Grouped Actions Ùˆ Transactions</div><div class="test-status status-pending" id="status2">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output2"></div>
            </div>
            <div class="test-item" id="test3">
                <div class="test-header"><div class="test-name">Û³. Time Travel Ùˆ Export/Import ØªØ§Ø±ÛŒØ®Ú†Ù‡</div><div class="test-status status-pending" id="status3">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output3"></div>
            </div>
            <div class="test-item" id="test4">
                <div class="test-header"><div class="test-name">Û´. Action Logging Ùˆ Replay</div><div class="test-status status-pending" id="status4">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output4"></div>
            </div>
            
            <div class="btn-group">
                <button id="run-btn">â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
                <button id="run-simulation-btn" style="background:#5c6bc0">ğŸ® Ø§Ø¬Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ø±Ø¨Ø±</button>
            </div>
            
            <div class="console" id="console">
                <div class="log">[Ø³ÛŒØ³ØªÙ…] ØªØ³Øª Undo/Redo + Time Travel Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</div>
            </div>
        </div>
    </div>

<script>
// ========== Ø³ÛŒØ³ØªÙ… Undo/Redo Ù¾ÛŒØ´Ø±ÙØªÙ‡ ==========
const UndoRedoManager = {
    state: {},
    history: [],
    future: [], // Ø¨Ø±Ø§ÛŒ Redo
    currentIndex: -1,
    maxHistorySize: 50,
    transactionStack: [],
    actionLog: [],
    
    // ========== Ù…Ø¯ÛŒØ±ÛŒØª State Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Undo/Redo ==========
    setState(key, value, options = {}) {
        const { 
            description = `ØªÙ†Ø¸ÛŒÙ… ${key}`,
            groupId = null,
            skipHistory = false,
            timestamp = Date.now()
        } = options;
        
        const oldValue = this.state[key];
        const newValue = value;
        
        // Ø§ÛŒØ¬Ø§Ø¯ action record
        const action = {
            id: this.generateId(),
            type: 'SET_STATE',
            key,
            oldValue,
            newValue,
            description,
            groupId,
            timestamp,
            stateSnapshot: this.getStateSnapshot()
        };
        
        // Ø§Ú¯Ø± Ø¯Ø± transaction Ù‡Ø³ØªÛŒÙ…ØŒ action Ø±Ø§ Ø¨Ù‡ transaction ÙØ¹Ù„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
        if (this.transactionStack.length > 0 && !skipHistory) {
            const currentTransaction = this.transactionStack[this.transactionStack.length - 1];
            currentTransaction.actions.push(action);
            this.log(`Action Ø¨Ù‡ transaction "${currentTransaction.name}" Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯`);
        } 
        // Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±ØªØŒ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
        else if (!skipHistory) {
            this.addToHistory(action);
        }
        
        // Ø§Ø¬Ø±Ø§ÛŒ ØªØºÛŒÛŒØ±
        this.state[key] = newValue;
        
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† future (ÙˆÙ‚ØªÛŒ ØªØºÛŒÛŒØ± Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ future Ø¨Ø§Ø·Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
        if (!skipHistory && this.future.length > 0) {
            this.future = [];
            this.updateControls();
        }
        
        this.log(`âœ… ${description}: ${this.formatValue(oldValue)} â†’ ${this.formatValue(newValue)}`);
        this.updateVisualizations();
        
        return action;
    },
    
    // ========== Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ ==========
    addToHistory(action) {
        // Ø§Ú¯Ø± Ø¯Ø± Ù…ÛŒØ§Ù†Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù‡Ø³ØªÛŒÙ…ØŒ future Ø±Ø§ Ù‚Ø·Ø¹ Ú©Ù†
        if (this.currentIndex < this.history.length - 1) {
            this.history = this.history.slice(0, this.currentIndex + 1);
        }
        
        this.history.push(action);
        this.currentIndex = this.history.length - 1;
        
        // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø§Ù†Ø¯Ø§Ø²Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
        if (this.history.length > this.maxHistorySize) {
            const removed = this.history.shift();
            this.currentIndex--;
            this.log(`ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø± Ø´Ø¯. Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† action Ø­Ø°Ù Ø´Ø¯: ${removed.description}`);
        }
        
        // Ù„Ø§Ú¯ action
        this.actionLog.push({
            ...action,
            loggedAt: Date.now()
        });
        
        this.updateControls();
        this.updateHistoryTimeline();
    },
    
    // ========== Undo/Redo ==========
    undo() {
        if (this.currentIndex < 0) {
            this.log("Ù‡ÛŒÚ† actionØ§ÛŒ Ø¨Ø±Ø§ÛŒ undo ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", 'warning');
            return null;
        }
        
        const action = this.history[this.currentIndex];
        
        // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† State
        if (action.type === 'SET_STATE') {
            this.state[action.key] = action.oldValue;
        }
        
        // Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ future Ø¨Ø±Ø§ÛŒ Ø§Ù…Ú©Ø§Ù† redo
        this.future.unshift(action);
        
        this.currentIndex--;
        
        this.log(`âª Undo: ${action.description} (${this.formatValue(action.newValue)} â†’ ${this.formatValue(action.oldValue)})`);
        this.updateVisualizations();
        this.updateControls();
        
        return action;
    },
    
    redo() {
        if (this.future.length === 0) {
            this.log("Ù‡ÛŒÚ† actionØ§ÛŒ Ø¨Ø±Ø§ÛŒ redo ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", 'warning');
            return null;
        }
        
        const action = this.future.shift();
        
        // Ø§Ø¹Ù…Ø§Ù„ Ù…Ø¬Ø¯Ø¯ ØªØºÛŒÛŒØ±
        if (action.type === 'SET_STATE') {
            this.state[action.key] = action.newValue;
        }
        
        this.currentIndex++;
        this.history = this.history.slice(0, this.currentIndex + 1);
        this.history.push(action);
        
        this.log(`â© Redo: ${action.description} (${this.formatValue(action.oldValue)} â†’ ${this.formatValue(action.newValue)})`);
        this.updateVisualizations();
        this.updateControls();
        
        return action;
    },
    
    // ========== Grouped Actions Ùˆ Transactions ==========
    beginTransaction(name = `Transaction_${Date.now()}`) {
        const transaction = {
            id: this.generateId(),
            name,
            startTime: Date.now(),
            actions: [],
            completed: false
        };
        
        this.transactionStack.push(transaction);
        this.log(`ğŸš€ Ø´Ø±ÙˆØ¹ Transaction: "${name}"`);
        
        return transaction.id;
    },
    
    commitTransaction() {
        if (this.transactionStack.length === 0) {
            this.log("Transaction ÙØ¹Ø§Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", 'warning');
            return null;
        }
        
        const transaction = this.transactionStack.pop();
        transaction.endTime = Date.now();
        transaction.completed = true;
        
        // Ø§Ú¯Ø± transaction Ø´Ø§Ù…Ù„ action Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© group Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
        if (transaction.actions.length > 0) {
            const groupAction = {
                id: transaction.id,
                type: 'TRANSACTION',
                name: transaction.name,
                actions: [...transaction.actions],
                startTime: transaction.startTime,
                endTime: transaction.endTime,
                description: `Transaction: ${transaction.name} (${transaction.actions.length} action)`,
                timestamp: Date.now()
            };
            
            this.addToHistory(groupAction);
            this.log(`âœ… Transaction "${transaction.name}" Ø«Ø¨Øª Ø´Ø¯: ${transaction.actions.length} action`);
        } else {
            this.log(`Transaction "${transaction.name}" Ø¨Ø¯ÙˆÙ† action Ø¨ÙˆØ¯`, 'warning');
        }
        
        return transaction;
    },
    
    rollbackTransaction() {
        if (this.transactionStack.length === 0) {
            this.log("Transaction ÙØ¹Ø§Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", 'warning');
            return null;
        }
        
        const transaction = this.transactionStack.pop();
        
        // Undo Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… actionÙ‡Ø§ÛŒ transaction
        for (let i = transaction.actions.length - 1; i >= 0; i--) {
            const action = transaction.actions[i];
            if (action.type === 'SET_STATE') {
                this.state[action.key] = action.oldValue;
            }
        }
        
        this.log(`â†©ï¸ Transaction "${transaction.name}" rollback Ø´Ø¯: ${transaction.actions.length} action Ù„ØºÙˆ Ø´Ø¯Ù†Ø¯`);
        this.updateVisualizations();
        
        return transaction;
    },
    
    // ========== Time Travel ==========
    jumpToHistoryIndex(index) {
        if (index < 0 || index >= this.history.length) {
            this.log(`Ø§ÛŒÙ†Ø¯Ú©Ø³ ${index} Ø®Ø§Ø±Ø¬ Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø³Øª`, 'error');
            return false;
        }
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ actions Ø¨Ø±Ø§ÛŒ undo/redo
        const actionsToUndo = this.history.slice(index + 1, this.currentIndex + 1);
        const actionsToRedo = this.history.slice(index + 1);
        
        // Ø§Ú¯Ø± Ø¨Ù‡ Ø¹Ù‚Ø¨ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ…
        if (index < this.currentIndex) {
            for (let i = this.currentIndex; i > index; i--) {
                const action = this.history[i];
                if (action.type === 'SET_STATE') {
                    this.state[action.key] = action.oldValue;
                }
            }
        } 
        // Ø§Ú¯Ø± Ø¨Ù‡ Ø¬Ù„Ùˆ Ù…ÛŒâ€ŒØ±ÙˆÛŒÙ…
        else if (index > this.currentIndex) {
            for (let i = this.currentIndex + 1; i <= index; i++) {
                const action = this.history[i];
                if (action.type === 'SET_STATE') {
                    this.state[action.key] = action.newValue;
                }
            }
        }
        
        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ future Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¬Ø§Ø¨Ù‡â€ŒØ¬Ø§ÛŒÛŒ
        this.future = this.history.slice(index + 1);
        
        this.currentIndex = index;
        
        this.log(`ğŸ•’ Time Travel Ø¨Ù‡ action ${index + 1} Ø§Ø² ${this.history.length}`);
        this.updateVisualizations();
        this.updateControls();
        this.updateHistoryTimeline();
        
        return true;
    },
    
    jumpToTimestamp(timestamp) {
        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ† action Ø¨Ù‡ timestamp Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡
        let closestIndex = -1;
        let minDiff = Infinity;
        
        for (let i = 0; i < this.history.length; i++) {
            const diff = Math.abs(this.history[i].timestamp - timestamp);
            if (diff < minDiff) {
                minDiff = diff;
                closestIndex = i;
            }
        }
        
        if (closestIndex >= 0) {
            return this.jumpToHistoryIndex(closestIndex);
        }
        
        return false;
    },
    
    // ========== Export/Import Ùˆ Replay ==========
    exportHistory() {
        const exportData = {
            history: this.history,
            currentIndex: this.currentIndex,
            state: this.getStateSnapshot(),
            exportTime: Date.now(),
            version: '1.0'
        };
        
        const serialized = JSON.stringify(exportData, null, 2);
        this.log(`ØªØ§Ø±ÛŒØ®Ú†Ù‡ export Ø´Ø¯: ${this.history.length} action`);
        
        return serialized;
    },
    
    importHistory(serialized) {
        try {
            const importData = JSON.parse(serialized);
            
            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø§Ø®ØªØ§Ø±
            if (!importData.history || !Array.isArray(importData.history)) {
                throw new Error('ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
            }
            
            this.history = importData.history;
            this.currentIndex = importData.currentIndex || this.history.length - 1;
            
            // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ State
            if (importData.state) {
                this.state = importData.state;
            }
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† future
            this.future = [];
            
            this.log(`ØªØ§Ø±ÛŒØ®Ú†Ù‡ import Ø´Ø¯: ${this.history.length} action`);
            this.updateVisualizations();
            this.updateControls();
            this.updateHistoryTimeline();
            
            return true;
        } catch (error) {
            this.log(`Ø®Ø·Ø§ Ø¯Ø± import ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${error.message}`, 'error');
            return false;
        }
    },
    
    replayActions(actions, speed = 100) {
        return new Promise((resolve) => {
            this.log(`Ø´Ø±ÙˆØ¹ Replay ${actions.length} action Ø¨Ø§ Ø³Ø±Ø¹Øª ${speed}ms`);
            
            let index = 0;
            const replayInterval = setInterval(() => {
                if (index >= actions.length) {
                    clearInterval(replayInterval);
                    this.log(`Replay Ú©Ø§Ù…Ù„ Ø´Ø¯`);
                    resolve(true);
                    return;
                }
                
                const action = actions[index];
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ action
                if (action.type === 'SET_STATE') {
                    this.state[action.key] = action.newValue;
                    this.log(`Replay [${index + 1}/${actions.length}]: ${action.description}`);
                }
                
                index++;
                this.updateVisualizations();
                
            }, speed);
        });
    },
    
    // ========== Utilities ==========
    generateId() {
        return `act_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    },
    
    getStateSnapshot() {
        return JSON.parse(JSON.stringify(this.state));
    },
    
    formatValue(value) {
        if (value === null) return 'null';
        if (value === undefined) return 'undefined';
        if (typeof value === 'object') return `{${Object.keys(value).length} key}`;
        if (typeof value === 'string') return `"${value.substring(0, 20)}${value.length > 20 ? '...' : ''}"`;
        return String(value);
    },
    
    clearHistory() {
        this.history = [];
        this.future = [];
        this.currentIndex = -1;
        this.actionLog = [];
        this.log("ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù…Ù„Ø§Ù‹ Ù¾Ø§Ú© Ø´Ø¯");
        this.updateVisualizations();
        this.updateControls();
        this.updateHistoryTimeline();
    },
    
    // ========== UI Updates ==========
    updateControls() {
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        
        undoBtn.disabled = this.currentIndex < 0;
        redoBtn.disabled = this.future.length === 0;
        
        undoBtn.innerHTML = `âª Undo (${Math.max(0, this.currentIndex + 1)}/${this.history.length})`;
        redoBtn.innerHTML = `â© Redo (${this.future.length})`;
    },
    
    updateHistoryTimeline() {
        const timeline = document.getElementById('history-timeline');
        timeline.innerHTML = '';
        
        if (this.history.length === 0) {
            timeline.innerHTML = '<div class="history-item">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</div>';
            return;
        }
        
        for (let i = 0; i < this.history.length; i++) {
            const action = this.history[i];
            const item = document.createElement('div');
            item.className = `history-item ${i === this.currentIndex ? 'current' : ''}`;
            
            const time = new Date(action.timestamp).toLocaleTimeString('fa-IR');
            const desc = action.description || action.type;
            
            item.innerHTML = `
                <strong>#${i + 1}</strong> [${time}]: ${desc}
                ${action.type === 'SET_STATE' ? `<br><small>${action.key}: ${this.formatValue(action.oldValue)} â†’ ${this.formatValue(action.newValue)}</small>` : ''}
            `;
            
            // Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ jump Ø¨Ù‡ Ø§ÛŒÙ† action
            item.style.cursor = 'pointer';
            item.addEventListener('click', () => {
                if (i !== this.currentIndex) {
                    this.jumpToHistoryIndex(i);
                }
            });
            
            timeline.appendChild(item);
        }
        
        // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ø¢ÛŒØªÙ… Ø¬Ø§Ø±ÛŒ
        const currentItem = timeline.querySelector('.history-item.current');
        if (currentItem) {
            currentItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    },
    
    updateVisualizations() {
        const visualizer = document.getElementById('state-visualizer');
        const stateKeys = Object.keys(this.state);
        
        if (stateKeys.length === 0) {
            visualizer.innerHTML = '<strong>ğŸ¯ State ÙØ¹Ù„ÛŒ:</strong> Ø®Ø§Ù„ÛŒ';
            return;
        }
        
        let html = `<strong>ğŸ¯ State ÙØ¹Ù„ÛŒ (${stateKeys.length} key):</strong><br>`;
        
        // Ù†Ù…Ø§ÛŒØ´ Ûµ key Ø§ÙˆÙ„
        stateKeys.slice(0, 5).forEach(key => {
            const value = this.state[key];
            html += `<div style="margin-top: 5px;"><strong>${key}:</strong> ${this.formatValue(value)}</div>`;
        });
        
        if (stateKeys.length > 5) {
            html += `<div style="color:#666;margin-top:5px;">Ùˆ ${stateKeys.length - 5} key Ø¯ÛŒÚ¯Ø±...</div>`;
        }
        
        html += `<div style="color:#4db6ac;margin-top:8px;font-size:.8rem;">
            ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${this.history.length} action | UndoÙ‡Ø§: ${this.currentIndex + 1} | RedoÙ‡Ø§: ${this.future.length}
        </div>`;
        
        visualizer.innerHTML = html;
    },
    
    log(message, type = 'info') {
        const consoleEl = document.getElementById('console');
        const logEntry = document.createElement('div');
        logEntry.className = 'log';
        
        const prefix = type === 'error' ? '[Ø®Ø·Ø§] ' : 
                      type === 'warning' ? '[Ù‡Ø´Ø¯Ø§Ø±] ' : 
                      type === 'success' ? '[Ù…ÙˆÙÙ‚] ' : '';
        
        logEntry.textContent = `${prefix}${message}`;
        
        if (type === 'error') logEntry.style.color = '#ef9a9a';
        if (type === 'warning') logEntry.style.color = '#fff59d';
        if (type === 'success') logEntry.style.color = '#c5e1a5';
        
        consoleEl.appendChild(logEntry);
        consoleEl.scrollTop = consoleEl.scrollHeight;
        console.log(`[UndoRedo] ${message}`);
    },
    
    clear() {
        this.state = {};
        this.history = [];
        this.future = [];
        this.currentIndex = -1;
        this.transactionStack = [];
        this.actionLog = [];
        this.log("Ø³ÛŒØ³ØªÙ… Undo/Redo Ù¾Ø§Ú© Ø´Ø¯");
        this.updateVisualizations();
        this.updateControls();
        this.updateHistoryTimeline();
    }
};

// ========== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo ==========
const undoRedoTests = [
    {
        id: 'test1',
        name: 'Undo/Redo Ù¾Ø§ÛŒÙ‡ Ùˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚',
        run: async () => {
            UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Undo/Redo Ù¾Ø§ÛŒÙ‡ ===");
            UndoRedoManager.clear();
            
            // Û±. ØªØ³Øª Ø§ÛŒØ¬Ø§Ø¯ Ú†Ù†Ø¯ÛŒÙ† ØªØºÛŒÛŒØ±
            UndoRedoManager.setState('user', 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª', { description: 'ØªÙ†Ø¸ÛŒÙ… Ú©Ø§Ø±Ø¨Ø±' });
            UndoRedoManager.setState('score', 0, { description: 'Ø´Ø±ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø²' });
            UndoRedoManager.setState('level', 1, { description: 'Ø´Ø±ÙˆØ¹ Ø³Ø·Ø­' });
            UndoRedoManager.setState('score', 50, { description: 'Ø§ÙØ²Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø²' });
            UndoRedoManager.setState('level', 2, { description: 'Ø§Ø±ØªÙ‚Ø§Ø¡ Ø³Ø·Ø­' });
            
            if (UndoRedoManager.history.length !== 5) {
                throw new Error(`ØªØ¹Ø¯Ø§Ø¯ actions ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: 5ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${UndoRedoManager.history.length}`);
            }
            
            // Û². ØªØ³Øª Undo
            const undo1 = UndoRedoManager.undo(); // Ø¨Ø§ÛŒØ¯ level Ø±Ø§ Ø§Ø² 2 Ø¨Ù‡ 1 Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯
            if (!undo1 || undo1.description !== 'Ø§Ø±ØªÙ‚Ø§Ø¡ Ø³Ø·Ø­') {
                throw new Error('Undo Ø§ÙˆÙ„ Ø§Ø´ØªØ¨Ø§Ù‡ Ø¹Ù…Ù„ Ú©Ø±Ø¯');
            }
            if (UndoRedoManager.state.level !== 1) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² undoØŒ level Ø¨Ø§ÛŒØ¯ 1 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.level} Ø§Ø³Øª`);
            }
            
            const undo2 = UndoRedoManager.undo(); // Ø¨Ø§ÛŒØ¯ score Ø±Ø§ Ø§Ø² 50 Ø¨Ù‡ 0 Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯
            if (UndoRedoManager.state.score !== 0) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² undo Ø¯ÙˆÙ…ØŒ score Ø¨Ø§ÛŒØ¯ 0 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.score} Ø§Ø³Øª`);
            }
            
            // Û³. ØªØ³Øª Redo
            const redo1 = UndoRedoManager.redo(); // Ø¨Ø§ÛŒØ¯ score Ø±Ø§ Ø¨Ù‡ 50 Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯
            if (!redo1 || redo1.description !== 'Ø§ÙØ²Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø²') {
                throw new Error('Redo Ø§ÙˆÙ„ Ø§Ø´ØªØ¨Ø§Ù‡ Ø¹Ù…Ù„ Ú©Ø±Ø¯');
            }
            if (UndoRedoManager.state.score !== 50) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² redoØŒ score Ø¨Ø§ÛŒØ¯ 50 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.score} Ø§Ø³Øª`);
            }
            
            // Û´. ØªØ³Øª Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚ ØªØ§Ø±ÛŒØ®Ú†Ù‡
            UndoRedoManager.maxHistorySize = 3;
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† actions Ø¨ÛŒØ´ØªØ± Ø§Ø² limit
            UndoRedoManager.setState('coins', 100, { description: 'Ø§ÙØ²Ø§ÛŒØ´ Ø³Ú©Ù‡â€ŒÙ‡Ø§' });
            UndoRedoManager.setState('coins', 150, { description: 'Ø§ÙØ²Ø§ÛŒØ´ Ø¨ÛŒØ´ØªØ± Ø³Ú©Ù‡â€ŒÙ‡Ø§' });
            UndoRedoManager.setState('coins', 200, { description: 'Ø­Ø¯Ø§Ú©Ø«Ø± Ø³Ú©Ù‡â€ŒÙ‡Ø§' });
            
            if (UndoRedoManager.history.length > 3) {
                throw new Error(`Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±Ø¹Ø§ÛŒØª Ù†Ø´Ø¯. Ø§Ù†ØªØ¸Ø§Ø±: Ø­Ø¯Ø§Ú©Ø«Ø± 3ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${UndoRedoManager.history.length}`);
            }
            
            // Ûµ. ØªØ³Øª Undo ØªÙ…Ø§Ù… actions
            while (UndoRedoManager.currentIndex >= 0) {
                UndoRedoManager.undo();
            }
            
            if (UndoRedoManager.currentIndex !== -1) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² undo Ù‡Ù…Ù‡ actionsØŒ currentIndex Ø¨Ø§ÛŒØ¯ -1 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.currentIndex} Ø§Ø³Øª`);
            }
            
            // Û¶. ØªØ³Øª Redo ØªÙ…Ø§Ù… actions
            while (UndoRedoManager.future.length > 0) {
                UndoRedoManager.redo();
            }
            
            if (UndoRedoManager.future.length !== 0) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² redo Ù‡Ù…Ù‡ actionsØŒ future Ø¨Ø§ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.future.length} Ø¢ÛŒØªÙ… Ø¯Ø§Ø±Ø¯`);
            }
            
            // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† limit Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡
            UndoRedoManager.maxHistorySize = 50;
            
            UndoRedoManager.log("âœ… ØªØ³Øª Undo/Redo Ù¾Ø§ÛŒÙ‡ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯", 'success');
            
            return `âœ… Undo/Redo Ù¾Ø§ÛŒÙ‡ ØµØ­ÛŒØ­ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (${UndoRedoManager.history.length} action Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡)`;
        }
    },
    {
        id: 'test2',
        name: 'Grouped Actions Ùˆ Transactions',
        run: async () => {
            UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Grouped Actions ===");
            UndoRedoManager.clear();
            
            // Û±. Ø´Ø±ÙˆØ¹ ÛŒÚ© transaction
            const transactionId = UndoRedoManager.beginTransaction('Ø®Ø±ÛŒØ¯ Ø¯Ø±Ø³ Ø²Ø¨Ø§Ù†');
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† actions Ø¨Ù‡ transaction
            UndoRedoManager.setState('cart', [], { description: 'Ø®Ø§Ù„ÛŒ Ú©Ø±Ø¯Ù† Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯' });
            UndoRedoManager.setState('total', 0, { description: 'ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬Ù…ÙˆØ¹' });
            UndoRedoManager.setState('cart', ['Ø¯Ø±Ø³ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ù…Ù‚Ø¯Ù…Ø§ØªÛŒ'], { description: 'Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø±Ø³ Ø¨Ù‡ Ø³Ø¨Ø¯' });
            UndoRedoManager.setState('total', 50, { description: 'Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø¬Ù…ÙˆØ¹' });
            UndoRedoManager.setState('userCoins', 100, { description: 'ØªÙ†Ø¸ÛŒÙ… Ø³Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø±' });
            UndoRedoManager.setState('userCoins', 50, { description: 'Ú©Ø³Ø± Ù‡Ø²ÛŒÙ†Ù‡ Ø®Ø±ÛŒØ¯' });
            
            // Û². commit transaction
            const transaction = UndoRedoManager.commitTransaction();
            
            if (!transaction) {
                throw new Error('Transaction commit Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
            }
            
            if (transaction.actions.length !== 6) {
                throw new Error(`ØªØ¹Ø¯Ø§Ø¯ actions Ø¯Ø± transaction Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: 6ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${transaction.actions.length}`);
            }
            
            // Û³. Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ transaction Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© action Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø«Ø¨Øª Ø´Ø¯Ù‡
            const lastAction = UndoRedoManager.history[UndoRedoManager.history.length - 1];
            if (lastAction.type !== 'TRANSACTION') {
                throw new Error('Transaction Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø«Ø¨Øª Ù†Ø´Ø¯');
            }
            
            // Û´. Undo Ú©Ø±Ø¯Ù† transaction (Ø¨Ø§ÛŒØ¯ ØªÙ…Ø§Ù… 6 action Ø¨Ø§ ÛŒÚ© Undo Ø¨Ø±Ú¯Ø±Ø¯Ù†Ø¯)
            const initialHistoryLength = UndoRedoManager.history.length;
            UndoRedoManager.undo();
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ú¯Ø´Øª stateÙ‡Ø§
            if (UndoRedoManager.state.userCoins !== 100) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² undo transactionØŒ userCoins Ø¨Ø§ÛŒØ¯ 100 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.userCoins} Ø§Ø³Øª`);
            }
            
            if (JSON.stringify(UndoRedoManager.state.cart) !== JSON.stringify([])) {
                throw new Error('Ø¨Ø¹Ø¯ Ø§Ø² undo transactionØŒ cart Ø¨Ø§ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯');
            }
            
            // Ûµ. ØªØ³Øª nested transactions
            UndoRedoManager.beginTransaction('ØªØ±Ø§Ú©Ù†Ø´ ÙˆØ§Ù„Ø¯');
            UndoRedoManager.setState('parent', 'Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ù„Ø¯', { description: 'ØªÙ†Ø¸ÛŒÙ… ÙˆØ§Ù„Ø¯' });
            
            UndoRedoManager.beginTransaction('ØªØ±Ø§Ú©Ù†Ø´ ÙØ±Ø²Ù†Ø¯');
            UndoRedoManager.setState('child', 'Ù…Ù‚Ø¯Ø§Ø± ÙØ±Ø²Ù†Ø¯', { description: 'ØªÙ†Ø¸ÛŒÙ… ÙØ±Ø²Ù†Ø¯' });
            UndoRedoManager.commitTransaction();
            
            UndoRedoManager.setState('parent', 'Ù…Ù‚Ø¯Ø§Ø± ÙˆØ§Ù„Ø¯ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡', { description: 'ØªØºÛŒÛŒØ± ÙˆØ§Ù„Ø¯' });
            UndoRedoManager.commitTransaction();
            
            // Û¶. ØªØ³Øª rollback transaction
            UndoRedoManager.beginTransaction('ØªØ±Ø§Ú©Ù†Ø´ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø±Ø§ÛŒ rollback');
            UndoRedoManager.setState('temp', 'Ù…Ù‚Ø¯Ø§Ø± Ù…ÙˆÙ‚Øª', { description: 'ØªÙ†Ø¸ÛŒÙ… Ù…ÙˆÙ‚Øª' });
            UndoRedoManager.setState('temp', 'Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯', { description: 'ØªØºÛŒÛŒØ± Ù…ÙˆÙ‚Øª' });
            
            const beforeRollbackState = JSON.stringify(UndoRedoManager.state);
            UndoRedoManager.rollbackTransaction();
            
            if (UndoRedoManager.state.temp !== undefined) {
                throw new Error('Ø¨Ø¹Ø¯ Ø§Ø² rollbackØŒ temp Ø¨Ø§ÛŒØ¯ undefined Ø¨Ø§Ø´Ø¯');
            }
            
            // Û·. Ø¨Ø±Ø±Ø³ÛŒ empty transaction
            UndoRedoManager.beginTransaction('ØªØ±Ø§Ú©Ù†Ø´ Ø®Ø§Ù„ÛŒ');
            const emptyTransaction = UndoRedoManager.commitTransaction();
            
            if (emptyTransaction.actions.length !== 0) {
                throw new Error('ØªØ±Ø§Ú©Ù†Ø´ Ø®Ø§Ù„ÛŒ Ø¨Ø§ÛŒØ¯ 0 action Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯');
            }
            
            UndoRedoManager.log("âœ… ØªØ³Øª Grouped Actions Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯", 'success');
            
            return `âœ… Transactions ØµØ­ÛŒØ­ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ (${transaction.actions.length} action Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø´Ø¯Ù†Ø¯)`;
        }
    },
    {
        id: 'test3',
        name: 'Time Travel Ùˆ Export/Import ØªØ§Ø±ÛŒØ®Ú†Ù‡',
        run: async () => {
            UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Time Travel ===");
            UndoRedoManager.clear();
            
            // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ø³Ø±ÛŒ ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ ÙÙˆØ§ØµÙ„ Ø²Ù…Ø§Ù†ÛŒ
            const startTime = Date.now();
            
            UndoRedoManager.setState('step', 1, { 
                description: 'Ù…Ø±Ø­Ù„Ù‡ Û±: Ø´Ø±ÙˆØ¹',
                timestamp: startTime 
            });
            
            await new Promise(resolve => setTimeout(resolve, 100));
            UndoRedoManager.setState('step', 2, { 
                description: 'Ù…Ø±Ø­Ù„Ù‡ Û²: Ù¾ÛŒØ´Ø±ÙØª',
                timestamp: startTime + 100 
            });
            
            await new Promise(resolve => setTimeout(resolve, 100));
            UndoRedoManager.setState('step', 3, { 
                description: 'Ù…Ø±Ø­Ù„Ù‡ Û³: Ø§Ø¯Ø§Ù…Ù‡',
                timestamp: startTime + 200 
            });
            
            await new Promise(resolve => setTimeout(resolve, 100));
            UndoRedoManager.setState('step', 4, { 
                description: 'Ù…Ø±Ø­Ù„Ù‡ Û´: Ù†Ø²Ø¯ÛŒÚ© Ù¾Ø§ÛŒØ§Ù†',
                timestamp: startTime + 300 
            });
            
            await new Promise(resolve => setTimeout(resolve, 100));
            UndoRedoManager.setState('step', 5, { 
                description: 'Ù…Ø±Ø­Ù„Ù‡ Ûµ: Ù¾Ø§ÛŒØ§Ù†',
                timestamp: startTime + 400 
            });
            
            // Û±. ØªØ³Øª jump Ø¨Ù‡ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ø®Ø§Øµ
            const jumpIndex = 2; // Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Û³ Ø¨Ø±Ùˆ
            const success = UndoRedoManager.jumpToHistoryIndex(jumpIndex);
            
            if (!success) {
                throw new Error('jumpToHistoryIndex Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
            }
            
            if (UndoRedoManager.state.step !== 3) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² jump Ø¨Ù‡ Ø§ÛŒÙ†Ø¯Ú©Ø³ ${jumpIndex}ØŒ step Ø¨Ø§ÛŒØ¯ 3 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.step} Ø§Ø³Øª`);
            }
            
            // Û². ØªØ³Øª jump Ø¨Ù‡ timestamp
            const targetTimestamp = startTime + 100; // Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Û² Ø¨Ø±ÙˆØ¯
            const timestampSuccess = UndoRedoManager.jumpToTimestamp(targetTimestamp);
            
            if (!timestampSuccess) {
                throw new Error('jumpToTimestamp Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
            }
            
            if (UndoRedoManager.state.step !== 2) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² jump Ø¨Ù‡ timestampØŒ step Ø¨Ø§ÛŒØ¯ 2 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.step} Ø§Ø³Øª`);
            }
            
            // Û³. ØªØ³Øª export ØªØ§Ø±ÛŒØ®Ú†Ù‡
            const exported = UndoRedoManager.exportHistory();
            
            if (!exported || exported.length === 0) {
                throw new Error('export ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
            }
            
            // Û´. ØªØºÛŒÛŒØ± state Ùˆ ØªØ³Øª import
            UndoRedoManager.setState('extra', 'Ù…Ù‚Ø¯Ø§Ø± Ø§Ø¶Ø§ÙÙ‡', { description: 'Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ø±Ø§ÛŒ ØªØ³Øª' });
            
            const beforeImportState = UndoRedoManager.state.step;
            const importSuccess = UndoRedoManager.importHistory(exported);
            
            if (!importSuccess) {
                throw new Error('import ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯');
            }
            
            // Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ state Ù‚Ø¨Ù„ Ø§Ø² export Ø¨Ø±Ú¯Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
            if (UndoRedoManager.state.step !== 2) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² importØŒ step Ø¨Ø§ÛŒØ¯ 2 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.step} Ø§Ø³Øª`);
            }
            
            // Ûµ. ØªØ³Øª jump Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ Ùˆ Ø§Ù†ØªÙ‡Ø§
            UndoRedoManager.jumpToHistoryIndex(0); // Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§
            if (UndoRedoManager.state.step !== 1) {
                throw new Error('jump Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ Ú©Ø§Ø± Ù†Ú©Ø±Ø¯');
            }
            
            UndoRedoManager.jumpToHistoryIndex(UndoRedoManager.history.length - 1); // Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§
            if (UndoRedoManager.state.step !== 5) {
                throw new Error('jump Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ Ú©Ø§Ø± Ù†Ú©Ø±Ø¯');
            }
            
            // Û¶. ØªØ³Øª jump Ø¨Ù‡ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù†Ø§Ù…Ø¹ØªØ¨Ø±
            const invalidJump = UndoRedoManager.jumpToHistoryIndex(100);
            if (invalidJump) {
                throw new Error('jump Ø¨Ù‡ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¨Ø§ÛŒØ¯ false Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯');
            }
            
            UndoRedoManager.log("âœ… ØªØ³Øª Time Travel Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯", 'success');
            
            return `âœ… Time Travel ØµØ­ÛŒØ­ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (${UndoRedoManager.history.length} actionØŒ export/import Ù…ÙˆÙÙ‚)`;
        }
    },
    {
        id: 'test4',
        name: 'Action Logging Ùˆ Replay',
        run: async () => {
            UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Action Logging ===");
            UndoRedoManager.clear();
            
            // Û±. Ø§ÛŒØ¬Ø§Ø¯ actions Ù…Ø®ØªÙ„Ù Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯
            const actionsToLog = [
                { key: 'userProgress', value: 0, desc: 'Ø´Ø±ÙˆØ¹ Ù¾ÛŒØ´Ø±ÙØª Ú©Ø§Ø±Ø¨Ø±' },
                { key: 'userProgress', value: 25, desc: 'Ù¾ÛŒØ´Ø±ÙØª Û²ÛµÙª' },
                { key: 'userProgress', value: 50, desc: 'Ù¾ÛŒØ´Ø±ÙØª ÛµÛ°Ùª' },
                { key: 'completedLessons', value: [], desc: 'Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡' },
                { key: 'completedLessons', value: ['Ø¯Ø±Ø³ Û±'], desc: 'ØªÚ©Ù…ÛŒÙ„ Ø¯Ø±Ø³ Û±' },
                { key: 'completedLessons', value: ['Ø¯Ø±Ø³ Û±', 'Ø¯Ø±Ø³ Û²'], desc: 'ØªÚ©Ù…ÛŒÙ„ Ø¯Ø±Ø³ Û²' },
                { key: 'score', value: 100, desc: 'Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ' }
            ];
            
            // Ø§Ø¬Ø±Ø§ÛŒ actions
            for (const action of actionsToLog) {
                UndoRedoManager.setState(action.key, action.value, { 
                    description: action.desc 
                });
            }
            
            // Û². Ø¨Ø±Ø±Ø³ÛŒ action log
            if (UndoRedoManager.actionLog.length !== actionsToLog.length) {
                throw new Error(`ØªØ¹Ø¯Ø§Ø¯ actions Ø¯Ø± log Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: ${actionsToLog.length}ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${UndoRedoManager.actionLog.length}`);
            }
            
            // Û³. ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹
            const setStateLogs = UndoRedoManager.actionLog.filter(log => log.type === 'SET_STATE');
            if (setStateLogs.length !== actionsToLog.length) {
                throw new Error('ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯ Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
            }
            
            // Û´. ØªØ³Øª replay
            // Ø§ÙˆÙ„ state Ø±Ø§ reset Ú©Ù†ÛŒÙ…
            UndoRedoManager.state = {};
            
            // replay actions Ø¨Ø§ Ø³Ø±Ø¹Øª Ø³Ø±ÛŒØ¹
            await UndoRedoManager.replayActions(setStateLogs, 50);
            
            // Ø¨Ø±Ø±Ø³ÛŒ state Ø¨Ø¹Ø¯ Ø§Ø² replay
            if (UndoRedoManager.state.userProgress !== 50) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² replayØŒ userProgress Ø¨Ø§ÛŒØ¯ 50 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.userProgress} Ø§Ø³Øª`);
            }
            
            if (JSON.stringify(UndoRedoManager.state.completedLessons) !== JSON.stringify(['Ø¯Ø±Ø³ Û±', 'Ø¯Ø±Ø³ Û²'])) {
                throw new Error('Ø¨Ø¹Ø¯ Ø§Ø² replayØŒ completedLessons Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
            }
            
            if (UndoRedoManager.state.score !== 100) {
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² replayØŒ score Ø¨Ø§ÛŒØ¯ 100 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.score} Ø§Ø³Øª`);
            }
            
            // Ûµ. ØªØ³Øª replay Ø¬Ø²Ø¦ÛŒ
            const partialActions = setStateLogs.slice(0, 3); // ÙÙ‚Ø· Û³ action Ø§ÙˆÙ„
            UndoRedoManager.state = {};
            
            await UndoRedoManager.replayActions(partialActions, 30);
            
            if (UndoRedoManager.state.userProgress !== 50) { // Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø¢Ø®Ø±ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø± partialActions Ø¨Ø±Ø³Ø¯
                throw new Error(`Ø¨Ø¹Ø¯ Ø§Ø² replay Ø¬Ø²Ø¦ÛŒØŒ userProgress Ø¨Ø§ÛŒØ¯ 50 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.userProgress} Ø§Ø³Øª`);
            }
            
            // Û¶. ØªØ³Øª Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ transactionÙ‡Ø§
            UndoRedoManager.clear();
            
            UndoRedoManager.beginTransaction('ØªØ±Ø§Ú©Ù†Ø´ ØªØ³Øª Ù„Ø§Ú¯');
            UndoRedoManager.setState('test1', 'value1', { description: 'ØªØ³Øª Û±' });
            UndoRedoManager.setState('test2', 'value2', { description: 'ØªØ³Øª Û²' });
            UndoRedoManager.commitTransaction();
            
            // Ø¨Ø§ÛŒØ¯ Û³ Ù„Ø§Ú¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒÙ…: Û² SET_STATE + Û± TRANSACTION
            if (UndoRedoManager.actionLog.length !== 3) {
                throw new Error(`Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ transaction Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: 3ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${UndoRedoManager.actionLog.length}`);
            }
            
            // Û·. ØªØ³Øª Ù„Ø§Ú¯ undo/redo actions
            const beforeUndoLogCount = UndoRedoManager.actionLog.length;
            UndoRedoManager.undo();
            
            // Ø¨Ø§ÛŒØ¯ ÛŒÚ© Ù„Ø§Ú¯ Ø¨Ø±Ø§ÛŒ undo Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
            if (UndoRedoManager.actionLog.length !== beforeUndoLogCount + 1) {
                throw new Error('Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ undo Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯');
            }
            
            const undoLog = UndoRedoManager.actionLog[UndoRedoManager.actionLog.length - 1];
            if (!undoLog.description || !undoLog.description.includes('Undo')) {
                throw new Error('Ù„Ø§Ú¯ undo Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØµØ­ÛŒØ­ Ù†Ø¯Ø§Ø±Ø¯');
            }
            
            UndoRedoManager.log("âœ… ØªØ³Øª Action Logging Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯", 'success');
            
            return `âœ… Action Logging Ùˆ Replay ØµØ­ÛŒØ­ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯ (${UndoRedoManager.actionLog.length} action Ù„Ø§Ú¯ Ø´Ø¯Ù‡)`;
        }
    }
];

// ========== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ==========
async function runAllUndoRedoTests() {
    const runBtn = document.getElementById('run-btn');
    runBtn.disabled = true;
    runBtn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo...';
    
    // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ù†Ø³ÙˆÙ„
    document.getElementById('console').innerHTML = '<div class="log">[Ø³ÛŒØ³ØªÙ…] ØªØ³Øª Undo/Redo + Time Travel Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</div>';
    
    UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo ===");
    
    let passed = 0;
    
    for (let i = 0; i < undoRedoTests.length; i++) {
        const test = undoRedoTests[i];
        const testElement = document.getElementById(test.id);
        const statusElement = document.getElementById(`status${i+1}`);
        const outputElement = document.getElementById(`output${i+1}`);
        
        // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§
        testElement.className = 'test-item running';
        statusElement.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§';
        statusElement.className = 'test-status status-running';
        outputElement.innerHTML = '<span style="color:#666">Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ...</span>';
        
        try {
            UndoRedoManager.log(`Ø´Ø±ÙˆØ¹ ØªØ³Øª: ${test.name}`);
            
            // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± ØªØ³Øª
            UndoRedoManager.clear();
            
            const result = await test.run();
            
            // ØªØ³Øª Ù…ÙˆÙÙ‚
            testElement.className = 'test-item passed';
            statusElement.textContent = 'Ù…ÙˆÙÙ‚';
            statusElement.className = 'test-status status-passed';
            outputElement.innerHTML = `<div style="color:#2e7d32">${result}</div>`;
            passed++;
            
            UndoRedoManager.log(`ØªØ³Øª "${test.name}" Ù…ÙˆÙÙ‚`, 'success');
            
        } catch (error) {
            // ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚
            testElement.className = 'test-item failed';
            statusElement.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
            statusElement.className = 'test-status status-failed';
            outputElement.innerHTML = `<div style="color:#c62828"><strong>âŒ Ø®Ø·Ø§:</strong> ${error.message}</div>`;
            
            UndoRedoManager.log(`ØªØ³Øª "${test.name}" Ù†Ø§Ù…ÙˆÙÙ‚: ${error.message}`, 'error');
        }
        
        // ØªØ§Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡ Ø¨ÛŒÙ† ØªØ³Øªâ€ŒÙ‡Ø§
        await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    runBtn.disabled = false;
    runBtn.textContent = `ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ (${passed}/${undoRedoTests.length} Ù…ÙˆÙÙ‚)`;
    
    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
    if (passed === undoRedoTests.length) {
        UndoRedoManager.log("ğŸ‰ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø´Øª Ø³Ø± Ú¯Ø°Ø§Ø´ØªÙ‡ Ø´Ø¯Ù†Ø¯!", 'success');
        UndoRedoManager.log("âœ… Ø³ÛŒØ³ØªÙ… Undo/Redo Ø¨Ø±Ø§ÛŒ Vakamova Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.", 'success');
    } else {
        UndoRedoManager.log(`ØªØ³Øªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù†Ø¯: ${passed} Ø§Ø² ${undoRedoTests.length} Ù…ÙˆÙÙ‚`, 
                          passed >= 3 ? 'success' : 'warning');
    }
}

// ========== Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ø±Ø¨Ø± ==========
async function runUserSimulation() {
    UndoRedoManager.clear();
    UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ø±Ø¨Ø± Vakamova ===");
    
    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ÛŒÚ© Ø¬Ù„Ø³Ù‡ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø²Ø¨Ø§Ù†
    UndoRedoManager.setState('currentLanguage', 'english', { description: 'Ø§Ù†ØªØ®Ø§Ø¨ Ø²Ø¨Ø§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ' });
    UndoRedoManager.setState('currentLevel', 'beginner', { description: 'Ø³Ø·Ø­ Ù…Ø¨ØªØ¯ÛŒ' });
    
    // Ø´Ø±ÙˆØ¹ ÛŒÚ© Ø¯Ø±Ø³
    UndoRedoManager.beginTransaction('Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø³ Û±');
    UndoRedoManager.setState('currentLesson', 'Ø¯Ø±Ø³ Û±: Ø³Ù„Ø§Ù… Ùˆ Ø§Ø­ÙˆØ§Ù„Ù¾Ø±Ø³ÛŒ', { description: 'Ø´Ø±ÙˆØ¹ Ø¯Ø±Ø³' });
    UndoRedoManager.setState('lessonProgress', 0, { description: 'Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³' });
    UndoRedoManager.setState('score', 0, { description: 'Ø´Ø±ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø²' });
    UndoRedoManager.commitTransaction();
    
    // Ø§Ù†Ø¬Ø§Ù… ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§
    await new Promise(resolve => setTimeout(resolve, 300));
    UndoRedoManager.setState('score', 20, { description: 'ØªÙ…Ø±ÛŒÙ† Û± ØªÚ©Ù…ÛŒÙ„' });
    UndoRedoManager.setState('lessonProgress', 25, { description: 'Ù¾ÛŒØ´Ø±ÙØª Û²ÛµÙª' });
    
    await new Promise(resolve => setTimeout(resolve, 300));
    UndoRedoManager.setState('score', 45, { description: 'ØªÙ…Ø±ÛŒÙ† Û² ØªÚ©Ù…ÛŒÙ„' });
    UndoRedoManager.setState('lessonProgress', 50, { description: 'Ù¾ÛŒØ´Ø±ÙØª ÛµÛ°Ùª' });
    
    // Ø§Ø´ØªØ¨Ø§Ù‡ Ú©Ø§Ø±Ø¨Ø± - Undo Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    await new Promise(resolve => setTimeout(resolve, 300));
    UndoRedoManager.log("Ú©Ø§Ø±Ø¨Ø± Ø§Ø´ØªØ¨Ø§Ù‡ Ú©Ø±Ø¯ - Ø¯Ø± Ø­Ø§Ù„ Undo...", 'warning');
    UndoRedoManager.undo();
    UndoRedoManager.undo();
    
    // Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    await new Promise(resolve => setTimeout(resolve, 300));
    UndoRedoManager.setState('score', 40, { description: 'ØªÙ…Ø±ÛŒÙ† Û² (ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯)' });
    UndoRedoManager.setState('lessonProgress', 50, { description: 'Ù¾ÛŒØ´Ø±ÙØª ÛµÛ°Ùª (ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯)' });
    
    // Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø±Ø³
    await new Promise(resolve => setTimeout(resolve, 300));
    UndoRedoManager.setState('score', 65, { description: 'ØªÙ…Ø±ÛŒÙ† Û³ ØªÚ©Ù…ÛŒÙ„' });
    UndoRedoManager.setState('lessonProgress', 75, { description: 'Ù¾ÛŒØ´Ø±ÙØª Û·ÛµÙª' });
    
    await new Promise(resolve => setTimeout(resolve, 300));
    UndoRedoManager.setState('score', 85, { description: 'ØªÙ…Ø±ÛŒÙ† Û´ ØªÚ©Ù…ÛŒÙ„' });
    UndoRedoManager.setState('lessonProgress', 100, { description: 'Ù¾ÛŒØ´Ø±ÙØª Û±Û°Û°Ùª - Ø¯Ø±Ø³ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!' });
    
    // ØªÚ©Ù…ÛŒÙ„ Ø¯Ø±Ø³
    UndoRedoManager.beginTransaction('ØªÚ©Ù…ÛŒÙ„ Ø¯Ø±Ø³ Û±');
    UndoRedoManager.setState('completedLessons', ['Ø¯Ø±Ø³ Û±: Ø³Ù„Ø§Ù… Ùˆ Ø§Ø­ÙˆØ§Ù„Ù¾Ø±Ø³ÛŒ'], { description: 'Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡' });
    UndoRedoManager.setState('totalScore', 85, { description: 'Ø°Ø®ÛŒØ±Ù‡ Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„' });
    UndoRedoManager.setState('currentLesson', null, { description: 'Ù¾Ø§ÛŒØ§Ù† Ø¯Ø±Ø³' });
    UndoRedoManager.setState('lessonProgress', 0, { description: 'Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ù¾ÛŒØ´Ø±ÙØª' });
    UndoRedoManager.commitTransaction();
    
    UndoRedoManager.log("ğŸ® Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ø±Ø¨Ø± Ú©Ø§Ù…Ù„ Ø´Ø¯!", 'success');
    UndoRedoManager.log("Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Undo/Redo Ø¨Ø±Ø§ÛŒ Ø¢Ø²Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯", 'info');
}

// ========== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ==========
document.addEventListener('DOMContentLoaded', () => {
    // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ
    document.getElementById('run-btn').addEventListener('click', runAllUndoRedoTests);
    document.getElementById('run-simulation-btn').addEventListener('click', runUserSimulation);
    
    // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„
    document.getElementById('undo-btn').addEventListener('click', () => UndoRedoManager.undo());
    document.getElementById('redo-btn').addEventListener('click', () => UndoRedoManager.redo());
    document.getElementById('clear-history-btn').addEventListener('click', () => UndoRedoManager.clearHistory());
    document.getElementById('jump-to-btn').addEventListener('click', () => {
        const index = prompt('Ø¨Ù‡ Ú©Ø¯Ø§Ù… Ø§ÛŒÙ†Ø¯Ú©Ø³ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø±ÙˆÛŒØ¯ØŸ (Û± ØªØ§ ' + UndoRedoManager.history.length + ')');
        if (index) {
            const idx = parseInt(index) - 1;
            if (idx >= 0 && idx < UndoRedoManager.history.length) {
                UndoRedoManager.jumpToHistoryIndex(idx);
            }
        }
    });
    
    UndoRedoManager.log("Ø³ÛŒØ³ØªÙ… Undo/Redo + Time Travel Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.");
    UndoRedoManager.log("Û±. Ø±ÙˆÛŒ 'Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ÛŒØ§");
    UndoRedoManager.log("Û². Ø±ÙˆÛŒ 'Ø§Ø¬Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ø±Ø¨Ø±' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ ÛŒÚ© Ø³Ù†Ø§Ø±ÛŒÙˆ ÙˆØ§Ù‚Ø¹ÛŒ ØªØ³Øª Ø´ÙˆØ¯");
    
    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ UI
    UndoRedoManager.updateControls();
    UndoRedoManager.updateVisualizations();
    UndoRedoManager.updateHistoryTimeline();
});
</script>
</body>
</html>
