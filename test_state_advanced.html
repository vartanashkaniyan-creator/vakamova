<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªØ³Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ State Manager</title>
    <style>
        body { font-family: Tahoma; margin: 20px; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .success { background: #d4edda; padding: 10px; }
        .error { background: #f8d7da; padding: 10px; }
        #output { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ State Manager</h1>
    
    <div class="test-section">
        <h3>ØªØ³Øª Undo/Redo</h3>
        <button onclick="testUndoRedo()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        <div id="undoOutput"></div>
    </div>
    
    <div class="test-section">
        <h3>ØªØ³Øª Performance (1000 ØªØºÛŒÛŒØ±)</h3>
        <button onclick="testPerformance()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        <div id="perfOutput"></div>
    </div>
    
    <div class="test-section">
        <h3>ØªØ³Øª Validation State</h3>
        <button onclick="testValidation()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        <div id="validOutput"></div>
    </div>
    
    <div class="test-section">
        <h3>ØªØ³Øª Error Handling</h3>
        <button onclick="testErrorHandling()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª</button>
        <div id="errorOutput"></div>
    </div>

    <script type="module">
        import StateManager from './core/state-manager.js';
        
        // Ø§ÛŒØ¬Ø§Ø¯ State Manager Ø¨Ø§ Ø§Ø³Ú©ÛŒÙ…Ø§
        const stateSchema = {
            user: {
                name: 'string',
                email: 'string',
                level: 'number'
            },
            lesson: {
                id: 'string',
                progress: 'number',
                completed: 'boolean'
            },
            app: {
                theme: 'string',
                language: 'string'
            }
        };
        
        const stateManager = new StateManager(stateSchema);
        
        // --- ØªÙˆØ§Ø¨Ø¹ ØªØ³Øª ---
        
        window.testUndoRedo = async function() {
            const output = document.getElementById('undoOutput');
            output.innerHTML = '<p>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...</p>';
            
            try {
                // ØªØºÛŒÛŒØ±Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
                stateManager.setState({ user: { name: 'Ú©Ø§Ø±Ø¨Ø± Ø§ÙˆÙ„', email: 'test@test.com', level: 1 } });
                stateManager.setState({ user: { name: 'Ú©Ø§Ø±Ø¨Ø± Ø¯ÙˆÙ…', email: 'test2@test.com', level: 2 } });
                stateManager.setState({ app: { theme: 'dark', language: 'fa' } });
                
                let current = stateManager.getState();
                output.innerHTML += `<p>âœ… Ø­Ø§Ù„Øª ÙØ¹Ù„ÛŒ: ${JSON.stringify(current.user)}</p>`;
                
                // Undo
                const undone = stateManager.undo();
                output.innerHTML += `<p>${undone ? 'âœ… Ø¹Ù…Ù„ÛŒØ§Øª Undo Ù…ÙˆÙÙ‚' : 'âŒ Undo Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯'}</p>`;
                
                current = stateManager.getState();
                output.innerHTML += `<p>âœ… Ø¨Ø¹Ø¯ Ø§Ø² Undo: ${JSON.stringify(current.user)}</p>`;
                
                // Redo
                const redone = stateManager.redo();
                output.innerHTML += `<p>${redone ? 'âœ… Ø¹Ù…Ù„ÛŒØ§Øª Redo Ù…ÙˆÙÙ‚' : 'âŒ Redo Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯'}</p>`;
                
                current = stateManager.getState();
                output.innerHTML += `<p>âœ… Ø¨Ø¹Ø¯ Ø§Ø² Redo: ${JSON.stringify(current.user)}</p>`;
                
                output.innerHTML = `<div class="success">${output.innerHTML}</div>`;
            } catch (error) {
                output.innerHTML = `<div class="error">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
            }
        };
        
        window.testPerformance = async function() {
            const output = document.getElementById('perfOutput');
            output.innerHTML = '<p>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...</p>';
            
            try {
                const startTime = performance.now();
                
                // 1000 ØªØºÛŒÛŒØ± Ø³Ø±ÛŒØ¹
                for (let i = 1; i <= 1000; i++) {
                    stateManager.setState({ 
                        app: { theme: i % 2 === 0 ? 'dark' : 'light', language: 'fa' }
                    });
                }
                
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                output.innerHTML = `
                    <div class="success">
                        âœ… 1000 ØªØºÛŒÛŒØ± Ø¯Ø± ${duration.toFixed(2)} Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯<br>
                        âš¡ Ø³Ø±Ø¹Øª: ${(1000 / duration * 1000).toFixed(2)} Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø± Ø«Ø§Ù†ÛŒÙ‡<br>
                        ğŸ’¾ Ø§Ù†Ø¯Ø§Ø²Ù‡ state: ${JSON.stringify(stateManager.getState()).length} Ø¨Ø§ÛŒØª
                    </div>
                `;
            } catch (error) {
                output.innerHTML = `<div class="error">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
            }
        };
        
        window.testValidation = async function() {
            const output = document.getElementById('validOutput');
            output.innerHTML = '<p>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...</p>';
            
            try {
                // ØªØ³Øª Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù…ÙˆÙÙ‚
                stateManager.setState({ user: { name: 'Ø¹Ù„ÛŒ', email: 'ali@test.com', level: 5 } });
                output.innerHTML += '<p>âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¯Ø§Ø¯Ù‡ Ø¯Ø±Ø³Øª Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯</p>';
                
                // ØªØ³Øª Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯Ù‡ (Ø¨Ø§ try/catch)
                try {
                    stateManager.setState({ user: { name: 'Ø±Ø¶Ø§', email: 12345, level: 'high' } });
                    output.innerHTML += '<p>âŒ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ù…ÛŒâ€ŒØ¯Ø§Ø¯ Ø§Ù…Ø§ Ù†Ø¯Ø§Ø¯!</p>';
                } catch (error) {
                    output.innerHTML += `<p>âœ… Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø®Ø·Ø§ Ø±Ø§ Ú¯Ø±ÙØª: ${error.message}</p>`;
                }
                
                output.innerHTML = `<div class="success">${output.innerHTML}</div>`;
            } catch (error) {
                output.innerHTML = `<div class="error">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
            }
        };
        
        window.testErrorHandling = async function() {
            const output = document.getElementById('errorOutput');
            output.innerHTML = '<p>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§...</p>';
            
            try {
                // ØªØ³Øª Undo ÙˆÙ‚ØªÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª
                stateManager.clearHistory();
                const undone = stateManager.undo();
                output.innerHTML += `<p>${!undone ? 'âœ… Undo Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø®Ø§Ù„ÛŒ Ø¯Ø±Ø³Øª Ú©Ø§Ø± Ú©Ø±Ø¯' : 'âŒ Ø¨Ø§ÛŒØ¯ false Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯'}</p>`;
                
                // ØªØ³Øª Redo ÙˆÙ‚ØªÛŒ Redo history Ø®Ø§Ù„ÛŒ Ø§Ø³Øª
                const redone = stateManager.redo();
                output.innerHTML += `<p>${!redone ? 'âœ… Redo Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø®Ø§Ù„ÛŒ Ø¯Ø±Ø³Øª Ú©Ø§Ø± Ú©Ø±Ø¯' : 'âŒ Ø¨Ø§ÛŒØ¯ false Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯'}</p>`;
                
                // ØªØ³Øª setState Ø¨Ø§ Ø¯Ø§Ø¯Ù‡ null
                try {
                    stateManager.setState(null);
                    output.innerHTML += '<p>âŒ setState Ø¨Ø§ null Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ Ù…ÛŒâ€ŒØ¯Ø§Ø¯</p>';
                } catch (error) {
                    output.innerHTML += `<p>âœ… Ø®Ø·Ø§ÛŒ null Ú¯Ø±ÙØªÙ‡ Ø´Ø¯: ${error.message}</p>`;
                }
                
                // ØªØ³Øª getState Ø¨Ø§ Ù…Ø³ÛŒØ± Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯
                const value = stateManager.getState('some.nonexistent.path');
                output.innerHTML += `<p>âœ… Ù…Ø³ÛŒØ± Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø±Ú¯Ø´Øª: ${value}</p>`;
                
                output.innerHTML = `<div class="success">${output.innerHTML}</div>`;
            } catch (error) {
                output.innerHTML = `<div class="error">âŒ Ø®Ø·Ø§: ${error.message}</div>`;
            }
        };
        
        console.log('âœ… State Manager ØªØ³Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
    </script>
</body>
</html>
