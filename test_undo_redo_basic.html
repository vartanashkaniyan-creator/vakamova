<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Undo/Redo Ù¾Ø§ÛŒÙ‡ - Vakamova</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:tahoma;background:#006064;color:#333;padding:20px}.container{max-width:800px;margin:auto;background:#fff;border-radius:10px;overflow:hidden}header{background:#00838f;color:#fff;padding:20px;text-align:center}h1{font-size:1.5rem}.test-section{padding:20px}.test-item{background:#f5f5f5;border-radius:8px;padding:15px;margin-bottom:15px;border-right:5px solid#4db6ac}.passed{border-right-color:#43a047;background:#e8f5e9}.failed{border-right-color:#e53935;background:#ffebee}.running{border-right-color:#fb8c00;background:#fff3e0}.test-header{display:flex;justify-content:space-between;margin-bottom:10px}.test-name{font-weight:bold}.test-status{padding:3px 10px;border-radius:12px;font-size:.8rem}.status-pending{background:#fff9c4;color:#f57c00}.status-running{background:#bbdefb;color:#1565c0}.status-passed{background:#c8e6c9;color:#2e7d32}.status-failed{background:#ffcdd2;color:#c62828}button{background:#00838f;color:#fff;border:none;padding:12px 25px;border-radius:8px;font-size:1rem;cursor:pointer;width:100%;margin-top:15px}button:hover{background:#006064}.console{background:#263238;color:#80cbc4;padding:15px;margin-top:20px;border-radius:8px;font-family:monospace;font-size:.9rem;max-height:200px;overflow-y:auto}.log{padding:5px 0;border-bottom:1px solid #37474f}.history-view{background:#e0f7fa;padding:10px;border-radius:6px;margin:10px 0;font-family:monospace;font-size:.85rem;max-height:150px;overflow-y:auto}
    </style>
</head>
<body>
    <div class="container">
        <header><h1>â†©ï¸ ØªØ³Øª Undo/Redo Ù¾Ø§ÛŒÙ‡</h1></header>
        <div class="test-section">
            <div class="history-view" id="history-view">
                <strong>ğŸ“œ ØªØ§Ø±ÛŒØ®Ú†Ù‡:</strong> Ø¢Ù…Ø§Ø¯Ù‡
            </div>
            
            <div class="test-item" id="test1">
                <div class="test-header"><div class="test-name">Û±. Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚ ØªØ§Ø±ÛŒØ®Ú†Ù‡ (max:5)</div><div class="test-status status-pending" id="status1">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output1"></div>
            </div>
            <div class="test-item" id="test2">
                <div class="test-header"><div class="test-name">Û². Undo/Redo Ú†Ù†Ø¯ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ</div><div class="test-status status-pending" id="status2">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output2"></div>
            </div>
            <div class="test-item" id="test3">
                <div class="test-header"><div class="test-name">Û³. ØµØ­Øª Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø²Ú¯Ø´Øª</div><div class="test-status status-pending" id="status3">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output3"></div>
            </div>
            <div class="test-item" id="test4">
                <div class="test-header"><div class="test-name">Û´. Ø´Ù…Ø§Ø±Ø´ Ø¯Ù‚ÛŒÙ‚ actions</div><div class="test-status status-pending" id="status4">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output4"></div>
            </div>
            
            <button id="run-btn">â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§</button>
            
            <div class="console" id="console">
                <div class="log">[Ø³ÛŒØ³ØªÙ…] ØªØ³Øª Undo/Redo Ù¾Ø§ÛŒÙ‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</div>
            </div>
        </div>
    </div>

<script>
// ========== State Manager Ø¨Ø§ Undo/Redo ==========
const UndoRedoManager = {
    state: { user: { coins: 100, level: 1 }, cart: [], lastAction: null },
    history: [],
    future: [], // Ø¨Ø±Ø§ÛŒ Redo
    maxHistorySize: 5,
    isInTransaction: false,
    transactionActions: [],
    
    // ========== Core Methods ==========
    setState(key, value, actionName = 'SET') {
        const oldValue = this._getNested(this.state, key);
        const newState = this._setNested({...this.state}, key, value);
        
        // ÙÙ‚Ø· Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
        if (JSON.stringify(oldValue) !== JSON.stringify(value)) {
            const historyEntry = {
                id: Date.now() + Math.random(),
                timestamp: Date.now(),
                action: actionName,
                key,
                oldValue,
                newValue: value,
                stateSnapshot: {...this.state} // Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ù…Ù„ state ÙØ¹Ù„ÛŒ
            };
            
            if (this.isInTransaction) {
                this.transactionActions.push(historyEntry);
            } else {
                this._addToHistory(historyEntry);
            }
        }
        
        this.state = newState;
        this.log(`State "${key}" = ${JSON.stringify(value).substring(0, 50)}...`);
        this._updateHistoryView();
        return true;
    },
    
    // ========== Undo/Redo Methods ==========
    undo() {
        if (this.history.length === 0) {
            this.log("Ù‡ÛŒÚ† Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ Undo ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", 'warning');
            return false;
        }
        
        const lastAction = this.history.pop();
        
        // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ
        this.state = this._setNested({...this.state}, lastAction.key, lastAction.oldValue);
        
        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± future Ø¨Ø±Ø§ÛŒ Redo
        this.future.push(lastAction);
        
        this.log(`â†©ï¸ Undo: ${lastAction.action} "${lastAction.key}"`);
        this._updateHistoryView();
        return lastAction;
    },
    
    redo() {
        if (this.future.length === 0) {
            this.log("Ù‡ÛŒÚ† Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ Redo ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯", 'warning');
            return false;
        }
        
        const nextAction = this.future.pop();
        
        // Ø§Ø¹Ù…Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Ù…Ù‚Ø¯Ø§Ø±
        this.state = this._setNested({...this.state}, nextAction.key, nextAction.newValue);
        
        // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ history
        this.history.push(nextAction);
        
        this.log(`â†ªï¸ Redo: ${nextAction.action} "${nextAction.key}"`);
        this._updateHistoryView();
        return nextAction;
    },
    
    // ========== History Management ==========
    _addToHistory(entry) {
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
        this.history.push(entry);
        
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† future (ÙˆÙ‚ØªÛŒ Ø¹Ù…Ù„ Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯)
        this.future = [];
        
        // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø³Ø§ÛŒØ² ØªØ§Ø±ÛŒØ®Ú†Ù‡ (Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ†â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯)
        if (this.history.length > this.maxHistorySize) {
            const removed = this.history.shift();
            this.log(`Ø­Ø°Ù Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† action Ø§Ø² ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${removed.action} "${removed.key}"`, 'warning');
        }
        
        this.log(`Action Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: ${entry.action} "${entry.key}" (ØªØ§Ø±ÛŒØ®Ú†Ù‡: ${this.history.length})`);
    },
    
    getHistoryStats() {
        return {
            totalActions: this.history.length + this.future.length,
            undoable: this.history.length,
            redoable: this.future.length,
            historySize: this.history.length,
            futureSize: this.future.length
        };
    },
    
    clearHistory() {
        const count = this.history.length + this.future.length;
        this.history = [];
        this.future = [];
        this.log(`ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø§Ú© Ø´Ø¯ (${count} action)`);
        this._updateHistoryView();
    },
    
    // ========== Utility Methods ==========
    _getNested(obj, path) {
        return path.split('.').reduce((o, p) => o && o[p], obj);
    },
    
    _setNested(obj, path, value) {
        const keys = path.split('.');
        const lastKey = keys.pop();
        const target = keys.reduce((o, p) => o[p] = o[p] || {}, obj);
        target[lastKey] = value;
        return obj;
    },
    
    _updateHistoryView() {
        const view = document.getElementById('history-view');
        const stats = this.getHistoryStats();
        
        let historyText = `<strong>ğŸ“œ ØªØ§Ø±ÛŒØ®Ú†Ù‡ (Ø­Ø¯Ø§Ú©Ø«Ø± ${this.maxHistorySize}):</strong><br>`;
        historyText += `â€¢ Undoable: ${stats.undoable} | Redoable: ${stats.redoable}<br>`;
        historyText += `â€¢ State: coins=${this.state.user?.coins}, level=${this.state.user?.level}<br>`;
        
        // Ù†Ù…Ø§ÛŒØ´ Ø¢Ø®Ø±ÛŒÙ† Û³ action
        if (this.history.length > 0) {
            historyText += `<br><strong>Ø¢Ø®Ø±ÛŒÙ† actions:</strong><br>`;
            const recent = this.history.slice(-3).reverse();
            recent.forEach((action, i) => {
                historyText += `${this.history.length - i}. ${action.action} "${action.key}"<br>`;
            });
        }
        
        view.innerHTML = historyText;
    },
    
    log(message, type = 'info') {
        const consoleEl = document.getElementById('console');
        const logEntry = document.createElement('div');
        logEntry.className = 'log';
        
        const prefix = type === 'error' ? '[Ø®Ø·Ø§] ' : 
                      type === 'warning' ? '[Ù‡Ø´Ø¯Ø§Ø±] ' : 
                      type === 'success' ? '[Ù…ÙˆÙÙ‚] ' : '';
        
        logEntry.textContent = `${prefix}${message}`;
        
        if (type === 'error') logEntry.style.color = '#ef9a9a';
        if (type === 'warning') logEntry.style.color = '#fff59d';
        if (type === 'success') logEntry.style.color = '#c5e1a5';
        
        consoleEl.appendChild(logEntry);
        consoleEl.scrollTop = consoleEl.scrollHeight;
        console.log(`[UndoRedo] ${message}`);
    },
    
    clear() {
        this.state = { user: { coins: 100, level: 1 }, cart: [], lastAction: null };
        this.history = [];
        this.future = [];
        this.isInTransaction = false;
        this.transactionActions = [];
        this.log("State Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯");
        this._updateHistoryView();
    }
};

// ========== ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo ==========
const undoRedoTests = [
    {
        id: 'test1',
        name: 'Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚ ØªØ§Ø±ÛŒØ®Ú†Ù‡',
        run: async () => {
            UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚ ===");
            UndoRedoManager.clear();
            UndoRedoManager.maxHistorySize = 5;
            
            // Ø§ÛŒØ¬Ø§Ø¯ Û· action (Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø²)
            const actions = [];
            for (let i = 1; i <= 7; i++) {
                UndoRedoManager.setState(`key${i}`, `value${i}`, `SET_${i}`);
                actions.push(`key${i}`);
            }
            
            const stats = UndoRedoManager.getHistoryStats();
            
            // Ø¨Ø±Ø±Ø³ÛŒ: Ø¨Ø§ÛŒØ¯ ÙÙ‚Ø· Ûµ action Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§Ø´Ø¯
            if (stats.historySize !== 5) {
                throw new Error(`Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚ Ø±Ø¹Ø§ÛŒØª Ù†Ø´Ø¯. Ø§Ù†ØªØ¸Ø§Ø±: 5 actionØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${stats.historySize}`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ: Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† actionÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯
            if (UndoRedoManager.history[0].key !== 'key3') { // key1 Ùˆ key2 Ø¨Ø§ÛŒØ¯ Ø­Ø°Ù Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯
                throw new Error(`Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† actions Ø­Ø°Ù Ù†Ø´Ø¯Ù†Ø¯. Ø§ÙˆÙ„ÛŒÙ† action: ${UndoRedoManager.history[0].key}`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ: Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† actionÙ‡Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ù†Ø¯
            const lastAction = UndoRedoManager.history[UndoRedoManager.history.length - 1];
            if (lastAction.key !== 'key7') {
                throw new Error(`Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† action Ø°Ø®ÛŒØ±Ù‡ Ù†Ø´Ø¯. Ø¢Ø®Ø±ÛŒÙ† action: ${lastAction.key}`);
            }
            
            UndoRedoManager.log(`Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚ Ûµ Ø±Ø¹Ø§ÛŒØª Ø´Ø¯. actions: ${stats.historySize}`, 'success');
            return `âœ… Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¹Ù…Ù‚ ${UndoRedoManager.maxHistorySize} Ø±Ø¹Ø§ÛŒØª Ø´Ø¯ (Û· action Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯ØŒ ${stats.historySize} Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯)`;
        }
    },
    {
        id: 'test2',
        name: 'Undo/Redo Ú†Ù†Ø¯ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ',
        run: async () => {
            UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Undo/Redo Ú†Ù†Ø¯ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ ===");
            UndoRedoManager.clear();
            
            // ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡
            UndoRedoManager.setState('user.coins', 100, 'INIT');
            UndoRedoManager.setState('user.level', 1, 'INIT');
            
            // Ø§ÛŒØ¬Ø§Ø¯ Û³ ØªØºÛŒÛŒØ±
            UndoRedoManager.setState('user.coins', 80, 'BUY_ITEM');
            UndoRedoManager.setState('user.level', 2, 'LEVEL_UP');
            UndoRedoManager.setState('user.coins', 70, 'BUY_ITEM_2');
            
            const initialStats = UndoRedoManager.getHistoryStats();
            if (initialStats.undoable !== 3) {
                throw new Error(`ØªØ¹Ø¯Ø§Ø¯ actions Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø´ØªØ¨Ø§Ù‡. Ø§Ù†ØªØ¸Ø§Ø±: 3ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${initialStats.undoable}`);
            }
            
            // ØªØ³Øª Undo Ø³Ù‡ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ
            UndoRedoManager.undo(); // coins Ø¨Ø§ÛŒØ¯ 80 Ø´ÙˆØ¯
            if (UndoRedoManager.state.user.coins !== 80) {
                throw new Error(`Undo Ù…Ø±Ø­Ù„Ù‡ Û± Ø§Ø´ØªØ¨Ø§Ù‡. coins Ø¨Ø§ÛŒØ¯ 80 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.user.coins} Ø§Ø³Øª`);
            }
            
            UndoRedoManager.undo(); // level Ø¨Ø§ÛŒØ¯ 1 Ø´ÙˆØ¯
            if (UndoRedoManager.state.user.level !== 1) {
                throw new Error(`Undo Ù…Ø±Ø­Ù„Ù‡ Û² Ø§Ø´ØªØ¨Ø§Ù‡. level Ø¨Ø§ÛŒØ¯ 1 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.user.level} Ø§Ø³Øª`);
            }
            
            UndoRedoManager.undo(); // coins Ø¨Ø§ÛŒØ¯ 100 Ø´ÙˆØ¯
            if (UndoRedoManager.state.user.coins !== 100) {
                throw new Error(`Undo Ù…Ø±Ø­Ù„Ù‡ Û³ Ø§Ø´ØªØ¨Ø§Ù‡. coins Ø¨Ø§ÛŒØ¯ 100 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.user.coins} Ø§Ø³Øª`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ future stack
            const midStats = UndoRedoManager.getHistoryStats();
            if (midStats.redoable !== 3) {
                throw new Error(`Future stack Ù¾Ø³ Ø§Ø² Undo Ø§Ø´ØªØ¨Ø§Ù‡. Ø§Ù†ØªØ¸Ø§Ø±: 3ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${midStats.redoable}`);
            }
            
            // ØªØ³Øª Redo Ø³Ù‡ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ
            UndoRedoManager.redo(); // coins Ø¨Ø§ÛŒØ¯ 80 Ø´ÙˆØ¯
            if (UndoRedoManager.state.user.coins !== 80) {
                throw new Error(`Redo Ù…Ø±Ø­Ù„Ù‡ Û± Ø§Ø´ØªØ¨Ø§Ù‡. coins Ø¨Ø§ÛŒØ¯ 80 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.user.coins} Ø§Ø³Øª`);
            }
            
            UndoRedoManager.redo(); // level Ø¨Ø§ÛŒØ¯ 2 Ø´ÙˆØ¯
            if (UndoRedoManager.state.user.level !== 2) {
                throw new Error(`Redo Ù…Ø±Ø­Ù„Ù‡ Û² Ø§Ø´ØªØ¨Ø§Ù‡. level Ø¨Ø§ÛŒØ¯ 2 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.user.level} Ø§Ø³Øª`);
            }
            
            UndoRedoManager.redo(); // coins Ø¨Ø§ÛŒØ¯ 70 Ø´ÙˆØ¯
            if (UndoRedoManager.state.user.coins !== 70) {
                throw new Error(`Redo Ù…Ø±Ø­Ù„Ù‡ Û³ Ø§Ø´ØªØ¨Ø§Ù‡. coins Ø¨Ø§ÛŒØ¯ 70 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${UndoRedoManager.state.user.coins} Ø§Ø³Øª`);
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ù†Ù‡Ø§ÛŒÛŒ
            const finalStats = UndoRedoManager.getHistoryStats();
            if (finalStats.undoable !== 3 || finalStats.redoable !== 0) {
                throw new Error(`ÙˆØ¶Ø¹ÛŒØª Ù†Ù‡Ø§ÛŒÛŒ stack Ø§Ø´ØªØ¨Ø§Ù‡. undoable: ${finalStats.undoable}, redoable: ${finalStats.redoable}`);
            }
            
            UndoRedoManager.log("Undo/Redo Ø³Ù‡ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯", 'success');
            return `âœ… Undo/Redo Ú†Ù†Ø¯ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ ØµØ­ÛŒØ­ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (Û³ Ù…Ø±Ø­Ù„Ù‡ Ú©Ø§Ù…Ù„)`;
        }
    },
    {
        id: 'test3',
        name: 'ØµØ­Øª Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø²Ú¯Ø´Øª',
        run: async () => {
            UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª ØµØ­Øª Ù…Ù‚Ø§Ø¯ÛŒØ± ===");
            UndoRedoManager.clear();
            
            // Ø§ÛŒØ¬Ø§Ø¯ state Ù¾ÛŒÚ†ÛŒØ¯Ù‡
            const complexState = {
                cart: [
                    { id: 1, name: 'Ú©ØªØ§Ø¨', price: 50, quantity: 2 },
                    { id: 2, name: 'Ø¯ÙØªØ±', price: 20, quantity: 1 }
                ],
                user: {
                    profile: {
                        name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª',
                        email: 'test@vakamova.com',
                        settings: { theme: 'dark', notifications: true }
                    }
                }
            };
            
            // Ø°Ø®ÛŒØ±Ù‡ state Ø§ÙˆÙ„ÛŒÙ‡
            UndoRedoManager.state = complexState;
            const initialState = JSON.stringify(complexState);
            
            // Ø§ÛŒØ¬Ø§Ø¯ ØªØºÛŒÛŒØ±Ø§Øª
            UndoRedoManager.setState('cart.0.quantity', 3, 'UPDATE_QTY');
            UndoRedoManager.setState('user.profile.settings.theme', 'light', 'CHANGE_THEME');
            UndoRedoManager.setState('user.profile.email', 'updated@test.com', 'UPDATE_EMAIL');
            
            // Ø°Ø®ÛŒØ±Ù‡ state Ù¾Ø³ Ø§Ø² ØªØºÛŒÛŒØ±Ø§Øª
            const afterChangesState = JSON.stringify(UndoRedoManager.state);
            
            // Undo Ù‡Ù…Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
            UndoRedoManager.undo(); // email
            UndoRedoManager.undo(); // theme
            UndoRedoManager.undo(); // quantity
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ù‚ÛŒÙ‚ Ø¨Ù‡ state Ø§ÙˆÙ„ÛŒÙ‡
            const afterUndoState = JSON.stringify(UndoRedoManager.state);
            
            if (afterUndoState !== initialState) {
                // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªÙØ§ÙˆØª
                const initialObj = JSON.parse(initialState);
                const undoObj = UndoRedoManager.state;
                
                const differences = [];
                if (JSON.stringify(initialObj.cart) !== JSON.stringify(undoObj.cart)) {
                    differences.push('cart Ù…ØªÙØ§ÙˆØª Ø§Ø³Øª');
                }
                if (JSON.stringify(initialObj.user) !== JSON.stringify(undoObj.user)) {
                    differences.push('user Ù…ØªÙØ§ÙˆØª Ø§Ø³Øª');
                }
                
                throw new Error(`Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ state Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ù‚ÛŒÙ‚ Ù†ÛŒØ³Øª. ØªÙØ§ÙˆØªÙ‡Ø§: ${differences.join(', ')}`);
            }
            
            // Redo Ù‡Ù…Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
            UndoRedoManager.redo(); // quantity
            UndoRedoManager.redo(); // theme
            UndoRedoManager.redo(); // email
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ù‚ÛŒÙ‚ Ø¨Ù‡ state Ù¾Ø³ Ø§Ø² ØªØºÛŒÛŒØ±Ø§Øª
            const afterRedoState = JSON.stringify(UndoRedoManager.state);
            
            if (afterRedoState !== afterChangesState) {
                throw new Error('Redo Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨Ù‡ state Ù¾Ø³ Ø§Ø² ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§Ø²Ù†Ú¯Ø´Øª');
            }
            
            // ØªØ³Øª Ù…Ù‚Ø§Ø¯ÛŒØ± Ø®Ø§Øµ
            if (UndoRedoManager.state.cart[0].quantity !== 3) {
                throw new Error('Ù…Ù‚Ø¯Ø§Ø± quantity Ù¾Ø³ Ø§Ø² Redo Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
            }
            
            if (UndoRedoManager.state.user.profile.settings.theme !== 'light') {
                throw new Error('Ù…Ù‚Ø¯Ø§Ø± theme Ù¾Ø³ Ø§Ø² Redo Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
            }
            
            if (UndoRedoManager.state.user.profile.email !== 'updated@test.com') {
                throw new Error('Ù…Ù‚Ø¯Ø§Ø± email Ù¾Ø³ Ø§Ø² Redo Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
            }
            
            UndoRedoManager.log("ØµØ­Øª Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¯Ø± Undo/Redo ØªØ£ÛŒÛŒØ¯ Ø´Ø¯", 'success');
            return `âœ… ØµØ­Øª Ù…Ù‚Ø§Ø¯ÛŒØ± ØªØ¶Ù…ÛŒÙ† Ø´Ø¯Ù‡ Ø§Ø³Øª (Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ + Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¹Ù…ÛŒÙ‚)`;
        }
    },
    {
        id: 'test4',
        name: 'Ø´Ù…Ø§Ø±Ø´ Ø¯Ù‚ÛŒÙ‚ actions',
        run: async () => {
            UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Ø´Ù…Ø§Ø±Ø´ actions ===");
            UndoRedoManager.clear();
            
            // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡â€ŒÙ‡Ø§
            let expectedTotal = 0;
            let expectedHistory = 0;
            
            // Û±. Ø§ÛŒØ¬Ø§Ø¯ Û´ action Ù…Ø¹Ù…ÙˆÙ„ÛŒ
            for (let i = 1; i <= 4; i++) {
                UndoRedoManager.setState(`test${i}`, i, `ACTION_${i}`);
                expectedTotal++;
                expectedHistory++;
            }
            
            let stats = UndoRedoManager.getHistoryStats();
            if (stats.undoable !== 4) {
                throw new Error(`Ù¾Ø³ Ø§Ø² Û´ action: undoable Ø¨Ø§ÛŒØ¯ 4 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${stats.undoable} Ø§Ø³Øª`);
            }
            
            // Û². Undo Ø¯Ùˆ action
            UndoRedoManager.undo();
            UndoRedoManager.undo();
            
            stats = UndoRedoManager.getHistoryStats();
            if (stats.undoable !== 2) {
                throw new Error(`Ù¾Ø³ Ø§Ø² Û² Undo: undoable Ø¨Ø§ÛŒØ¯ 2 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${stats.undoable} Ø§Ø³Øª`);
            }
            if (stats.redoable !== 2) {
                throw new Error(`Ù¾Ø³ Ø§Ø² Û² Undo: redoable Ø¨Ø§ÛŒØ¯ 2 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${stats.redoable} Ø§Ø³Øª`);
            }
            
            // Û³. Ø§ÛŒØ¬Ø§Ø¯ action Ø¬Ø¯ÛŒØ¯ (Ø¨Ø§ÛŒØ¯ future Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†Ø¯)
            UndoRedoManager.setState('newAction', 'value', 'NEW_ACTION');
            expectedTotal++;
            expectedHistory = 3; // Û² undoable Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ + Û± action Ø¬Ø¯ÛŒØ¯
            
            stats = UndoRedoManager.getHistoryStats();
            if (stats.redoable !== 0) {
                throw new Error(`Ù¾Ø³ Ø§Ø² action Ø¬Ø¯ÛŒØ¯: future Ø¨Ø§ÛŒØ¯ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŒ Ø§Ù…Ø§ redoable=${stats.redoable}`);
            }
            if (stats.undoable !== 3) {
                throw new Error(`Ù¾Ø³ Ø§Ø² action Ø¬Ø¯ÛŒØ¯: undoable Ø¨Ø§ÛŒØ¯ 3 Ø¨Ø§Ø´Ø¯ØŒ Ø§Ù…Ø§ ${stats.undoable} Ø§Ø³Øª`);
            }
            
            // Û´. ØªØ³Øª setState Ø¨Ø§ Ù…Ù‚Ø¯Ø§Ø± ØªÚ©Ø±Ø§Ø±ÛŒ (Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯)
            const beforeDuplicate = stats.undoable;
            UndoRedoManager.setState('test1', 1, 'DUPLICATE'); // Ù…Ù‚Ø¯Ø§Ø± Ù…Ø´Ø§Ø¨Ù‡
            stats = UndoRedoManager.getHistoryStats();
            
            if (stats.undoable !== beforeDuplicate) {
                throw new Error(`setState ØªÚ©Ø±Ø§Ø±ÛŒ Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯. Ù‚Ø¨Ù„: ${beforeDuplicate}, Ø¨Ø¹Ø¯: ${stats.undoable}`);
            }
            
            // Ûµ. ØªØ³Øª clearHistory
            UndoRedoManager.clearHistory();
            stats = UndoRedoManager.getHistoryStats();
            
            if (stats.undoable !== 0 || stats.redoable !== 0) {
                throw new Error(`Ù¾Ø³ Ø§Ø² clearHistory: Ù‡Ù…Ù‡ actions Ø¨Ø§ÛŒØ¯ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯. undoable=${stats.undoable}, redoable=${stats.redoable}`);
            }
            
            // Û¶. ØªØ³Øª Undo/Redo Ø±ÙˆÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø®Ø§Ù„ÛŒ
            const undoResult = UndoRedoManager.undo();
            if (undoResult !== false) {
                throw new Error('Undo Ø±ÙˆÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø®Ø§Ù„ÛŒ Ø¨Ø§ÛŒØ¯ false Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯');
            }
            
            const redoResult = UndoRedoManager.redo();
            if (redoResult !== false) {
                throw new Error('Redo Ø±ÙˆÛŒ future Ø®Ø§Ù„ÛŒ Ø¨Ø§ÛŒØ¯ false Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯');
            }
            
            UndoRedoManager.log("Ø´Ù…Ø§Ø±Ø´ Ø¯Ù‚ÛŒÙ‚ actions ØªØ£ÛŒÛŒØ¯ Ø´Ø¯", 'success');
            return `âœ… Ø´Ù…Ø§Ø±Ø´ actions Ø¯Ù‚ÛŒÙ‚ Ø§Ø³Øª (duplicate detection + future clearing)`;
        }
    }
];

// ========== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ==========
async function runAllUndoRedoTests() {
    const runBtn = document.getElementById('run-btn');
    runBtn.disabled = true;
    runBtn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo...';
    
    // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ù†Ø³ÙˆÙ„
    document.getElementById('console').innerHTML = '<div class="log">[Ø³ÛŒØ³ØªÙ…] ØªØ³Øª Undo/Redo Ù¾Ø§ÛŒÙ‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</div>';
    
    UndoRedoManager.log("=== Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo Ù¾Ø§ÛŒÙ‡ ===");
    
    let passed = 0;
    
    for (let i = 0; i < undoRedoTests.length; i++) {
        const test = undoRedoTests[i];
        const testElement = document.getElementById(test.id);
        const statusElement = document.getElementById(`status${i+1}`);
        const outputElement = document.getElementById(`output${i+1}`);
        
        // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¨Ù‡ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§
        testElement.className = 'test-item running';
        statusElement.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§';
        statusElement.className = 'test-status status-running';
        outputElement.innerHTML = '<span style="color:#666">Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ...</span>';
        
        try {
            UndoRedoManager.log(`Ø´Ø±ÙˆØ¹ ØªØ³Øª: ${test.name}`);
            
            // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± ØªØ³Øª
            UndoRedoManager.clear();
            
            const result = await test.run();
            
            // ØªØ³Øª Ù…ÙˆÙÙ‚
            testElement.className = 'test-item passed';
            statusElement.textContent = 'Ù…ÙˆÙÙ‚';
            statusElement.className = 'test-status status-passed';
            outputElement.innerHTML = `<div style="color:#2e7d32">${result}</div>`;
            passed++;
            
            UndoRedoManager.log(`ØªØ³Øª "${test.name}" Ù…ÙˆÙÙ‚`, 'success');
            
        } catch (error) {
            // ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚
            testElement.className = 'test-item failed';
            statusElement.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
            statusElement.className = 'test-status status-failed';
            outputElement.innerHTML = `<div style="color:#c62828"><strong>âŒ Ø®Ø·Ø§:</strong> ${error.message}</div>`;
            
            UndoRedoManager.log(`ØªØ³Øª "${test.name}" Ù†Ø§Ù…ÙˆÙÙ‚: ${error.message}`, 'error');
        }
        
        // ØªØ§Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡ Ø¨ÛŒÙ† ØªØ³Øªâ€ŒÙ‡Ø§
        await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    runBtn.disabled = false;
    runBtn.textContent = `ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ (${passed}/${undoRedoTests.length} Ù…ÙˆÙÙ‚)`;
    
    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
    if (passed === undoRedoTests.length) {
        UndoRedoManager.log("ğŸ‰ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Undo/Redo Ù¾Ø§ÛŒÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø´Øª Ø³Ø± Ú¯Ø°Ø§Ø´ØªÙ‡ Ø´Ø¯Ù†Ø¯!", 'success');
        UndoRedoManager.log("âœ… Ø³ÛŒØ³ØªÙ… Undo/Redo Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.", 'success');
    } else {
        UndoRedoManager.log(`ØªØ³Øªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù†Ø¯: ${passed} Ø§Ø² ${undoRedoTests.length} Ù…ÙˆÙÙ‚`, 
                          passed >= 3 ? 'success' : 'warning');
    }
}

// ========== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ==========
document.addEventListener('DOMContentLoaded', () => {
    // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ
    document.getElementById('run-btn').addEventListener('click', runAllUndoRedoTests);
    
    UndoRedoManager.log("Ø³ÛŒØ³ØªÙ… ØªØ³Øª Undo/Redo Ù¾Ø§ÛŒÙ‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.");
    UndoRedoManager.log("Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ 'Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.");
    UndoRedoManager._updateHistoryView();
});
</script>
</body>
</html>
