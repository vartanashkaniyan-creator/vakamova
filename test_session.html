<!DOCTYPE html>
<html>
<head>
    <title>ØªØ³Øª SessionManager</title>
    <style>
        body { font-family: Tahoma; padding: 20px; text-align: center; }
        button { padding: 12px 25px; font-size: 16px; background: #9C27B0; color: white; 
                 border: none; border-radius: 5px; cursor: pointer; margin: 10px; }
        button:hover { background: #7B1FA2; }
        #result { margin: 20px; padding: 20px; border: 2px solid #ddd; border-radius: 10px; 
                  min-height: 150px; font-family: monospace; text-align: left; background: #f9f9f9; 
                  max-height: 400px; overflow-y: auto; }
        .session-info { background: #f3e5f5; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .step { margin: 8px 0; padding: 8px; border-left: 4px solid #9C27B0; background: white; }
        .success-step { border-left-color: #4CAF50; }
        .error-step { border-left-color: #f44336; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª SessionManager</h1>
    <p>ÙØ§Ø² Û³: Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø´Ù† Ú©Ø§Ø±Ø¨Ø± + StateManager + EventBus</p>
    
    <div>
        <button onclick="testSessionManager()">ØªØ³Øª SessionManager</button>
        <button onclick="clearLog()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
    </div>
    
    <div id="result">Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ ØªØ³Øª...</div>
    
    <div id="sessionInfo" class="session-info">
        ÙˆØ¶Ø¹ÛŒØª Ø³Ø´Ù†: Ù…Ù†ØªØ¸Ø± ØªØ³Øª...
    </div>

    <script>
        // ==================== Û±. EventBus ====================
        class EventBus {
            constructor() { this.listeners = {}; }
            on(eventName, callback) {
                if (!this.listeners[eventName]) this.listeners[eventName] = [];
                this.listeners[eventName].push(callback);
                return () => this.off(eventName, callback);
            }
            off(eventName, callback) {
                if (this.listeners[eventName]) {
                    this.listeners[eventName] = this.listeners[eventName].filter(cb => cb !== callback);
                }
            }
            emit(eventName, data) {
                if (this.listeners[eventName]) {
                    this.listeners[eventName].forEach(callback => {
                        try { callback(data); } catch (error) { console.error('Listener error:', error); }
                    });
                }
            }
        }
        
        // ==================== Û². StateManager ====================
        class StateManager {
            constructor(initialState = {}) {
                this.state = { ...initialState };
                this.eventBus = new EventBus();
            }
            getState() { return { ...this.state }; }
            dispatch(action) {
                const oldState = { ...this.state };
                switch (action.type) {
                    case 'SET_USER': this.state.user = action.payload; break;
                    case 'CLEAR_USER': this.state.user = null; break;
                    case 'UPDATE_SESSION': this.state.session = { ...this.state.session, ...action.payload }; break;
                }
                this.eventBus.emit('state.changed', { type: action.type, oldState, newState: this.state });
            }
        }
        
        // ==================== Û³. SessionManager ====================
        class SessionManager {
            constructor(eventBus, stateManager, config = {}) {
                this.eventBus = eventBus;
                this.stateManager = stateManager;
                this.config = {
                    accessTokenTTL: 5000, // 5 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª
                    sessionTimeout: 10000,
                    ...config
                };
                this.currentSession = null;
                this.timers = {};
                log("âœ… SessionManager Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯");
            }
            
            async login(credentials) {
                try {
                    log(`ğŸ” ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ÛŒÙ†: ${credentials.email}`);
                    
                    // Ø³Ø§Ø®Øª Ø³Ø´Ù† mock
                    this.currentSession = {
                        userId: `user_${Date.now()}`,
                        email: credentials.email,
                        accessToken: `token_${Math.random().toString(36).substr(2)}`,
                        refreshToken: `refresh_${Math.random().toString(36).substr(2)}`,
                        expiresAt: Date.now() + this.config.accessTokenTTL,
                        createdAt: Date.now(),
                        lastActivityAt: Date.now()
                    };
                    
                    // Ø¢Ù¾Ø¯ÛŒØª state
                    this.stateManager.dispatch({
                        type: 'SET_USER',
                        payload: {
                            id: this.currentSession.userId,
                            email: credentials.email,
                            name: credentials.email.split('@')[0]
                        }
                    });
                    
                    // Ø§Ù†ØªØ´Ø§Ø± event
                    this.eventBus.emit('user.login', this.currentSession);
                    this.eventBus.emit('session.created', this.currentSession);
                    
                    // Ø´Ø±ÙˆØ¹ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯
                    this.startSessionMonitoring();
                    
                    log(`âœ… Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚: ${this.currentSession.userId}`, 'success');
                    this.updateDisplay();
                    return this.currentSession;
                    
                } catch (error) {
                    log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù„Ø§Ú¯ÛŒÙ†: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            async logout() {
                if (!this.currentSession) return;
                
                log(`ğŸ‘‹ Ù„Ø§Ú¯Ø§ÙˆØª Ú©Ø§Ø±Ø¨Ø±: ${this.currentSession.userId}`);
                
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† state
                this.stateManager.dispatch({ type: 'CLEAR_USER' });
                
                // Ø§Ù†ØªØ´Ø§Ø± event
                this.eventBus.emit('user.logout', this.currentSession);
                this.eventBus.emit('session.destroyed', this.currentSession);
                
                // ØªÙˆÙ‚Ù ØªØ§ÛŒÙ…Ø±Ù‡Ø§
                this.stopSessionMonitoring();
                
                this.currentSession = null;
                this.updateDisplay();
                log("âœ… Ù„Ø§Ú¯Ø§ÙˆØª Ù…ÙˆÙÙ‚");
            }
            
            isAuthenticated() {
                if (!this.currentSession) return false;
                if (Date.now() >= this.currentSession.expiresAt) {
                    log("âš ï¸ Ø³Ø´Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡", 'warning');
                    this.logout();
                    return false;
                }
                return true;
            }
            
            getAccessToken() {
                return this.currentSession?.accessToken || null;
            }
            
            startSessionMonitoring() {
                // ØªØ§ÛŒÙ…Ø± Ø¨Ø±Ø§ÛŒ auto-logout
                this.timers.sessionTimeout = setTimeout(() => {
                    log("â° Ø²Ù…Ø§Ù† Ø³Ø´Ù† Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯ - auto logout", 'warning');
                    this.logout();
                }, this.config.sessionTimeout);
                
                // ØªØ§ÛŒÙ…Ø± Ø¨Ø±Ø§ÛŒ auto-refresh
                this.timers.tokenRefresh = setTimeout(() => {
                    this.refreshToken();
                }, this.config.accessTokenTTL - 1000);
            }
            
            stopSessionMonitoring() {
                Object.values(this.timers).forEach(timer => clearTimeout(timer));
                this.timers = {};
            }
            
            refreshToken() {
                if (!this.currentSession) return;
                
                log("ğŸ”„ ØªÙ…Ø¯ÛŒØ¯ ØªÙˆÚ©Ù†...");
                this.currentSession.accessToken = `token_new_${Math.random().toString(36).substr(2)}`;
                this.currentSession.expiresAt = Date.now() + this.config.accessTokenTTL;
                this.currentSession.lastActivityAt = Date.now();
                
                this.eventBus.emit('token.refreshed', this.currentSession);
                log("âœ… ØªÙˆÚ©Ù† ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯");
                
                // Ø±ÛŒØ³ØªØ§Ø±Øª ØªØ§ÛŒÙ…Ø± refresh
                this.timers.tokenRefresh = setTimeout(() => {
                    this.refreshToken();
                }, this.config.accessTokenTTL - 1000);
                
                this.updateDisplay();
            }
            
            updateDisplay() {
                const display = document.getElementById('sessionInfo');
                if (!display) return;
                
                if (this.currentSession) {
                    const expiresIn = Math.max(0, this.currentSession.expiresAt - Date.now());
                    display.innerHTML = `
                        <strong>Ø³Ø´Ù† ÙØ¹Ø§Ù„:</strong><br>
                        ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: ${this.currentSession.email}<br>
                        ğŸ”‘ ØªÙˆÚ©Ù†: ${this.currentSession.accessToken.substring(0, 20)}...<br>
                        â³ Ø§Ù†Ù‚Ø¶Ø§: ${Math.round(expiresIn/1000)} Ø«Ø§Ù†ÛŒÙ‡ Ø¯ÛŒÚ¯Ø±<br>
                        ğŸ” ÙˆØ¶Ø¹ÛŒØª: ${this.isAuthenticated() ? 'Ù…Ø¹ØªØ¨Ø±' : 'Ù†Ø§Ù…Ø¹ØªØ¨Ø±'}
                    `;
                } else {
                    display.innerHTML = `<strong>âŒ Ù‡ÛŒÚ† Ø³Ø´Ù† ÙØ¹Ø§Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</strong>`;
                }
            }
        }
        
        // ==================== Û´. ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ====================
        function log(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            const stepClass = type === 'success' ? 'success-step' : 
                            type === 'error' ? 'error-step' : 'step';
            
            resultDiv.innerHTML += `
                <div class="${stepClass}">
                    <strong>[${new Date().toLocaleTimeString()}]</strong> ${message}
                </div>
            `;
            resultDiv.scrollTop = resultDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('result').innerHTML = '';
        }
        
        // ==================== Ûµ. ØªØ³Øª Ø§ØµÙ„ÛŒ ====================
        let sessionManager = null;
        let eventBus = null;
        let stateManager = null;
        
        function testSessionManager() {
            clearLog();
            log("ğŸ¬ Ø´Ø±ÙˆØ¹ ØªØ³Øª SessionManager...", "success");
            
            try {
                // Û±. Ø³Ø§Ø®Øª EventBus Ùˆ StateManager
                log("Ù…Ø±Ø­Ù„Ù‡ Û±: Ø³Ø§Ø®Øª EventBus Ùˆ StateManager...");
                eventBus = new EventBus();
                stateManager = new StateManager({
                    user: null,
                    session: null,
                    settings: { language: 'fa' }
                });
                
                // Û². Ø³Ø§Ø®Øª SessionManager
                log("Ù…Ø±Ø­Ù„Ù‡ Û²: Ø³Ø§Ø®Øª SessionManager...");
                sessionManager = new SessionManager(eventBus, stateManager, {
                    accessTokenTTL: 8000, // 8 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª
                    sessionTimeout: 15000 // 15 Ø«Ø§Ù†ÛŒÙ‡
                });
                
                // Û³. Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ events
                log("Ù…Ø±Ø­Ù„Ù‡ Û³: Ø«Ø¨Øª listenerâ€ŒÙ‡Ø§...");
                eventBus.on('user.login', (session) => {
                    log(`ğŸ“¢ Event: user.login - ${session.userId}`, 'success');
                });
                
                eventBus.on('user.logout', () => {
                    log(`ğŸ“¢ Event: user.logout`, 'warning');
                });
                
                eventBus.on('token.refreshed', () => {
                    log(`ğŸ“¢ Event: token.refreshed`, 'info');
                });
                
                stateManager.eventBus.on('state.changed', (data) => {
                    if (data.type === 'SET_USER' || data.type === 'CLEAR_USER') {
                        log(`ğŸ“¢ State changed: ${data.type}`, 'info');
                    }
                });
                
                // Û´. ØªØ³Øª Ù„Ø§Ú¯ÛŒÙ†
                log("Ù…Ø±Ø­Ù„Ù‡ Û´: ØªØ³Øª Ù„Ø§Ú¯ÛŒÙ†...");
                setTimeout(async () => {
                    try {
                        const session = await sessionManager.login({
                            email: 'user@vakamova.com',
                            password: 'password123'
                        });
                        
                        log(`âœ… Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² - User ID: ${session.userId}`, 'success');
                        log(`ğŸ”‘ ØªÙˆÚ©Ù† Ø¯Ø³ØªØ±Ø³ÛŒ: ${session.accessToken.substring(0, 25)}...`);
                        log(`â° Ø§Ù†Ù‚Ø¶Ø§ÛŒ ØªÙˆÚ©Ù†: ${new Date(session.expiresAt).toLocaleTimeString()}`);
                        
                        // Ûµ. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø²
                        setTimeout(() => {
                            log("Ù…Ø±Ø­Ù„Ù‡ Ûµ: Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø²...");
                            const isAuth = sessionManager.isAuthenticated();
                            log(`ğŸ” ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø²: ${isAuth ? 'âœ… Ù…Ø¹ØªØ¨Ø±' : 'âŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±'}`);
                            
                            // Û¶. Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù†
                            const token = sessionManager.getAccessToken();
                            log(`ğŸ”‘ ØªÙˆÚ©Ù† ÙØ¹Ù„ÛŒ: ${token ? token.substring(0, 20) + '...' : 'null'}`);
                        }, 1000);
                        
                        // Û·. Ù…Ù†ØªØ¸Ø± auto-refresh Ø¨Ù…Ø§Ù†
                        log("Ù…Ø±Ø­Ù„Ù‡ Û¶: Ù…Ù†ØªØ¸Ø± auto-refresh (Ø¨Ø¹Ø¯ Ø§Ø² Û· Ø«Ø§Ù†ÛŒÙ‡)...", 'info');
                        
                        // Û¸. ØªØ³Øª Ù„Ø§Ú¯Ø§ÙˆØª Ø¯Ø³ØªÛŒ
                        setTimeout(async () => {
                            log("Ù…Ø±Ø­Ù„Ù‡ Û·: ØªØ³Øª Ù„Ø§Ú¯Ø§ÙˆØª Ø¯Ø³ØªÛŒ...");
                            await sessionManager.logout();
                            
                            // Û¹. Ø¨Ø±Ø±Ø³ÛŒ state Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§Ú¯Ø§ÙˆØª
                            setTimeout(() => {
                                const state = stateManager.getState();
                                log(`ğŸ“Š State Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§Ú¯Ø§ÙˆØª: Ú©Ø§Ø±Ø¨Ø± = ${state.user ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'null'}`);
                                
                                // Û±Û°. ØªØ³Øª Ù„Ø§Ú¯ÛŒÙ† Ù…Ø¬Ø¯Ø¯
                                setTimeout(async () => {
                                    log("Ù…Ø±Ø­Ù„Ù‡ Û¸: ØªØ³Øª Ù„Ø§Ú¯ÛŒÙ† Ù…Ø¬Ø¯Ø¯...");
                                    try {
                                        const newSession = await sessionManager.login({
                                            email: 'another@test.com',
                                            password: 'test123'
                                        });
                                        log(`âœ… Ù„Ø§Ú¯ÛŒÙ† Ù…Ø¬Ø¯Ø¯ Ù…ÙˆÙÙ‚ - User ID: ${newSession.userId}`, 'success');
                                        
                                        // Û±Û±. Ù…Ù†ØªØ¸Ø± auto-logout
                                        log("Ù…Ø±Ø­Ù„Ù‡ Û¹: Ù…Ù†ØªØ¸Ø± auto-logout (Ø¨Ø¹Ø¯ Ø§Ø² Û±Ûµ Ø«Ø§Ù†ÛŒÙ‡)...", 'warning');
                                        
                                    } catch (error) {
                                        log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù„Ø§Ú¯ÛŒÙ† Ù…Ø¬Ø¯Ø¯: ${error.message}`, 'error');
                                    }
                                }, 1000);
                            }, 500);
                        }, 4000);
                        
                    } catch (error) {
                        log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù„Ø§Ú¯ÛŒÙ†: ${error.message}`, 'error');
                    }
                }, 500);
                
                // Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
                setTimeout(() => {
                    log("=".repeat(50));
                    log("ğŸ‰ ØªØ³Øª SessionManager ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ú©Ø§Ù…Ù„ Ø´Ø¯!", 'success');
                    log("âœ… Ù„Ø§Ú¯ÛŒÙ†/Ù„Ø§Ú¯Ø§ÙˆØª Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯");
                    log("âœ… auto-refresh ØªÙˆÚ©Ù† ÙØ¹Ø§Ù„ Ø§Ø³Øª");
                    log("âœ… auto-logout Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯");
                    log("âœ… Ù‡Ù…Ø§Ù‡Ù†Ú¯ÛŒ Ø¨Ø§ StateManager Ø¨Ø±Ù‚Ø±Ø§Ø± Ø§Ø³Øª");
                }, 2000);
                
            } catch (error) {
                log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª SessionManager: ${error.message}`, 'error');
                console.error("SessionManager test error:", error);
            }
        }
        
        // ==================== Û¶. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡ ====================
        window.onload = function() {
            log("ğŸ“± SessionManager Test Ready");
            log("Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ 'ØªØ³Øª SessionManager' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯");
        };
    </script>
</body>
</html>
