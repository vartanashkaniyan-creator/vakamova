
// Ø¯Ø± ÙØ§ÛŒÙ„ test_runner.html Ø®ÙˆØ¯ØŒ Ø§ÛŒÙ† Ú©Ø¯ Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø¨Ø®Ø´ <script> Ú©Ù†

// ==================== Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ù‡Ù…Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ ====================
const PROJECT_MODULES = [
    // Ù‡Ø³ØªÙ‡ Ø§ØµÙ„ÛŒ
    { name: 'Event Bus', path: 'core/event_bus.js', type: 'core' },
    { name: 'State Manager', path: 'core/state_manager.js', type: 'core' },
    { name: 'Context Provider', path: 'core/context_provider.js', type: 'core' },
    { name: 'API Client', path: 'core/api_client.js', type: 'core' },
    { name: 'Router Middleware', path: 'core/router_middleware.js', type: 'core' },
    { name: 'Guards', path: 'core/guards.js', type: 'core' },
    
    // Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ
    { name: 'Auth Manager', path: 'modules/auth/auth_manager.js', type: 'auth' },
    { name: 'Token Manager', path: 'modules/auth/token_manager.js', type: 'auth' },
    { name: 'Auth Middleware', path: 'modules/auth/auth_middleware.js', type: 'auth' },
    { name: 'Lesson Engine', path: 'modules/lessons/engine.js', type: 'lesson' },
    
    // ØµÙØ­Ø§Øª
    { name: 'Auth View', path: 'pages/auth/auth_view.js', type: 'page' },
    { name: 'Home Page', path: 'pages/home/home_page.js', type: 'page' },
    { name: 'Router', path: 'pages/router.js', type: 'page' }
];


// ==================== ØªØ³Øª Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øª Button ====================
async function testButtonComponent() {
    console.log('ğŸŸ¢ Ø´Ø±ÙˆØ¹ ØªØ³Øª Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øª Button...');
    try {
        // Û±. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„ Button (Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² import Ù†Ø´Ø¯Ù‡)
        if (typeof VakamovaButton === 'undefined') {
            await loadModule({ name: 'Button', path: 'components/Button.js', type: 'ui' });
        }
        
        // Û². Ø³Ø§Ø®Øª Ù†Ù…ÙˆÙ†Ù‡ Button Ø¨Ø§ eventBus Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ
        const mockEventBus = {
            emit: (event, data) => console.log(`ğŸ“¢ [Button Test] Ø±ÙˆÛŒØ¯Ø§Ø¯: ${event}`, data),
            on: () => () => {}
        };
        
        const button = new VakamovaButton({ eventBus: mockEventBus });
        
        // Û³. Ø±Ù†Ø¯Ø± Button Ø¯Ø± ÛŒÚ© Ø§Ù„Ù…Ø§Ù† Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ
        const testContainer = document.createElement('div');
        document.body.appendChild(testContainer);
        
        button.render(testContainer, {
            type: 'primary',
            size: 'md',
            text: 'Ø¯Ú©Ù…Ù‡ ØªØ³Øª Vakamova',
            icon: 'âœ…',
            onClick: () => console.log('âœ… Ú©Ù„ÛŒÚ© Ø¯Ú©Ù…Ù‡ Ú©Ø§Ø± Ú©Ø±Ø¯!')
        });
        
        // Û´. ØªØ³Øª Ù…ØªØ¯Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
        button.disable();
        console.assert(button.isDisabled(), 'âŒ disable() Ú©Ø§Ø± Ù†Ú©Ø±Ø¯');
        
        button.enable();
        console.assert(!button.isDisabled(), 'âŒ enable() Ú©Ø§Ø± Ù†Ú©Ø±Ø¯');
        
        button.setLoading(true);
        console.assert(button.isLoading(), 'âŒ setLoading(true) Ú©Ø§Ø± Ù†Ú©Ø±Ø¯');
        
        button.setLoading(false);
        console.assert(!button.isLoading(), 'âŒ setLoading(false) Ú©Ø§Ø± Ù†Ú©Ø±Ø¯');
        
        // Ûµ. ØªÙ…ÛŒØ²Ú©Ø§Ø±ÛŒ
        button.destroy();
        testContainer.remove();
        
        console.log('âœ… ØªØ³Øª Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øª Button Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.');
        return { success: true, component: 'Button', message: 'Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª.' };
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª Button:', error);
        return { success: false, component: 'Button', error: error.message };
    }
}

// ==================== Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Button Ø¨Ù‡ Ù„ÛŒØ³Øª Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ ====================
// (Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø¯Ø± Ø¢Ø±Ø§ÛŒÙ‡ PROJECT_MODULESØŒ Ø¨Ø¹Ø¯ Ø§Ø² Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ auth Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†)
// { name: 'Button Component', path: 'components/Button.js', type: 'ui' },
    






    
// ==================== ØªØ³Øª Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø± ====================
async function runFullIntegrationTest() {
    console.log('ğŸš€ Ø´Ø±ÙˆØ¹ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ú©Ø§Ù…Ù„ Vakamova');
    
    // Ù…Ø±Ø­Ù„Ù‡ Û±: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡Ù…Ù‡ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§
    const loadResults = await loadAllModules();
    if (!loadResults.success) {
        console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§');
        return;
    }
    
    // Ù…Ø±Ø­Ù„Ù‡ Û²: ØªØ³Øª Ø¬Ø±ÛŒØ§Ù† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
    console.log('ğŸ” ØªØ³Øª Ø¬Ø±ÛŒØ§Ù† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª...');
    const authTest = await testAuthFlow();
    if (!authTest.success) {
        console.error('âŒ Ø³ÛŒØ³ØªÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯');
        return;
    }
    
    // Ù…Ø±Ø­Ù„Ù‡ Û³: ØªØ³Øª Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
    console.log('ğŸ“ ØªØ³Øª Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§...');
    const routingTest = await testRoutingAndGuards();
    
    // Ù…Ø±Ø­Ù„Ù‡ Û´: ØªØ³Øª Ù…Ø§Ú˜ÙˆÙ„ Ø¯Ø±Ø³
    console.log('ğŸ“š ØªØ³Øª Ù…ÙˆØªÙˆØ± Ø¯Ø±Ø³â€ŒÙ‡Ø§...');
    const lessonTest = await testLessonModule();
    
    // Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬
    console.log('\nğŸ“Š ========== Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ ØªØ³Øª ==========');
    console.log(`âœ… Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡: ${loadResults.loadedCount}/${PROJECT_MODULES.length}`);
    console.log(`âœ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª: ${authTest.success ? 'Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡' : 'Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯'}`);
    console.log(`ğŸ“ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ: ${routingTest.success ? 'ÙØ¹Ø§Ù„' : 'Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…'}`);
    console.log(`ğŸ“š Ù…ÙˆØªÙˆØ± Ø¯Ø±Ø³: ${lessonTest.success ? 'Ø¢Ù…Ø§Ø¯Ù‡' : 'Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡'}`);
    console.log('ğŸ‰ ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Ú©Ø§Ù…Ù„ Ø´Ø¯!');
    
    // Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯
    if (authTest.success && routingTest.success) {
        console.log('\nğŸ’¡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¹Ø¯ÛŒ: ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ (index.html) Ùˆ Ø§ØªØµØ§Ù„ Router');
    }
}

// ==================== ØªÙˆØ§Ø¨Ø¹ ØªØ³Øª ====================
async function testAuthFlow() {
    try {
        // ØªØ³Øª Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
        const signupResult = await auth_manager.register({
            email: 'test@vakamova.com',
            password: 'Test123!@#',
            name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª'
        });
        
        if (!signupResult.success) {
            console.warn('âš ï¸ Ø«Ø¨Øª Ù†Ø§Ù… ØªØ³ØªÛŒ Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯ (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)');
        }
        
        // ØªØ³Øª ÙˆØ±ÙˆØ¯
        const loginResult = await auth_manager.login('test@vakamova.com', 'Test123!@#');
        
        // ØªØ³Øª ØªÙˆÚ©Ù†
        const tokenValid = await token_manager.validateToken(loginResult.token);
        
        // ØªØ³Øª ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± State Manager
        const userState = state_manager.get('auth.user');
        
        return {
            success: loginResult.success && tokenValid,
            user: userState,
            message: 'Ø¬Ø±ÛŒØ§Ù† Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯'
        };
    } catch (error) {
        return { success: false, error: error.message };
    }
}

async function testRoutingAndGuards() {
    try {
        // ØªØ³Øª Route Guards
        const publicRouteAccess = await guards.checkRouteAccess('/login', null);
        const protectedRouteAccess = await guards.checkRouteAccess('/dashboard', { isAuthenticated: true });
        
        // ØªØ³Øª Middleware
        const middlewareResult = await router_middleware.process({
            path: '/lesson/1',
            user: { isAuthenticated: true, role: 'student' }
        });
        
        return {
            success: publicRouteAccess.allowed && !protectedRouteAccess.allowed && middlewareResult.success,
            details: { publicRouteAccess, protectedRouteAccess, middlewareResult }
        };
    } catch (error) {
        return { success: false, error: error.message };
    }
}

async function testLessonModule() {
    try {
        // ØªØ³Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³â€ŒÙ‡Ø§
        const lessons = await lesson_engine.getAvailableLessons();
        const firstLesson = await lesson_engine.loadLesson(lessons[0]?.id || 'default');
        
        return {
            success: Array.isArray(lessons) && firstLesson !== null,
            lessonCount: lessons?.length || 0,
            sampleLesson: firstLesson?.title || 'Ø¯Ø±Ø³ ØªØ³Øª'
        };
    } catch (error) {
        return { success: false, error: error.message };
    }
}

// ==================== Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ====================
async function loadAllModules() {
    const results = { loaded: [], failed: [], loadedCount: 0 };
    
    for (const module of PROJECT_MODULES) {
        try {
            await loadModule(module);
            results.loaded.push(module.name);
            results.loadedCount++;
            console.log(`âœ… ${module.name} Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`);
        } catch (error) {
            results.failed.push({ name: module.name, error: error.message });
            console.warn(`âš ï¸ Ø®Ø·Ø§ Ø¯Ø± ${module.name}: ${error.message}`);
        }
    }
    
    return {
        success: results.failed.length === 0,
        ...results
    };
}

function loadModule(moduleInfo) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = moduleInfo.path;
        script.type = 'module';
        
        script.onload = () => resolve();
        script.onerror = () => reject(new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ${moduleInfo.path}`));
        
        document.head.appendChild(script);
    });
}

// ==================== Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ³Øª ====================
document.addEventListener('DOMContentLoaded', () => {
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ ØªØ³Øª Ø¨Ù‡ ØµÙØ­Ù‡
    const testButton = document.createElement('button');
    testButton.textContent = 'ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Ú©Ø§Ù…Ù„ Vakamova';
    testButton.style.cssText = `
        position: fixed; top: 20px; right: 20px; 
        padding: 15px 25px; background: #0d7377; 
        color: white; border: none; border-radius: 10px;
        cursor: pointer; font-size: 16px; z-index: 1000;
    `;
    testButton.onclick = runFullIntegrationTest;
    document.body.appendChild(testButton);
    
    console.log('ğŸ§ª ØªØ³ØªØ± ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ Vakamova Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª');
    console.log('Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ØªØ³ØªØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ "Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Ú©Ø§Ù…Ù„" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯');
});
