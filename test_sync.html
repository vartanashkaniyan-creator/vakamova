<!DOCTYPE html>
<html>
<head>
    <title>ØªØ³Øª RealTimeSync</title>
    <style>
        body { font-family: Tahoma; padding: 20px; text-align: center; }
        button { padding: 12px 25px; font-size: 16px; background: #009688; color: white; 
                 border: none; border-radius: 5px; cursor: pointer; margin: 10px; }
        button:hover { background: #00796B; }
        #result { margin: 20px; padding: 20px; border: 2px solid #ddd; border-radius: 10px; 
                  min-height: 150px; font-family: monospace; text-align: left; background: #f9f9f9; 
                  max-height: 400px; overflow-y: auto; }
        .sync-info { background: #E0F2F1; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .step { margin: 8px 0; padding: 8px; border-left: 4px solid #009688; background: white; }
        .success-step { border-left-color: #4CAF50; }
        .error-step { border-left-color: #f44336; }
        .conflict-step { border-left-color: #FF9800; }
        .entity-box { background: #B2DFDB; margin: 10px; padding: 10px; border-radius: 5px; display: inline-block; }
        .sync-status { padding: 5px 10px; border-radius: 3px; margin: 2px; font-size: 12px; }
        .synced { background: #C8E6C9; color: #2E7D32; }
        .pending { background: #FFF9C4; color: #F57F17; }
        .conflict { background: #FFCDD2; color: #C62828; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ØªØ³Øª RealTimeSync</h1>
    <p>ÙØ§Ø² Ûµ: Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ù„Ø§Ø¯Ø±Ù†Ú¯ + Conflict Resolution</p>
    
    <div>
        <button onclick="testRealTimeSync()">ØªØ³Øª RealTimeSync</button>
        <button onclick="simulateConflict()">Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Conflict</button>
        <button onclick="forceSyncAll()">Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ÙÙˆØ±ÛŒ</button>
        <button onclick="clearLog()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯</button>
    </div>
    
    <div id="result">Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ ØªØ³Øª...</div>
    
    <div id="syncInfo" class="sync-info">
        ğŸ”„ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ: Ù…Ù†ØªØ¸Ø± ØªØ³Øª...
    </div>
    
    <div id="entitiesContainer">
        <!-- Ù…ÙˆØ¬ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
    </div>

    <script>
        // ==================== Û±. EventBus ====================
        class EventBus {
            constructor() { this.listeners = {}; }
            on(eventName, callback) {
                if (!this.listeners[eventName]) this.listeners[eventName] = [];
                this.listeners[eventName].push(callback);
                return () => this.off(eventName, callback);
            }
            off(eventName, callback) {
                if (this.listeners[eventName]) {
                    this.listeners[eventName] = this.listeners[eventName].filter(cb => cb !== callback);
                }
            }
            emit(eventName, data) {
                if (this.listeners[eventName]) {
                    this.listeners[eventName].forEach(callback => {
                        try { callback(data); } catch (error) { console.error('Listener error:', error); }
                        });
                    }
                }
            }
            
            // ==================== Û². StateManager ====================
            class StateManager {
                constructor(initialState = {}) {
                    this.state = { 
                        user: null,
                        lessons: [],
                        settings: {},
                        syncStatus: {},
                        ...initialState 
                    };
                    this.eventBus = new EventBus();
                    log("âœ… StateManager Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯");
                }
                
                getState() { return { ...this.state }; }
                
                dispatch(action) {
                    const oldState = { ...this.state };
                    
                    switch (action.type) {
                        case 'SET_USER':
                            this.state.user = action.payload;
                            break;
                        case 'ADD_LESSON':
                            if (!this.state.lessons) this.state.lessons = [];
                            this.state.lessons.push(action.payload);
                            break;
                        case 'UPDATE_LESSON':
                            const lessonIndex = this.state.lessons.findIndex(l => l.id === action.payload.id);
                            if (lessonIndex !== -1) {
                                this.state.lessons[lessonIndex] = { 
                                    ...this.state.lessons[lessonIndex], 
                                    ...action.payload 
                                };
                            }
                            break;
                        case 'UPDATE_SYNC_STATUS':
                            this.state.syncStatus = { ...this.state.syncStatus, ...action.payload };
                            break;
                        case 'UPDATE_SETTINGS':
                            this.state.settings = { ...this.state.settings, ...action.payload };
                            break;
                    }
                    
                    this.eventBus.emit('state.changed', { 
                        type: action.type, 
                        oldState, 
                        newState: this.state,
                        payload: action.payload 
                    });
                    
                    updateEntitiesDisplay();
                }
            }
            
            // ==================== Û³. RealTimeSync ====================
            class RealTimeSync {
                constructor(eventBus, stateManager, config = {}) {
                    this.eventBus = eventBus;
                    this.stateManager = stateManager;
                    this.config = {
                        syncInterval: 5000,
                        autoSync: true,
                        conflictRetryDelay: 3000,
                        ...config
                    };
                    
                    this.isOnline = true;
                    this.isSyncing = false;
                    this.syncTimer = null;
                    this.conflictResolvers = {};
                    this.syncStrategies = {};
                    this.pendingSyncs = new Map();
                    
                    // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ events
                    this.eventBus.on('network.status', (status) => {
                        this.setOnline(status.isOnline);
                    });
                    
                    this.stateManager.eventBus.on('state.changed', (data) => {
                        this.handleStateChange(data);
                    });
                    
                    log("âœ… RealTimeSync Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯");
                    this.startAutoSync();
                }
                
                // Ø´Ø±ÙˆØ¹ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
                startAutoSync() {
                    if (this.syncTimer || !this.config.autoSync) return;
                    
                    this.syncTimer = setInterval(() => {
                        if (this.isOnline && !this.isSyncing) {
                            this.syncAll({ background: true });
                        }
                    }, this.config.syncInterval);
                    
                    log("â° Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ¹Ø§Ù„ Ø´Ø¯");
                }
                
                // ØªÙˆÙ‚Ù Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
                stopAutoSync() {
                    if (this.syncTimer) {
                        clearInterval(this.syncTimer);
                        this.syncTimer = null;
                        log("â¹ï¸ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ØªÙˆÙ‚Ù Ø´Ø¯");
                    }
                }
                
                // ØªÙ†Ø¸ÛŒÙ… ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ†/Ø¢ÙÙ„Ø§ÛŒÙ†
                setOnline(online) {
                    const wasOnline = this.isOnline;
                    this.isOnline = online;
                    
                    if (!wasOnline && online) {
                        log("ğŸŒ Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯ - Ø´Ø±ÙˆØ¹ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ", 'success');
                        this.eventBus.emit('sync.network_restored');
                        if (this.config.autoSync) {
                            this.syncAll({ background: true });
                        }
                    } else if (wasOnline && !online) {
                        log("ğŸ“´ Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ø´Ø¯ - ØªÙˆÙ‚Ù Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ", 'warning');
                        this.eventBus.emit('sync.network_lost');
                    }
                }
                
                // Ø«Ø¨Øª Conflict Resolver
                registerConflictResolver(entityType, resolver) {
                    this.conflictResolvers[entityType] = resolver;
                    log(`ğŸ”§ Conflict Resolver Ø«Ø¨Øª Ø´Ø¯ Ø¨Ø±Ø§ÛŒ: ${entityType}`);
                }
                
                // Ø«Ø¨Øª Sync Strategy
                registerSyncStrategy(entityType, strategy) {
                    this.syncStrategies[entityType] = strategy;
                    log(`ğŸ”§ Sync Strategy Ø«Ø¨Øª Ø´Ø¯ Ø¨Ø±Ø§ÛŒ: ${entityType}`);
                }
                
                // Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØºÛŒÛŒØ± state
                handleStateChange(changeData) {
                    // ØªØ´Ø®ÛŒØµ entity type Ø§Ø² ØªØºÛŒÛŒØ± state
                    let entityType = null;
                    let entityId = null;
                    
                    if (changeData.type === 'UPDATE_LESSON') {
                        entityType = 'lesson';
                        entityId = changeData.payload.id;
                    } else if (changeData.type === 'UPDATE_SETTINGS') {
                        entityType = 'settings';
                        entityId = 'global';
                    } else if (changeData.type === 'SET_USER') {
                        entityType = 'user';
                        entityId = changeData.payload?.id;
                    }
                    
                    if (entityType && entityId && this.isOnline) {
                        // ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² sync Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯
                        clearTimeout(this.stateChangeDebounce);
                        this.stateChangeDebounce = setTimeout(() => {
                            this.syncEntity(entityType, entityId, { priority: 1 });
                        }, 1000);
                    }
                }
                
                // Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ÛŒÚ© entity
                async syncEntity(entityType, entityId, options = {}) {
                    const syncKey = `${entityType}:${entityId}`;
                    
                    if (this.pendingSyncs.has(syncKey)) {
                        log(`âš ï¸ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø§Ø³Øª Ø¨Ø±Ø§ÛŒ: ${syncKey}`, 'warning');
                        return this.pendingSyncs.get(syncKey);
                    }
                    
                    log(`ğŸ”„ Ø´Ø±ÙˆØ¹ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ: ${syncKey}`);
                    
                    const syncPromise = this.performEntitySync(entityType, entityId, options);
                    this.pendingSyncs.set(syncKey, syncPromise);
                    
                    try {
                        const result = await syncPromise;
                        return result;
                    } finally {
                        this.pendingSyncs.delete(syncKey);
                    }
                }
                
                // Ø§Ø¬Ø±Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ
                async performEntitySync(entityType, entityId, options) {
                    this.isSyncing = true;
                    this.updateSyncStatus(entityType, entityId, 'syncing');
                    
                    try {
                        // Û±. Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ù…Ø­Ù„ÛŒ
                        const localData = this.getLocalEntity(entityType, entityId);
                        if (!localData) {
                            throw new Error(`Entity Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯: ${entityType}:${entityId}`);
                        }
                        
                        // Û². Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² Ø³Ø±ÙˆØ±
                        const remoteData = await this.fetchRemoteData(entityType, entityId);
                        
                        // Û³. ØªØ´Ø®ÛŒØµ ØªØºÛŒÛŒØ±Ø§Øª
                        const localChanges = this.detectChanges(localData, remoteData);
                        const remoteChanges = this.detectChanges(remoteData, localData);
                        
                        // Û´. Ø¨Ø±Ø±Ø³ÛŒ conflict
                        if (this.hasConflict(localChanges, remoteChanges)) {
                            log(`âš”ï¸ Conflict ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯ Ø¨Ø±Ø§ÛŒ: ${entityType}:${entityId}`, 'conflict');
                            return await this.handleConflict(entityType, entityId, localChanges, remoteChanges, options);
                        }
                        
                        // Ûµ. Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª
                        let result;
                        if (Object.keys(remoteChanges).length > 0) {
                            // ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø² Ø³Ø±ÙˆØ±
                            result = await this.applyRemoteChanges(entityType, entityId, remoteChanges);
                            log(`âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø² Ø³Ø±ÙˆØ± Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯: ${entityType}:${entityId}`, 'success');
                        } else if (Object.keys(localChanges).length > 0) {
                            // Ø§Ø±Ø³Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ù‡ Ø³Ø±ÙˆØ±
                            result = await this.sendLocalChanges(entityType, entityId, localChanges);
                            log(`ğŸ“¤ ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: ${entityType}:${entityId}`, 'success');
                        } else {
                            result = { status: 'already_synced', message: 'Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÛŒÚ©Ø³Ø§Ù† Ù‡Ø³ØªÙ†Ø¯' };
                            log(`âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ù‡Ù…Ú¯Ø§Ù… Ù‡Ø³ØªÙ†Ø¯: ${entityType}:${entityId}`);
                        }
                        
                        this.updateSyncStatus(entityType, entityId, 'synced');
                        this.eventBus.emit('sync.completed', { entityType, entityId, result });
                        
                        return {
                            success: true,
                            entityType,
                            entityId,
                            ...result
                        };
                        
                    } catch (error) {
                        log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ${entityType}:${entityId}: ${error.message}`, 'error');
                        this.updateSyncStatus(entityType, entityId, 'error');
                        this.eventBus.emit('sync.error', { entityType, entityId, error });
                        
                        return {
                            success: false,
                            entityType,
                            entityId,
                            error: error.message
                        };
                    } finally {
                        this.isSyncing = false;
                    }
                }
                
                // Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù‡Ù…Ù‡ entities
                async syncAll(options = {}) {
                    if (this.isSyncing) {
                        log("âš ï¸ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù… Ø§Ø³Øª", 'warning');
                        return;
                    }
                    
                    log("ğŸ”„ Ø´Ø±ÙˆØ¹ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒ...");
                    this.isSyncing = true;
                    
                    try {
                        const entities = this.getSyncableEntities();
                        const results = [];
                        
                        // Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ entities
                        const priorityOrder = ['user', 'settings', 'lesson'];
                        const sortedEntities = entities.sort((a, b) => {
                            const aPriority = priorityOrder.indexOf(a.type);
                            const bPriority = priorityOrder.indexOf(b.type);
                            return bPriority - aPriority; // Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§ØªØ± Ø§ÙˆÙ„
                        });
                        
                        for (const entity of sortedEntities) {
                            try {
                                const result = await this.syncEntity(entity.type, entity.id, {
                                    ...options,
                                    priority: 10 - priorityOrder.indexOf(entity.type)
                                });
                                results.push(result);
                            } catch (error) {
                                results.push({
                                    success: false,
                                    entityType: entity.type,
                                    entityId: entity.id,
                                    error: error.message
                                });
                            }
                        }
                        
                        const successful = results.filter(r => r.success).length;
                        const failed = results.filter(r => !r.success).length;
                        
                        log(`ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒ: âœ… ${successful} Ù…ÙˆÙÙ‚, âŒ ${failed} Ù†Ø§Ù…ÙˆÙÙ‚`, 
                            failed > 0 ? 'warning' : 'success');
                        
                        this.eventBus.emit('sync.all_completed', { results, successful, failed });
                        
                        return results;
                        
                    } finally {
                        this.isSyncing = false;
                    }
                }
                
                // Ù…Ø¯ÛŒØ±ÛŒØª conflict
                async handleConflict(entityType, entityId, localChanges, remoteChanges, options) {
                    const resolver = this.conflictResolvers[entityType] || this.conflictResolvers.default;
                    
                    if (!resolver) {
                        log(`âš ï¸ Ù‡ÛŒÚ† Conflict ResolverÛŒ Ø¨Ø±Ø§ÛŒ ${entityType} Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯`, 'error');
                        this.updateSyncStatus(entityType, entityId, 'conflict');
                        this.eventBus.emit('sync.conflict', { entityType, entityId, localChanges, remoteChanges });
                        return {
                            success: false,
                            status: 'conflict_unresolved',
                            entityType,
                            entityId
                        };
                    }
                    
                    log(`ğŸ”§ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø­Ù„ conflict Ø¨Ø§ ${resolver.name}...`);
                    
                    try {
                        const resolution = await resolver.resolve(localChanges, remoteChanges, {
                            entityType,
                            entityId,
                            ...options
                        });
                        
                        if (resolution.resolved) {
                            // Ø§Ø¹Ù…Ø§Ù„ Ø±Ø§Ù‡â€ŒØ­Ù„
                            await this.applyResolution(entityType, entityId, resolution);
                            log(`âœ… Conflict Ø­Ù„ Ø´Ø¯: ${resolution.strategy}`, 'success');
                            
                            // retry sync
                            setTimeout(() => {
                                this.syncEntity(entityType, entityId, { 
                                    ...options, 
                                    retry: true 
                                });
                            }, this.config.conflictRetryDelay);
                            
                            return {
                                success: true,
                                status: 'conflict_resolved',
                                strategy: resolution.strategy,
                                entityType,
                                entityId
                            };
                        } else {
                            // Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØµÙ…ÛŒÙ… Ú©Ø§Ø±Ø¨Ø±
                            log(`ğŸ‘¤ Conflict Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØµÙ…ÛŒÙ… Ú©Ø§Ø±Ø¨Ø± Ø¯Ø§Ø±Ø¯`, 'warning');
                            this.updateSyncStatus(entityType, entityId, 'needs_user_decision');
                            this.eventBus.emit('sync.user_intervention_needed', { 
                                entityType, 
                                entityId, 
                                localChanges, 
                                remoteChanges 
                            });
                            
                            return {
                                success: false,
                                status: 'needs_user_decision',
                                entityType,
                                entityId
                            };
                        }
                    } catch (error) {
                        log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ù„ conflict: ${error.message}`, 'error');
                        return {
                            success: false,
                            status: 'conflict_error',
                            error: error.message,
                            entityType,
                            entityId
                        };
                    }
                }
                
                // ==================== ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ====================
                
                getLocalEntity(entityType, entityId) {
                    const state = this.stateManager.getState();
                    
                    switch (entityType) {
                        case 'user':
                            return state.user;
                        case 'lesson':
                            return state.lessons?.find(l => l.id === entityId);
                        case 'settings':
                            return state.settings;
                        default:
                            return null;
                    }
                }
                
                async fetchRemoteData(entityType, entityId) {
                    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ Ø³Ø±ÙˆØ±
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            // Ø¯Ø§Ø¯Ù‡ mock
                            const mockData = {
                                user: {
                                    id: 'user_123',
                                    name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª',
                                    email: 'test@vakamova.com',
                                    lastSync: Date.now() - 10000 // 10 Ø«Ø§Ù†ÛŒÙ‡ Ù‚Ø¨Ù„
                                },
                                lesson: {
                                    id: entityId,
                                    title: `Ø¯Ø±Ø³ ${entityId}`,
                                    progress: Math.floor(Math.random() * 100),
                                    lastUpdated: Date.now() - 5000
                                },
                                settings: {
                                    theme: 'light',
                                    language: 'fa',
                                    notifications: true
                                }
                            };
                            
                            resolve(mockData[entityType] || {});
                        }, 500);
                    });
                }
                
                detectChanges(local, remote) {
                    const changes = {};
                    
                    if (!local || !remote) return changes;
                    
                    for (const key in remote) {
                        if (JSON.stringify(local[key]) !== JSON.stringify(remote[key])) {
                            changes[key] = remote[key];
                        }
                    }
                    
                    return changes;
                }
                
                hasConflict(localChanges, remoteChanges) {
                    const commonKeys = Object.keys(localChanges).filter(key => remoteChanges[key]);
                    return commonKeys.length > 0;
                }
                
                async applyRemoteChanges(entityType, entityId, changes) {
                    // Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± state
                    if (entityType === 'lesson') {
                        this.stateManager.dispatch({
                            type: 'UPDATE_LESSON',
                            payload: { id: entityId, ...changes }
                        });
                    } else if (entityType === 'settings') {
                        this.stateManager.dispatch({
                            type: 'UPDATE_SETTINGS',
                            payload: changes
                        });
                    }
                    
                    return { applied: true, changes };
                }
                
                async sendLocalChanges(entityType, entityId, changes) {
                    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            resolve({ sent: true, changes, timestamp: Date.now() });
                        }, 800);
                    });
                }
                
                async applyResolution(entityType, entityId, resolution) {
                    // Ø§Ø¹Ù…Ø§Ù„ Ø±Ø§Ù‡â€ŒØ­Ù„ conflict
                    const mergedData = { ...resolution.mergedData };
                    
                    if (entityType === 'lesson') {
                        this.stateManager.dispatch({
                            type: 'UPDATE_LESSON',
                            payload: { id: entityId, ...mergedData }
                        });
                    }
                    
                    return { applied: true };
                }
                
                getSyncableEntities() {
                    const state = this.stateManager.getState();
                    const entities = [];
                    
                    if (state.user) {
                        entities.push({ type: 'user', id: state.user.id || 'current' });
                    }
                    
                    if (state.lessons) {
                        state.lessons.forEach(lesson => {
                            entities.push({ type: 'lesson', id: lesson.id });
                        });
                    }
                    
                    if (state.settings) {
                        entities.push({ type: 'settings', id: 'global' });
                    }
                    
                    return entities;
                }
                
                updateSyncStatus(entityType, entityId, status) {
                    const key = `${entityType}:${entityId}`;
                    this.stateManager.dispatch({
                        type: 'UPDATE_SYNC_STATUS',
                        payload: { [key]: { status, timestamp: Date.now() } }
                    });
                }
            }
            
            // ==================== Û´. Conflict Resolvers ====================
            const conflictResolvers = {
                // Last Write Wins
                lastWriteWins: {
                    name: 'lastWriteWins',
                    resolve: async (localChanges, remoteChanges, context) => {
                        const localTimestamp = localChanges._timestamp || 0;
                        const remoteTimestamp = remoteChanges._timestamp || 0;
                        
                        if (remoteTimestamp > localTimestamp) {
                            return {
                                resolved: true,
                                strategy: 'remote_wins',
                                mergedData: { ...localChanges, ...remoteChanges }
                            };
                        } else {
                            return {
                                resolved: true,
                                strategy: 'local_wins',
                                mergedData: { ...remoteChanges, ...localChanges }
                            };
                        }
                    }
                },
                
                // Merge Changes
                merge: {
                    name: 'merge',
                    resolve: async (localChanges, remoteChanges, context) => {
                        // Ø§Ø¯ØºØ§Ù… Ø³Ø§Ø¯Ù‡
                        const merged = { ...localChanges, ...remoteChanges };
                        
                        // Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§ØµØŒ Ù…Ù†Ø·Ù‚ ÙˆÛŒÚ˜Ù‡
                        if (context.entityType === 'lesson') {
                            // Ø¨Ø±Ø§ÛŒ progressØŒ Ù…Ù‚Ø¯Ø§Ø± Ø¨ÛŒØ´ØªØ± Ø±Ø§ Ø¨Ú¯ÛŒØ±
                            if (localChanges.progress && remoteChanges.progress) {
                                merged.progress = Math.max(localChanges.progress, remoteChanges.progress);
                            }
                        }
                        
                        return {
                            resolved: true,
                            strategy: 'merged',
                            mergedData: merged
                        };
                    }
                },
                
                // Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØµÙ…ÛŒÙ… Ú©Ø§Ø±Ø¨Ø±
                userDecision: {
                    name: 'userDecision',
                    resolve: async () => {
                        return {
                            resolved: false,
                            strategy: 'needs_user_decision'
                        };
                    }
                }
            };
            
            // ==================== Ûµ. ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ====================
            function log(message, type = 'info') {
                const resultDiv = document.getElementById('result');
                const stepClass = type === 'success' ? 'success-step' : 
                                type === 'error' ? 'error-step' :
                                type === 'conflict' ? 'conflict-step' : 'step';
                
                resultDiv.innerHTML += `
                    <div class="${stepClass}">
                        <strong>[${new Date().toLocaleTimeString()}]</strong> ${message}
                    </div>
                `;
                resultDiv.scrollTop = resultDiv.scrollHeight;
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
            
            function clearLog() {
                document.getElementById('result').innerHTML = '';
            }
            
            function updateEntitiesDisplay() {
                const container = document.getElementById('entitiesContainer');
                if (!container) return;
                
                const state = window.stateManager?.getState();
                if (!state) return;
                
                let html = '<h3>ğŸ“‹ Ù…ÙˆØ¬ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§:</h3>';
                
                // Ú©Ø§Ø±Ø¨Ø±
                if (state.user) {
                    const syncStatus = state.syncStatus?.['user:current']?.status || 'pending';
                    html += `
                        <div class="entity-box">
                            ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: ${state.user.name}<br>
                            <span class="sync-status ${syncStatus}">${syncStatus}</span>
                        </div>
                    `;
                }
                
                // Ø¯Ø±Ø³â€ŒÙ‡Ø§
                if (state.lessons && state.lessons.length > 0) {
                    state.lessons.forEach(lesson => {
                        const syncStatus = state.syncStatus?.[`lesson:${lesson.id}`]?.status || 'pending';
                        html += `
                            <div class="entity-box">
                                ğŸ“š ${lesson.title}<br>
                                ğŸ“Š Ù¾ÛŒØ´Ø±ÙØª: ${lesson.progress}%<br>
                                <span class="sync-status ${syncStatus}">${syncStatus}</span>
                            </div>
                        `;
                    });
                }
                
                // ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                if (state.settings) {
                    const syncStatus = state.syncStatus?.['settings:global']?.status || 'pending';
                    html += `
                        <div class="entity-box">
                            âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª<br>
                            Ø²Ø¨Ø§Ù†: ${state.settings.language || 'fa'}<br>
                            <span class="sync-status ${syncStatus}">${syncStatus}</span>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            }
            
            // ==================== Û¶. ØªØ³Øª Ø§ØµÙ„ÛŒ ====================
            let realTimeSync = null;
            let eventBus = null;
            let stateManager = null;
            
            function testRealTimeSync() {
                clearLog();
                log("ğŸ¬ Ø´Ø±ÙˆØ¹ ØªØ³Øª RealTimeSync...", "success");
                
                try {
                    // Û±. Ø³Ø§Ø®Øª EventBus
                    log("Ù…Ø±Ø­Ù„Ù‡ Û±: Ø³Ø§Ø®Øª EventBus Ùˆ StateManager...");
                    eventBus = new EventBus();
                    stateManager = new StateManager({
                        user: {
                            id: 'user_123',
                            name: 'Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ',
                            email: 'ali@vakamova.com'
                        },
                        lessons: [
                            { id: 'lesson_1', title: 'Ù…Ù‚Ø¯Ù…Ø§Øª Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ', progress: 30 },
                            { id: 'lesson_2', title: 'Ú¯Ø±Ø§Ù…Ø± Ù¾Ø§ÛŒÙ‡', progress: 60 },
                            { id: 'lesson_3', title: 'Ù…Ú©Ø§Ù„Ù…Ù‡ Ø±ÙˆØ²Ù…Ø±Ù‡', progress: 10 }
                        ],
                        settings: {
                            theme: 'light',
                            language: 'fa',
                            notifications: true
                        }
                    });
                    
                    window.stateManager = stateManager; // Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
                    
                    // Û². Ø³Ø§Ø®Øª RealTimeSync
                    log("Ù…Ø±Ø­Ù„Ù‡ Û²: Ø³Ø§Ø®Øª RealTimeSync...");
                    realTimeSync = new RealTimeSync(eventBus, stateManager, {
                        syncInterval: 7000,
                        autoSync: true,
                        conflictRetryDelay: 2000
                    });
                    
                    // Û³. Ø«Ø¨Øª Conflict Resolvers
                    log("Ù…Ø±Ø­Ù„Ù‡ Û³: Ø«Ø¨Øª Conflict Resolvers...");
                    realTimeSync.registerConflictResolver('lesson', conflictResolvers.merge);
                    realTimeSync.registerConflictResolver('user', conflictResolvers.lastWriteWins);
                    realTimeSync.registerConflictResolver('settings', conflictResolvers.lastWriteWins);
                    realTimeSync.registerConflictResolver('default', conflictResolvers.userDecision);
                    
                    // Û´. Ø«Ø¨Øª Event Listeners
                    log("Ù…Ø±Ø­Ù„Ù‡ Û´: Ø«Ø¨Øª Event Listeners...");
                    eventBus.on('sync.completed', (data) => {
                        log(`ğŸ“¢ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯: ${data.entityType}:${data.entityId}`, 'success');
                    });
                    
                    eventBus.on('sync.conflict', (data) => {
                        log(`ğŸ“¢ Conflict ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯ Ø¯Ø±: ${data.entityType}:${data.entityId}`, 'conflict');
                    });
                    
                    eventBus.on('sync.user_intervention_needed', (data) => {
                        log(`ğŸ“¢ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØµÙ…ÛŒÙ… Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ: ${data.entityType}:${data.entityId}`, 'warning');
                    });
                    
                    eventBus.on('sync.all_completed', (data) => {
                        log(`ğŸ“Š Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯: ${data.successful} Ù…ÙˆÙÙ‚, ${data.failed} Ù†Ø§Ù…ÙˆÙÙ‚`);
                    });
                    
                    // Ûµ. ØªØ³Øª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ entity Ø®Ø§Øµ
                    log("Ù…Ø±Ø­Ù„Ù‡ Ûµ: ØªØ³Øª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø±Ø³ Û±...");
                    setTimeout(async () => {
                        try {
                            const result = await realTimeSync.syncEntity('lesson', 'lesson_1', { priority: 10 });
                            log(`Ù†ØªÛŒØ¬Ù‡ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø±Ø³ Û±: ${result.success ? 'âœ… Ù…ÙˆÙÙ‚' : 'âŒ Ù†Ø§Ù…ÙˆÙÙ‚'}`);
                        } catch (error) {
                            log(`Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø±Ø³ Û±: ${error.message}`, 'error');
                        }
                    }, 1000);
                    
                    // Û¶. ØªØ³Øª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒ
                    log("Ù…Ø±Ø­Ù„Ù‡ Û¶: ØªØ³Øª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒ (Ø¨Ø¹Ø¯ Ø§Ø² Û³ Ø«Ø§Ù†ÛŒÙ‡)...");
                    setTimeout(async () => {
                        try {
                            const results = await realTimeSync.syncAll();
                            log(`Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. ${results.length} entity Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯.`);
                        } catch (error) {
                            log(`Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒ: ${error.message}`, 'error');
                        }
                    }, 3000);
                    
                    // Û·. Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªØºÛŒÛŒØ± state (trigger auto-sync)
                    log("Ù…Ø±Ø­Ù„Ù‡ Û·: Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªØºÛŒÛŒØ± state (Ø¨Ø¹Ø¯ Ø§Ø² Û¶ Ø«Ø§Ù†ÛŒÙ‡)...");
                    setTimeout(() => {
                        stateManager.dispatch({
                            type: 'UPDATE_LESSON',
                            payload: { id: 'lesson_2', progress: 85 }
                        });
                        log("ğŸ“ Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø±Ø³ Û² Ø¨Ù‡ 85% Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯");
                    }, 6000);
                    
                    // Û¸. Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†/Ø¢Ù†Ù„Ø§ÛŒÙ†
                    log("Ù…Ø±Ø­Ù„Ù‡ Û¸: Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ†/Ø¢Ù†Ù„Ø§ÛŒÙ† (Ø¨Ø¹Ø¯ Ø§Ø² Û¹ Ø«Ø§Ù†ÛŒÙ‡)...", 'warning');
                    setTimeout(() => {
                        realTimeSync.setOnline(false);
                        
                        setTimeout(() => {
                            realTimeSync.setOnline(true);
                        }, 3000);
                    }, 9000);
                    
                    // Û¹. Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´
                    const updateDisplayInterval = setInterval(() => {
                        updateEntitiesDisplay();
                        
                        // Ø¢Ù¾Ø¯ÛŒØª sync info
                        const syncInfo = document.getElementById('syncInfo');
                        if (syncInfo && realTimeSync) {
                            const status = realTimeSync.isSyncing ? 'Ø¯Ø± Ø­Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ...' : 
                                          realTimeSync.isOnline ? 'Ø¢Ù…Ø§Ø¯Ù‡' : 'Ø¢ÙÙ„Ø§ÛŒÙ†';
                            syncInfo.innerHTML = `
                                ğŸ”„ ÙˆØ¶Ø¹ÛŒØª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ:<br>
                                ğŸ“¶ Ø´Ø¨Ú©Ù‡: ${realTimeSync.isOnline ? 'ğŸŒ Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'ğŸ“´ Ø¢ÙÙ„Ø§ÛŒÙ†'}<br>
                                âš™ï¸ Ø­Ø§Ù„Øª: ${realTimeSync.isSyncing ? 'ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø³ÛŒÙ†Ú©' : 'âœ… Ø¢Ù…Ø§Ø¯Ù‡'}<br>
                                â° auto-sync: ${realTimeSync.syncTimer ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
                            `;
                        }
                    }, 1000);
                    
                    // Û±Û°. Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
                    setTimeout(() => {
                        log("=".repeat(50));
                        log("ğŸ‰ ØªØ³Øª RealTimeSync Ú©Ø§Ù…Ù„ Ø´Ø¯!", 'success');
                        log("âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ entity Ø®Ø§Øµ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯");
                        log("âœ… Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ù„ÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯");
                        log("âœ… auto-sync Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØºÛŒÛŒØ±Ø§Øª state Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯");
                        log("âœ… Ù…Ø¯ÛŒØ±ÛŒØª Ø¢ÙÙ„Ø§ÛŒÙ†/Ø¢Ù†Ù„Ø§ÛŒÙ† Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯");
                        log("âœ… Conflict detection Ùˆ resolution Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯");
                        
                        clearInterval(updateDisplayInterval);
                        updateEntitiesDisplay();
                        
                    }, 15000);
                    
                } catch (error) {
                    log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª RealTimeSync: ${error.message}`, 'error');
                    console.error("RealTimeSync test error:", error);
                }
            }
            
            // ==================== Û·. ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ³Øª ====================
            function simulateConflict() {
                if (!realTimeSync) {
                    log("âš ï¸ Ø§Ø¨ØªØ¯Ø§ RealTimeSync Ø±Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯", 'error');
                    return;
                }
                
                log("âš”ï¸ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Conflict Ø¯Ø± Ø¯Ø±Ø³ Û±...", 'conflict');
                
                // ØªØºÛŒÛŒØ± Ù…Ø­Ù„ÛŒ
                stateManager.dispatch({
                    type: 'UPDATE_LESSON',
                    payload: { id: 'lesson_1', progress: 90, title: 'ØªØºÛŒÛŒØ± Ù…Ø­Ù„ÛŒ' }
                });
                
                // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªØºÛŒÛŒØ± Ù‡Ù…Ø²Ù…Ø§Ù† Ø¯Ø± Ø³Ø±ÙˆØ±
                setTimeout(() => {
                    log("Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ ØªØºÛŒÛŒØ± Ù‡Ù…Ø²Ù…Ø§Ù† Ø¯Ø± Ø³Ø±ÙˆØ±...");
                    // Ø§ÛŒÙ† Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´ÙˆØ¯ sync Ø¨Ø¹Ø¯ÛŒ conflict Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
                }, 500);
                
                // trigger sync
                setTimeout(() => {
                    realTimeSync.syncEntity('lesson', 'lesson_1', { priority: 10 });
                }, 1000);
            }
            
            function forceSyncAll() {
                if (!realTimeSync) {
                    log("âš ï¸ Ø§Ø¨ØªØ¯Ø§ RealTimeSync Ø±Ø§ Ø¨Ø³Ø§Ø²ÛŒØ¯", 'error');
                    return;
                }
                
                log("ğŸš€ Ø´Ø±ÙˆØ¹ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ÙÙˆØ±ÛŒ Ù‡Ù…Ù‡ entities...");
                realTimeSync.syncAll({ force: true });
            }
            
            // ==================== Û¸. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡ ====================
            window.onload = function() {
                log("ğŸ“± RealTimeSync Test Ready");
                log("Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ 'ØªØ³Øª RealTimeSync' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯");
                log("Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Conflict Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ÙÙˆØ±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯");
            };
        </script>
    </body>
</html>
