<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Ù…Ù…ÛŒØ²ÛŒ Ù‡Ø³ØªÙ‡ Vakamova - Core Auditor</title>
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ù‡Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„ */
    </style>
</head>
<body>
    <div class="container">
        <!-- HTML Ù‡Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„ -->
    </div>
    
    <script>
        // ==================== Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ CORE ====================
        const CORE_MODULES = [
            { 
                id: 'event_bus',
                name: 'Event Bus', 
                path: 'core/event_bus.js', 
                dependencies: [],
                test: () => testEventBus()
            },
            { 
                id: 'utils',
                name: 'Utilities', 
                path: 'core/utils.js', 
                dependencies: [],
                test: () => testUtilities()
            },
            { 
                id: 'state',
                name: 'State (Ù¾Ø§ÛŒÙ‡)', 
                path: 'core/state.js', 
                dependencies: [],
                test: () => testBaseState()
            },
            { 
                id: 'state_manager',
                name: 'State Manager', 
                path: 'core/state_manager.js', 
                dependencies: ['event_bus'],
                test: () => testStateManager()
            },
            { 
                id: 'router',
                name: 'Router', 
                path: 'core/router.js', 
                dependencies: ['event_bus', 'state_manager'],
                test: () => testRouter()
            },
            { 
                id: 'database',
                name: 'Database', 
                path: 'core/database.js', 
                dependencies: ['utils'],
                test: () => testDatabase()
            },
            { 
                id: 'api',
                name: 'API (Ù¾Ø§ÛŒÙ‡)', 
                path: 'core/api.js', 
                dependencies: ['utils'],
                test: () => testBaseApi()
            },
            { 
                id: 'config',
                name: 'Config Manager', 
                path: 'core/config.js', 
                dependencies: ['utils'],
                test: () => testConfig()
            },
            { 
                id: 'font_manager',
                name: 'Font Manager', 
                path: 'core/font_manager.js', 
                dependencies: ['utils'],
                test: () => testFontManager()
            },
            { 
                id: 'context_provider',
                name: 'Context Provider', 
                path: 'core/context_provider.js', 
                dependencies: ['event_bus'],
                test: () => testContextProvider()
            },
            { 
                id: 'api_client',
                name: 'API Client', 
                path: 'core/api_client.js', 
                dependencies: ['event_bus', 'utils'],
                test: () => testApiClient()
            },
            { 
                id: 'router_middleware',
                name: 'Router Middleware', 
                path: 'core/router_middleware.js', 
                dependencies: ['router', 'state_manager'],
                test: () => testRouterMiddleware()
            },
            { 
                id: 'guards',
                name: 'Route Guards', 
                path: 'core/guards.js', 
                dependencies: ['router', 'state_manager'],
                test: () => testGuards()
            }
        ];
        
        // ==================== Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ ====================
        async function loadSmartSequence() {
            log('ğŸ§  Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø§ Ø±Ø¹Ø§ÛŒØª ØªØ±ØªÛŒØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§...', 'info');
            document.getElementById('progressFill').style.width = '0%';
            
            const total = CORE_MODULES.length;
            let loaded = 0;
            let round = 1;
            const maxRounds = 10;
            
            // Ø±ÛŒØ³Øª ÙˆØ¶Ø¹ÛŒØª
            appState.loadedModules.clear();
            appState.moduleElements.clear();
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
            createModuleCards();
            
            while (loaded < total && round <= maxRounds) {
                log(`ğŸ” Ø¯ÙˆØ± ${round} Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...`, 'info');
                let loadedThisRound = 0;
                
                for (let i = 0; i < CORE_MODULES.length; i++) {
                    const module = CORE_MODULES[i];
                    
                    // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡
                    if (appState.loadedModules.has(module.id)) {
                        continue;
                    }
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§
                    const missingDeps = module.dependencies.filter(dep => 
                        !appState.loadedModules.has(dep)
                    );
                    
                    if (missingDeps.length === 0) {
                        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÛŒÙ† Ù…Ø§Ú˜ÙˆÙ„
                        try {
                            log(`ğŸ“¦ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ${module.name}...`, 'info');
                            const success = await loadModule(i);
                            
                            if (success) {
                                loaded++;
                                loadedThisRound++;
                                appState.loadedModules.set(module.id, true);
                                
                                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ´Ø±ÙØª
                                const progress = (loaded / total) * 100;
                                document.getElementById('progressFill').style.width = `${progress}%`;
                                
                                // ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¨Ù‡ØªØ±
                                await new Promise(resolve => setTimeout(resolve, 300));
                            }
                        } catch (error) {
                            log(`âš ï¸ Ø®Ø·Ø§ Ø¯Ø± ${module.name}: ${error.message}`, 'warning');
                        }
                    } else {
                        // Ù†Ù…Ø§ÛŒØ´ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…ÙÙ‚ÙˆØ¯
                        updateModuleCard(i, 'waiting', missingDeps);
                    }
                }
                
                if (loadedThisRound === 0) {
                    log(`âš ï¸ Ø¯ÙˆØ± ${round}: Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§...`, 'warning');
                    
                    // Ù†Ù…Ø§ÛŒØ´ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø­Ù„ Ù†Ø´Ø¯Ù‡
                    const unresolved = CORE_MODULES
                        .filter(m => !appState.loadedModules.has(m.id))
                        .map(m => ({
                            name: m.name,
                            missing: m.dependencies.filter(d => !appState.loadedModules.has(d))
                        }))
                        .filter(m => m.missing.length > 0);
                    
                    if (unresolved.length > 0) {
                        log('ğŸ” ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø­Ù„ Ù†Ø´Ø¯Ù‡:', 'warning');
                        unresolved.forEach(item => {
                            log(`   ${item.name} â† ${item.missing.join(', ')}`, 'warning');
                        });
                    }
                    
                    // Ø§Ú¯Ø± Ø¯Ø± Ø¯ÙˆØ± Ø¯ÙˆÙ… Ù‡Ù… Ù¾ÛŒØ´Ø±ÙØªÛŒ Ù†Ø¨ÙˆØ¯ØŒ Ø´Ú©Ø³ØªÙ† Ø­Ù„Ù‚Ù‡
                    if (round >= 2) {
                        log('ğŸ’¥ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ØªÙˆÙ‚Ù Ø´Ø¯: ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø­Ù„ Ù†Ø´Ø¯Ù‡', 'error');
                        break;
                    }
                }
                
                round++;
            }
            
            const finalResult = {
                loaded: loaded,
                total: total,
                success: loaded === total
            };
            
            if (finalResult.success) {
                log(`ğŸ‰ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯: Ù‡Ù…Ù‡ ${total} ÙØ§ÛŒÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯`, 'success');
            } else {
                log(`âš ï¸ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø§ØªÙ…Ø§Ù…: ${loaded} Ø§Ø² ${total} ÙØ§ÛŒÙ„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`, 'warning');
            }
            
            return finalResult;
        }
        
        // ==================== ØªØ§Ø¨Ø¹ loadModule Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ ====================
        async function loadModule(moduleIndex) {
            const module = CORE_MODULES[moduleIndex];
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = module.path;
                
                // ØªÙ†Ø¸ÛŒÙ… timeout Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÛŒâ€ŒÙ¾Ø§ÛŒØ§Ù†
                const timeoutId = setTimeout(() => {
                    script.remove();
                    reject(new Error(`ØªØ§ÛŒÙ…â€ŒØ§ÙˆØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ ${module.path}`));
                }, 10000); // 10 Ø«Ø§Ù†ÛŒÙ‡
                
                script.onload = () => {
                    clearTimeout(timeoutId);
                    updateModuleCard(moduleIndex, 'loaded');
                    log(`âœ… ${module.name} Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`, 'success');
                    resolve(true);
                };
                
                script.onerror = () => {
                    clearTimeout(timeoutId);
                    updateModuleCard(moduleIndex, 'error');
                    log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ${module.name} (Ù…Ø³ÛŒØ±: ${module.path})`, 'error');
                    resolve(false); // reject Ù†Ú©Ù†ØŒ ÙÙ‚Ø· false Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†
                };
                
                // Ù†ÙˆØ¹ Ù…Ø§Ú˜ÙˆÙ„ ÛŒØ§ Ù…Ø¹Ù…ÙˆÙ„ÛŒØŸ
                if (module.path.includes('_bus.js') || module.path.includes('manager.js')) {
                    script.type = 'module';
                }
                
                document.head.appendChild(script);
            });
        }
        
        // ==================== ØªÙˆØ§Ø¨Ø¹ ØªØ³Øª Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡ ====================
        function testEventBus() {
            try {
                // Ú†Ù†Ø¯ÛŒÙ† Ø±ÙˆØ´ Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† EventBus
                const possibleBuses = [
                    window.eventBus,
                    window.EventBus,
                    window.HyperEventBus ? new window.HyperEventBus() : null,
                    window.eventBus || (window.HyperEventBus && new window.HyperEventBus())
                ].filter(Boolean);
                
                if (possibleBuses.length === 0) {
                    return { success: false, message: 'EventBus ÛŒØ§ÙØª Ù†Ø´Ø¯' };
                }
                
                const bus = possibleBuses[0];
                let eventReceived = false;
                
                // ØªØ³Øª Ø³Ø§Ø¯Ù‡ Ø§Ù†ØªØ´Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯
                const testEvent = 'auditor:test:' + Date.now();
                
                if (typeof bus.on === 'function' && typeof bus.emit === 'function') {
                    const unsubscribe = bus.on(testEvent, () => {
                        eventReceived = true;
                    });
                    
                    bus.emit(testEvent, { test: true });
                    
                    // ØµØ¨Ø± Ú©Ù† Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø±ÙˆÛŒØ¯Ø§Ø¯
                    setTimeout(() => {
                        if (typeof unsubscribe === 'function') {
                            unsubscribe();
                        }
                    }, 100);
                    
                    return eventReceived ? 
                        { success: true, message: 'EventBus ÙØ¹Ø§Ù„ Ø§Ø³Øª' } :
                        { success: false, message: 'EventBus Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ú©Ø±Ø¯' };
                }
                
                return { success: false, message: 'EventBus API Ù…Ø¹ØªØ¨Ø± Ù†Ø¯Ø§Ø±Ø¯' };
            } catch (error) {
                return { success: false, message: error.message };
            }
        }
        
        function testUtilities() {
            // ØªØ³Øª Ø³Ø§Ø¯Ù‡â€ŒØªØ±
            try {
                const utilsExist = 
                    typeof window.utils === 'object' ||
                    typeof window.Utils === 'object' ||
                    typeof window.UTILS === 'object' ||
                    (typeof window !== 'undefined' && window.JSON);
                
                return utilsExist ? 
                    { success: true, message: 'Utilities Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª' } :
                    { success: true, message: 'Utilities Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ù…Ø§ Ù…Ø­ÛŒØ· JS Ø³Ø§Ù„Ù… Ø§Ø³Øª' };
            } catch (error) {
                return { success: false, message: error.message };
            }
        }
        
        // Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ ØªØ³Øª Ù‡Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„...
        
        // ==================== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Ú©Ù„ÛŒ ====================
        async function runAllTests() {
            log('ğŸ§ª Ø´Ø±ÙˆØ¹ ØªØ³Øª Ú©Ù„ÛŒ Ù‡Ù…Ù‡ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§...', 'info');
            
            const results = [];
            for (let i = 0; i < CORE_MODULES.length; i++) {
                const module = CORE_MODULES[i];
                
                if (appState.loadedModules.has(module.id)) {
                    log(`   ØªØ³Øª ${module.name}...`, 'info');
                    const result = await module.test();
                    results.push({
                        module: module.name,
                        ...result
                    });
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø±Øª
                    updateModuleCard(i, result.success ? 'loaded' : 'error');
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            // Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬
            const passed = results.filter(r => r.success).length;
            const failed = results.filter(r => !r.success).length;
            
            log(`ğŸ“Š Ù†ØªØ§ÛŒØ¬ ØªØ³Øª: ${passed} Ù…ÙˆÙÙ‚ØŒ ${failed} Ù†Ø§Ù…ÙˆÙÙ‚`, 
                failed === 0 ? 'success' : 'warning');
            
            return { results, passed, failed };
        }
        
        // ==================== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ====================
        window.addEventListener('DOMContentLoaded', () => {
            createModuleCards();
            log('ğŸ”§ Ù…Ù…ÛŒØ²ÛŒ Ù‡Ø³ØªÙ‡ Vakamova Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª', 'success');
            log('ğŸ“Œ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ "Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯" Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯', 'info');
            
            // Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² Ú©Ù†Ø³ÙˆÙ„
            window.CoreAuditor = {
                loadSmart: loadSmartSequence,
                testAll: runAllTests,
                getState: () => ({
                    loaded: appState.loadedModules.size,
                    modules: Array.from(appState.loadedModules.keys())
                })
            };
        });
        
        // Ø¨Ù‚ÛŒÙ‡ Ú©Ø¯Ù‡Ø§ (updateModuleCard, createModuleCards, log, etc.) 
        // Ù‡Ù…Ø§Ù†Ù†Ø¯ Ú©Ø¯ Ø´Ù…Ø§ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯...
        
    </script>
</body>
</html>
