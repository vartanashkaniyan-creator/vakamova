<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HyperLang Pro - Ø¢Ù…ÙˆØ²Ø´ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Û±Û² Ø²Ø¨Ø§Ù†</title>
    <meta name="description" content="Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¢Ù…ÙˆØ²Ø´ Û±Û² Ø²Ø¨Ø§Ù† Ø²Ù†Ø¯Ù‡ Ø¯Ù†ÛŒØ§ Ø¨Ø§ Ø³ÛŒØ³ØªÙ… Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¢Ù…ÙˆØ²Ø´ÛŒ">
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a237e">
    <link rel="icon" type="image/png" href="assets/icon-192.png">
    <link rel="apple-touch-icon" href="assets/icon-192.png">
    
    <!-- Critical CSS -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }
        #app { 
            min-height: 100vh;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .app-loaded #app { opacity: 1; }
        .loading-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #1a237e;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        .loading-screen.hidden { opacity: 0; pointer-events: none; }
        .spinner { 
            width: 50px; height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Responsive Grid */
        .main-container {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr auto;
            min-height: 100vh;
        }
        @media (min-width: 768px) {
            .main-container {
                grid-template-columns: 250px 1fr;
                grid-template-areas: 
                    "sidebar header"
                    "sidebar main"
                    "sidebar footer";
            }
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Error Boundary */
        .error-boundary {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <h2>Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ HyperLang Pro</h2>
        <p id="loadingStatus">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‡Ø³ØªÙ‡ Ø³ÛŒØ³ØªÙ…...</p>
    </div>
    
    <!-- Error Boundary -->
    <div class="error-boundary" id="errorBoundary">
        <div style="max-width: 500px; margin: 100px auto;">
            <h2 style="color: #ff5252;">âš ï¸ Ø®Ø·Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ…</h2>
            <p id="errorMessage" style="margin: 20px 0;"></p>
            <button onclick="window.location.reload()" 
                    style="padding: 10px 30px; background: #1a237e; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
            </button>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="app" class="main-container">
        <!-- Screen reader announcement -->
        <div class="sr-only" id="srAnnouncement" aria-live="polite"></div>
        
        <!-- Header -->
        <header style="grid-area: header; padding: 15px; background: rgba(0,0,0,0.2);">
            <h1>HyperLang Pro</h1>
        </header>
        
        <!-- Sidebar -->
        <aside style="grid-area: sidebar; background: rgba(0,0,0,0.3); padding: 15px;">
            <nav id="mainNav">
                <!-- Navigation will be injected by JavaScript -->
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main style="grid-area: main; padding: 20px;" id="mainContent">
            <div class="content-wrapper">
                <!-- Dynamic content will be rendered here -->
            </div>
        </main>
        
        <!-- Footer -->
        <footer style="grid-area: footer; padding: 15px; text-align: center; background: rgba(0,0,0,0.2);">
            <p>Â© Û±Û´Û°Û³ HyperLang Pro - Ù†Ø³Ø®Ù‡ Û±.Û°.Û°</p>
        </footer>
    </div>
    
    <!-- ==================== CORE SYSTEM ==================== -->
    <!-- Configuration & Settings -->
    <script src="config.js"></script>
    
    <!-- Database Layer -->
    <script src="CORE_db.js"></script>
    
    <!-- State Management -->
    <script src="CORE_state.js"></script>
    
    <!-- Routing System -->
    <script src="CORE_router.js"></script>
    
    <!-- ==================== MODULES ==================== -->
    <!-- Authentication -->
    <script src="MODULES_auth.js"></script>
    
    <!-- Lesson Engine -->
    <script src="MODULES_lesson_engine_LessonManager.js"></script>
    
    <!-- UI Renderer -->
    <script src="UI_components_SmartLessonRenderer.js"></script>
    
    <!-- ==================== DATA ==================== -->
    <script type="module">
        // Languages data will be loaded dynamically
    </script>
    
            lessonManager: null,
            renderer: null,
            
            // Initialize application with dependency injection
            async init() {
                try {
                    this.updateLoadingStatus('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª...');
                    <script src="app.js"></script>
                    // 1. Load configuration
                    if (typeof AppConfig === 'undefined') {
                        throw new Error('ÙØ§ÛŒÙ„ config.js Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯');
                    }
                    this.config = AppConfig;
                    this.config.validateConfig();
                    
                    this.updateLoadingStatus('Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³...');
                    
                    // 2. Initialize database
                    this.db = new AppDatabase();
                    await this.db.init();
                    
                    this.updateLoadingStatus('Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ… Ø­Ø§Ù„Øª...');
                    
                    // 3. Initialize state management
                    this.state = new AppState(this.db);
                    await this.state.restore();
                    
                    this.updateLoadingStatus('Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ...');
                    
                    // 4. Initialize router
                    this.router = new AppRouter({
                        onRouteChange: this.onRouteChange.bind(this)
                    });
                    
                    this.updateLoadingStatus('Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…ÙˆØªÙˆØ± Ø¯Ø±Ø³...');
                    
                    // 5. Initialize lesson engine
                    this.lessonManager = new LessonManager(this.db, this.state);
                    
                    this.updateLoadingStatus('Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø±Ù†Ø¯Ø±Ú©Ù†Ù†Ø¯Ù‡...');
                    
                    // 6. Initialize UI renderer
                    this.renderer = new SmartLessonRenderer('mainContent');
                    
                    this.updateLoadingStatus('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø­ØªÙˆØ§...');
                    
                    // 7. Load initial data
                    await this.loadInitialData();
                    
                    // 8. Hide loading screen
                    setTimeout(() => {
                        document.getElementById('loadingScreen').classList.add('hidden');
                        document.body.classList.add('app-loaded');
                        this.updateLoadingStatus('Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ù‡ Ú©Ø§Ø±!');
                        
                        // 9. Start routing
                        this.router.start();
                        
                        // 10. Announce to screen readers
                        this.announceToScreenReader('Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† HyperLang Pro Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯');
                        
                        console.log('ğŸš€ HyperLang Pro successfully initialized!');
                    }, 500);
                    
                } catch (error) {
                    console.error('âŒ Initialization error:', error);
                    this.showCriticalError(`Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ: ${error.message}`);
                }
            },
            
            updateLoadingStatus(text) {
                const element = document.getElementById('loadingStatus');
                if (element) element.textContent = text;
            },
            
            async loadInitialData() {
                // Load languages
                try {
                    const response = await fetch('DATA_languages.json');
                    this.languages = await response.json();
                    console.log(`âœ… Loaded ${this.languages.length} languages`);
                } catch (error) {
                    console.warn('Could not load languages, using default');
                    this.languages = AppConfig.LANGUAGES || [];
                }
            },
            
            onRouteChange(route) {
                console.log('Route changed to:', route);
                
                // Update active navigation
                this.updateNavigation(route);
                
                // Render appropriate content based on route
                switch(route) {
                    case '/':
                        this.renderHomePage();
                        break;
                    case '/lessons':
                        this.renderLessonsPage();
                        break;
                    case '/profile':
                        this.renderProfilePage();
                        break;
                    default:
                        this.renderLessonPage(route);
                }
            },
            
            renderHomePage() {
                this.renderer.renderDashboard({
                    languages: this.languages,
                    userProgress: this.state.userProgress,
                    recentLessons: this.state.recentLessons
                });
            },
            
            async renderLessonsPage() {
                const lessons = await this.lessonManager.getAvailableLessons(
                    this.state.currentLanguage,
                    this.state.currentLevel
                );
                this.renderer.renderLessonLibrary(lessons);
            },
            
            async renderLessonPage(lessonId) {
                const lesson = await this.lessonManager.loadLesson(
                    this.state.currentLanguage,
                    this.state.currentLevel,
                    lessonId
                );
                if (lesson) {
                    this.renderer.renderLesson(lesson);
                    this.state.recordLessonView(lessonId);
                }
            },
            
            renderProfilePage() {
                this.renderer.renderUserProfile(this.state.user);
            },
            
            updateNavigation(activeRoute) {
                // Implementation for navigation updates
                const nav = document.getElementById('mainNav');
                // Navigation logic here
            },
            
            announceToScreenReader(message) {
                const announcement = document.getElementById('srAnnouncement');
                announcement.textContent = message;
            },
            
            showCriticalError(message) {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorBoundary').style.display = 'block';
            }
        };
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            HyperLang.init();
        });
        
        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').then(
                    registration => {
                        console.log('âœ… ServiceWorker registered:', registration.scope);
                    },
                    error => {
                        console.log('âŒ ServiceWorker registration failed:', error);
                    }
                );
            });
        }
        
        // Offline detection
        window.addEventListener('online', () => {
            HyperLang.announceToScreenReader('Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯');
        });
        
        window.addEventListener('offline', () => {
            HyperLang.announceToScreenReader('Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† ÙØ¹Ø§Ù„ Ø´Ø¯');
        });
    </script>
</body>
</html>
