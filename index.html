<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vakamova - Ø¢Ù…ÙˆØ²Ø´ Ø²Ø¨Ø§Ù† Û±Û² Ø²Ø¨Ø§Ù†Ù‡</title>
    
    <!-- ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ -->
    <link rel="stylesheet" href="assets/fonts/vazirmatn.css">
    
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù¾Ø±Ú†Ù…â€ŒÙ‡Ø§ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/css/flag-icons.min.css">
    
    <!-- Ø§Ø³ØªØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ -->
    <style>
        :root {
            --primary: #1a237e;
            --secondary: #311b92;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #2196f3;
            --text: #ffffff;
            --bg-dark: #0f172a;
            --bg-card: rgba(255, 255, 255, 0.1);
            --border: rgba(255, 255, 255, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            font-family: 'Vazirmatn', 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }
        
        #app {
            min-height: 100vh;
            position: relative;
        }
        
        /* Ù†ÙˆØ§Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ */
        .app-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--info);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 1.2rem;
            color: #94a3b8;
            text-align: center;
        }
        
        /* Ù‡Ø¯Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ */
        .app-header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            padding: 15px 30px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00b0ff, #00e5ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        /* Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ */
        .app-content {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeIn 0.5s ease;
        }
        
        /* Ø­Ø§Ù„Øª Ø®Ø·Ø§ */
        .error-state {
            background: rgba(244, 67, 54, 0.1);
            border: 2px solid var(--danger);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 40px auto;
            max-width: 600px;
        }
        
        .error-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .retry-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 20px;
            transition: opacity 0.3s;
        }
        
        .retry-btn:hover {
            opacity: 0.9;
        }
        
        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
        @media (max-width: 768px) {
            .app-header {
                padding: 15px;
                flex-direction: column;
                gap: 15px;
            }
            
            .app-content {
                padding: 20px;
            }
            
            .logo {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <!-- ØµÙØ­Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ -->
    <div id="loadingScreen" class="app-loading">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Vakamova...</div>
    </div>
    
    <!-- Ø³Ø§Ø®ØªØ§Ø± Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ -->
    <div id="app" style="display: none;">
        <!-- Ù‡Ø¯Ø± -->
        <header class="app-header">
            <div class="logo">
                <span>ğŸ“</span>
                <span>Vakamova</span>
            </div>
            
            <div class="user-menu">
                <div id="languageSelector" class="language-selector">
                    <!-- Ù¾Ø±Ú†Ù…â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                </div>
                <div id="userStatus" class="user-status">
                    <!-- ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± -->
                </div>
            </div>
        </header>
        
        <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->
        <main class="app-content" id="appContent">
            <!-- ØµÙØ­Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù†Ø¯Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            <div id="pageContainer"></div>
        </main>
        
        <!-- Ø­Ø§Ù„Øª Ø®Ø·Ø§ -->
        <div id="errorState" class="error-state" style="display: none;">
            <div class="error-icon">âš ï¸</div>
            <h2 id="errorTitle">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡</h2>
            <p id="errorMessage">Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ… Ø±Ø® Ø¯Ø§Ø¯Ù‡ Ø§Ø³Øª.</p>
            <button class="retry-btn" onclick="window.location.reload()">
                ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
            </button>
        </div>
    </div>
    
    <!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ -->
    <script type="module">
        // ==================== CONFIGURATION ====================
        const APP_CONFIG = {
            name: 'Vakamova',
            version: '1.0.0',
            defaultPage: 'dashboard',
            coreModules: [
                { name: 'Event Bus', path: 'core/event_bus.js' },
                { name: 'State Manager', path: 'core/state_manager.js' },
                { name: 'Context Provider', path: 'core/context_provider.js' },
                { name: 'Router Middleware', path: 'core/router_middleware.js' },
                { name: 'Guards', path: 'core/guards.js' }
            ],
            featureModules: [
                { name: 'Auth System', path: 'modules/auth/auth_manager.js' },
                { name: 'Dashboard View', path: 'pages/dashboard/view.js' },
                { name: 'Home View', path: 'pages/home/view.js' },
                { name: 'Language Constants', path: 'core/language_constants.js' }
            ]
        };
        
        // ==================== APPLICATION STATE ====================
        const appState = {
            isInitialized: false,
            loadedModules: new Set(),
            currentPage: null,
            user: null,
            error: null
        };
        
        // ==================== CORE FUNCTIONS ====================
        function updateLoadingText(text) {
            const element = document.getElementById('loadingText');
            if (element) element.textContent = text;
        }
        
        function showError(title, message) {
            console.error(`[APP ERROR] ${title}: ${message}`);
            
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('app').style.display = 'none';
            
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
        }
        
        async function loadModule(moduleConfig) {
            return new Promise((resolve, reject) => {
                updateLoadingText(`Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ${moduleConfig.name}...`);
                
                const script = document.createElement('script');
                script.src = moduleConfig.path;
                script.type = 'module';
                
                script.onload = () => {
                    appState.loadedModules.add(moduleConfig.name);
                    console.log(`âœ… ${moduleConfig.name} loaded`);
                    resolve();
                };
                
                script.onerror = () => {
                    reject(new Error(`Failed to load ${moduleConfig.path}`));
                };
                
                document.head.appendChild(script);
            });
        }
        
        async function initializeApp() {
            try {
                console.log(`ğŸš€ Initializing ${APP_CONFIG.name} v${APP_CONFIG.version}`);
                
                // Ù…Ø±Ø­Ù„Ù‡ Û±: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù‡Ø³ØªÙ‡
                updateLoadingText('Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡...');
                for (const module of APP_CONFIG.coreModules) {
                    await loadModule(module);
                }
                
                // Ù…Ø±Ø­Ù„Ù‡ Û²: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Event Bus Ùˆ State Manager
                updateLoadingText('Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§Ø±ØªØ¨Ø§Ø·Ø§Øª...');
                
                // Ù…Ø±Ø­Ù„Ù‡ Û³: Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§
                updateLoadingText('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ...');
                for (const module of APP_CONFIG.featureModules) {
                    try {
                        await loadModule(module);
                    } catch (error) {
                        console.warn(`âš ï¸ Could not load ${module.name}:`, error.message);
                    }
                }
                
                // Ù…Ø±Ø­Ù„Ù‡ Û´: ØªÙ†Ø¸ÛŒÙ… Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
                setupEventListeners();
                
                // Ù…Ø±Ø­Ù„Ù‡ Ûµ: Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø¨Ù‡ ØµÙØ­Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
                navigateTo(APP_CONFIG.defaultPage);
                
                // Ù…Ø±Ø­Ù„Ù‡ Û¶: Ù†Ù…Ø§ÛŒØ´ Ø¨Ø±Ù†Ø§Ù…Ù‡
                finalizeInitialization();
                
            } catch (error) {
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ', error.message);
            }
        }
        
        function setupEventListeners() {
            // Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±
            if (window.eventBus) {
                eventBus.on('auth:status:changed', (data) => {
                    appState.user = data.user;
                    updateUserStatus();
                });
                
                eventBus.on('router:navigate', (data) => {
                    navigateTo(data.path);
                });
            }
        }
        
        function navigateTo(page) {
            if (!appState.isInitialized) return;
            
            appState.currentPage = page;
            console.log(`ğŸ“ Navigating to: ${page}`);
            
            // Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù…Ù†Ø·Ù‚ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ú©Ø§Ù…Ù„ Ø±Ø§ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯
            renderPage(page);
        }
        
        function renderPage(page) {
            const container = document.getElementById('pageContainer');
            if (!container) return;
            
            switch(page) {
                case 'dashboard':
                    if (window.dashboardView) {
                        dashboardView.render('pageContainer');
                    } else {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 60px;">
                                <h2>ğŸ¯ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Vakamova</h2>
                                <p>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø²Ø¨Ø§Ù†â€ŒÙ‡Ø§</p>
                            </div>
                        `;
                    }
                    break;
                    
                case 'home':
                    if (window.homeView) {
                        // Ø§Ú¯Ø± HomeView Ø¯Ø§Ø±ÛŒØ¯
                    } else {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 60px;">
                                <h2>ğŸ  ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</h2>
                                <p>Ø¨Ù‡ Vakamova Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</p>
                            </div>
                        `;
                    }
                    break;
                    
                default:
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px;">
                            <h2>ğŸ“„ ØµÙØ­Ù‡ ${page}</h2>
                            <p>Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ø§Ø³Øª</p>
                        </div>
                    `;
            }
        }
        
        function updateUserStatus() {
            const element = document.getElementById('userStatus');
            if (!element) return;
            
            if (appState.user) {
                element.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 35px; height: 35px; border-radius: 50%; 
                              background: linear-gradient(45deg, #00b0ff, #00e5ff); 
                              display: flex; align-items: center; justify-content: center;">
                            ğŸ‘¤
                        </div>
                        <span>${appState.user.name || 'Ú©Ø§Ø±Ø¨Ø±'}</span>
                    </div>
                `;
            } else {
                element.innerHTML = `
                    <button style="background: var(--info); color: white; border: none; 
                           padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                        ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…
                    </button>
                `;
            }
        }
        
        function setupLanguageSelector() {
            const element = document.getElementById('languageSelector');
            if (!element || !window.LANGUAGE_FLAGS) return;
            
            // Ù†Ù…Ø§ÛŒØ´ Û´ Ø²Ø¨Ø§Ù† Ø§ÙˆÙ„ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù†Ù…ÙˆÙ†Ù‡
            const languages = ['FA', 'AR_IQ', 'TR', 'EN_GB'];
            element.innerHTML = languages.map(code => 
                `<span style="margin: 0 5px; cursor: pointer;" 
                       title="${window.LANGUAGE_NAMES?.[code] || code}">
                    ${window.LANGUAGE_FLAGS[code]}
                </span>`
            ).join('');
        }
        
        function finalizeInitialization() {
            // Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
            document.getElementById('loadingScreen').style.opacity = '0';
            
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øªâ€ŒÙ‡Ø§ÛŒ UI
                setupLanguageSelector();
                updateUserStatus();
                
                appState.isInitialized = true;
                console.log('ğŸ‰ Application initialized successfully!');
                
                // Ø§Ù†ØªØ´Ø§Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ
                if (window.eventBus) {
                    eventBus.emit('app:initialized', {
                        timestamp: Date.now(),
                        version: APP_CONFIG.version,
                        loadedModules: Array.from(appState.loadedModules)
                    });
                }
                
            }, 500);
        }
        
        // ==================== START APPLICATION ====================
        // Ø´Ø±ÙˆØ¹ Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ DOM
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§Ù‡Ø§ÛŒå…¨å±€
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });
        
        // Ø§Ú©Ø³Ù¾ÙˆØ±Øª Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
        window.VakamovaApp = {
            state: appState,
            config: APP_CONFIG,
            navigateTo,
            reload: () => window.location.reload()
        };
    </script>
</body>
</html>
