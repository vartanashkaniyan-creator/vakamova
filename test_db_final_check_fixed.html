<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ - Vakamova</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:tahoma;background:#5d4037;color:#333;padding:20px}.container{max-width:800px;margin:auto;background:#fff;border-radius:10px;overflow:hidden}header{background:#795548;color:#fff;padding:20px;text-align:center}h1{font-size:1.5rem}.test-section{padding:20px}.test-item{background:#f5f5f5;border-radius:8px;padding:15px;margin-bottom:15px;border-right:5px solid#a1887f}.passed{border-right-color:#43a047;background:#e8f5e9}.failed{border-right-color:#e53935;background:#ffebee}.running{border-right-color:#fb8c00;background:#fff3e0}.test-header{display:flex;justify-content:space-between;margin-bottom:10px}.test-name{font-weight:bold}.test-status{padding:3px 10px;border-radius:12px;font-size:.8rem}.status-pending{background:#fff9c4;color:#f57c00}.status-running{background:#bbdefb;color:#1565c0}.status-passed{background:#c8e6c9;color:#2e7d32}.status-failed{background:#ffcdd2;color:#c62828}button{background:#795548;color:#fff;border:none;padding:12px 25px;border-radius:8px;font-size:1rem;cursor:pointer;width:100%;margin-top:15px}button:hover{background:#5d4037}.console{background:#263238;color:#80cbc4;padding:15px;margin-top:20px;border-radius:8px;font-family:monospace;font-size:.9rem;max-height:200px;overflow-y:auto}.log{padding:5px 0;border-bottom:1px solid #37474f}.summary{background:#d7ccc8;padding:15px;border-radius:8px;margin:15px 0}
    </style>
</head>
<body>
    <div class="container">
        <header><h1>âœ… ØªØ³Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ - Functional Tests</h1></header>
        <div class="test-section">
            <div class="summary">
                <strong>Ù‡Ø¯Ù:</strong> Ø¨Ø±Ø±Ø³ÛŒ ØµØ­Øª Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ÛŒ Ø­ÛŒØ§ØªÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³<br>
                <strong>ÙˆÛŒÚ˜Ú¯ÛŒ:</strong> Ø¨Ø¯ÙˆÙ† ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ ØªØ§ÛŒÙ…ÛŒÙ†Ú¯ Ù…Ø±ÙˆØ±Ú¯Ø±<br>
                <strong>Ø®Ø±ÙˆØ¬ÛŒ:</strong> ØªØ£ÛŒÛŒØ¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ ØµØ­ÛŒØ­ Ø¨Ø±Ø§ÛŒ Vakamova
            </div>
            
            <div class="test-item" id="test1">
                <div class="test-header"><div class="test-name">Û±. Ø¨Ø±Ø±Ø³ÛŒ ØµØ­Øª Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡</div><div class="test-status status-pending" id="status1">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output1"></div>
            </div>
            <div class="test-item" id="test2">
                <div class="test-header"><div class="test-name">Û². Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†ÛŒ Ø³Ø§Ø¯Ù‡</div><div class="test-status status-pending" id="status2">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div></div>
                <div id="output2"></div>
            </div>
            
            <button id="run-btn">â–¶ï¸ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ</button>
            <button id="run-single1" style="background:#8d6e63;margin-top:10px">ğŸ” ÙÙ‚Ø· ØªØ³Øª Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡</button>
            <button id="run-single2" style="background:#8d6e63;margin-top:10px">ğŸ” ÙÙ‚Ø· ØªØ³Øª Ù‡Ù…Ø²Ù…Ø§Ù†ÛŒ</button>
            
            <div class="console" id="console">
                <div class="log">[Ø³ÛŒØ³ØªÙ…] ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</div>
            </div>
        </div>
    </div>

<script>
// ========== Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ÛŒ ==========
const FinalDB = {
    users: new Map(),
    lessons: new Map(),
    progress: new Map(),
    nextId: { users: 1, lessons: 1 },
    
    // Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±
    createUser(email, name) {
        const user = {
            id: this.nextId.users++,
            email,
            name,
            coins: 100,
            level: 1,
            created_at: new Date().toISOString()
        };
        this.users.set(user.id, user);
        this.log(`Ú©Ø§Ø±Ø¨Ø± "${name}" (${user.id}) Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`);
        return user;
    },
    
    // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø³
    createLesson(title, language) {
        const lesson = {
            id: this.nextId.lessons++,
            title,
            language,
            price: 50,
            difficulty: 'beginner'
        };
        this.lessons.set(lesson.id, lesson);
        this.log(`Ø¯Ø±Ø³ "${title}" (${lesson.id}) Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`);
        return lesson;
    },
    
    // Ø§ÛŒØ¬Ø§Ø¯ ÛŒØ§ Ø¢Ù¾Ø¯ÛŒØª Ù¾ÛŒØ´Ø±ÙØª
    createProgress(userId, lessonId, score) {
        const key = `${userId}_${lessonId}`;
        
        // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        const existing = this.progress.get(key);
        
        const progress = {
            user_id: userId,
            lesson_id: lessonId,
            score: existing ? Math.max(existing.score, score) : score,
            completed: (existing ? Math.max(existing.score, score) : score) >= 80,
            updated_at: new Date().toISOString()
        };
        
        this.progress.set(key, progress);
        this.log(`Ù¾ÛŒØ´Ø±ÙØª Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± ${userId} Ùˆ Ø¯Ø±Ø³ ${lessonId}: Ø§Ù…ØªÛŒØ§Ø²=${score}, ØªÚ©Ù…ÛŒÙ„=${progress.completed}`);
        return progress;
    },
    
    // ========== ØªØ³Øª Û±: Ø¨Ø±Ø±Ø³ÛŒ ØµØ­Øª Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡ ==========
    async testBulkOperations() {
        this.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡ ===");
        
        // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ù‚Ø¨Ù„ Ø§Ø² Ø´Ø±ÙˆØ¹
        this.clear();
        
        // Ù…Ø±Ø­Ù„Ù‡ Û±: Ø§ÛŒØ¬Ø§Ø¯ ÛµÛ° Ú©Ø§Ø±Ø¨Ø±
        const userCount = 50;
        const createdUsers = [];
        
        for (let i = 0; i < userCount; i++) {
            const user = this.createUser(`user${i}@final.com`, `Ú©Ø§Ø±Ø¨Ø± Ù†Ù‡Ø§ÛŒÛŒ ${i}`);
            createdUsers.push(user);
        }
        
        // Ø¨Ø±Ø±Ø³ÛŒ: Ø¢ÛŒØ§ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù†Ø¯ØŸ
        if (this.users.size !== userCount) {
            throw new Error(`ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: ${userCount}ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${this.users.size}`);
        }
        this.log(`âœ“ Ø§ÛŒØ¬Ø§Ø¯ ${userCount} Ú©Ø§Ø±Ø¨Ø± Ù…ÙˆÙÙ‚`);
        
        // Ù…Ø±Ø­Ù„Ù‡ Û²: Ø§ÛŒØ¬Ø§Ø¯ Û±Û° Ø¯Ø±Ø³
        const lessonCount = 10;
        const createdLessons = [];
        
        for (let i = 0; i < lessonCount; i++) {
            const lesson = this.createLesson(`Ø¯Ø±Ø³ Ù†Ù‡Ø§ÛŒÛŒ ${i}`, i % 2 === 0 ? 'english' : 'persian');
            createdLessons.push(lesson);
        }
        
        if (this.lessons.size !== lessonCount) {
            throw new Error(`ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø³â€ŒÙ‡Ø§ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: ${lessonCount}ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${this.lessons.size}`);
        }
        this.log(`âœ“ Ø§ÛŒØ¬Ø§Ø¯ ${lessonCount} Ø¯Ø±Ø³ Ù…ÙˆÙÙ‚`);
        
        // Ù…Ø±Ø­Ù„Ù‡ Û³: Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÛŒØ´Ø±ÙØª Ø¨Ø±Ø§ÛŒ ØªØ±Ú©ÛŒØ¨â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù (Û²Û° Ø±Ú©ÙˆØ±Ø¯)
        const progressCount = 20;
        for (let i = 0; i < progressCount; i++) {
            const user = createdUsers[i % createdUsers.length];
            const lesson = createdLessons[i % createdLessons.length];
            const score = Math.floor(Math.random() * 100);
            
            this.createProgress(user.id, lesson.id, score);
        }
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù‡Ø§ÛŒÛŒ
        if (this.progress.size !== progressCount) {
            throw new Error(`ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØª Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: ${progressCount}ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${this.progress.size}`);
        }
        this.log(`âœ“ Ø§ÛŒØ¬Ø§Ø¯ ${progressCount} Ø±Ú©ÙˆØ±Ø¯ Ù¾ÛŒØ´Ø±ÙØª Ù…ÙˆÙÙ‚`);
        
        // Ø¨Ø±Ø±Ø³ÛŒ ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        const issues = [];
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        for (const user of createdUsers) {
            const storedUser = this.users.get(user.id);
            if (!storedUser) issues.push(`Ú©Ø§Ø±Ø¨Ø± ${user.id} ÛŒØ§ÙØª Ù†Ø´Ø¯`);
            if (storedUser && storedUser.coins !== 100) issues.push(`Ú©ÙˆÛŒÙ† Ú©Ø§Ø±Ø¨Ø± ${user.id} Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª: ${storedUser.coins}`);
        }
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø±Ø³â€ŒÙ‡Ø§
        for (const lesson of createdLessons) {
            const storedLesson = this.lessons.get(lesson.id);
            if (!storedLesson) issues.push(`Ø¯Ø±Ø³ ${lesson.id} ÛŒØ§ÙØª Ù†Ø´Ø¯`);
            if (storedLesson && storedLesson.price !== 50) issues.push(`Ù‚ÛŒÙ…Øª Ø¯Ø±Ø³ ${lesson.id} Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª: ${storedLesson.price}`);
        }
        
        if (issues.length > 0) {
            throw new Error(`Ù…Ø´Ú©Ù„Ø§Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ú¯ÛŒ: ${issues.slice(0, 3).join(', ')}`);
        }
        
        return {
            success: true,
            stats: {
                users: this.users.size,
                lessons: this.lessons.size,
                progress: this.progress.size,
                totalOperations: userCount + lessonCount + progressCount
            }
        };
    },
    
    // ========== ØªØ³Øª Û²: Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†ÛŒ Ø³Ø§Ø¯Ù‡ ==========
    async testConcurrentOperations() {
        this.log("=== Ø´Ø±ÙˆØ¹ ØªØ³Øª Ù‡Ù…Ø²Ù…Ø§Ù†ÛŒ Ø³Ø§Ø¯Ù‡ ===");
        
        // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ù‚Ø¨Ù„ Ø§Ø² Ø´Ø±ÙˆØ¹
        this.clear();
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        const user1 = this.createUser('concurrent1@test.com', 'Ù‡Ù…Ø²Ù…Ø§Ù† Û±');
        const user2 = this.createUser('concurrent2@test.com', 'Ù‡Ù…Ø²Ù…Ø§Ù† Û²');
        const lesson1 = this.createLesson('Ø¯Ø±Ø³ Ù‡Ù…Ø²Ù…Ø§Ù† Û±', 'english');
        const lesson2 = this.createLesson('Ø¯Ø±Ø³ Ù‡Ù…Ø²Ù…Ø§Ù† Û²', 'persian');
        
        // Ø°Ø®ÛŒØ±Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§ÙˆÙ„ÛŒÙ‡
        const initialUser1Coins = user1.coins;
        const initialUser2Coins = user2.coins;
        
        this.log(`ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡: Ú©Ø§Ø±Ø¨Ø±1=${user1.coins} Ø³Ú©Ù‡ØŒ Ú©Ø§Ø±Ø¨Ø±2=${user2.coins} Ø³Ú©Ù‡`);
        this.log(`Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±: Û´ Ø¹Ù…Ù„ÛŒØ§Øª Ù¾ÛŒØ´Ø±ÙØª Ø¨Ø§ Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ÛŒ 85, 70, 90, 65`);
        
        // ØªØ¹Ø±ÛŒÙ Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª ÙˆØ§Ø¶Ø­
        const operations = [
            {
                name: 'Ú©Ø§Ø±Ø¨Ø± Û± Ø¯Ø±Ø³ Û±',
                action: () => {
                    const result = this.createProgress(user1.id, lesson1.id, 85);
                    user1.coins -= 10;
                    return result;
                }
            },
            {
                name: 'Ú©Ø§Ø±Ø¨Ø± Û² Ø¯Ø±Ø³ Û²',
                action: () => {
                    const result = this.createProgress(user2.id, lesson2.id, 70);
                    user2.coins -= 10;
                    return result;
                }
            },
            {
                name: 'Ú©Ø§Ø±Ø¨Ø± Û± Ø¯Ø±Ø³ Û²',
                action: () => {
                    const result = this.createProgress(user1.id, lesson2.id, 90);
                    user1.coins -= 10;
                    return result;
                }
            },
            {
                name: 'Ú©Ø§Ø±Ø¨Ø± Û² Ø¯Ø±Ø³ Û±',
                action: () => {
                    const result = this.createProgress(user2.id, lesson1.id, 65);
                    user2.coins -= 10;
                    return result;
                }
            }
        ];
        
        // Ø§Ø¬Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ù†ØªØ§ÛŒØ¬
        const results = [];
        for (let i = 0; i < operations.length; i++) {
            const op = operations[i];
            try {
                this.log(`Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª ${i+1}: ${op.name}`);
                const result = op.action();
                results.push(result);
                this.log(`Ø¹Ù…Ù„ÛŒØ§Øª ${i+1} Ù…ÙˆÙÙ‚: Ø§Ù…ØªÛŒØ§Ø²=${result.score}, ØªÚ©Ù…ÛŒÙ„=${result.completed}`);
            } catch (error) {
                this.log(`Ø®Ø·Ø§ Ø¯Ø± Ø¹Ù…Ù„ÛŒØ§Øª ${i+1} (${op.name}): ${error.message}`, 'error');
                throw new Error(`Ø¹Ù…Ù„ÛŒØ§Øª ${i+1} Ù†Ø§Ù…ÙˆÙÙ‚: ${error.message}`);
            }
        }
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ
        this.log(`=== Ø¨Ø±Ø±Ø³ÛŒ Ù†ØªØ§ÛŒØ¬ ===`);
        this.log(`ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØª Ø¯Ø± Map: ${this.progress.size}`);
        this.log(`Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± progress:`);
        for (const key of this.progress.keys()) {
            const p = this.progress.get(key);
            this.log(`  ${key}: Ø§Ù…ØªÛŒØ§Ø²=${p.score}, ØªÚ©Ù…ÛŒÙ„=${p.completed}`);
        }
        
        const issues = [];
        
        // Û±. Ø¨Ø±Ø±Ø³ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ (Ø¨Ø§ÛŒØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Û´ Ø¨Ø§Ø´Ø¯)
        const expectedProgressCount = 4;
        if (this.progress.size !== expectedProgressCount) {
            issues.push(`ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØª Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: ${expectedProgressCount}ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${this.progress.size} (Ú©Ù„ÛŒØ¯Ù‡Ø§: ${Array.from(this.progress.keys()).join(', ')})`);
        }
        
        // Û². Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        const expectedUser1Coins = initialUser1Coins - 20; // Ø¯Ùˆ Ø¯Ø±Ø³
        const expectedUser2Coins = initialUser2Coins - 20; // Ø¯Ùˆ Ø¯Ø±Ø³
        
        if (user1.coins !== expectedUser1Coins) {
            issues.push(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Û± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: ${expectedUser1Coins}ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${user1.coins}`);
        }
        
        if (user2.coins !== expectedUser2Coins) {
            issues.push(`Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§Ø±Ø¨Ø± Û² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: ${expectedUser2Coins}ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${user2.coins}`);
        }
        
        // Û³. Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡
        let completedCount = 0;
        const progressDetails = [];
        
        for (const [key, progress] of this.progress) {
            progressDetails.push(`${key}=${progress.score}(${progress.completed ? 'ØªÚ©Ù…ÛŒÙ„' : 'Ù†Ø§Ù‚Øµ'})`);
            if (progress.completed) completedCount++;
        }
        
        const expectedCompletedCount = 2; // Ú©Ø§Ø±Ø¨Ø±1: Ø¯Ø±Ø³1(85) Ùˆ Ø¯Ø±Ø³2(90)
        if (completedCount !== expectedCompletedCount) {
            issues.push(`ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: ${expectedCompletedCount}ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${completedCount} (Ø¬Ø²ÛŒÛŒØ§Øª: ${progressDetails.join(', ')})`);
        }
        
        // Û´. Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§
        const expectedScores = {
            [`${user1.id}_${lesson1.id}`]: 85,
            [`${user2.id}_${lesson2.id}`]: 70,
            [`${user1.id}_${lesson2.id}`]: 90,
            [`${user2.id}_${lesson1.id}`]: 65
        };
        
        for (const [expectedKey, expectedScore] of Object.entries(expectedScores)) {
            const progress = this.progress.get(expectedKey);
            if (!progress) {
                issues.push(`Ø±Ú©ÙˆØ±Ø¯ Ù¾ÛŒØ´Ø±ÙØª Ø¨Ø±Ø§ÛŒ ${expectedKey} ÛŒØ§ÙØª Ù†Ø´Ø¯`);
            } else if (progress.score !== expectedScore) {
                issues.push(`Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ ${expectedKey} Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§Ù†ØªØ¸Ø§Ø±: ${expectedScore}ØŒ ÙˆØ§Ù‚Ø¹ÛŒ: ${progress.score}`);
            }
        }
        
        if (issues.length > 0) {
            this.log(`Ù…Ø´Ú©Ù„Ø§Øª ÛŒØ§ÙØª Ø´Ø¯Ù‡: ${issues.join(' | ')}`, 'error');
            throw new Error(issues.join(' | '));
        }
        
        this.log(`âœ“ ØªÙ…Ø§Ù… Ø¨Ø±Ø±Ø³ÛŒâ€ŒÙ‡Ø§ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯Ù†Ø¯`, 'success');
        
        return {
            success: true,
            stats: {
                users: this.users.size,
                lessons: this.lessons.size,
                progress: this.progress.size,
                completedLessons: completedCount,
                user1FinalCoins: user1.coins,
                user2FinalCoins: user2.coins,
                progressDetails: progressDetails
            }
        };
    },
    
    // ========== Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ==========
    log(message, type = 'info') {
        const consoleEl = document.getElementById('console');
        const logEntry = document.createElement('div');
        logEntry.className = 'log';
        
        const prefix = type === 'error' ? '[Ø®Ø·Ø§] ' : type === 'success' ? '[Ù…ÙˆÙÙ‚] ' : '';
        logEntry.textContent = `${prefix}${message}`;
        
        if (type === 'error') logEntry.style.color = '#ef9a9a';
        if (type === 'success') logEntry.style.color = '#c5e1a5';
        
        consoleEl.appendChild(logEntry);
        consoleEl.scrollTop = consoleEl.scrollHeight;
        console.log(`[FinalDB] ${message}`);
    },
    
    clear() {
        this.users.clear();
        this.lessons.clear();
        this.progress.clear();
        this.nextId = { users: 1, lessons: 1 };
        this.log("Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ú©Ø§Ù…Ù„Ø§Ù‹ Ù¾Ø§Ú© Ø´Ø¯");
    }
};

// ========== Ù…Ø¯ÛŒØ±ÛŒØª ØªØ³Øªâ€ŒÙ‡Ø§ ==========
const tests = [
    {
        id: 'test1',
        name: 'Ø¨Ø±Ø±Ø³ÛŒ ØµØ­Øª Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡',
        run: async () => {
            const testElement = document.getElementById('test1');
            const statusElement = document.getElementById('status1');
            const outputElement = document.getElementById('output1');
            
            testElement.className = 'test-item running';
            statusElement.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§';
            statusElement.className = 'test-status status-running';
            outputElement.innerHTML = '<span style="color:#666">Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¨ÙˆÙ‡...</span>';
            
            try {
                const result = await FinalDB.testBulkOperations();
                
                testElement.className = 'test-item passed';
                statusElement.textContent = 'Ù…ÙˆÙÙ‚';
                statusElement.className = 'test-status status-passed';
                outputElement.innerHTML = `
                    <div style="color:#2e7d32">
                        <strong>âœ… Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯</strong><br>
                        <small>
                            Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: ${result.stats.users} | 
                            Ø¯Ø±Ø³â€ŒÙ‡Ø§: ${result.stats.lessons} | 
                            Ù¾ÛŒØ´Ø±ÙØªâ€ŒÙ‡Ø§: ${result.stats.progress}<br>
                            Ú©Ù„ Ø¹Ù…Ù„ÛŒØ§Øª: ${result.stats.totalOperations}
                        </small>
                    </div>
                `;
                
                FinalDB.log("ØªØ³Øª Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯", 'success');
                return true;
                
            } catch (error) {
                testElement.className = 'test-item failed';
                statusElement.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
                statusElement.className = 'test-status status-failed';
                outputElement.innerHTML = `<div style="color:#c62828"><strong>âŒ Ø®Ø·Ø§:</strong> ${error.message}</div>`;
                
                FinalDB.log(`ØªØ³Øª Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡ Ù†Ø§Ù…ÙˆÙÙ‚: ${error.message}`, 'error');
                return false;
            }
        }
    },
    {
        id: 'test2',
        name: 'Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù†ÛŒ Ø³Ø§Ø¯Ù‡',
        run: async () => {
            const testElement = document.getElementById('test2');
            const statusElement = document.getElementById('status2');
            const outputElement = document.getElementById('output2');
            
            testElement.className = 'test-item running';
            statusElement.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§';
            statusElement.className = 'test-status status-running';
            outputElement.innerHTML = '<span style="color:#666">Ø¯Ø± Ø­Ø§Ù„ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù‡Ù…Ø²Ù…Ø§Ù†...</span>';
            
            try {
                const result = await FinalDB.testConcurrentOperations();
                
                testElement.className = 'test-item passed';
                statusElement.textContent = 'Ù…ÙˆÙÙ‚';
                statusElement.className = 'test-status status-passed';
                outputElement.innerHTML = `
                    <div style="color:#2e7d32">
                        <strong>âœ… Ù‡Ù…Ø²Ù…Ø§Ù†ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯</strong><br>
                        <small>
                            Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØª: ${result.stats.progress}<br>
                            Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡: ${result.stats.completedLessons}<br>
                            Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø§Ø±Ø¨Ø± Û±: ${result.stats.user1FinalCoins}<br>
                            Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø§Ø±Ø¨Ø± Û²: ${result.stats.user2FinalCoins}
                        </small>
                    </div>
                `;
                
                FinalDB.log("ØªØ³Øª Ù‡Ù…Ø²Ù…Ø§Ù†ÛŒ Ø³Ø§Ø¯Ù‡ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯", 'success');
                return true;
                
            } catch (error) {
                testElement.className = 'test-item failed';
                statusElement.textContent = 'Ù†Ø§Ù…ÙˆÙÙ‚';
                statusElement.className = 'test-status status-failed';
                outputElement.innerHTML = `<div style="color:#c62828"><strong>âŒ Ø®Ø·Ø§:</strong> ${error.message}</div>`;
                
                FinalDB.log(`ØªØ³Øª Ù‡Ù…Ø²Ù…Ø§Ù†ÛŒ Ø³Ø§Ø¯Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚: ${error.message}`, 'error');
                return false;
            }
        }
    }
];

// ========== Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ ==========
async function runAllTests() {
    const runBtn = document.getElementById('run-btn');
    runBtn.disabled = true;
    runBtn.textContent = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ...';
    
    // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ù†Ø³ÙˆÙ„
    document.getElementById('console').innerHTML = '<div class="log">[Ø³ÛŒØ³ØªÙ…] ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª</div>';
    
    FinalDB.log("=== Ø´Ø±ÙˆØ¹ Ø§Ø¬Ø±Ø§ÛŒ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ ===");
    
    let passed = 0;
    
    for (let i = 0; i < tests.length; i++) {
        // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù‚Ø¨Ù„ Ø§Ø² Ù‡Ø± ØªØ³Øª
        FinalDB.clear();
        
        const success = await tests[i].run();
        if (success) passed++;
        
        // ØªØ§Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ±
        await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    runBtn.disabled = false;
    runBtn.textContent = `ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ (${passed}/${tests.length} Ù…ÙˆÙÙ‚)`;
    
    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
    if (passed === tests.length) {
        FinalDB.log("ğŸ‰ ØªÙ…Ø§Ù… ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø´Øª Ø³Ø± Ú¯Ø°Ø§Ø´ØªÙ‡ Ø´Ø¯Ù†Ø¯!", 'success');
        FinalDB.log("âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Vakamova Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª ÙˆØ§Ù‚Ø¹ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.", 'success');
    } else {
        FinalDB.log(`ØªØ³Øªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù†Ø¯: ${passed} Ø§Ø² ${tests.length} Ù…ÙˆÙÙ‚`, 
                   passed >= 1 ? 'success' : 'error');
    }
}

// ========== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ==========
document.addEventListener('DOMContentLoaded', () => {
    // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡ Ø§ØµÙ„ÛŒ
    document.getElementById('run-btn').addEventListener('click', runAllTests);
    
    // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ ØªÚ©ÛŒ
    document.getElementById('run-single1').addEventListener('click', () => {
        FinalDB.clear();
        document.getElementById('console').innerHTML = '<div class="log">[Ø³ÛŒØ³ØªÙ…] Ø´Ø±ÙˆØ¹ ØªØ³Øª Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†Ø¨ÙˆÙ‡</div>';
        tests[0].run();
    });
    
    document.getElementById('run-single2').addEventListener('click', () => {
        FinalDB.clear();
        document.getElementById('console').innerHTML = '<div class="log">[Ø³ÛŒØ³ØªÙ…] Ø´Ø±ÙˆØ¹ ØªØ³Øª Ù‡Ù…Ø²Ù…Ø§Ù†ÛŒ Ø³Ø§Ø¯Ù‡</div>';
        tests[1].run();
    });
    
    FinalDB.log("Ø³ÛŒØ³ØªÙ… ØªØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.");
    FinalDB.log("Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ 'Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ' Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.");
});
</script>
</body>
</html>
