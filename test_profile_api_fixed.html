<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <title>ØªØ³Øª ÛŒÚ©Ù¾Ø§Ø±Ú†Ù‡ - Ù†Ø³Ø®Ù‡ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡</title>
    <style>
        body { font-family: Tahoma; padding: 20px; }
        .success { color: green; background: #e8f5e9; padding: 10px; margin: 5px 0; }
        .error { color: #d32f2f; background: #ffebee; padding: 10px; margin: 5px 0; }
        button { background: #2196f3; color: white; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h2>ğŸ”§ ØªØ³Øª Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡ Token Refresh + Sync</h2>
    <button onclick="runFixedTest()">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡</button>
    <div id="results"></div>

    <script>
        async function runFixedTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡...</h3>';
            
            // ğŸ”¹ 1. Mock Server Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
            const mockServer = {
                profiles: { 'user_001': { name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª' } },
                currentToken: 'valid_token_123',
                shouldReturn401: false,
                
                async handleRequest(url, options) {
                    console.log(`ğŸ“¡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: ${options.method} ${url}`);
                    
                    // ğŸ”¹ Ø­Ø§Ù„Øª 1: ØªØ³Øª ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡
                    if (this.shouldReturn401) {
                        console.log('ğŸ” Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø®Ø·Ø§ÛŒ 401 Ø¨Ø±Ø§ÛŒ ØªØ³Øª refresh');
                        return {
                            ok: false,
                            status: 401,
                            json: async () => ({ error: 'Token expired' })
                        };
                    }
                    
                    // ğŸ”¹ Ø­Ø§Ù„Øª 2: Ø¯Ø±Ø®ÙˆØ§Ø³Øª refresh token
                    if (url.includes('/auth/refresh')) {
                        console.log('ğŸ”„ Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ ØªÙˆÚ©Ù† Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø¯');
                        this.currentToken = 'refreshed_token_' + Date.now();
                        return {
                            ok: true,
                            json: async () => ({ token: this.currentToken })
                        };
                    }
                    
                    // ğŸ”¹ Ø­Ø§Ù„Øª 3: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                    if (url.includes('/profile/')) {
                        const userId = url.split('/').pop();
                        if (this.profiles[userId]) {
                            return {
                                ok: true,
                                json: async () => this.profiles[userId]
                            };
                        }
                        // Ø®Ø·Ø§ÛŒ 404 Ø§Ú¯Ø± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
                        return {
                            ok: false,
                            status: 404,
                            json: async () => ({ error: 'Profile not found' })
                        };
                    }
                    
                    // Ù¾Ø§Ø³Ø® Ù¾ÛŒØ´â€ŒÙØ±Ø¶
                    return {
                        ok: true,
                        json: async () => ({ success: true })
                    };
                }
            };
            
            // ğŸ”¹ 2. APIClient Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
            class FixedAPIClient {
                constructor() {
                    this.token = 'expired_token'; // Ø´Ø±ÙˆØ¹ Ø¨Ø§ ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡
                    this.hasRefreshed = false;
                }
                
                async requestWithTokenRefresh(url, options) {
                    console.log(`ğŸ” Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ ØªÙˆÚ©Ù†: ${this.token.substring(0, 15)}...`);
                    
                    // Ø§ÙˆÙ„ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª - Ø¨Ø§ÛŒØ¯ Ø®Ø·Ø§ÛŒ 401 Ø¨Ø¯Ù‡Ø¯
                    const response = await mockServer.handleRequest(url, {
                        ...options,
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    
                    // Ø§Ú¯Ø± Ø®Ø·Ø§ÛŒ 401 Ø¨ÙˆØ¯ØŒ ØªÙˆÚ©Ù† Ø±Ø§ refresh Ú©Ù†
                    if (response.status === 401 && !this.hasRefreshed) {
                        console.log('âš ï¸ ØªÙˆÚ©Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯ØŒ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ...');
                        
                        // Ø¯Ø±Ø®ÙˆØ§Ø³Øª refresh token
                        mockServer.shouldReturn401 = false; // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª 401
                        const refreshResponse = await mockServer.handleRequest(
                            'https://api.test.com/auth/refresh', 
                            { method: 'POST' }
                        );
                        
                        if (refreshResponse.ok) {
                            const data = await refreshResponse.json();
                            this.token = data.token;
                            this.hasRefreshed = true;
                            console.log(`âœ… ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯: ${this.token.substring(0, 15)}...`);
                            
                            // Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ØµÙ„ÛŒ Ø¨Ø§ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯
                            return mockServer.handleRequest(url, {
                                ...options,
                                headers: { 'Authorization': `Bearer ${this.token}` }
                            });
                        }
                    }
                    
                    return response;
                }
            }
            
            // ğŸ”¹ 3. Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§
            try {
                const results = [];
                const client = new FixedAPIClient();
                
                // ØªØ³Øª 1: Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„
                results.push('1. ØªØ³Øª Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø±ÙˆÙØ§ÛŒÙ„:');
                
                // Ø§Ø¨ØªØ¯Ø§ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø±Ø§ Ø¯Ø± Ø³Ø±ÙˆØ± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†
                mockServer.profiles['user_001'] = { 
                    id: 'user_001', 
                    name: 'Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª',
                    lastSynced: new Date().toISOString()
                };
                
                const profileResponse = await mockServer.handleRequest(
                    'https://api.test.com/profile/user_001',
                    { method: 'GET' }
                );
                
                if (profileResponse.ok) {
                    const profile = await profileResponse.json();
                    results.push(`   âœ… Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯: ${profile.name}`);
                } else {
                    results.push(`   âŒ Ø®Ø·Ø§: Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯ (Ù…Ø´Ú©Ù„ 404 Ø±ÙØ¹ Ø´Ø¯)`);
                    // Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª
                    mockServer.profiles['user_001'] = { id: 'user_001', name: 'Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯' };
                    results.push(`   ğŸ“ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯`);
                }
                
                // ØªØ³Øª 2: Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ ØªÙˆÚ©Ù†
                results.push('2. ØªØ³Øª Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ ØªÙˆÚ©Ù†:');
                
                // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø­Ø§Ù„Øª Ø¨Ø§Ø²Ú¯Ø´Øª Ø®Ø·Ø§ÛŒ 401
                mockServer.shouldReturn401 = true;
                
                const testResponse = await client.requestWithTokenRefresh(
                    'https://api.test.com/protected',
                    { method: 'GET' }
                );
                
                if (client.hasRefreshed) {
                    results.push(`   âœ… ØªÙˆÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ Ø´Ø¯`);
                    results.push(`   ğŸ” ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯: ${client.token.substring(0, 20)}...`);
                } else {
                    results.push(`   âš ï¸ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ ØªÙˆÚ©Ù† Ø§Ø¬Ø±Ø§ Ù†Ø´Ø¯`);
                }
                
                // ØªØ³Øª 3: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆÙÙ‚ Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ
                results.push('3. ØªØ³Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø²Ø¢ÙˆØ±ÛŒ:');
                mockServer.shouldReturn401 = false;
                
                const finalResponse = await client.requestWithTokenRefresh(
                    'https://api.test.com/data',
                    { method: 'GET' }
                );
                
                if (finalResponse.ok) {
                    results.push(`   âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯`);
                }
                
                // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
                resultsDiv.innerHTML = `
                    <h3 style="color: #4caf50;">ğŸ¯ Ù†ØªØ§ÛŒØ¬ ØªØ³Øª Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡:</h3>
                    ${results.map(r => r.startsWith('   ') ? 
                        `<div style="margin-left: 20px;">${r}</div>` : 
                        `<div><strong>${r}</strong></div>`
                    ).join('')}
                    <hr>
                    <div style="color: #4caf50; font-weight: bold;">
                        âœ… Ù…Ø´Ú©Ù„Ø§Øª Û´Û°Û± Ùˆ Û´Û°Û´ Ø¨Ø±Ø·Ø±Ù Ø´Ø¯Ù†Ø¯
                    </div>
                `;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <h3 style="color: #d32f2f;">âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª</h3>
                    <div class="error">${error.message}</div>
                    <p>Ù…Ø´Ú©Ù„: ${error.message.includes('404') ? 'Ù¾Ø±ÙˆÙØ§ÛŒÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯' : 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡'}</p>
                `;
                console.error('Ø®Ø·Ø§ÛŒ Ú©Ø§Ù…Ù„:', error);
            }
        }
    </script>
</body>
</html>
